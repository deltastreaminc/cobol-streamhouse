IDENTIFICATION DIVISION.
PROGRAM-ID. STATE-CHANGE-LOGGER.
AUTHOR. YOUR-NAME.
DATE-WRITTEN. CURRENT-DATE.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
COPY 'KAFKA-UTILS.COB'.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-BROKER-ID PIC 9(9) VALUE 0.
01 WS-IN-CONTROLLER-CONTEXT PIC X(1) VALUE 'N'.
01 WS-CONTROLLER-EPOCH PIC 9(9) VALUE 0.
01 WS-LOG-IDENT PIC X(50) VALUE SPACES.
01 WS-LOGGER PIC X(50) VALUE 'state.change.logger'.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    MOVE BROKERID TO WS-BROKER-ID.
    MOVE inControllerContext TO WS-IN-CONTROLLER-CONTEXT.
    MOVE controllerEpoch TO WS-CONTROLLER-EPOCH.

    IF WS-CONTROLLER-EPOCH IS NOT EQUAL TO 0 AND WS-IN-CONTROLLER-CONTEXT IS EQUAL TO 'N'
        MOVE 'Controller epoch should only be defined if inControllerContext is true' TO WS-EXCEPTION-MESSAGE
        PERFORM EXCEPTION-HANDLER
    END-IF.

    MOVE 'Logger' TO WS-LOG-IDENT.
    IF WS-IN-CONTROLLER-CONTEXT IS EQUAL TO 'Y'
        STRING '[Controller id=' DELIMITED BY SIZE
               WS-BROKER-ID DELIMITED BY SIZE
               ']' DELIMITED BY SIZE
        INTO WS-LOG-IDENT
    ELSE
        STRING '[Broker id=' DELIMITED BY SIZE
               WS-BROKER-ID DELIMITED BY SIZE
               ']' DELIMITED BY SIZE
        INTO WS-LOG-IDENT
    END-IF.

    IF WS-CONTROLLER-EPOCH IS NOT EQUAL TO 0
        STRING ' epoch=' DELIMITED BY SIZE
               WS-CONTROLLER-EPOCH DELIMITED BY SIZE
        INTO WS-LOG-IDENT
    END-IF.

    PERFORM LOG-MESSAGE.

EXCEPTION-HANDLER.
    DISPLAY WS-EXCEPTION-MESSAGE.
    STOP RUN.

LOG-MESSAGE.
    PERFORM KAFKA-LOG USING WS-LOGGER, WS-LOG-IDENT.

STOP RUN.