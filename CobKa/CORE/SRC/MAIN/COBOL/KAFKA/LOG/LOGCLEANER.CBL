IDENTIFICATION DIVISION.
PROGRAM-ID. LOG-CLEANER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION TIME RETURNING DATE.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 CONFIG-PARAMS.
    05 CLEANER-THREADS PIC 9(4) VALUE 0.
    05 DEDUPE-BUFFER-SIZE PIC 9(10) VALUE 0.
    05 DEDUPE-BUFFER-LOAD-FACTOR PIC 9V99 VALUE 0.
    05 IO-BUFFER-SIZE PIC 9(8) VALUE 0.
    05 MESSAGE-MAX-BYTES PIC 9(8) VALUE 0.
    05 CLEANER-IO-MAX-BYTES PIC 9(10) VALUE 0.
    05 CLEANER-BACKOFF-MS PIC 9(8) VALUE 0.
    05 CLEANER-ENABLE PIC X VALUE 'N'.

01 METRICS-NAMES.
    05 MAX-BUFFER-UTILIZATION-PERCENT PIC X(32) VALUE 'max-buffer-utilization-percent'.
    05 CLEANER-RECOPY-PERCENT PIC X(20) VALUE 'cleaner-recopy-percent'.
    05 MAX-CLEAN-TIME-SECS PIC X(16) VALUE 'max-clean-time-secs'.
    05 MAX-COMPACTION-DELAY-SECS PIC X(20) VALUE 'max-compaction-delay-secs'.
    05 DEAD-THREAD-COUNT PIC X(16) VALUE 'DeadThreadCount'.

01 CONFIG-RECONFIGURABLE PIC X(30) VALUE 'log.cleaner.threads,log.cleaner.dedupe.buffer.size,log.cleaner.dedupe.buffer.load.factor,log.cleaner.io.buffer.size,message.max.bytes,log.cleaner.io.max.bytes.per.second,log.cleaner.backoff.ms'.

01 THREAD-POOL.
    05 THREAD-DETAILS OCCURS 0 TO 999 TIMES DEPENDING ON CLEANER-THREADS.
        10 THREAD-ID PIC 9(4).
        10 THREAD-STATS.
            15 START-TIME PIC 9(10) COMP-3.
            15 MAP-COMPLETE-TIME PIC 9(10) COMP-3.
            15 END-TIME PIC 9(10) COMP-3.
            15 BYTES-READ PIC 9(10) COMP-3.
            15 BYTES-WRITTEN PIC 9(10) COMP-3.
            15 MAP-BYTES-READ PIC 9(10) COMP-3.
            15 MAP-MESSAGES-READ PIC 9(10) COMP-3.
            15 MESSAGES-READ PIC 9(10) COMP-3.
            15 INVALID-MESSAGES-READ PIC 9(10) COMP-3.
            15 MESSAGES-WRITTEN PIC 9(10) COMP-3.
            15 BUFFER-UTILIZATION PIC 9V99 COMP-3.
        10 THREAD-FAILED PIC X VALUE 'N'.

01 CLEANER-MANAGER.
    05 PAUSED-PARTITIONS OCCURS 0 TO 999 TIMES DEPENDING ON CLEANER-THREADS.
        10 TOPIC-PARTITION PIC X(100).
    05 UNCLEANABLE-PARTITIONS OCCURS 0 TO 999 TIMES DEPENDING ON CLEANER-THREADS.
        10 TOPIC-PARTITION PIC X(100).
    05 CHECKPOINT-OFFSETS OCCURS 0 TO 999 TIMES DEPENDING ON CLEANER-THREADS.
        10 TOPIC-PARTITION PIC X(100).
        10 CHECKPOINT-OFFSET PIC 9(10) COMP-3.

01 THROTTLER.
    05 CURRENT-RATE PIC 9(10) COMP-3.
    05 CHECKPOINT-INTERVAL PIC 9(3) VALUE 300.
    05 UNIT PIC X(8) VALUE 'bytes'.

01 TRANSACTION-METADATA.
    05 ONGOING-COMMITTED-TXNS OCCURS 0 TO 999 TIMES DEPENDING ON CLEANER-THREADS.
        10 PRODUCER-ID PIC 9(10) COMP-3.
    05 ONGOING-ABORTED-TXNS OCCURS 0 TO 999 TIMES DEPENDING ON CLEANER-THREADS.
        10 PRODUCER-ID PIC 9(10) COMP-3.
        10 FIRST-OFFSET PIC 9(10) COMP-3.
        10 LAST-OBSERVED-OFFSET PIC 9(10) COMP-3.
    05 ABORTED-TXN-QUEUE OCCURS 0 TO 999 TIMES DEPENDING ON CLEANER-THREADS.
        10 PRODUCER-ID PIC 9(10) COMP-3.
        10 FIRST-OFFSET PIC 9(10) COMP-3.

01 LOG-TO-CLEAN.
    05 TOPIC-PARTITION PIC X(100).
    05 LOG-HANDLE PIC X(30).
    05 FIRST-DIRTY-OFFSET PIC 9(10) COMP-3.
    05 FIRST-UNCLEANABLE-OFFSET PIC 9(10) COMP-3.
    05 NEEDS-COMPACTION-NOW PIC X VALUE 'N'.
    05 CLEAN-BYTES PIC 9(10) COMP-3.
    05 CLEANABLE-BYTES PIC 9(10) COMP-3.
    05 TOTAL-BYTES PIC 9(10) COMP-3.
    05 CLEANABLE-RATIO PIC 9V99 COMP-3.

PROCEDURE DIVISION.
    PERFORM STARTUP.
    PERFORM SHUTDOWN.
    STOP RUN.

STARTUP.
    DISPLAY 'Starting the log cleaner'.
    PERFORM VARYING THREAD-ID FROM 1 BY 1 UNTIL THREAD-ID > CLEANER-THREADS
        PERFORM INITIALIZE-CLEANER-THREAD
    END-PERFORM.

INITIALIZE-CLEANER-THREAD.
    MOVE THREAD-ID TO THREAD-DETAILS(THREAD-ID).THREAD-ID.
    PERFORM INITIALIZE-OFFSET-MAP.
    PERFORM INITIALIZE-IO-BUFFERS.
    PERFORM INITIALIZE-THROTTLER.
    PERFORM INITIALIZE-TRANSACTION-METADATA.
    START THREAD THREAD-DETAILS(THREAD-ID).

SHUTDOWN.
    DISPLAY 'Shutting down the log cleaner'.
    PERFORM VARYING THREAD-ID FROM 1 BY 1 UNTIL THREAD-ID > CLEANER-THREADS
        PERFORM SHUTDOWN-CLEANER-THREAD
    END-PERFORM.
    PERFORM REMOVE-METRICS.

SHUTDOWN-CLEANER-THREAD.
    SET THREAD-DETAILS(THREAD-ID).THREAD-FAILED TO 'Y'.
    STOP THREAD THREAD-DETAILS(THREAD-ID).

REMOVE-METRICS.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > 5
        EVALUATE I
            WHEN 1 CALL 'REMOVE-METRIC' USING MAX-BUFFER-UTILIZATION-PERCENT
            WHEN 2 CALL 'REMOVE-METRIC' USING CLEANER-RECOPY-PERCENT
            WHEN 3 CALL 'REMOVE-METRIC' USING MAX-CLEAN-TIME-SECS
            WHEN 4 CALL 'REMOVE-METRIC' USING MAX-COMPACTION-DELAY-SECS
            WHEN 5 CALL 'REMOVE-METRIC' USING DEAD-THREAD-COUNT
        END-EVALUATE
    END-PERFORM.
    CALL 'REMOVE-CLEANER-MANAGER-METRICS'.

RECONFIGURE.
    MOVE CONFIG-PARAMS TO NEW-CONFIG-PARAMS.
    PERFORM VALIDATE-RECONFIGURATION USING NEW-CONFIG-PARAMS.
    IF RECONFIGURATION-VALID
        PERFORM SHUTDOWN-CLEANER-THREADS
        PERFORM STARTUP-CLEANER-THREADS USING NEW-CONFIG-PARAMS
    ELSE
        RAISE CONFIGURATION-EXCEPTION.

VALIDATE-RECONFIGURATION.
    IF NEW-CLEANER-THREADS < 1
        RAISE CONFIGURATION-EXCEPTION WITH TEXT 'Log cleaner threads should be at least 1'.
    IF NEW-CLEANER-THREADS < CLEANER-THREADS / 2
        RAISE CONFIGURATION-EXCEPTION WITH TEXT 'Log cleaner threads cannot be reduced to less than half the current value'.
    IF NEW-CLEANER-THREADS > CLEANER-THREADS * 2
        RAISE CONFIGURATION-EXCEPTION WITH TEXT 'Log cleaner threads cannot be increased to more than double the current value'.

STARTUP-CLEANER-THREADS.
    MOVE NEW-CLEANER-THREADS TO CLEANER-THREADS.
    PERFORM VARYING THREAD-ID FROM 1 BY 1 UNTIL THREAD-ID > CLEANER-THREADS
        PERFORM INITIALIZE-CLEANER-THREAD
    END-PERFORM.

INITIALIZE-OFFSET-MAP.
    CALL 'CREATE-OFFSET-MAP' USING THREAD-DETAILS(THREAD-ID).OFFSET-MAP.

INITIALIZE-IO-BUFFERS.
    ALLOCATE READBUFFER PIC X(IO-BUFFER-SIZE).
    ALLOCATE WRITEBUFFER PIC X(IO-BUFFER-SIZE).

INITIALIZE-THROTTLER.
    MOVE CLEANER-IO-MAX-BYTES TO THROTTLER.CURRENT-RATE.

INITIALIZE-TRANSACTION-METADATA.
    INITIALIZE TRANSACTION-METADATA.

CLEAN-LOG.
    PERFORM CLEAN-LOG-SEGMENTS.
    PERFORM DELETE-OLD-SEGMENTS.

CLEAN-LOG-SEGMENTS.
    PERFORM GET-NEXT-LOG-TO-CLEAN.
    IF LOG-TO-CLEAN NOT EQUAL SPACES
        PERFORM CHECK-IF-CLEANING-ABORTED
        PERFORM CLEAN-SEGMENTS
        PERFORM MARK-CLEANING-COMPLETE
    END-IF.

GET-NEXT-LOG-TO-CLEAN.
    CALL 'GET-FILTHIEST-COMPACTED-LOG' USING LOG-TO-CLEAN.

CHECK-IF-CLEANING-ABORTED.
    CALL 'CHECK-CLEANING-ABORTED' USING LOG-TO-CLEAN.TOPIC-PARTITION.

CLEAN-SEGMENTS.
    PERFORM VARYING SEGMENT-INDEX FROM 1 BY 1 UNTIL SEGMENT-INDEX > COUNT OF LOG-TO-CLEAN.LOG-SEGMENTS
        PERFORM CLEAN-SEGMENT USING LOG-TO-CLEAN.LOG-SEGMENTS(SEGMENT-INDEX)
    END-PERFORM.

CLEAN-SEGMENT.
    PERFORM BUILD-OFFSET-MAP USING LOG-TO-CLEAN.LOG-HANDLE, SEGMENT.
    PERFORM CLEAN-INTO-NEW-SEGMENT USING LOG-TO-CLEAN.LOG-HANDLE, SEGMENT.
    PERFORM REPLACE-SEGMENT.

BUILD-OFFSET-MAP.
    CALL 'BUILD-OFFSET-MAP' USING LOG-HANDLE, LOG-TO-CLEAN.FIRST-DIRTY-OFFSET, LOG-TO-CLEAN.FIRST-UNCLEANABLE-OFFSET, THREAD-DETAILS(THREAD-ID).OFFSET-MAP, THREAD-DETAILS(THREAD-ID).STATS.

CLEAN-INTO-NEW-SEGMENT.
    CALL 'CLEAN-INTO-NEW-SEGMENT' USING LOG-TO-CLEAN.TOPIC-PARTITION, LOG-HANDLE, NEW-SEGMENT, THREAD-DETAILS(THREAD-ID).OFFSET-MAP, CONFIG-PARAMS.RETAIN-DELETES-FOR-LEGACY, CONFIG-PARAMS.DELETE-RETENTION-MS, CONFIG-PARAMS.MESSAGE-MAX-BYTES, TRANSACTION-METADATA, THREAD-DETAILS(THREAD-ID).STATS, TIME().

REPLACE-SEGMENT.
    CALL 'REPLACE-SEGMENTS' USING LOG-TO-CLEAN.LOG-HANDLE, NEW-SEGMENT, LOG-TO-CLEAN.LOG-SEGMENTS(SEGMENT-INDEX).

DELETE-OLD-SEGMENTS.
    CALL 'DELETE-OLD-SEGMENTS' USING LOG-TO-CLEAN.LOG-HANDLE.

MARK-CLEANING-COMPLETE.
    CALL 'MARK-CLEANING-COMPLETE' USING LOG-TO-CLEAN.TOPIC-PARTITION, LOG-TO-CLEAN.LOG-HANDLE.

ABORT-CLEANING.
    CALL 'ABORT-CLEANING' USING LOG-TO-CLEAN.TOPIC-PARTITION.

UPDATE-CHECKPOINTS.
    CALL 'UPDATE-CHECKPOINTS' USING LOG-TO-CLEAN.LOG-HANDLE.PARENT-DIR, LOG-TO-CLEAN.TOPIC-PARTITION.

ALTER-CHECKPOINT-DIR.
    CALL 'ALTER-CHECKPOINT-DIR' USING LOG-TO-CLEAN.TOPIC-PARTITION, LOG-TO-CLEAN.LOG-HANDLE.PARENT-DIR, NEW-PARENT-DIR.

HANDLE-LOG-DIR-FAILURE.
    CALL 'HANDLE-LOG-DIR-FAILURE' USING LOG-TO-CLEAN.LOG-HANDLE.PARENT-DIR.

TRUNCATE-CHECKPOINT.
    CALL 'TRUNCATE-CHECKPOINT' USING LOG-TO-CLEAN.LOG-HANDLE.PARENT-DIR, LOG-TO-CLEAN.TOPIC-PARTITION, OFFSET.

ABORT-AND-PAUSE-CLEANING.
    CALL 'ABORT-AND-PAUSE-CLEANING' USING LOG-TO-CLEAN.TOPIC-PARTITION.

RESUME-CLEANING.
    CALL 'RESUME-CLEANING' USING PAUSED-PARTITIONS.

AWAIT-CLEANED.
    CALL 'AWAIT-CLEANED' USING LOG-TO-CLEAN.TOPIC-PARTITION, OFFSET, TIMEOUT RETURNING RESULT.

PAUSE-CLEANING-FOR-NON-COMPACTED.
    CALL 'PAUSE-CLEANING-FOR-NON-COMPACTED' RETURNING NON-COMPACTED-PARTITIONS.