IDENTIFICATION DIVISION.
PROGRAM-ID. UNIFIED-LOG.
AUTHOR. Apache Software Foundation.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY "KAFKA-UTILS.CPY".
    COPY "KAFKA-COMMON.CPY".
    COPY "KAFKA-SERVER.CPY".
    COPY "KAFKA-STORAGE.CPY".

DATA DIVISION.
01 LOCK PIC X(1) VALUE SPACE.
   88 LOCKED VALUE '1'.
   88 UNLOCKED VALUE '0'.
01 FIRST-UNSTABLE-OFFSET-METADATA PIC 9(18) COMP-3.
01 HIGH-WATERMARK-METADATA.
   03 MESSAGE-OFFSET PIC 9(18) COMP-3.
   03 MESSAGE-OFFSET-ONLY PIC X(1) VALUE 'Y' WHEN MESSAGE-OFFSET-ONLY, VALUE 'N' OTHERWISE.
01 METRICS-GROUP PIC X(30) VALUE 'Log'.
01 METRIC-NAMES PIC X(30) OCCURS 4 TIMES.
   03 METRIC-NAME PIC X(30).
   03 METRIC-TAGS PIC X(100).
01 PRODUCER-EXPIRE-CHECK PIC 9(18) COMP-3.
01 PARTITION-METADATA-FILE PIC X(100).
01 LOCAL-LOG-START-OFFSET PIC 9(18) COMP-3.
01 HIGHEST-OFFSET-IN-REMOTE-STORAGE PIC 9(18) COMP-3.
01 TOPIC-ID PIC X(36).
01 LOG-OFFSETS-LISTENER PIC X(30) VALUE 'NO-OP-OFFSETS-LISTENER'.

PROCEDURE DIVISION.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. INITIALIZE-PARTITION-METADATA.
    PROCEDURE DIVISION.
        PERFORM INITIALIZE-PARTITION-METADATA-SUBROUTINE.
    END PROGRAM INITIALIZE-PARTITION-METADATA.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. INITIALIZE-TOPIC-ID.
    PROCEDURE DIVISION.
        PERFORM INITIALIZE-TOPIC-ID-SUBROUTINE.
    END PROGRAM INITIALIZE-TOPIC-ID.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. UPDATE-HIGH-WATERMARK.
    PROCEDURE DIVISION USING NEW-HIGH-WATERMARK.
        PERFORM UPDATE-HIGH-WATERMARK-SUBROUTINE.
    END PROGRAM UPDATE-HIGH-WATERMARK.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. MAYBE-INCREMENT-HIGH-WATERMARK.
    PROCEDURE DIVISION USING NEW-HIGH-WATERMARK.
        PERFORM MAYBE-INCREMENT-HIGH-WATERMARK-SUBROUTINE.
    END PROGRAM MAYBE-INCREMENT-HIGH-WATERMARK.

    IDENTIFICATION DIVISION.  
    PROGRAM-ID. FETCH-LAST-STABLE-OFFSET-METADATA.
    PROCEDURE DIVISION.
        PERFORM FETCH-LAST-STABLE-OFFSET-METADATA-SUBROUTINE.
    END PROGRAM FETCH-LAST-STABLE-OFFSET-METADATA.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. NEW-METRICS.
    PROCEDURE DIVISION.
        PERFORM NEW-METRICS-SUBROUTINE.
    END PROGRAM NEW-METRICS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. REMOVE-EXPIRED-PRODUCERS.
    PROCEDURE DIVISION USING CURRENT-TIME-MS.
        PERFORM REMOVE-EXPIRED-PRODUCERS-SUBROUTINE.
    END PROGRAM REMOVE-EXPIRED-PRODUCERS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. LOAD-PRODUCER-STATE.
    PROCEDURE DIVISION USING LAST-OFFSET.
        PERFORM LOAD-PRODUCER-STATE-SUBROUTINE.
    END PROGRAM LOAD-PRODUCER-STATE.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. MAYBE-START-TRANSACTION-VERIFICATION.
    PROCEDURE DIVISION USING PRODUCER-ID, SEQUENCE, EPOCH, SUPPORTS-EPOCH-BUMP.
        PERFORM MAYBE-START-TRANSACTION-VERIFICATION-SUBROUTINE.
    END PROGRAM MAYBE-START-TRANSACTION-VERIFICATION.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. ANALYSIS-AND-VALIDATE-PRODUCER-STATE.
    PROCEDURE DIVISION USING APPEND-OFFSET-METADATA, RECORDS, ORIGIN, REQUEST-VERIFICATION-GUARD.
        PERFORM ANALYSIS-AND-VALIDATE-PRODUCER-STATE-SUBROUTINE.
    END PROGRAM ANALYSIS-AND-VALIDATE-PRODUCER-STATE.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. APPEND-AS-LEADER.
    PROCEDURE DIVISION USING RECORDS, LEADER-EPOCH, ORIGIN, REQUEST-LOCAL, VERIFICATION-GUARD.
        PERFORM APPEND-AS-LEADER-SUBROUTINE.
    END PROGRAM APPEND-AS-LEADER.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. APPEND-AS-FOLLOWER.
    PROCEDURE DIVISION USING RECORDS.
        PERFORM APPEND-AS-FOLLOWER-SUBROUTINE.
    END PROGRAM APPEND-AS-FOLLOWER.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. APPEND.
    PROCEDURE DIVISION USING RECORDS, ORIGIN, VALIDATE-AND-ASSIGN-OFFSETS, LEADER-EPOCH, REQUEST-LOCAL, VERIFICATION-GUARD, IGNORE-RECORD-SIZE, TO-MAGIC.
        PERFORM APPEND-SUBROUTINE.
    END PROGRAM APPEND.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. ASSIGN-EPOCH-START-OFFSET.
    PROCEDURE DIVISION USING LEADER-EPOCH, START-OFFSET.
        PERFORM ASSIGN-EPOCH-START-OFFSET-SUBROUTINE.
    END PROGRAM ASSIGN-EPOCH-START-OFFSET.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. LATEST-EPOCH.
    PROCEDURE DIVISION.
        PERFORM LATEST-EPOCH-SUBROUTINE.
    END PROGRAM LATEST-EPOCH.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. END-OFFSET-FOR-EPOCH.
    PROCEDURE DIVISION USING LEADER-EPOCH.
        PERFORM END-OFFSET-FOR-EPOCH-SUBROUTINE.
    END PROGRAM END-OFFSET-FOR-EPOCH.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. MAYBE-INCREMENT-LOCAL-LOG-START-OFFSET.
    PROCEDURE DIVISION USING NEW-LOCAL-LOG-START-OFFSET, REASON.
        PERFORM MAYBE-INCREMENT-LOCAL-LOG-START-OFFSET-SUBROUTINE.
    END PROGRAM MAYBE-INCREMENT-LOCAL-LOG-START-OFFSET.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. MAYBE-INCREMENT-LOG-START-OFFSET.
    PROCEDURE DIVISION USING NEW-LOG-START-OFFSET, REASON.
        PERFORM MAYBE-INCREMENT-LOG-START-OFFSET-SUBROUTINE.
    END PROGRAM MAYBE-INCREMENT-LOG-START-OFFSET.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. UPDATE-HIGHEST-OFFSET-IN-REMOTE-STORAGE.
    PROCEDURE DIVISION USING OFFSET.
        PERFORM UPDATE-HIGHEST-OFFSET-IN-REMOTE-STORAGE-SUBROUTINE.
    END PROGRAM UPDATE-HIGHEST-OFFSET-IN-REMOTE-STORAGE.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. RENAME-DIR.
    PROCEDURE DIVISION USING NAME, SHOULD-REINITIALIZE.
        PERFORM RENAME-DIR-SUBROUTINE.
    END PROGRAM RENAME-DIR.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. CLOSE-HANDLERS.
    PROCEDURE DIVISION.
        PERFORM CLOSE-HANDLERS-SUBROUTINE.
    END PROGRAM CLOSE-HANDLERS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. APPEND-AS-LEADER-WITH-RECORD-VERSION.
    PROCEDURE DIVISION USING RECORDS, LEADER-EPOCH, RECORD-VERSION.
        PERFORM APPEND-AS-LEADER-WITH-RECORD-VERSION-SUBROUTINE.
    END PROGRAM APPEND-AS-LEADER-WITH-RECORD-VERSION.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. READ.
    PROCEDURE DIVISION USING START-OFFSET, MAX-LENGTH, ISOLATION, MIN-ONE-MESSAGE.
        PERFORM READ-SUBROUTINE.
    END PROGRAM READ.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. COLLECT-ABORTED-TRANSACTIONS.
    PROCEDURE DIVISION USING START-OFFSET, UPPER-BOUND-OFFSET.
        PERFORM COLLECT-ABORTED-TRANSACTIONS-SUBROUTINE.
    END PROGRAM COLLECT-ABORTED-TRANSACTIONS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. FETCH-OFFSET-BY-TIMESTAMP.
    PROCEDURE DIVISION USING TARGET-TIMESTAMP, REMOTE-OFFSET-READER.
        PERFORM FETCH-OFFSET-BY-TIMESTAMP-SUBROUTINE.
    END PROGRAM FETCH-OFFSET-BY-TIMESTAMP.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. DELETE-OLD-SEGMENTS.
    PROCEDURE DIVISION.
        PERFORM DELETE-OLD-SEGMENTS-SUBROUTINE.
    END PROGRAM DELETE-OLD-SEGMENTS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. DELETABLE-SEGMENTS.
    PROCEDURE DIVISION USING PREDICATE.
        PERFORM DELETABLE-SEGMENTS-SUBROUTINE.
    END PROGRAM DELETABLE-SEGMENTS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. DELETE-SEGMENTS.
    PROCEDURE DIVISION USING DELETABLE, REASON.
        PERFORM DELETE-SEGMENTS-SUBROUTINE.
    END PROGRAM DELETE-SEGMENTS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. DELETE-LOG-START-OFFSET-BREACHED-SEGMENTS.
    PROCEDURE DIVISION.
        PERFORM DELETE-LOG-START-OFFSET-BREACHED-SEGMENTS-SUBROUTINE.
    END PROGRAM DELETE-LOG-START-OFFSET-BREACHED-SEGMENTS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. DELETE-RETENTION-SIZE-BREACHED-SEGMENTS.
    PROCEDURE DIVISION.
        PERFORM DELETE-RETENTION-SIZE-BREACHED-SEGMENTS-SUBROUTINE.
    END PROGRAM DELETE-RETENTION-SIZE-BREACHED-SEGMENTS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. DELETE-RETENTION-MS-BREACHED-SEGMENTS.
    PROCEDURE DIVISION.
        PERFORM DELETE-RETENTION-MS-BREACHED-SEGMENTS-SUBROUTINE.
    END PROGRAM DELETE-RETENTION-MS-BREACHED-SEGMENTS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. MAYBE-ROLL.
    PROCEDURE DIVISION USING MESSAGES-SIZE, APPEND-INFO.
        PERFORM MAYBE-ROLL-SUBROUTINE.
    END PROGRAM MAYBE-ROLL.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. ROLL.
    PROCEDURE DIVISION USING EXPECTED-NEXT-OFFSET.
        PERFORM ROLL-SUBROUTINE.
    END PROGRAM ROLL.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. FLUSH.
    PROCEDURE DIVISION USING FORCE-FLUSH-ACTIVE-SEGMENT.
        PERFORM FLUSH-SUBROUTINE.
    END PROGRAM FLUSH.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. FLUSH-UPTOOFFSET-EXCLUSIVE.
    PROCEDURE DIVISION USING OFFSET, INCLUDING-OFFSET.
        PERFORM FLUSH-UPTOOFFSET-EXCLUSIVE-SUBROUTINE.
    END PROGRAM FLUSH-UPTOOFFSET-EXCLUSIVE.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. DELETE.
    PROCEDURE DIVISION.
        PERFORM DELETE-SUBROUTINE.
    END PROGRAM DELETE.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. TAKE-PRODUCER-SNAPSHOT.
    PROCEDURE DIVISION.
        PERFORM TAKE-PRODUCER-SNAPSHOT-SUBROUTINE.
    END PROGRAM TAKE-PRODUCER-SNAPSHOT.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. LATEST-PRODUCER-SNAPSHOT-OFFSET.
    PROCEDURE DIVISION.
        PERFORM LATEST-PRODUCER-SNAPSHOT-OFFSET-SUBROUTINE.
    END PROGRAM LATEST-PRODUCER-SNAPSHOT-OFFSET.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. OLDEST-PRODUCER-SNAPSHOT-OFFSET.
    PROCEDURE DIVISION.
        PERFORM OLDEST-PRODUCER-SNAPSHOT-OFFSET-SUBROUTINE.
    END PROGRAM OLDEST-PRODUCER-SNAPSHOT-OFFSET.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. LATEST-PRODUCER-STATE-END-OFFSET.
    PROCEDURE DIVISION.
        PERFORM LATEST-PRODUCER-STATE-END-OFFSET-SUBROUTINE.
    END PROGRAM LATEST-PRODUCER-STATE-END-OFFSET.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. FLUSH-PRODUCER-STATE-SNAPSHOT.
    PROCEDURE DIVISION USING SNAPSHOT.
        PERFORM FLUSH-PRODUCER-STATE-SNAPSHOT-SUBROUTINE.
    END PROGRAM FLUSH-PRODUCER-STATE-SNAPSHOT.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. TRUNCATE-TO.
    PROCEDURE DIVISION USING TARGET-OFFSET.
        PERFORM TRUNCATE-TO-SUBROUTINE.
    END PROGRAM TRUNCATE-TO.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. TRUNCATE-FULLY-AND-START-AT.
    PROCEDURE DIVISION USING NEW-OFFSET, LOG-START-OFFSET-OPT.
        PERFORM TRUNCATE-FULLY-AND-START-AT-SUBROUTINE.
    END PROGRAM TRUNCATE-FULLY-AND-START-AT.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. REMOVE-LOG-METRICS.
    PROCEDURE DIVISION.
        PERFORM REMOVE-LOG-METRICS-SUBROUTINE.
    END PROGRAM REMOVE-LOG-METRICS.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. ADD-SEGMENT.
    PROCEDURE DIVISION USING SEGMENT.
        PERFORM ADD-SEGMENT-SUBROUTINE.
    END PROGRAM ADD-SEGMENT.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. SPLIT-OVERFLOWED-SEGMENT.
    PROCEDURE DIVISION USING SEGMENT.
        PERFORM SPLIT-OVERFLOWED-SEGMENT-SUBROUTINE.
    END PROGRAM SPLIT-OVERFLOWED-SEGMENT.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. DELETE-PRODUCER-SNAPSHOTS.
    PROCEDURE DIVISION USING SEGMENTS, ASYNC-DELETE.
        PERFORM DELETE-PRODUCER-SNAPSHOTS-SUBROUTINE.
    END PROGRAM DELETE-PRODUCER-SNAPSHOTS.

    STOP RUN.

CONTAINS.

    INITIALIZE-PARTITION-METADATA-SUBROUTINE.
        PERFORM RECORD-PARTITION-METADATA-FILE.
    END INITIALIZE-PARTITION-METADATA-SUBROUTINE.

    INITIALIZE-TOPIC-ID-SUBROUTINE.
        PERFORM RECOVER-TOPIC-ID.
        PERFORM RECORD-TOPIC-ID.
    END INITIALIZE-TOPIC-ID-SUBROUTINE.

    UPDATE-HIGH-WATERMARK-SUBROUTINE.
        PERFORM COMPUTE-NEW-HIGH-WATERMARK.
        PERFORM UPDATE-HIGH-WATERMARK-METADATA.
    END UPDATE-HIGH-WATERMARK-SUBROUTINE.

    MAYBE-INCREMENT-HIGH-WATERMARK-SUBROUTINE.
        PERFORM CHECK-HIGH-WATERMARK-INCREASE.
        PERFORM UPDATE-HIGH-WATERMARK-METADATA.
    END MAYBE-INCREMENT-HIGH-WATERMARK-SUBROUTINE.

    FETCH-LAST-STABLE-OFFSET-METADATA-SUBROUTINE.
        PERFORM FETCH-FIRST