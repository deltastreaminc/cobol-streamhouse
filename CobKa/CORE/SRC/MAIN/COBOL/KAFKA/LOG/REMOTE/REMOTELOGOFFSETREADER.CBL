IDENTIFICATION DIVISION.
PROGRAM-ID. REMOTE-LOG-OFFSET-READER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC FUNCTIONS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 REMOTE-LOG-MANAGER PIC X(30).
01 TOPIC-PARTITION PIC X(30).
01 TIMESTAMP PIC S9(18) BINARY.
01 STARTING-OFFSET PIC S9(18) BINARY.
01 LEADER-EPOCH-CACHE PIC X(30).
01 SEARCH-IN-LOCAL-LOG PIC X(30).
01 CALLBACK PIC X(30).
01 RESULT PIC X(30).
01 TIMESTAMP-AND-OFFSET-OPT PIC X(30).
01 EXCEPTION-VAR PIC X(30).

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    MOVE FUNCTION CONCATENATE('RemoteLogManager ', REMOTE-LOG-MANAGER) TO REMOTE-LOG-MANAGER
    MOVE FUNCTION CONCATENATE('TopicPartition ', TOPIC-PARTITION) TO TOPIC-PARTITION
    MOVE TIMESTAMP TO TIMESTAMP
    MOVE STARTING-OFFSET TO STARTING-OFFSET
    MOVE FUNCTION CONCATENATE('LeaderEpochFileCache ', LEADER-EPOCH-CACHE) TO LEADER-EPOCH-CACHE
    MOVE FUNCTION CONCATENATE('Supplier<Optional<FileRecords.TimestampAndOffset>> ', SEARCH-IN-LOCAL-LOG) TO SEARCH-IN-LOCAL-LOG
    MOVE FUNCTION CONCATENATE('Consumer<OffsetResultHolder.FileRecordsOrError> ', CALLBACK) TO CALLBACK

    PERFORM FIND-OFFSET-BY-TIMESTAMP
    PERFORM HANDLE-EXCEPTIONS
    PERFORM CALL-CALLBACK

    STOP RUN.

FIND-OFFSET-BY-TIMESTAMP.
    MOVE FUNCTION CONCATENATE('OffsetResultHolder.FileRecordsOrError ', RESULT) TO RESULT
    MOVE FUNCTION CONCATENATE('Optional<FileRecords.TimestampAndOffset> ', TIMESTAMP-AND-OFFSET-OPT) TO TIMESTAMP-AND-OFFSET-OPT
    CALL FUNCTION 'rlm.findOffsetByTimestamp' USING TOPIC-PARTITION, TIMESTAMP, STARTING-OFFSET, LEADER-EPOCH-CACHE
        RETURNING TIMESTAMP-AND-OFFSET-OPT
    CALL FUNCTION 'searchInLocalLog'
        RETURNING TIMESTAMP-AND-OFFSET-OPT
    MOVE NEW OffsetResultHolder.FileRecordsOrError(OPTIONAL EMPTY, TIMESTAMP-AND-OFFSET-OPT) TO RESULT

HANDLE-EXCEPTIONS.
    MOVE FUNCTION CONCATENATE('Exception ', EXCEPTION-VAR) TO EXCEPTION-VAR
    PERFORM VARYING RETRY-COUNT FROM 1 BY 1 UNTIL RETRY-COUNT > 1
        MOVE NEW OffsetResultHolder.FileRecordsOrError(OPTIONAL EXCEPTION-VAR, OPTIONAL EMPTY) TO RESULT
        MOVE 'Error occurred while reading the remote log offset for ' TO DISPLAY-MESSAGE
        MOVE TOPIC-PARTITION TO DISPLAY-MESSAGE
        DISPLAY DISPLAY-MESSAGE EXCEPTION-VAR
    END-PERFORM

CALL-CALLBACK.
    CALL FUNCTION 'callback' USING RESULT