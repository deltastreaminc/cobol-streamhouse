IDENTIFICATION DIVISION.
PROGRAM-ID. REMOTELOGREADER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC FUNCTIONS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-FETCHINFO USAGE OBJECT REFERENCE.
01 WS-RLM USAGE OBJECT REFERENCE.
01 WS-BROKERTOPICSTATS USAGE OBJECT REFERENCE.
01 WS-CALLBACK USAGE POINTER.
01 WS-QUOTAMANAGER USAGE OBJECT REFERENCE.
01 WS-REMOTEREADTIMER USAGE OBJECT REFERENCE.
01 WS-LOGGER USAGE OBJECT REFERENCE.
01 WS-REMOTELOGREADRESULT USAGE OBJECT REFERENCE.
01 WS-FETCHDATAINFO USAGE OBJECT REFERENCE.
01 WS-OFFSETOUTOFRANGEEXCEPTION USAGE OBJECT REFERENCE.
01 WS-EXCEPTION USAGE OBJECT REFERENCE.
01 WS-TOPICPARTITION PIC X(50).
01 WS-TOPICNAME PIC X(50).
01 WS-RECORDSSIZEINBYTES PIC 9(18) COMP-3.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    MOVE FUNCTION LOGGER-NEW(LITERAL "kafka.log.remote.RemoteLogReader") TO WS-LOGGER.

    PERFORM INITIALIZE-INSTANCE.

    PERFORM CALL-REMOTEREAD.

    GOBACK.

INITIALIZE-INSTANCE.
    MOVE FETCHINFO TO WS-FETCHINFO.
    MOVE RLM TO WS-RLM.
    MOVE BROKERTOPICSTATS TO WS-BROKERTOPICSTATS.
    MOVE CALLBACK TO WS-CALLBACK.
    MOVE QUOTAMANAGER TO WS-QUOTAMANAGER.
    MOVE REMOTEREADTIMER TO WS-REMOTEREADTIMER.

    MOVE FETCHINFO-TOPICPARTITION-TOPIC TO WS-TOPICNAME.
    PERFORM BROKERTOPICSTATS-TOPICSTATS.
    PERFORM BROKERTOPICSTATS-ALLTOPICSSTATS.

CALL-REMOTEREAD.
    PERFORM LOGGER-DEBUG USING "Reading records from remote storage for topic partition {}"
        USING WS-TOPICPARTITION.

    MOVE FUNCTION REMOTEREADTIMER-TIME(WS-RLM REMOTEREAD WS-FETCHINFO) TO WS-FETCHDATAINFO.

    PERFORM BROKERTOPICSTATS-REMOTEFETCHBYTESRATE
        USING WS-TOPICNAME
        USING WS-FETCHDATAINFO-RECORDS-SIZEINBYTES.
    PERFORM BROKERTOPICSTATS-ALLTOPICSSTATS-REMOTEFETCHBYTESRATE
        USING WS-FETCHDATAINFO-RECORDS-SIZEINBYTES.

    MOVE REMOTELOGREADRESULT NEW(WS-FETCHDATAINFO WS-OFFSETOUTOFRANGEEXCEPTION) TO WS-REMOTELOGREADRESULT.

    PERFORM LOGGER-DEBUG USING "Finished reading records from remote storage for topic partition {}"
        USING WS-TOPICPARTITION.

    PERFORM QUOTAMANAGER-RECORD
        USING WS-REMOTELOGREADRESULT-FETCHDATAINFO-RECORDS-SIZEINBYTES.

    PERFORM CALLBACK-ACCEPT USING WS-REMOTELOGREADRESULT.

    GOBACK.

BROKERTOPICSTATS-TOPICSTATS.
    CALL "BrokerTopicStats" "topicStats" USING WS-TOPICNAME
        RETURNING WS-BROKERTOPICSTATS.
    CALL "BrokerTopicStats" "remoteFetchRequestRate" USING WS-BROKERTOPICSTATS
        PERFORM RATE-MARK.

BROKERTOPICSTATS-ALLTOPICSSTATS.
    CALL "BrokerTopicStats" "allTopicsStats"
        RETURNING WS-BROKERTOPICSTATS.
    CALL "BrokerTopicStats" "remoteFetchRequestRate" USING WS-BROKERTOPICSTATS
        PERFORM RATE-MARK.

BROKERTOPICSTATS-REMOTEFETCHBYTESRATE.
    CALL "BrokerTopicStats" "remoteFetchBytesRate" USING WS-BROKERTOPICSTATS WS-RECORDSSIZEINBYTES
        PERFORM RATE-MARK.

BROKERTOPICSTATS-ALLTOPICSSTATS-REMOTEFETCHBYTESRATE.
    CALL "BrokerTopicStats" "remoteFetchBytesRate" USING WS-BROKERTOPICSTATS WS-RECORDSSIZEINBYTES
        PERFORM RATE-MARK.

BROKERTOPICSTATS-FAILEDREMOTEATCHREQUESTRATE.
    CALL "BrokerTopicStats" "failedRemoteFetchRequestRate" USING WS-BROKERTOPICSTATS
        PERFORM RATE-MARK.

BROKERTOPICSTATS-ALLTOPICSSTATS-FAILEDREMOTEATCHREQUESTRATE.
    CALL "BrokerTopicStats" "failedRemoteFetchRequestRate" USING WS-BROKERTOPICSTATS
        PERFORM RATE-MARK.

RATE-MARK.
    CALL "Rate" "mark" USING FUNCTION POINTER-OF(RETURN-ITEM).

QUOTAMANAGER-RECORD.
    CALL "RLMQuotaManager" "record" USING WS-QUOTAMANAGER WS-RECORDSSIZEINBYTES.

CALLBACK-ACCEPT.
    CALL USING POINTER WS-CALLBACK USING WS-REMOTELOGREADRESULT.