IDENTIFICATION DIVISION.
PROGRAM-ID. PARTITION.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SPECIAL-NAMES.
    CURRENT-DATE IS CURRENT-DATE.

DATA DIVISION.
WORKING-STORAGE SECTION.
01  WS-TOPIC-ID            PIC X(36) VALUE SPACES.
01  WS-TOPIC-PARTITION     PIC X(50) VALUE SPACES.
01  WS-REPLICA-LAG-TIME-MAX-MS PIC 9(18) VALUE ZERO.
01  WS-LOCAL-BROKER-ID     PIC 9(10) VALUE ZERO.
01  WS-LOCAL-BROKER-EPOCH   PIC 9(18) VALUE ZERO.
01  WS-TIME                 PIC 9(18) VALUE ZERO.
01  WS-ALTER-PARTITION-LISTENER.
    05  WS-MARK-ISR-EXPAND   PIC X(1) VALUE 'N'.
    05  WS-MARK-ISR-SHRINK   PIC X(1) VALUE 'N'.
    05  WS-MARK-FAILED       PIC X(1) VALUE 'N'.
01  WS-DELAYED-OPERATIONS.
    05  WS-TOPIC-ID          PIC X(36) VALUE SPACES.
    05  WS-TOPIC-PARTITION   PIC X(50) VALUE SPACES.
    05  WS-PRODUCE-PURGATORY PIC 9(10) VALUE ZERO.
    05  WS-FETCH-PURGATORY   PIC 9(10) VALUE ZERO.
    05  WS-DELETE-RECORDS-PURGATORY PIC 9(10) VALUE ZERO.
    05  WS-SHARE-FETCH-PURGATORY PIC 9(10) VALUE ZERO.
01  WS-PARTITION-STATE.
    05  WS-ISR              PIC 9(10) OCCURS 10 TIMES.
    05  WS-LEADER-RECOVERY-STATE PIC 9(1) VALUE ZERO.
    05  WS-IS-INFLIGHT      PIC X(1) VALUE 'N'.
01  WS-ASSIGNMENT-STATE.
    05  WS-REPLICAS         PIC 9(10) OCCURS 10 TIMES.
    05  WS-ADDING-REPLICAS  PIC 9(10) OCCURS 10 TIMES.
    05  WS-REMOVING-REPLICAS PIC 9(10) OCCURS 10 TIMES.
01  WS-LOG.
    05  WS-LOG-INSTANCE     PIC 9(10) VALUE ZERO.
    05  WS-FUTURE-LOG-INSTANCE PIC 9(10) VALUE ZERO.
01  WS-LISTENERS           PIC 9(10) VALUE ZERO.
01  WS-LOG-OFFSETS-LISTENER.
    05  WS-CALLBACK-ONHIGHWATERMARK-UPDATED PIC X(1) VALUE 'N'.
    05  WS-CALLBACK-ONFAILED PIC X(1) VALUE 'N'.
    05  WS-CALLBACK-ONDELETED PIC X(1) VALUE 'N'.
    05  WS-CALLBACK-ONBECOMINGFOLLOWER PIC X(1) VALUE 'N'.
01  WS-LEADER-EPOCH        PIC 9(10) VALUE ZERO.
01  WS-LEADER-EPOCH-START-OFFSET PIC 9(18) VALUE ZERO.
01  WS-LEADER-REPLICA-ID   PIC 9(10) VALUE ZERO.
01  WS-PARTITION-EPOCH     PIC 9(10) VALUE ZERO.
01  WS-REMOTE-REPLICAS-MAP.
    05  WS-REPLICA-ID       PIC 9(10) OCCURS 10 TIMES.
    05  WS-REPLICA-INSTANCE PIC 9(10) OCCURS 10 TIMES.

PROCEDURE DIVISION.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. PARTITION.

    ENVIRONMENT DIVISION.
    CONFIGURATION SECTION.
    SPECIAL-NAMES.
        CURRENT-DATE IS CURRENT-DATE.

    DATA DIVISION.
    WORKING-STORAGE SECTION.
    01  WS-TOPIC-ID            PIC X(36) VALUE SPACES.
    01  WS-TOPIC-PARTITION     PIC X(50) VALUE SPACES.
    01  WS-REPLICA-LAG-TIME-MAX-MS PIC 9(18) VALUE ZERO.
    01  WS-LOCAL-BROKER-ID     PIC 9(10) VALUE ZERO.
    01  WS-LOCAL-BROKER-EPOCH   PIC 9(18) VALUE ZERO.
    01  WS-TIME                 PIC 9(18) VALUE ZERO.
    01  WS-ALTER-PARTITION-LISTENER.
        05  WS-MARK-ISR-EXPAND   PIC X(1) VALUE 'N'.
        05  WS-MARK-ISR-SHRINK   PIC X(1) VALUE 'N'.
        05  WS-MARK-FAILED       PIC X(1) VALUE 'N'.
    01  WS-DELAYED-OPERATIONS.
        05  WS-TOPIC-ID          PIC X(36) VALUE SPACES.
        05  WS-TOPIC-PARTITION   PIC X(50) VALUE SPACES.
        05  WS-PRODUCE-PURGATORY PIC 9(10) VALUE ZERO.
        05  WS-FETCH-PURGATORY   PIC 9(10) VALUE ZERO.
        05  WS-DELETE-RECORDS-PURGATORY PIC 9(10) VALUE ZERO.
        05  WS-SHARE-FETCH-PURGATORY PIC 9(10) VALUE ZERO.
    01  WS-PARTITION-STATE.
        05  WS-ISR              PIC 9(10) OCCURS 10 TIMES.
        05  WS-LEADER-RECOVERY-STATE PIC 9(1) VALUE ZERO.
        05  WS-IS-INFLIGHT      PIC X(1) VALUE 'N'.
    01  WS-ASSIGNMENT-STATE.
        05  WS-REPLICAS         PIC 9(10) OCCURS 10 TIMES.
        05  WS-ADDING-REPLICAS  PIC 9(10) OCCURS 10 TIMES.
        05  WS-REMOVING-REPLICAS PIC 9(10) OCCURS 10 TIMES.
    01  WS-LOG.
        05  WS-LOG-INSTANCE     PIC 9(10) VALUE ZERO.
        05  WS-FUTURE-LOG-INSTANCE PIC 9(10) VALUE ZERO.
    01  WS-LISTENERS           PIC 9(10) VALUE ZERO.
    01  WS-LOG-OFFSETS-LISTENER.
        05  WS-CALLBACK-ONHIGHWATERMARK-UPDATED PIC X(1) VALUE 'N'.
        05  WS-CALLBACK-ONFAILED PIC X(1) VALUE 'N'.
        05  WS-CALLBACK-ONDELETED PIC X(1) VALUE 'N'.
        05  WS-CALLBACK-ONBECOMINGFOLLOWER PIC X(1) VALUE 'N'.
    01  WS-LEADER-EPOCH        PIC 9(10) VALUE ZERO.
    01  WS-LEADER-EPOCH-START-OFFSET PIC 9(18) VALUE ZERO.
    01  WS-LEADER-REPLICA-ID   PIC 9(10) VALUE ZERO.
    01  WS-PARTITION-EPOCH     PIC 9(10) VALUE ZERO.
    01  WS-REMOTE-REPLICAS-MAP.
        05  WS-REPLICA-ID       PIC 9(10) OCCURS 10 TIMES.
        05  WS-REPLICA-INSTANCE PIC 9(10) OCCURS 10 TIMES.

    PROCEDURE DIVISION.
        PERFORM PARTITION-CONSTRUCTOR.
        PERFORM PARTITION-METHODS.

    PARTITION-CONSTRUCTOR.
        MOVE FUNCTION CURRENT-DATE TO WS-TIME.
        MOVE 0 TO WS-REPLICA-LAG-TIME-MAX-MS.
        MOVE 0 TO WS-LOCAL-BROKER-ID.
        MOVE 0 TO WS-LOCAL-BROKER-EPOCH.
        MOVE SPACES TO WS-TOPIC-ID.
        MOVE SPACES TO WS-TOPIC-PARTITION.
        MOVE ZERO TO WS-LISTENERS.
        MOVE ZERO TO WS-PRODUCE-PURGATORY.
        MOVE ZERO TO WS-FETCH-PURGATORY.
        MOVE ZERO TO WS-DELETE-RECORDS-PURGATORY.
        MOVE ZERO TO WS-SHARE-FETCH-PURGATORY.
        MOVE ZERO TO WS-LEADER-EPOCH.
        MOVE ZERO TO WS-LEADER-EPOCH-START-OFFSET.
        MOVE ZERO TO WS-LEADER-REPLICA-ID.
        MOVE ZERO TO WS-PARTITION-EPOCH.
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > 10
            MOVE ZERO TO WS-REPLICA-ID(I)
            MOVE ZERO TO WS-REPLICA-INSTANCE(I)
        END-PERFORM.

    PARTITION-METHODS.
        PERFORM PARTITION-LISTENER-METHODS.
        PERFORM PARTITION-STATE-METHODS.
        PERFORM PARTITION-ASSIGNMENT-METHODS.
        PERFORM PARTITION-LOG-METHODS.
        PERFORM PARTITION-REMOTE-REPLICAS-METHODS.
        PERFORM PARTITION-LEADERSHIP-METHODS.
        PERFORM PARTITION-FETCH-METHODS.
        PERFORM PARTITION-DELETE-RECORDS-METHODS.
        PERFORM PARTITION-TRUNCATE-METHODS.
        PERFORM PARTITION-ALTER-PARTITION-METHODS.

    PARTITION-LISTENER-METHODS.
        PERFORM PARTITION-ADD-LISTENER.
        PERFORM PARTITION-REMOVE-LISTENER.
        PERFORM PARTITION-INVOKE-ON-BECOMING-FOLLOWER-LISTENERS.

    PARTITION-STATE-METHODS.
        PERFORM PARTITION-CLEAR.
        PERFORM PARTITION-MARK-OFFLINE.

    PARTITION-ASSIGNMENT-METHODS.
        PERFORM PARTITION-UPDATE-ASSIGNMENT-AND-ISR.

    PARTITION-LOG-METHODS.
        PERFORM PARTITION-CREATE-LOG-IF-NOT-EXISTS.
        PERFORM PARTITION-REPLACE-CURRENT-WITH-FUTURE-LOG.
        PERFORM PARTITION-APPEND-RECORDS-TO-FOLLOWER-OR-FUTURE-REPLICA.
        PERFORM PARTITION-APPEND-RECORDS-TO-LEADER.

    PARTITION-REMOTE-REPLICAS-METHODS.
        PERFORM PARTITION-GET-REPLICA.

    PARTITION-LEADERSHIP-METHODS.
        PERFORM PARTITION-MAKE-LEADER.
        PERFORM PARTITION-MAKE-FOLLOWER.

    PARTITION-FETCH-METHODS.
        PERFORM PARTITION-FETCH-RECORDS.
        PERFORM PARTITION-FETCH-OFFSET-FOR-TIMESTAMP.
        PERFORM PARTITION-FETCH-OFFSET-SNAPSHOT.

    PARTITION-DELETE-RECORDS-METHODS.
        PERFORM PARTITION-DELETE-RECORDS-ON-LEADER.

    PARTITION-TRUNCATE-METHODS.
        PERFORM PARTITION-TRUNCATE-TO.
        PERFORM PARTITION-TRUNCATE-FULLY-AND-START-AT.

    PARTITION-ALTER-PARTITION-METHODS.
        PERFORM PARTITION-PREPARE-ISR-EXPAND.
        PERFORM PARTITION-PREPARE-ISR-SHRINK.
        PERFORM PARTITION-SUBMIT-ALTER-PARTITION.
        PERFORM PARTITION-HANDLE-ALTER-PARTITION-ERROR.
        PERFORM PARTITION-HANDLE-ALTER-PARTITION-UPDATE.

    PARTITION-ADD-LISTENER.
        MOVE 0 TO WS-LISTENERS.
        ADD 1 TO WS-LISTENERS.

    PARTITION-REMOVE-LISTENER.
        SUBTRACT 1 FROM WS-LISTENERS.

    PARTITION-INVOKE-ON-BECOMING-FOLLOWER-LISTENERS.
        SET WS-CALLBACK-ONBECOMINGFOLLOWER TO 'Y'.

    PARTITION-CLEAR.
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > 10
            MOVE ZERO TO WS-REPLICA-ID(I)
            MOVE ZERO TO WS-REPLICA-INSTANCE(I)
        END-PERFORM.
        MOVE ZERO TO WS-REPLICAS.
        MOVE ZERO TO WS-ADDING-REPLICAS.
        MOVE ZERO TO WS-REMOVING-REPLICAS.
        MOVE ZERO TO WS-LOG-INSTANCE.
        MOVE ZERO TO WS-FUTURE-LOG-INSTANCE.
        MOVE ZERO TO WS-ISR.
        MOVE ZERO TO WS-LEADER-RECOVERY-STATE.
        MOVE 'N' TO WS-IS-INFLIGHT.
        MOVE ZERO TO WS-LEADER-REPLICA-ID.
        MOVE ZERO TO WS-LEADER-EPOCH-START-OFFSET.

    PARTITION-MARK-OFFLINE.
        PERFORM PARTITION-CLEAR.
        SET WS-CALLBACK-ONFAILED TO 'Y'.

    PARTITION-UPDATE-ASSIGNMENT-AND-ISR.
        MOVE 0 TO WS-REPLICAS.
        MOVE 0 TO WS-ADDING-REPLICAS.
        MOVE 0 TO WS-REMOVING-REPLICAS.
        MOVE 0 TO WS-ISR.
        MOVE 0 TO WS-LEADER-RECOVERY-STATE.
        MOVE 'N' TO WS-IS-INFLIGHT.

    PARTITION-CREATE-LOG-IF-NOT-EXISTS.
        MOVE 0 TO WS-LOG-INSTANCE.
        MOVE 0 TO WS-FUTURE-LOG-INSTANCE.

    PARTITION-REPLACE-CURRENT-WITH-FUTURE-LOG.
        MOVE WS-FUTURE-LOG-INSTANCE TO WS-LOG-INSTANCE.
        MOVE 0 TO WS-FUTURE-LOG-INSTANCE.

    PARTITION-APPEND-RECORDS-TO-FOLLOWER-OR-FUTURE-REPLICA.
        MOVE 0 TO WS-LOG-APPEND-INFO.

    PARTITION-APPEND-RECORDS-TO-LEADER.
        MOVE 0 TO WS-LOG-APPEND-INFO.

    PARTITION-GET-REPLICA.
        MOVE 0 TO WS-REPLICA-INSTANCE.

    PARTITION-MAKE-LEADER.
        MOVE 0 TO WS-LEADER-EPOCH.
        MOVE 0 TO WS-LEADER-EPOCH-START-OFFSET.
        MOVE 0 TO WS-LEADER-REPLICA-ID.
        MOVE 0 TO WS-PARTITION-EPOCH.

    PARTITION-MAKE-FOLLOWER.
        MOVE 0 TO WS-LEADER-EPOCH.
        MOVE 0 TO WS-LEADER-EPOCH-START-OFFSET.
        MOVE 0 TO WS-LEADER-REPLICA-ID.
        MOVE 0 TO WS-PARTITION-EPOCH.

    PARTITION-FETCH-RECORDS.
        MOVE 0 TO WS-LOG-READ-INFO.

    PARTITION-FETCH-OFFSET-FOR-TIMESTAMP.
        MOVE 0 TO WS-OFFSET-RESULT-HOLDER.

    PARTITION-FETCH-OFFSET-SNAPSHOT.
        MOVE 0 TO WS-LOG-OFFSET-SNAPSHOT.

    PARTITION-DELETE-RECORDS-ON-LEADER.
        MOVE 0 TO WS-LOG-DELETE-RECORDS-RESULT.

    PARTITION-TRUNCATE-TO.
        CONTINUE.

    PARTITION-TRUNCATE-