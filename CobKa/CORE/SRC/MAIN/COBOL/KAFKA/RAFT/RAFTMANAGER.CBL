IDENTIFICATION DIVISION.
PROGRAM-ID. KAFKA-RAFT-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SPECIAL-NAMES.
    CLASS JAVA-FILE IS FILE.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-CLUSTER-ID PIC X(10).
01 WS-CONFIG PIC X(10).
01 WS-METADATA-LOG-DIR-UUID PIC X(36).
01 WS-RECORD-SERDE PIC X(10).
01 WS-TOPIC-PARTITION.
    05 WS-TOPIC PIC X(100).
    05 WS-PARTITION PIC 9(9).
01 WS-TOPIC-ID PIC X(36).
01 WS-TIME PIC X(10).
01 WS-METRICS PIC X(10).
01 WS-EXTERNAL-KRAFT-METRICS PIC X(10).
01 WS-THREAD-NAME-PREFIX PIC X(20).
01 WS-CONTROLLER-QUORUM-VOTERS-FUTURE PIC X(10).
01 WS-BOOTSTRAP-SERVERS PIC X(10).
01 WS-LOCAL-LISTENERS PIC X(10).
01 WS-FATAL-FAULT-HANDLER PIC X(10).
01 WS-API-VERSIONS PIC X(10).
01 WS-RAFT-CONFIG PIC X(10).
01 WS-THREAD-NAME-PREFIX PIC X(20).
01 WS-LOG-CONTEXT PIC X(20).
01 WS-SCHEDULER PIC X(10).
01 WS-DATA-DIR PIC X(100).
01 WS-DATA-DIR-LOCK PIC X(10).
01 WS-REPLICATED-LOG PIC X(10).
01 WS-NET-CHANNEL PIC X(10).
01 WS-EXPIRATION-TIMER PIC X(10).
01 WS-EXPIRATION-SERVICE PIC X(10).
01 WS-CLIENT PIC X(10).
01 WS-CLIENT-DRIVER PIC X(10).

PROCEDURE DIVISION.
    PERFORM CREATE-LOG-DIRECTORY.
    PERFORM LOCK-DATA-DIR.
    PERFORM BUILD-METADATA-LOG.
    PERFORM BUILD-NETWORK-CHANNEL.
    PERFORM BUILD-RAFT-CLIENT.
    PERFORM STARTUP.
    PERFORM SHUTDOWN.
    PERFORM REGISTER.
    PERFORM HANDLE-REQUEST.
    PERFORM GET-LEADER-AND-EPOCH.
    PERFORM GET-VOTER-NODE.

    CREATE-LOG-DIRECTORY.
        MOVE NEW-FILE(WS-CONFIG, WS-METADATA-LOG-DIR, WS-TOPIC-PARTITION) TO WS-DATA-DIR.

    LOCK-DATA-DIR.
        MOVE NEW-FILE-LOCK(WS-CONFIG, WS-METADATA-LOG-DIR) TO WS-DATA-DIR-LOCK.

    BUILD-METADATA-LOG.
        MOVE NEW-KAFKA-METADATA-LOG(WS-TOPIC-PARTITION, WS-TOPIC-ID, WS-DATA-DIR, WS-TIME, WS-SCHEDULER, WS-CONFIG) TO WS-REPLICATED-LOG.

    BUILD-NETWORK-CHANNEL.
        MOVE NEW-KAFKA-NETWORK-CHANNEL(WS-TIME, WS-CONFIG, WS-THREAD-NAME-PREFIX) TO WS-NET-CHANNEL.

    BUILD-RAFT-CLIENT.
        MOVE NEW-KAFKA-RAFT-CLIENT(WS-CONFIG, WS-METADATA-LOG-DIR-UUID, WS-RECORD-SERDE, WS-NET-CHANNEL, WS-REPLICATED-LOG, WS-TIME, WS-EXPIRATION-SERVICE, WS-LOG-CONTEXT, WS-CONFIG, WS-CLUSTER-ID, WS-BOOTSTRAP-SERVERS, WS-LOCAL-LISTENERS, WS-RAFT-CONFIG) TO WS-CLIENT.

    STARTUP.
        CALL CLIENT-INITIALIZE USING WS-CONTROLLER-QUORUM-VOTERS-FUTURE, WS-REPLICATED-LOG, WS-METRICS, WS-EXTERNAL-KRAFT-METRICS.
        CALL NET-CHANNEL-START.
        CALL CLIENT-DRIVER-START.

    SHUTDOWN.
        CALL EXPIRATION-SERVICE-SHUTDOWN.
        CALL EXPIRATION-TIMER-CLOSE.
        CALL CLIENT-DRIVER-SHUTDOWN.
        CALL SCHEDULER-SHUTDOWN.
        CALL NET-CHANNEL-CLOSE.
        CALL REPLICATED-LOG-CLOSE.
        CALL DATA-DIR-LOCK-DESTROY.

    REGISTER.
        CALL CLIENT-REGISTER USING WS-LISTENER.

    HANDLE-REQUEST.
        CALL CLIENT-DRIVER-HANDLE-REQUEST USING WS-CONTEXT, WS-HEADER, WS-REQUEST, WS-CREATED-TIME-MS.

    GET-LEADER-AND-EPOCH.
        MOVE CLIENT-LEADER-AND-EPOCH TO WS-LEADER-AND-EPOCH.

    GET-VOTER-NODE.
        MOVE CLIENT-VOTER-NODE(WS-ID, WS-LISTENER) TO WS-VOTER-NODE.

STOP RUN.