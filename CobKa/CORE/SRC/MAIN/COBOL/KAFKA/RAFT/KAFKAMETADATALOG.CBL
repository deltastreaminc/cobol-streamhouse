IDENTIFICATION DIVISION.
PROGRAM-ID. KAFKA-METADATA-LOG.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT UNIFIED-LOG
    ASSIGN TO DYNAMIC-DAT-FILE-1
    ORGANIZATION IS SEQUENTIAL
    ACCESS MODE IS SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD UNIFIED-LOG.
01 UNIFIED-LOG-REC.
   05 FIRST-OFFSET    PIC S9(18) COMP.
   05 LAST-OFFSET     PIC S9(18) COMP.

WORKING-STORAGE SECTION.
01 WS-SNAPSHOT-MAP.
   05 SNAPSHOT-ID     PIC X(100).
   05 SNAPSHOT-READER PIC X(100).
01 WS-TOPICPARTITION.
   05 TOPIC-NAME      PIC X(50).
   05 PARTITION-ID    PIC 9(5).
01 WS-CONFIG.
   05 MAX-BATCH-SIZE-BYTES PIC 9(9) COMP.
   05 LOG-SEGMENT-BYTES    PIC 9(9) COMP.
   05 LOG-SEGMENT-MILLIS   PIC 9(9) COMP.
   05 RETENTION-MILLIS     PIC 9(9) COMP.
   05 RETENTION-MAX-BYTES  PIC 9(18) COMP.
01 WS-MISC.
   05 CURRENT-TIMESTAMP   PIC 9(18) COMP.
   05 SNAPSHOT-COUNT      PIC 9(5) COMP.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM INIT-METADATA-LOG.
    PERFORM MAIN-LOOP UNTIL WS-SNAPSHOT-COUNT = 0.
    PERFORM CLOSE-METADATA-LOG.
    STOP RUN.

INIT-METADATA-LOG.
    OPEN INPUT UNIFIED-LOG.
    PERFORM RECOVER-SNAPSHOTS.
    PERFORM TRUNCATE-TO-LATEST-SNAPSHOT.

RECOVER-SNAPSHOTS.
    MOVE SPACES TO WS-SNAPSHOT-MAP.
    READ UNIFIED-LOG
        AT END
            CLOSE UNIFIED-LOG
            RETURN.
    PERFORM UNTIL WS-SNAPSHOT-COUNT > 0
        MOVE FIRST-OFFSET TO SNAPSHOT-ID
        MOVE SPACES TO SNAPSHOT-READER
        MOVE WS-SNAPSHOT-MAP TO SNAPSHOT-ID
        ADD 1 TO WS-SNAPSHOT-COUNT
        READ UNIFIED-LOG
            AT END
                CLOSE UNIFIED-LOG
                RETURN.
    CLOSE UNIFIED-LOG.

TRUNCATE-TO-LATEST-SNAPSHOT.
    MOVE SPACES TO SNAPSHOT-ID.
    PERFORM UNTIL SNAPSHOT-ID = SPACES
        MOVE SNAPSHOT-ID TO WS-TOPICPARTITION
        MOVE SNAPSHOT-ID TO WS-CONFIG
        PERFORM TRUNCATE-FULLY-AND-START-AT
        MOVE SPACES TO SNAPSHOT-ID.

TRUNCATE-FULLY-AND-START-AT.
    MOVE WS-TOPICPARTITION TO UNIFIED-LOG-REC.
    MOVE WS-CONFIG TO UNIFIED-LOG-REC.
    TRUNCATE UNIFIED-LOG TO FIRST-OFFSET.

CLOSE-METADATA-LOG.
    CLOSE UNIFIED-LOG.
    PERFORM VARYING SNAPSHOT-ID FROM 1 BY 1 UNTIL SNAPSHOT-ID = WS-SNAPSHOT-COUNT
        MOVE WS-SNAPSHOT-MAP(SNAPSHOT-ID) TO SNAPSHOT-READER
        CLOSE SNAPSHOT-READER
    END-PERFORM.