IDENTIFICATION DIVISION.
PROGRAM-ID. KAFKA-CSV-METRICS-REPORTER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY "KAFKA-METRICS-CONFIG".
    COPY "KAFKA-YAMMER-METRICS".

DATA DIVISION.
WORKING-STORAGE SECTION.
    01 CSV-DIR PIC X(256) VALUE SPACES.
    01 UNDERLYING PIC 9(18) COMP-5 VALUE 0.
    01 RUNNING PIC 9 VALUE 0.
    01 INITIALIZED PIC 9 VALUE 0.

PROCEDURE DIVISION.

GET-MBEAN-NAME.
    MOVE "kafka:type=kafka.metrics.KafkaCSVMetricsReporter" TO MBEAN-NAME.
    EXIT.

INIT.
    PERFORM INITIALIZE-REPORTER.

INITIALIZE-REPORTER.
    IF INITIALIZED = 0 THEN
        MOVE PROPS-STRING("kafka.csv.metrics.dir", "kafka_metrics") TO CSV-DIR
        PERFORM DELETE-CSV-DIR
        PERFORM CREATE-CSV-DIR
        MOVE NEW CsvReporter(KAFKA-YAMMER-METRICS-DEFAULT-REGISTRY(), CSV-DIR) TO UNDERLYING
        IF PROPS-BOOLEAN("kafka.csv.metrics.reporter.enabled", FALSE) = TRUE THEN
            MOVE 1 TO INITIALIZED
            PERFORM START-REPORTER USING PROPS-LONG("kafka.csv.metrics.polling.interval.secs")
        END-IF
    END-IF.

START-REPORTER.
    IF INITIALIZED = 1 AND RUNNING = 0 THEN
        CALL UNDERLYING "start" USING POLLING-PERIOD-SECS, TimeUnit-SECONDS
        MOVE 1 TO RUNNING
        DISPLAY "Started Kafka CSV metrics reporter with polling period " POLLING-PERIOD-SECS " seconds"
    END-IF.

STOP-REPORTER.
    IF INITIALIZED = 1 AND RUNNING = 1 THEN
        CALL UNDERLYING "shutdown"
        MOVE 0 TO RUNNING
        DISPLAY "Stopped Kafka CSV metrics reporter"
        MOVE NEW CsvReporter(KAFKA-YAMMER-METRICS-DEFAULT-REGISTRY(), CSV-DIR) TO UNDERLYING
    END-IF.

DELETE-CSV-DIR.
    CALL Utils "delete" USING CSV-DIR.

CREATE-CSV-DIR.
    CALL Files "createDirectories" USING CSV-DIR-PATH.

PROPS-STRING.
    MOVE PROPS(1) TO RETURN-VALUE.
    IF PROPS(2) = SPACES THEN
        MOVE PROPS(2) TO RETURN-VALUE
    END-IF.
    EXIT.

PROPS-BOOLEAN.
    IF PROPS(1) = "true" THEN
        MOVE 1 TO RETURN-VALUE
    ELSE
        MOVE 0 TO RETURN-VALUE
    END-IF.
    EXIT.

PROPS-LONG.
    MOVE PROPS(1) TO RETURN-VALUE.
    EXIT.

STOP RUN.