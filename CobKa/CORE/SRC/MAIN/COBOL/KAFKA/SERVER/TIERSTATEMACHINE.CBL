IDENTIFICATION DIVISION.
PROGRAM-ID. TierStateMachine.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC FUNCTIONS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-TOPIC-PARTITION.
   05 WS-TOPIC       PIC X(100).
   05 WS-PARTITION   PIC 9(9) COMP.
01 WS-LEADER-EPOCH   PIC 9(9) COMP.
01 WS-LEADER-LOCAL-START-OFFSET   PIC 9(18) COMP-3.
01 WS-OFFSET-TO-FETCH             PIC 9(18) COMP-3.
01 WS-LEADER-END-OFFSET           PIC 9(18) COMP-3.
01 WS-INITIAL-LAG                 PIC 9(18) COMP-3.
01 WS-REMOTE-LOG-SEGMENT-METADATA.
   05 WS-END-OFFSET               PIC 9(18) COMP-3.
   05 WS-LEADER-EPOCH             PIC 9(9) COMP.
01 WS-PREVIOUS-OFFSET-TO-LEADER-LOCAL-LOG-START-OFFSET   PIC 9(18) COMP-3.
01 WS-TARGET-EPOCH                PIC 9(9) COMP.
01 WS-REMOTE-LOG-MANAGER          PIC X(100).
01 WS-PRODUCER-SNAPSHOT-FILE      PIC X(200).
01 WS-LEADER-EPOCH-ENTRIES        PIC 9(9) COMP OCCURS 99.

PROCEDURE DIVISION.
START-TIER-STATE-MACHINE.
    MOVE FUNCTION CONCATENATE(SPACE, SPACE, SPACE) TO WS-TOPIC.
    MOVE ZEROS TO WS-PARTITION.

    PERFORM FETCH-EARLIEST-LOCAL-OFFSET.
    PERFORM BUILD-REMOTE-LOG-AUX-STATE.
    PERFORM FETCH-LATEST-OFFSET.
    PERFORM COMPUTE-INITIAL-LAG.
    PERFORM RETURN-PARTITION-FETCH-STATE.

    STOP RUN.

FETCH-EARLIEST-LOCAL-OFFSET.
    CALL "leader.fetchEarliestLocalOffset" USING WS-TOPIC-PARTITION, WS-LEADER-EPOCH
        RETURNING WS-LEADER-LOCAL-START-OFFSET, WS-LEADER-EPOCH.

BUILD-REMOTE-LOG-AUX-STATE.
    CALL "replicaMgr.brokerTopicStats().topicStats()" USING WS-TOPIC
        INVOKING "buildRemoteLogAuxStateRequestRate" MARK.
    CALL "replicaMgr.brokerTopicStats().allTopicsStats()"
        INVOKING "buildRemoteLogAuxStateRequestRate" MARK.

    PERFORM FETCH-EARLIER-EPOCH-END-OFFSET.
    PERFORM READ-LEADER-EPOCH-CHECKPOINT.
    PERFORM BUILD-PRODUCER-SNAPSHOT-FILE.

    CALL "partition.truncateFullyAndStartAt" USING WS-OFFSET-TO-FETCH, WS-USEFUTURELOG, WS-LEADERLOGSTARTOFFSET.
    CALL "unifiedLog.maybeIncrementLogStartOffset" USING WS-LEADERLOGSTARTOFFSET, "LeaderOffsetIncremented".
    CALL "unifiedLog.maybeIncrementLocalLogStartOffset" USING WS-OFFSET-TO-FETCH, "LeaderOffsetIncremented".
    CALL "unifiedLog.leaderEpochCache().assign" USING WS-LEADER-EPOCH-ENTRIES.
    CALL "unifiedLog.producerStateManager().truncateFullyAndReloadSnapshots".
    CALL "unifiedLog.loadProducerState" USING WS-OFFSET-TO-FETCH.

FETCH-EARLIER-EPOCH-END-OFFSET.
    MOVE FUNCTION CONCATENATE(WS-TOPIC, WS-PARTITION) TO WS-TOPIC-PARTITION.
    SUBTRACT 1 FROM WS-LEADER-EPOCH GIVING WS-PREVIOUS-OFFSET-TO-LEADER-LOCAL-LOG-START-OFFSET.
    CALL "leader.fetchEpochEndOffsets" USING WS-TOPIC-PARTITION, WS-LEADER-EPOCH, WS-PREVIOUS-OFFSET-TO-LEADER-LOCAL-LOG-START-OFFSET
        RETURNING WS-TARGET-EPOCH, WS-REMOTE-LOG-SEGMENT-METADATA.

READ-LEADER-EPOCH-CHECKPOINT.
    CALL "rlm.storageManager().fetchIndex" USING WS-REMOTE-LOG-SEGMENT-METADATA, "LEADER_EPOCH"
        RETURNING WS-LEADER-EPOCH-ENTRIES.

BUILD-PRODUCER-SNAPSHOT-FILE.
    MOVE FUNCTION CONCATENATE(WS-PRODUCER-SNAPSHOT-FILE, ".tmp") TO WS-PRODUCER-SNAPSHOT-FILE.
    CALL "Files.copy" USING WS-PRODUCER-SNAPSHOT-FILE, WS-REMOTE-LOG-SEGMENT-METADATA, "PRODUCER_SNAPSHOT".
    CALL "Utils.atomicMoveWithFallback" USING WS-PRODUCER-SNAPSHOT-FILE, WS-PRODUCER-SNAPSHOT-FILE, FALSE.

FETCH-LATEST-OFFSET.
    CALL "leader.fetchLatestOffset" USING WS-TOPIC-PARTITION, WS-LEADER-EPOCH
        RETURNING WS-LEADER-END-OFFSET.

COMPUTE-INITIAL-LAG.
    SUBTRACT WS-OFFSET-TO-FETCH FROM WS-LEADER-END-OFFSET GIVING WS-INITIAL-LAG.

RETURN-PARTITION-FETCH-STATE.
    RETURN PartitionFetchState(WS-TOPIC-ID, WS-OFFSET-TO-FETCH, WS-INITIAL-LAG, WS-LEADER-EPOCH, "Fetching", WS-LATEST-EPOCH).