IDENTIFICATION DIVISION.
PROGRAM-ID. AddPartitionsToTxnManager.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY "kafka/server/KafkaConfig.cpy".
    COPY "kafka/server/MetadataCache.cpy".
    COPY "kafka/utils/Logging.cpy".
    COPY "org/apache/kafka/clients/ClientResponse.cpy".
    COPY "org/apache/kafka/clients/NetworkClient.cpy".
    COPY "org/apache/kafka/clients/RequestCompletionHandler.cpy".
    COPY "org/apache/kafka/common/internals/Topic.cpy".
    COPY "org/apache/kafka/common/Node.cpy".
    COPY "org/apache/kafka/common/TopicPartition.cpy".
    COPY "org/apache/kafka/common/message/AddPartitionsToTxnRequestData.cpy".
    COPY "org/apache/kafka/common/protocol/Errors.cpy".
    COPY "org/apache/kafka/common/requests/AddPartitionsToTxnRequest.cpy".
    COPY "org/apache/kafka/common/requests/AddPartitionsToTxnResponse.cpy".
    COPY "org/apache/kafka/common/requests/MetadataResponse.cpy".
    COPY "org/apache/kafka/common/utils/Time.cpy".
    COPY "org/apache/kafka/server/metrics/KafkaMetricsGroup.cpy".
    COPY "org/apache/kafka/server/util/InterBrokerSendThread.cpy".
    COPY "org/apache/kafka/server/util/RequestAndCompletionHandler.cpy".

DATA DIVISION.
WORKING-STORAGE SECTION.
    01 WS-INFLIGHT-NODES PIC X(30) OCCURS 99 TIMES INDEXED BY WS-INFLIGHT-NODE-IDX.
    01 WS-NODE-TO-TRANSACTIONS.
        05 WS-NODE-TO-TRANSACTIONS-ITEM OCCURS 99 TIMES INDEXED BY WS-NODE-TO-TRANSACTIONS-IDX.
            10 WS-NODE PIC X(30).
            10 WS-TRANSACTION-DATA-AND-CALLBACKS.
                15 WS-TRANSACTION-DATA PIC X(100).
                15 WS-CALLBACKS PIC X(100) OCCURS 99 TIMES INDEXED BY WS-CALLBACKS-IDX.
                15 WS-START-TIME-MS PIC 9(18) OCCURS 99 TIMES INDEXED BY WS-START-TIME-MS-IDX.
                15 WS-TRANSACTION-SUPPORTED-OPERATION PIC X(10).
    01 WS-TRANSACTION-COORDINATOR-PARTITION PIC 9(9).
    01 WS-TOPIC-PARTITIONS-TO-ERROR PIC X(100) OCCURS 99 TIMES INDEXED BY WS-TOPIC-PARTITIONS-TO-ERROR-IDX.
    01 WS-VERIFICATION-FAILURE-RATE PIC X(30).
    01 WS-VERIFICATION-TIME-MS PIC X(30).

PROCEDURE DIVISION.
    MAIN-PROCEDURE.
        PERFORM ADD-OR-VERIFY-TRANSACTION.
        PERFORM ADD-TXN-DATA.
        PERFORM GET-TRANSACTION-COORDINATOR.
        PERFORM TOP-TOPIC-PARTITIONS-TO-ERROR.
        PERFORM SEND-CALLBACK.
        PERFORM GENERATE-REQUESTS.
        PERFORM SHUTDOWN.

    ADD-OR-VERIFY-TRANSACTION.
        MOVE TRANSACTIONAL-ID TO WS-TRANSACTION-COORDINATOR-PARTITION.
        PERFORM GET-TRANSACTION-COORDINATOR.
        IF WS-TRANSACTION-COORDINATOR IS EMPTY
            PERFORM SEND-CALLBACK USING TOPIC-PARTITIONS TO ERRORS-COORDINATOR-NOT-AVAILABLE
        ELSE
            PERFORM BUILD-ADD-PARTITIONS-TO-TXN-TOPIC-COLLECTION
            PERFORM ADD-TXN-DATA.

    ADD-TXN-DATA.
        MOVE TRANSACTIONAL-ID TO WS-TRANSACTION-COORDINATOR.
        MOVE PRODUCER-ID TO WS-TRANSACTION-DATA(WS-TRANSACTION-COORDINATOR-IDX).PRODUCER-ID.
        MOVE PRODUCER-EPOCH TO WS-TRANSACTION-DATA(WS-TRANSACTION-COORDINATOR-IDX).PRODUCER-EPOCH.
        MOVE VERIFY-ONLY TO WS-TRANSACTION-DATA(WS-TRANSACTION-COORDINATOR-IDX).VERIFY-ONLY.
        MOVE TOPIC-COLLECTION TO WS-TRANSACTION-DATA(WS-TRANSACTION-COORDINATOR-IDX).TOPICS.
        MOVE CALLBACK TO WS-CALLBACKS(WS-TRANSACTION-COORDINATOR-IDX).
        MOVE TIME-MS TO WS-START-TIME-MS(WS-TRANSACTION-COORDINATOR-IDX).
        MOVE TRANSACTION-SUPPORTED-OPERATION TO WS-TRANSACTION-SUPPORTED-OPERATION(WS-TRANSACTION-COORDINATOR-IDX).
        PERFORM WAKEUP.

    GET-TRANSACTION-COORDINATOR.
        MOVE TRANSACTION-COORDINATOR-PARTITION TO WS-TRANSACTION-COORDINATOR-PARTITION.
        PERFORM CALL "MetadataCache" USING WS-TRANSACTION-COORDINATOR-PARTITION
            RETURNING WS-TRANSACTION-COORDINATOR.

    TOP-TOPIC-PARTITIONS-TO-ERROR.
        MOVE TRANSACTIONAL-ID TO WS-TOPIC-PARTITIONS-TO-ERROR-IDX.
        MOVE TRANSACTION-DATA TO WS-TOPIC-PARTITIONS-TO-ERROR(WS-TOPIC-PARTITIONS-TO-ERROR-IDX).
        MOVE ERROR TO WS-TOPIC-PARTITIONS-TO-ERROR(WS-TOPIC-PARTITIONS-TO-ERROR-IDX).
        PERFORM CALL "KafkaMetricsGroup" USING WS-VERIFICATION-FAILURE-RATE
            RETURNING WS-VERIFICATION-FAILURE-RATE.

    SEND-CALLBACK.
        PERFORM CALL "KafkaMetricsGroup" USING WS-VERIFICATION-TIME-MS
            RETURNING WS-VERIFICATION-TIME-MS.
        MOVE CALLBACK TO WS-CALLBACKS(WS-CALLBACK-IDX).
        MOVE TOPIC-PARTITIONS-TO-ERROR TO WS-CALLBACKS(WS-CALLBACK-IDX).
        MOVE START-TIME-MS TO WS-START-TIME-MS(WS-CALLBACK-IDX).
        CALL WS-CALLBACKS(WS-CALLBACK-IDX) USING WS-TOPIC-PARTITIONS-TO-ERROR.

    GENERATE-REQUESTS.
        MOVE CURRENT-TIME-MS TO WS-CURRENT-TIME-MS.
        MOVE NODES-REMOVED TO WS-NODES-REMOVED.
        PERFORM VARYING WS-NODE-TO-TRANSACTIONS-IDX FROM 1 BY 1 UNTIL WS-NODE-TO-TRANSACTIONS-IDX > 99
            IF WS-INFLIGHT-NODES(WS-INFLIGHT-NODE-IDX) NOT EQUAL WS-NODE(WS-NODE-TO-TRANSACTIONS-IDX)
                PERFORM BUILD-REQUEST-AND-COMPLETION-HANDLER
                PERFORM ADD-NODE-TO-INFLIGHT
                PERFORM REMOVE-NODE-FROM-TRANSACTIONS
            END-IF
        END-PERFORM.

    SHUTDOWN.
        PERFORM SUPER-SHUTDOWN.
        PERFORM CALL "KafkaMetricsGroup" USING WS-VERIFICATION-FAILURE-RATE, WS-VERIFICATION-TIME-MS
            RETURNING.

STOP RUN.