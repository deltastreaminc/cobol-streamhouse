IDENTIFICATION DIVISION.
PROGRAM-ID. DELAYEDFETCH.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY KAFKA.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 FETCH-PARTITION-STATUS.
    03 START-OFFSET-METADATA.
        05 MESSAGE-OFFSET USAGE DISPLAY PIC 9(18).
    03 FETCH-INFO.
        05 MAX-BYTES USAGE DISPLAY PIC 9(9).
        05 CURRENT-LEADER-EPOCH USAGE DISPLAY PIC 9(9).
        05 LAST-FETCHED-EPOCH.
01 ACCUMULATED-SIZE USAGE DISPLAY PIC 9(9) VALUE ZERO.
01 FETCH-INFO-TABLE.
    03 FILLER OCCURS 1 TO 9999 TIMES DEPENDING ON FETCH-PARTITION-STATUS-COUNT.
        05 TOPIC-ID-PARTITION.
            07 TOPIC-PARTITION.
                09 TOPIC PIC X(50).
                09 PARTITION PIC 9(5).
        05 FETCH-PARTITION-STATUS.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM TRYCOMPETE-PARAGRAPH.
    PERFORM ONCOMPLETE-PARAGRAPH.

TRYCOMPETE-PARAGRAPH.
    PERFORM VARYING TOPIC-ID-PARTITION-IDX FROM 1 BY 1 UNTIL TOPIC-ID-PARTITION-IDX > FETCH-PARTITION-STATUS-COUNT
        MOVE FETCH-PARTITION-STATUS(TOPIC-ID-PARTITION-IDX) TO FETCH-PARTITION-STATUS
        PERFORM CHECK-CASES-PARAGRAPH
    END-PERFORM.
    IF ACCUMULATED-SIZE >= PARAMS-MIN-BYTES
        PERFORM FORCECOMPLETE-PARAGRAPH
    ELSE
        MOVE FALSE TO RETURN-CODE.

CHECK-CASES-PARAGRAPH.
    IF START-OFFSET-METADATA NOT = UNKNOWN-OFFSET-METADATA
        PERFORM GETPARTITION-PARAGRAPH
        PERFORM FETCHOFFSET-SNAPSHOT-PARAGRAPH
        PERFORM CHECKFETCHOFFSET-PARAGRAPH
        PERFORM CHECKEPOCHTRUNACTION-PARAGRAPH
    ELSE
        PERFORM HANDLECASES-PARAGRAPH.

GETPARTITION-PARAGRAPH.
    MOVE TOPIC-PARTITION TO WS-TOPIC-PARTITION.
    CALL "GETPARTITIONOREXCEPTION" USING REPLICA-MANAGER WS-TOPIC-PARTITION
        GIVING PARTITION.

FETCHOFFSET-SNAPSHOT-PARAGRAPH.
    CALL "FETCHOFFSSNAPSHOT" USING PARTITION CURRENT-LEADER-EPOCH PARAMS-FETCH-ONLY-LEADER
        GIVING OFFSET-SNAPSHOT.

CHECKFETCHOFFSET-PARAGRAPH.
    EVALUATE PARAMS-ISOLATION
        WHEN LOG-END
            MOVE OFFSET-SNAPSHOT-LOG-END-OFFSET TO END-OFFSET
        WHEN HIGH-WATERMARK 
            MOVE OFFSET-SNAPSHOT-HIGH-WATERMARK TO END-OFFSET
        WHEN TXN-COMMITTED
            MOVE OFFSET-SNAPSHOT-LAST-STABLE-OFFSET TO END-OFFSET
    END-EVALUATE.
    IF START-OFFSET-METADATA-MESSAGE-OFFSET > END-OFFSET-MESSAGE-OFFSET
        PERFORM FORCECOMPLETE-PARAGRAPH
    ELSE
        IF START-OFFSET-METADATA-MESSAGE-OFFSET < END-OFFSET-MESSAGE-OFFSET
            IF START-OFFSET-METADATA-ON-OLDER-SEGMENT(END-OFFSET)
                PERFORM FORCECOMPLETE-PARAGRAPH
            ELSE
                IF START-OFFSET-METADATA-ON-SAME-SEGMENT(END-OFFSET)
                    COMPUTE BYTES-AVAILABLE = MINIMUM(END-OFFSET-POSITION-DIFF(START-OFFSET-METADATA), FETCH-INFO-MAX-BYTES)
                    IF NOT PARAMS-IS-FROM-FOLLOWER OR NOT REPLICA-MANAGER-SHOULD-LEADER-THROTTLE(QUOTA, PARTITION, PARAMS-REPLICA-ID)
                        ADD BYTES-AVAILABLE TO ACCUMULATED-SIZE
                    END-IF
                END-IF
            END-IF
        END-IF
    END-IF.

CHECKEPOCHTRUNACTION-PARAGRAPH.
    IF FETCH-INFO-LAST-FETCHED-EPOCH IS PROVIDED
        CALL "LASTOFFSETFORLEADEREPOCH" USING PARTITION CURRENT-LEADER-EPOCH FETCH-INFO-LAST-FETCHED-EPOCH FALSE
            GIVING EPOCH-END-OFFSET
        IF EPOCH-END-OFFSET-ERROR-CODE NOT = NONE-ERROR-CODE
            OR EPOCH-END-OFFSET-END-OFFSET = UNDEFINED-EPOCH-OFFSET
            OR EPOCH-END-OFFSET-LEADER-EPOCH = UNDEFINED-EPOCH
            PERFORM FORCECOMPLETE-PARAGRAPH
        ELSE
            IF EPOCH-END-OFFSET-LEADER-EPOCH < FETCH-INFO-LAST-FETCHED-EPOCH
                OR EPOCH-END-OFFSET-END-OFFSET < FETCH-INFO-FETCH-OFFSET
                PERFORM FORCECOMPLETE-PARAGRAPH
            END-IF
        END-IF
    END-IF.

HANDLECASES-PARAGRAPH.
    EVALUATE TRUE
        WHEN NOTLEADERORFOLLOWEEXCEPTION
            PERFORM FORCECOMPLETE-PARAGRAPH
        WHEN UNKNOWNTOPICORPARTITIONEXCEPTION
            PERFORM FORCECOMPLETE-PARAGRAPH
        WHEN KAFKASTORAGEEXCEPTION
            PERFORM FORCECOMPLETE-PARAGRAPH
        WHEN FENCEDLEADEREPOCHEXCEPTION
            PERFORM FORCECOMPLETE-PARAGRAPH
    END-EVALUATE.

FORCECOMPLETE-PARAGRAPH.
    MOVE TRUE TO RETURN-CODE.

ONCOMPLETE-PARAGRAPH.
    MOVE FETCH-PARTITION-STATUS TO FETCH-INFO-TABLE.
    CALL "READFROMLOG" USING PARAMS FETCH-INFO-TABLE QUOTA TRUE
        GIVING LOG-READ-RESULTS.
    MOVE LOG-READ-RESULTS TO FETCH-PARTITION-DATA.
    CALL "RESPONSECALLBACK" USING FETCH-PARTITION-DATA.

STOP RUN.