IDENTIFICATION DIVISION.
PROGRAM-ID. REMOTE-LEADER-ENDPOINT.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-MAX-WAIT PIC 9(9) COMP-5 VALUE 0.
01 WS-MIN-BYTES PIC 9(9) COMP-5 VALUE 0.
01 WS-MAX-BYTES PIC 9(9) COMP-5 VALUE 0.
01 WS-FETCH-SIZE PIC 9(9) COMP-5 VALUE 0.
01 WS-TOPIC-PARTITION.
   03 WS-TOPIC PIC X(100).
   03 WS-PARTITION PIC 9(9) COMP-5.
01 WS-OFFSET-AND-EPOCH.
   03 WS-OFFSET PIC 9(18) COMP-5.
   03 WS-EPOCH PIC 9(9) COMP-5.
01 WS-TOPIC-LIST.
   03 OCCURS 100 TIMES.
     05 WS-TOPIC-NAME PIC X(100).
     05 WS-TOPIC-PARTITIONS.
        07 OCCURS 100 TIMES.
          09 WS-PARTITION-INDEX PIC 9(9) COMP-5.
          09 WS-CURRENT-LEADER-EPOCH PIC 9(9) COMP-5.
          09 WS-TIMESTAMP PIC 9(18) COMP-5.
01 WS-OFFSETS-FOR-LEADER-TOPIC.
   03 OCCURS 100 TIMES.
     05 WS-OFFSETS-FOR-LEADER-TOPIC-NAME PIC X(100).
     05 WS-OFFSETS-FOR-LEADER-PARTITIONS.
        07 OCCURS 100 TIMES.
          09 WS-OFFSETS-FOR-LEADER-PARTITION PIC 9(9) COMP-5.
          09 WS-OFFSETS-FOR-LEADER-EPOCH PIC 9(9) COMP-5.
          09 WS-OFFSETS-FOR-LEADER-ERROR-CODE PIC 9(9) COMP-5.

PROCEDURE DIVISION.
    PERFORM FETCH.
    PERFORM FETCH-EARLIEST-OFFSET.
    PERFORM FETCH-LATEST-OFFSET.
    PERFORM FETCH-EARLIEST-LOCAL-OFFSET.
    PERFORM FETCH-EPOCH-END-OFFSETS.
    PERFORM BUILD-FETCH.

FETCH.
    CALL "SEND-REQUEST" USING FETCH-REQUEST-BUILDER
    RETURNING CLIENT-RESPONSE.
    MOVE CLIENT-RESPONSE TO FETCH-RESPONSE.
    IF NOT FETCH-SESSION-HANDLER-HANDLE-RESPONSE
        IF FETCH-RESPONSE-ERROR = FETCH-SESSION-TOPIC-ID-ERROR
            RAISE FETCH-SESSION-TOPIC-ID-ERROR-EXCEPTION
        ELSE
            RETURN EMPTY-MAP
        END-IF
    ELSE
        RETURN FETCH-RESPONSE-DATA
    END-IF.

FETCH-EARLIEST-OFFSET.
    PERFORM FETCH-OFFSET USING WS-TOPIC-PARTITION, WS-CURRENT-LEADER-EPOCH, EARLIEST-TIMESTAMP
    RETURNING WS-OFFSET-AND-EPOCH.

FETCH-LATEST-OFFSET.
    PERFORM FETCH-OFFSET USING WS-TOPIC-PARTITION, WS-CURRENT-LEADER-EPOCH, LATEST-TIMESTAMP
    RETURNING WS-OFFSET-AND-EPOCH.

FETCH-EARLIEST-LOCAL-OFFSET.
    PERFORM FETCH-OFFSET USING WS-TOPIC-PARTITION, WS-CURRENT-LEADER-EPOCH, EARLIEST-LOCAL-TIMESTAMP
    RETURNING WS-OFFSET-AND-EPOCH.

FETCH-OFFSET.
    MOVE WS-TOPIC-PARTITION TO WS-TOPIC-LIST.
    CALL "SEND-REQUEST" USING LIST-OFFSETS-REQUEST-BUILDER
    RETURNING CLIENT-RESPONSE.
    MOVE CLIENT-RESPONSE TO LIST-OFFSETS-RESPONSE.
    FIND WS-TOPIC-PARTITION IN WS-TOPIC-LIST
        MOVE WS-PARTITION-INDEX TO WS-OFFSET-AND-EPOCH
    IF LIST-OFFSETS-RESPONSE-ERROR = NONE
        MOVE LIST-OFFSETS-RESPONSE-OFFSET TO WS-OFFSET
        MOVE LIST-OFFSETS-RESPONSE-LEADER-EPOCH TO WS-EPOCH
    ELSE
        RAISE LIST-OFFSETS-RESPONSE-ERROR-EXCEPTION
    END-IF.

FETCH-EPOCH-END-OFFSETS.
    INITIALIZE WS-OFFSETS-FOR-LEADER-TOPIC.
    MOVE WS-TOPIC-PARTITION TO WS-OFFSETS-FOR-LEADER-TOPIC.
    CALL "SEND-REQUEST" USING OFFSETS-FOR-LEADER-EPOCH-REQUEST-BUILDER
    RETURNING CLIENT-RESPONSE.
    MOVE CLIENT-RESPONSE TO OFFSETS-FOR-LEADER-EPOCH-RESPONSE.
    MOVE OFFSETS-FOR-LEADER-EPOCH-RESPONSE-DATA TO WS-OFFSETS-FOR-LEADER-TOPIC.
    RETURN WS-OFFSETS-FOR-LEADER-TOPIC.

BUILD-FETCH.
    CALL "FETCH-SESSION-HANDLER-NEW-BUILDER" USING WS-TOPIC-PARTITION-COUNT, FALSE
    RETURNING FETCH-DATA-BUILDER.
    PERFORM VARYING WS-TOPIC-PARTITION FROM 1 BY 1 UNTIL WS-TOPIC-PARTITION > WS-TOPIC-PARTITION-COUNT
        IF FETCH-STATE-IS-READY-FOR-FETCH AND NOT SHOULD-FOLLOWER-THROTTLE
            CALL "LOCAL-LOG-OR-EXCEPTION" USING WS-TOPIC-PARTITION
            RETURNING WS-LOG-START-OFFSET
            CALL "FETCH-REQUEST-PARTITION-DATA" USING
                FETCH-STATE-TOPIC-ID, FETCH-STATE-FETCH-OFFSET, WS-LOG-START-OFFSET, WS-FETCH-SIZE,
                FETCH-STATE-CURRENT-LEADER-EPOCH, FETCH-STATE-LAST-FETCHED-EPOCH
            RETURNING PARTITION-DATA
            CALL "FETCH-DATA-BUILDER-ADD" USING WS-TOPIC-PARTITION, PARTITION-DATA
        ELSE
            ADD WS-TOPIC-PARTITION TO WS-PARTITIONS-WITH-ERROR
        END-IF
    END-PERFORM.
    CALL "FETCH-DATA-BUILDER-BUILD" RETURNING FETCH-DATA.
    IF FETCH-DATA-SESSION-PARTITIONS-EMPTY AND FETCH-DATA-TO-FORGET-EMPTY
        RETURN NONE
    ELSE
        CALL "FETCH-REQUEST-BUILDER" USING
            FETCH-REQUEST-VERSION, BROKER-ID, BROKER-EPOCH-SUPPLIER, WS-MAX-WAIT, WS-MIN-BYTES, FETCH-DATA-TO-SEND
        RETURNING FETCH-REQUEST-OPTION
    END-IF.
    RETURN FETCH-REQUEST-OPTION, WS-PARTITIONS-WITH-ERROR.

SHOULD-FOLLOWER-THROTTLE.
    IF NOT FETCH-STATE-IS-REPLICA-IN-SYNC AND QUOTA-IS-THROTTLED AND QUOTA-IS-QUOTA-EXCEEDED
        RETURN TRUE
    ELSE
        RETURN FALSE
    END-IF.

COPY "COMMON-STRUCTURES.cpy".