IDENTIFICATION DIVISION.
PROGRAM-ID. CONTROLLER-MUTATION-QUOTA-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 LAST-THROTTLE-TIME-MS PIC 9(18) COMP-3.
01 LAST-RECORDED-TIME-MS PIC 9(18) COMP-3.

PROCEDURE DIVISION.

IDENTIFICATION DIVISION.
PROGRAM-ID. STRICT-CONTROLLER-MUTATION-QUOTA.

PROCEDURE DIVISION USING TIME, QUOTA-SENSOR.
    MOVE TIME-MILLISECONDS TO LAST-RECORDED-TIME-MS.
    PERFORM QUOTA-SENSOR-SYNC.
        CALL "QUOTA-SENSOR-CHECK-QUOTAS" USING LAST-RECORDED-TIME-MS.
        CALL "QUOTA-SENSOR-RECORD" USING PERMITS, LAST-RECORDED-TIME-MS, FALSE.
    END-PERFORM.
    PERFORM UPDATE-THROTTLE-TIME.
    RAISE "THROTTLING-QUOTA-EXCEEDED" USING LAST-THROTTLE-TIME-MS, "THROTTLING QUOTA EXCEEDED".

IDENTIFICATION DIVISION.
PROGRAM-ID. PERMISSIVE-CONTROLLER-MUTATION-QUOTA.

PROCEDURE DIVISION USING TIME, QUOTA-SENSOR.
    MOVE TIME-MILLISECONDS TO LAST-RECORDED-TIME-MS.
    CALL "QUOTA-SENSOR-RECORD" USING PERMITS, LAST-RECORDED-TIME-MS, TRUE.
    PERFORM UPDATE-THROTTLE-TIME.

IDENTIFICATION DIVISION.
PROGRAM-ID. CONTROLLER-MUTATION-QUOTA-MANAGER.

PROCEDURE DIVISION USING CONFIG, METRICS, TIME, THREAD-NAME-PREFIX, QUOTA-CALLBACK.
    PERFORM REGISTER-QUOTA-METRICS.
    PERFORM RECORD-AND-GET-THROTTLE-TIME.
    PERFORM NEW-STRICT-QUOTA-FOR.
    PERFORM NEW-PERMISSIVE-QUOTA-FOR.
    PERFORM NEW-QUOTA-FOR.

IDENTIFICATION DIVISION.
PROGRAM-ID. UPDATE-THROTTLE-TIME.

PROCEDURE DIVISION USING EXCEPTION, TIME-MS.
    CALL "CONTROLLER-MUTATION-QUOTA-MANAGER-THROTTLE-TIME-MS" USING EXCEPTION, TIME-MS
        GIVING LAST-THROTTLE-TIME-MS.
    MOVE TIME-MS TO LAST-RECORDED-TIME-MS.

IDENTIFICATION DIVISION.
PROGRAM-ID. CONTROLLER-MUTATION-QUOTA-MANAGER-THROTTLE-TIME-MS.

PROCEDURE DIVISION USING EXCEPTION, TIME-MS.
    IF EXCEPTION-METRIC-MEASURABLE IS TOKEN-BUCKET
        COMPUTE LAST-THROTTLE-TIME-MS = ROUND(-EXCEPTION-VALUE / EXCEPTION-BOUND * 1000)
    ELSE
        RAISE "ILLEGAL-ARGUMENT-EXCEPTION" USING "Metric " EXCEPTION-METRIC-NAME " is not a TokenBucket metric, value " EXCEPTION-METRIC-MEASURABLE.

IDENTIFICATION DIVISION.
PROGRAM-ID. REGISTER-QUOTA-METRICS.

PROCEDURE DIVISION USING METRIC-TAGS, SENSOR.
    CALL "METRICS-METRIC-NAME" USING "mutation-rate", "CONTROLLER_MUTATION", "Tracking mutation-rate per user/client-id", METRIC-TAGS
        GIVING SENSOR-RATE-METRIC.
    CALL "SENSOR-ADD" USING SENSOR-RATE-METRIC, NEW RATE.
    CALL "METRICS-METRIC-NAME" USING "tokens", "CONTROLLER_MUTATION", "Tracking remaining tokens in the token bucket per user/client-id", METRIC-TAGS
        GIVING SENSOR-QUOTA-METRIC.
    CALL "SENSOR-ADD" USING SENSOR-QUOTA-METRIC, NEW TOKEN-BUCKET, GET-QUOTA-METRIC-CONFIG(METRIC-TAGS).

IDENTIFICATION DIVISION.
PROGRAM-ID. RECORD-AND-GET-THROTTLE-TIME-MS.

PROCEDURE DIVISION USING SESSION, CLIENT-ID, VALUE, TIME-MS.
    PERFORM GET-OR-CREATE-QUOTA-SENSORS USING SESSION, CLIENT-ID
        GIVING CLIENT-SENSORS.
    MOVE CLIENT-SENSORS-QUOTA-SENSOR TO QUOTA-SENSOR.
    PERFORM QUOTA-SENSOR-SYNC.
        CALL "QUOTA-SENSOR-CHECK-QUOTAS" USING TIME-MS.
        CALL "QUOTA-SENSOR-RECORD" USING VALUE, TIME-MS, FALSE.
    END-PERFORM.
    MOVE 0 TO THROTTLE-TIME-MS.
    PERFORM UPDATE-THROTTLE-TIME USING EXCEPTION, TIME-MS
        GIVING THROTTLE-TIME-MS.

IDENTIFICATION DIVISION.
PROGRAM-ID. NEW-STRICT-QUOTA-FOR.

PROCEDURE DIVISION USING SESSION, CLIENT-ID.
    IF QUOTAS-ENABLED
        PERFORM GET-OR-CREATE-QUOTA-SENSORS USING SESSION, CLIENT-ID
            GIVING CLIENT-SENSORS
        MOVE CLIENT-SENSORS-QUOTA-SENSOR TO QUOTA-SENSOR
        MOVE TIME TO TIME-OBJECT
        CREATE STRICT-CONTROLLER-MUTATION-QUOTA USING TIME-OBJECT, QUOTA-SENSOR
        RETURN STRICT-CONTROLLER-MUTATION-QUOTA
    ELSE
        RETURN UNBOUNDED-CONTROLLER-MUTATION-QUOTA.

IDENTIFICATION DIVISION.
PROGRAM-ID. NEW-PERMISSIVE-QUOTA-FOR.

PROCEDURE DIVISION USING SESSION, CLIENT-ID.
    IF QUOTAS-ENABLED
        PERFORM GET-OR-CREATE-QUOTA-SENSORS USING SESSION, CLIENT-ID
            GIVING CLIENT-SENSORS
        MOVE CLIENT-SENSORS-QUOTA-SENSOR TO QUOTA-SENSOR
        MOVE TIME TO TIME-OBJECT
        CREATE PERMISSIVE-CONTROLLER-MUTATION-QUOTA USING TIME-OBJECT, QUOTA-SENSOR
        RETURN PERMISSIVE-CONTROLLER-MUTATION-QUOTA
    ELSE
        RETURN UNBOUNDED-CONTROLLER-MUTATION-QUOTA.

IDENTIFICATION DIVISION.
PROGRAM-ID. NEW-QUOTA-FOR.

PROCEDURE DIVISION USING REQUEST, STRICT-SINCE-VERSION.
    IF REQUEST-HEADER-API-VERSION >= STRICT-SINCE-VERSION
        PERFORM NEW-STRICT-QUOTA-FOR USING REQUEST
        RETURN
    ELSE
        PERFORM NEW-PERMISSIVE-QUOTA-FOR USING REQUEST
        RETURN.

END PROGRAM CONTROLLER-MUTATION-QUOTA-MANAGER.