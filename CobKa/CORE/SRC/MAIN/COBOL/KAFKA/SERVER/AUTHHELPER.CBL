IDENTIFICATION DIVISION.
PROGRAM-ID. AUTH-HELPER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC FUNCTIONS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-AUTHORIZER OBJECT REFERENCE.
01 WS-RESOURCE OBJECT REFERENCE.
01 WS-ACTION OBJECT REFERENCE.
01 WS-ACTIONS OCCURS 1 TO 9999 TIMES DEPENDING ON WS-ACTION-COUNT.
    05 WS-ACTION-OPERATION PIC X.
    05 WS-ACTION-RESOURCE OBJECT REFERENCE.
    05 WS-ACTION-REFCOUNT PIC 9(9) BINARY.
    05 WS-ACTION-LOGIFALLOWED PIC X.
    05 WS-ACTION-LOGIFDENIED PIC X.
01 WS-ACTION-COUNT PIC 9(4) BINARY.
01 WS-AUTHORIZED-OPS PIC 9(9) BINARY.
01 WS-SUPPORTED-OPS PIC 9(9) BINARY.
01 WS-AUTHORIZED-RESOURCENAMES PIC X(256) OCCURS 1 TO 9999 TIMES DEPENDING ON WS-AUTHORIZED-RESOURCENAMES-COUNT.
01 WS-AUTHORIZED-RESOURCENAMES-COUNT PIC 9(4) BINARY.
01 WS-RESOURCE-NAME-TO-COUNT PIC X(256) OCCURS 1 TO 9999 TIMES DEPENDING ON WS-RESOURCE-NAME-TO-COUNT-COUNT.
    05 WS-RESOURCE-NAME PIC X(256).
    05 WS-RESOURCE-COUNT PIC 9(9) BINARY.
01 WS-RESOURCE-NAME-TO-COUNT-COUNT PIC 9(4) BINARY.
01 WS-DESCRIBE-CLUSTER-RESPONSE-DATA OBJECT REFERENCE.
01 WS-DESCRIBE-CLUSTER-REQUEST OBJECT REFERENCE.
01 WS-EXPECTED-ENDPOINT-TYPE PIC 9(9) BINARY.
01 WS-CLUSTER-ID PIC X(256).
01 WS-GET-NODES PROCEDURE-POINTER.
01 WS-GET-CONTROLLER-ID PROCEDURE-POINTER.
01 WS-EFFECTIVE-CONTROLLER-ID PIC 9(9) BINARY.

PROCEDURE DIVISION.
MAIN-PARAGRAPH.

    PERFORM AUTHORIZE-PARAGRAPH.
    PERFORM AUTHORIZE-CLUSTER-OPERATION-PARAGRAPH.
    PERFORM AUTHORIZED-OPERATIONS-PARAGRAPH.
    PERFORM AUTHORIZE-BY-RESOURCE-TYPE-PARAGRAPH.
    PERFORM PARTITION-SEQ-BY-AUTHORIZED-PARAGRAPH.
    PERFORM FILTER-BY-AUTHORIZED-PARAGRAPH.
    PERFORM COMPUTE-DESCRIBE-CLUSTER-RESPONSE-PARAGRAPH.

    STOP RUN.

AUTHORIZE-PARAGRAPH.
    MOVE WS-AUTHORIZER TO FUNCTION AUTHORIZE(WS-REQUESTCONTEXT, WS-OPERATION, WS-RESOURCETYPE, WS-RESOURCENAME, WS-LOGIFALLOWED, WS-LOGIFDENIED, WS-REFCOUNT).
    IF FUNCTION AUTHORIZE(WS-REQUESTCONTEXT, WS-OPERATION, WS-RESOURCETYPE, WS-RESOURCENAME, WS-LOGIFALLOWED, WS-LOGIFDENIED, WS-REFCOUNT) THEN
        RETURN TRUE
    ELSE
        RETURN FALSE.

AUTHORIZE-CLUSTER-OPERATION-PARAGRAPH.
    IF NOT FUNCTION AUTHORIZE(WS-REQUEST-CONTEXT, WS-OPERATION, CLUSTER, CLUSTER-NAME) THEN
        RAISE CLUSTER-AUTHORIZATION-EXCEPTION.

AUTHORIZED-OPERATIONS-PARAGRAPH.
    MOVE FUNCTION SUPPORTED-OPERATIONS(WS-RESOURCE-TYPE) TO WS-SUPPORTED-OPS.
    IF WS-AUTHORIZER IS NOT NULL THEN
        MOVE FUNCTION AUTHORIZED-OPERATIONS(WS-REQUEST-CONTEXT, WS-RESOURCE) TO WS-AUTHORIZED-OPS
    ELSE
        MOVE WS-SUPPORTED-OPS TO WS-AUTHORIZED-OPS.

AUTHORIZE-BY-RESOURCE-TYPE-PARAGRAPH.
    MOVE FUNCTION AUTHORIZE-BY-RESOURCE-TYPE(WS-REQUESTCONTEXT, WS-OPERATION, WS-RESOURCETYPE) TO WS-AUTHORIZED.
    IF WS-AUTHORIZED THEN
        RETURN TRUE
    ELSE
        RETURN FALSE.

PARTITION-SEQ-BY-AUTHORIZED-PARAGRAPH.
    IF WS-AUTHORIZER IS NOT NULL THEN
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF WS-RESOURCES
            MOVE FUNCTION RESOURCE-NAME(WS-RESOURCES(I)) TO WS-RESOURCE-NAME(I)
            MOVE 1 TO WS-RESOURCE-COUNT(I)
        END-PERFORM
        MOVE LENGTH OF WS-RESOURCES TO WS-RESOURCE-NAME-TO-COUNT-COUNT
        MOVE FUNCTION FILTER-BY-AUTHORIZED(WS-REQUEST-CONTEXT, WS-OPERATION, WS-RESOURCETYPE, WS-RESOURCE-NAME-TO-COUNT, WS-LOGIFALLOWED, WS-LOGIFDENIED, FUNCTION RESOURCE-NAME) TO WS-AUTHORIZED-RESOURCENAMES
        MOVE LENGTH OF WS-AUTHORIZED-RESOURCENAMES TO WS-AUTHORIZED-RESOURCENAMES-COUNT
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF WS-RESOURCES
            IF FUNCTION CONTAINS(WS-AUTHORIZED-RESOURCENAMES, FUNCTION RESOURCE-NAME(WS-RESOURCES(I)))
                MOVE WS-RESOURCES(I) TO WS-AUTHORIZED-RESOURCES
            ELSE
                MOVE WS-RESOURCES(I) TO WS-DENIED-RESOURCES
            END-IF
        END-PERFORM
    ELSE
        MOVE WS-RESOURCES TO WS-AUTHORIZED-RESOURCES
        MOVE SPACES TO WS-DENIED-RESOURCES.

FILTER-BY-AUTHORIZED-PARAGRAPH.
    IF WS-AUTHORIZER IS NOT NULL THEN
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF WS-RESOURCES
            MOVE FUNCTION RESOURCE-NAME(WS-RESOURCES(I)) TO WS-RESOURCE-NAME(I)
            MOVE 1 TO WS-RESOURCE-COUNT(I)
        END-PERFORM
        MOVE LENGTH OF WS-RESOURCES TO WS-RESOURCE-NAME-TO-COUNT-COUNT
        MOVE FUNCTION FILTER-BY-AUTHORIZED(WS-REQUEST-CONTEXT, WS-OPERATION, WS-RESOURCETYPE, WS-RESOURCE-NAME-TO-COUNT, WS-LOGIFALLOWED, WS-LOGIFDENIED, FUNCTION RESOURCE-NAME) TO WS-AUTHORIZED-RESOURCENAMES
        MOVE LENGTH OF WS-AUTHORIZED-RESOURCENAMES TO WS-AUTHORIZED-RESOURCENAMES-COUNT
        RETURN WS-AUTHORIZED-RESOURCENAMES
    ELSE
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF WS-RESOURCES
            MOVE FUNCTION RESOURCE-NAME(WS-RESOURCES(I)) TO WS-AUTHORIZED-RESOURCENAMES(I)
        END-PERFORM
        MOVE LENGTH OF WS-RESOURCES TO WS-AUTHORIZED-RESOURCENAMES-COUNT
        RETURN WS-AUTHORIZED-RESOURCENAMES.

COMPUTE-DESCRIBE-CLUSTER-RESPONSE-PARAGRAPH.
    MOVE WS-REQUEST-BODY TO WS-DESCRIBE-CLUSTER-REQUEST.
    MOVE FUNCTION ENDPOINT-TYPE-FROM-ID(WS-DESCRIBE-CLUSTER-REQUEST-ENDPOINTTYPE) TO WS-EXPECTED-ENDPOINT-TYPE.
    IF WS-EXPECTED-ENDPOINT-TYPE = FUNCTION ENDPOINT-TYPE-UNKNOWN THEN
        MOVE FUNCTION INVALID-REQUEST-CODE() TO WS-DESCRIBE-CLUSTER-RESPONSE-ERRORCODE
        MOVE "Unsupported endpoint type " & WS-DESCRIBE-CLUSTER-REQUEST-ENDPOINTTYPE TO WS-DESCRIBE-CLUSTER-RESPONSE-ERRORMESSAGE
        RETURN WS-DESCRIBE-CLUSTER-RESPONSE-DATA
    ELSE IF WS-EXPECTED-ENDPOINT-TYPE != WS-DESCRIBE-CLUSTER-REQUEST-ENDPOINTTYPE THEN
        MOVE FUNCTION MISMATCHED-ENDPOINT-TYPE-CODE() TO WS-DESCRIBE-CLUSTER-RESPONSE-ERRORCODE
        MOVE "The request was sent to an endpoint of type " & WS-EXPECTED-ENDPOINT-TYPE & ", but we wanted an endpoint of type " & WS-DESCRIBE-CLUSTER-REQUEST-ENDPOINTTYPE TO WS-DESCRIBE-CLUSTER-RESPONSE-ERRORMESSAGE
        RETURN WS-DESCRIBE-CLUSTER-RESPONSE-DATA
    ELSE
        MOVE FUNCTION MIN-VALUE TO WS-CLUSTER-AUTHORIZED-OPERATIONS
        IF WS-DESCRIBE-CLUSTER-REQUEST-INCLUDECLUSTERAUTHORIZEDOPERATIONS THEN
            IF FUNCTION AUTHORIZE(WS-REQUEST-CONTEXT, DESCRIBE, CLUSTER, CLUSTER-NAME) THEN
                MOVE FUNCTION AUTHORIZED-OPERATIONS(WS-REQUEST, RESOURCE-CLUSTER) TO WS-CLUSTER-AUTHORIZED-OPERATIONS
            ELSE
                MOVE 0 TO WS-CLUSTER-AUTHORIZED-OPERATIONS
            END-IF
        END-IF
        MOVE FUNCTION GET-NODES() TO WS-NODES
        MOVE FUNCTION GET-CONTROLLER-ID() TO WS-CONTROLLER-ID
        IF WS-NODES-FIND(WS-CONTROLLER-ID) = SPACES THEN
            MOVE -1 TO WS-EFFECTIVE-CONTROLLER-ID
        ELSE
            MOVE WS-CONTROLLER-ID TO WS-EFFECTIVE-CONTROLLER-ID
        END-IF
        MOVE WS-CLUSTER-ID TO WS-DESCRIBE-CLUSTER-RESPONSE-CLUSTERID
        MOVE WS-EFFECTIVE-CONTROLLER-ID TO WS-DESCRIBE-CLUSTER-RESPONSE-CONTROLLERID
        MOVE WS-CLUSTER-AUTHORIZED-OPERATIONS TO WS-DESCRIBE-CLUSTER-RESPONSE-CLUSTERAUTHORIZEDOPERATIONS
        MOVE WS-NODES TO WS-DESCRIBE-CLUSTER-RESPONSE-BROKERS
        MOVE WS-EXPECTED-ENDPOINT-TYPE-ID TO WS-DESCRIBE-CLUSTER-RESPONSE-ENDPOINTTYPE
        RETURN WS-DESCRIBE-CLUSTER-RESPONSE-DATA.