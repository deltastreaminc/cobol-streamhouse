IDENTIFICATION DIVISION.
PROGRAM-ID. SHARED-SERVER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC FUNCTIONS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-SHARED-SERVER-CONFIG PIC X(1024).
01 WS-META-PROPS-ENSEMBLE PIC X(1024).
01 WS-TIME PIC X(1024).
01 WS-METRICS PIC X(1024).
01 WS-CONTROLLER-QUORUM-VOTERS-FUTURE PIC X(1024).
01 WS-BOOTSTRAP-SERVERS PIC X(1024).
01 WS-FAULT-HANDLER-FACTORY PIC X(1024).
01 WS-SOCKET-FACTORY PIC X(1024).
01 WS-LOG-CONTEXT PIC X(1024).
01 WS-STARTED PIC 9 VALUE 0.
01 WS-USED-BY-BROKER PIC 9 VALUE 0.
01 WS-USED-BY-CONTROLLER PIC 9 VALUE 0.
01 WS-BROKER-CONFIG PIC X(1024).
01 WS-CONTROLLER-CONFIG PIC X(1024).
01 WS-METRICS-REF PIC X(1024).
01 WS-RAFT-MANAGER PIC X(1024).
01 WS-BROKER-METRICS PIC X(1024).
01 WS-CONTROLLER-SERVER-METRICS PIC X(1024).
01 WS-LOADER PIC X(1024).
01 WS-SNAPSHOTS-DISABLED-REASON PIC X(1024).
01 WS-SNAPSHOT-EMITTER PIC X(1024).
01 WS-SNAPSHOT-GENERATOR PIC X(1024).
01 WS-METADATA-LOADER-METRICS PIC X(1024).

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM START-FOR-BROKER.
    PERFORM START-FOR-CONTROLLER.
    PERFORM STOP-FOR-BROKER.
    PERFORM STOP-FOR-CONTROLLER.
    PERFORM ENSURE-NOT-RAFT-LEADER.

START-FOR-BROKER.
    IF WS-USED-BY-BROKER = 0 AND WS-USED-BY-CONTROLLER = 0
        PERFORM START-SHARED-SERVER.
    MOVE 1 TO WS-USED-BY-BROKER.

START-FOR-CONTROLLER.
    IF WS-USED-BY-BROKER = 0 AND WS-USED-BY-CONTROLLER = 0
        PERFORM START-SHARED-SERVER.
    MOVE 1 TO WS-USED-BY-CONTROLLER.

STOP-FOR-BROKER.
    IF WS-USED-BY-BROKER = 1
        MOVE 0 TO WS-USED-BY-BROKER
        IF WS-USED-BY-BROKER = 0 AND WS-USED-BY-CONTROLLER = 0
            PERFORM STOP-SHARED-SERVER.

STOP-FOR-CONTROLLER.
    IF WS-USED-BY-CONTROLLER = 1
        MOVE 0 TO WS-USED-BY-CONTROLLER
        IF WS-USED-BY-BROKER = 0 AND WS-USED-BY-CONTROLLER = 0
            PERFORM STOP-SHARED-SERVER.

RAFT-MANAGER-FAULT-HANDLER.
    PERFORM BUILD-FAULT-HANDLER
        USING "raft manager" TRUE NULLS.

METADATA-LOADER-FAULT-HANDLER.
    PERFORM BUILD-FAULT-HANDLER
        USING "metadata loading" WS-USED-BY-CONTROLLER NULLS.

CONTROLLER-STARTUP-FAULT-HANDLER.
    PERFORM BUILD-FAULT-HANDLER
        USING "controller startup" TRUE NULLS.

INITIAL-BROKER-METADATA-LOAD-FAULT-HANDLER.
    PERFORM BUILD-FAULT-HANDLER
        USING "initial broker metadata loading" TRUE NULLS.

FATAL-QUORUM-CONTROLLER-FAULT-HANDLER.
    PERFORM BUILD-FAULT-HANDLER
        USING "quorum controller" TRUE NULLS.

NON-FATAL-QUORUM-CONTROLLER-FAULT-HANDLER.
    PERFORM BUILD-FAULT-HANDLER
        USING "quorum controller" FALSE NULLS.

METADATA-PUBLISHING-FAULT-HANDLER.
    PERFORM BUILD-FAULT-HANDLER
        USING "metadata publishing" FALSE NULLS.

BUILD-FAULT-HANDLER.
    MOVE FUNCTION WHEN-COMPILED TO WS-FAULT-HANDLER-FACTORY.
    CALL "BUILD" USING FUNCTION TRIM(ARGUMENT-1)
                        FUNCTION TRIM(ARGUMENT-2)
                        FUNCTION TRIM(ARGUMENT-3)
                        RETURNING WS-FAULT-HANDLER.

START-SHARED-SERVER.
    MOVE 1 TO WS-STARTED.
    PERFORM INITIALIZE-CONFIG.
    PERFORM INITIALIZE-METRICS.
    PERFORM INITIALIZE-RAFT-MANAGER.
    PERFORM INITIALIZE-METADATA-LOADER.
    PERFORM INITIALIZE-SNAPSHOT-EMITTER.
    PERFORM INITIALIZE-SNAPSHOT-GENERATOR.
    CALL "INSTALL-PUBLISHERS" USING WS-LOADER.
    CALL "REGISTER" USING WS-RAFT-MANAGER WS-LOADER.

STOP-SHARED-SERVER.
    MOVE 0 TO WS-STARTED.
    PERFORM SHUTDOWN-LOADER.
    PERFORM SHUTDOWN-SNAPSHOT-GENERATOR.
    PERFORM SHUTDOWN-RAFT-MANAGER.
    PERFORM SHUTDOWN-METRICS.

INITIALIZE-CONFIG.
    CALL "INITIALIZE" USING WS-SHARED-SERVER-CONFIG WS-BROKER-CONFIG WS-CONTROLLER-CONFIG.

INITIALIZE-METRICS.
    CALL "CONFIGURE" USING WS-SHARED-SERVER-CONFIG.
    MOVE NEW Metrics TO WS-METRICS-REF.

INITIALIZE-RAFT-MANAGER.
    CALL "NEW" USING WS-META-PROPS-ENSEMBLE WS-TIME WS-METRICS-REF
                 WS-CONTROLLER-QUORUM-VOTERS-FUTURE WS-BOOTSTRAP-SERVERS
                 WS-SOCKET-FACTORY WS-RAFT-MANAGER-FAULT-HANDLER
                 RETURNING WS-RAFT-MANAGER.
    CALL "STARTUP" USING WS-RAFT-MANAGER.

INITIALIZE-METADATA-LOADER.
    CALL "NEW-BUILDER" USING WS-RAFT-MANAGER WS-TIME WS-METADATA-LOADER-METRICS
                        WS-METADATA-LOADER-FAULT-HANDLER
                        RETURNING WS-LOADER.

INITIALIZE-SNAPSHOT-EMITTER.
    CALL "NEW-BUILDER" USING WS-RAFT-MANAGER WS-SNAPSHOT-EMITTER-METRICS
                        RETURNING WS-SNAPSHOT-EMITTER.

INITIALIZE-SNAPSHOT-GENERATOR.
    CALL "NEW-BUILDER" USING WS-SNAPSHOT-EMITTER WS-TIME
                        WS-METADATA-PUBLISHING-FAULT-HANDLER
                        WS-SHARED-SERVER-CONFIG
                        RETURNING WS-SNAPSHOT-GENERATOR.

SHUTDOWN-LOADER.
    CALL "BEGIN-SHUTDOWN" USING WS-LOADER.
    CALL "CLOSE" USING WS-LOADER.

SHUTDOWN-SNAPSHOT-GENERATOR.
    CALL "BEGIN-SHUTDOWN" USING WS-SNAPSHOT-GENERATOR.
    CALL "CLOSE" USING WS-SNAPSHOT-GENERATOR.

SHUTDOWN-RAFT-MANAGER.
    CALL "SHUTDOWN" USING WS-RAFT-MANAGER.

SHUTDOWN-METRICS.
    CALL "CLOSE" USING WS-METRICS-REF.

ENSURE-NOT-RAFT-LEADER.
    IF WS-RAFT-MANAGER IS NOT NULL
        CALL "SHUTDOWN" USING WS-RAFT-MANAGER
        MOVE NULL TO WS-RAFT-MANAGER.

STOP RUN.