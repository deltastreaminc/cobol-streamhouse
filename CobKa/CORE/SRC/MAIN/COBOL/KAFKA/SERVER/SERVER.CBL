IDENTIFICATION DIVISION.
PROGRAM-ID. SERVER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY KAFKA-METRICS-CONTEXT.
    COPY KAFKA-METRICS-REPORTER.
    COPY KAFKA-METRICS.
    COPY KAFKA-COMMON-CONFIGS.
    COPY KAFKA-SENSOR.
    COPY KAFKA-CONFIG.
    COPY KAFKA-TIME.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 METRICS-PREFIX PIC X(15) VALUE 'kafka.server'.
01 CLUSTER-ID-LABEL PIC X(15) VALUE 'kafka.cluster.id'.
01 NODE-ID-LABEL PIC X(15) VALUE 'kafka.node.id'.
01 PROCESS-STATUS PIC X(13).
   88 SHUTDOWN VALUE 'SHUTDOWN'.
   88 STARTING VALUE 'STARTING'.
   88 STARTED VALUE 'STARTED'.
   88 SHUTTING-DOWN VALUE 'SHUTTING-DOWN'.

PROCEDURE DIVISION.

STARTUP.
    CALL "CREATE-KAFKA-METRICS-CONTEXT" USING KAFKA-CONFIG, CLUSTER-ID
        RETURNING KAFKA-METRICS-CONTEXT.
    CALL "BUILD-METRICS" USING KAFKA-CONFIG, KAFKA-TIME, KAFKA-METRICS-CONTEXT
        RETURNING KAFKA-METRICS.
    SET STARTING TO TRUE.

SHUTDOWN.
    SET SHUTTING-DOWN TO TRUE.
    PERFORM SHUTDOWN-TASKS.

SHUTDOWN-TASKS.
    PERFORM SHUTDOWN-CLEANUP.
    SET SHUTDOWN TO TRUE.

AWAIT-SHUTDOWN.
    PERFORM UNTIL SHUTDOWN
        CONTINUE
    END-PERFORM.

SHUTDOWN-CLEANUP.
    CALL "SHUTDOWN" IN SERVER.

CREATE-KAFKA-METRICS-CONTEXT.
    MOVE CLUSTER-ID TO CONTEXT-LABELS(CLUSTER-ID-LABEL).
    MOVE KAFKA-CONFIG-NODE-ID TO CONTEXT-LABELS(NODE-ID-LABEL).
    MOVE CONFIG-ORIGINALS-WITH-PREFIX(KAFKA-COMMON-CONFIGS-METRICS-CONTEXT-PREFIX)
        TO CONTEXT-LABELS.
    CREATE KAFKA-METRICS-CONTEXT USING METRICS-PREFIX, CONTEXT-LABELS.

BUILD-METRICS.
    CREATE METRIC-CONFIG USING KAFKA-CONFIG-METRIC-NUM-SAMPLES,
        KAFKA-SENSOR-RECORDING-LEVEL-FOR-NAME(KAFKA-CONFIG-METRIC-RECORDING-LEVEL),
        KAFKA-CONFIG-METRIC-SAMPLE-WINDOW-MS, TIME-UNIT-MILLISECONDS.
    CREATE KAFKA-METRICS USING METRIC-CONFIG, KAFKA-METRICS-REPORTER-LIST, KAFKA-TIME, TRUE, KAFKA-METRICS-CONTEXT.