IDENTIFICATION DIVISION.
PROGRAM-ID. LOGMANAGERBUILDER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY. 
    COPY KAFKA-CONFIG.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 PRODUCER-ID-EXPIRATION-CHECK-INTERVAL-MS PIC 9(9) VALUE 600000.
01 LOG-DIRS PIC X(256) OCCURS 1 TO 9999 TIMES DEPENDING ON LOGDIRSCOUNT.
01 LOGDIRSCOUNT PIC 9(4) VALUE 0.
01 INITIAL-OFFLINE-DIRS PIC X(256) OCCURS 1 TO 9999 TIMES DEPENDING ON INITIALOFFLINECOUNT.
01 INITIALOFFLINECOUNT PIC 9(4) VALUE 0.
01 CONFIG-REPOSITORY PIC X(256).
01 INITIAL-DEFAULT-CONFIG PIC X(256).
01 CLEANER-CONFIG PIC X(256).
01 RECOVERY-THREADS-PER-DATA-DIR PIC 9(4) VALUE 1.
01 FLUSH-CHECK-MS PIC 9(9) VALUE 1000.
01 FLUSH-RECOVERY-OFFSET-CHECKPOINT-MS PIC 9(9) VALUE 10000.
01 FLUSH-START-OFFSET-CHECKPOINT-MS PIC 9(9) VALUE 10000.
01 RETENTION-CHECK-MS PIC 9(9) VALUE 1000.
01 MAX-TRANSACTION-TIMEOUT-MS PIC 9(9) VALUE 900000.
01 PRODUCER-STATE-MANAGER-CONFIG.
   05 MAX-PRODUCER-ID-EXPIRATION-MS PIC 9(9) VALUE 60000.
   05 TRANSACTION-VERIFICATION-ENABLED PIC X(1) VALUE 'F'.
01 SCHEDULER PIC X(256).
01 BROKER-TOPIC-STATS PIC X(256).
01 LOG-DIR-FAILURE-CHANNEL PIC X(256).
01 TIME PIC X(256) VALUE 'SYSTEM'.
01 REMOTE-STORAGE-SYSTEM-ENABLE PIC X(1) VALUE 'F'.
01 INITIAL-TASK-DELAY-MS PIC 9(9) VALUE 0.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM SET-LOG-DIRS
    PERFORM SET-INITIAL-OFFLINE-DIRS 
    PERFORM SET-CONFIG-REPOSITORY
    PERFORM SET-INITIAL-DEFAULT-CONFIG
    PERFORM SET-CLEANER-CONFIG
    PERFORM SET-RECOVERY-THREADS-PER-DATA-DIR
    PERFORM SET-FLUSH-CHECK-MS
    PERFORM SET-FLUSH-RECOVERY-OFFSET-CHECKPOINT-MS
    PERFORM SET-FLUSH-START-OFFSET-CHECKPOINT-MS
    PERFORM SET-RETENTION-CHECK-MS
    PERFORM SET-MAX-TRANSACTION-TIMEOUT-MS
    PERFORM SET-PRODUCER-STATE-MANAGER-CONFIG
    PERFORM SET-SCHEDULER
    PERFORM SET-BROKER-TOPIC-STATS
    PERFORM SET-LOG-DIR-FAILURE-CHANNEL
    PERFORM SET-TIME
    PERFORM SET-REMOTE-STORAGE-SYSTEM-ENABLE
    PERFORM SET-INITIAL-TASK-DELAY-MS
    PERFORM BUILD-LOG-MANAGER.

SET-LOG-DIRS.
    IF LOGDIRS IS NULL
        RAISE RUNTIME-EXCEPTION "you must set logDirs"
    END-IF
    MOVE LOGDIRS TO LOG-DIRS
    COMPUTE LOGDIRSCOUNT = FUNCTION COUNT(LOG-DIRS).

SET-INITIAL-OFFLINE-DIRS.
    MOVE INITIAL-OFFLINE-DIRS TO INITIAL-OFFLINE-DIRS
    COMPUTE INITIALOFFLINECOUNT = FUNCTION COUNT(INITIAL-OFFLINE-DIRS).

SET-CONFIG-REPOSITORY.
    IF CONFIG-REPOSITORY IS NULL
        RAISE RUNTIME-EXCEPTION "you must set configRepository"
    END-IF
    MOVE CONFIG-REPOSITORY TO CONFIG-REPOSITORY.

SET-INITIAL-DEFAULT-CONFIG.
    IF INITIAL-DEFAULT-CONFIG IS NULL
        RAISE RUNTIME-EXCEPTION "you must set initialDefaultConfig"
    END-IF
    MOVE INITIAL-DEFAULT-CONFIG TO INITIAL-DEFAULT-CONFIG.

SET-CLEANER-CONFIG.
    IF CLEANER-CONFIG IS NULL
        RAISE RUNTIME-EXCEPTION "you must set cleanerConfig" 
    END-IF
    MOVE CLEANER-CONFIG TO CLEANER-CONFIG.

SET-RECOVERY-THREADS-PER-DATA-DIR.
    MOVE RECOVERY-THREADS-PER-DATA-DIR TO RECOVERY-THREADS-PER-DATA-DIR.

SET-FLUSH-CHECK-MS.
    MOVE FLUSH-CHECK-MS TO FLUSH-CHECK-MS.

SET-FLUSH-RECOVERY-OFFSET-CHECKPOINT-MS.
    MOVE FLUSH-RECOVERY-OFFSET-CHECKPOINT-MS TO FLUSH-RECOVERY-OFFSET-CHECKPOINT-MS.

SET-FLUSH-START-OFFSET-CHECKPOINT-MS.
    MOVE FLUSH-START-OFFSET-CHECKPOINT-MS TO FLUSH-START-OFFSET-CHECKPOINT-MS.

SET-RETENTION-CHECK-MS.
    MOVE RETENTION-CHECK-MS TO RETENTION-CHECK-MS.

SET-MAX-TRANSACTION-TIMEOUT-MS.
    MOVE MAX-TRANSACTION-TIMEOUT-MS TO MAX-TRANSACTION-TIMEOUT-MS.

SET-PRODUCER-STATE-MANAGER-CONFIG.
    MOVE MAX-PRODUCER-ID-EXPIRATION-MS TO MAX-PRODUCER-ID-EXPIRATION-MS
    MOVE TRANSACTION-VERIFICATION-ENABLED TO TRANSACTION-VERIFICATION-ENABLED.

SET-SCHEDULER.
    IF SCHEDULER IS NULL
        RAISE RUNTIME-EXCEPTION "you must set scheduler"
    END-IF
    MOVE SCHEDULER TO SCHEDULER.

SET-BROKER-TOPIC-STATS.
    IF BROKER-TOPIC-STATS IS NULL
        RAISE RUNTIME-EXCEPTION "you must set brokerTopicStats"
    END-IF
    MOVE BROKER-TOPIC-STATS TO BROKER-TOPIC-STATS.

SET-LOG-DIR-FAILURE-CHANNEL.
    IF LOG-DIR-FAILURE-CHANNEL IS NULL
        RAISE RUNTIME-EXCEPTION "you must set logDirFailureChannel"
    END-IF
    MOVE LOG-DIR-FAILURE-CHANNEL TO LOG-DIR-FAILURE-CHANNEL.

SET-TIME.
    MOVE TIME TO TIME.

SET-REMOTE-STORAGE-SYSTEM-ENABLE.
    MOVE REMOTE-STORAGE-SYSTEM-ENABLE TO REMOTE-STORAGE-SYSTEM-ENABLE.

SET-INITIAL-TASK-DELAY-MS.
    MOVE INITIAL-TASK-DELAY-MS TO INITIAL-TASK-DELAY-MS.

BUILD-LOG-MANAGER.
    CALL "LOGMANAGER" USING
         LOG-DIRS
         INITIAL-OFFLINE-DIRS 
         CONFIG-REPOSITORY
         INITIAL-DEFAULT-CONFIG
         CLEANER-CONFIG
         RECOVERY-THREADS-PER-DATA-DIR
         FLUSH-CHECK-MS
         FLUSH-RECOVERY-OFFSET-CHECKPOINT-MS
         FLUSH-START-OFFSET-CHECKPOINT-MS
         RETENTION-CHECK-MS
         MAX-TRANSACTION-TIMEOUT-MS
         PRODUCER-STATE-MANAGER-CONFIG
         PRODUCER-ID-EXPIRATION-CHECK-INTERVAL-MS
         SCHEDULER
         BROKER-TOPIC-STATS
         LOG-DIR-FAILURE-CHANNEL
         TIME
         REMOTE-STORAGE-SYSTEM-ENABLE
         INITIAL-TASK-DELAY-MS
    END-CALL.

STOP RUN.