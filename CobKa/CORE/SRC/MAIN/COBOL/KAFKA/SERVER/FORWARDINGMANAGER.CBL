IDENTIFICATION DIVISION.
PROGRAM-ID. FORWARDING-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY "KAFKA-NETWORK-REQUEST-CHANNEL".
    COPY "KAFKA-UTILS-LOGGING".
    COPY "APACHE-KAFKA-CLIENTS-CLIENT-RESPONSE".
    COPY "APACHE-KAFKA-CLIENTS-NODE-API-VERSIONS".
    COPY "APACHE-KAFKA-COMMON-ERRORS".
    COPY "APACHE-KAFKA-COMMON-REQUESTS".
    COPY "APACHE-KAFKA-SERVER-COMMON-CONTROLLER-REQUEST-COMPLETION-HANDLER".
    COPY "APACHE-KAFKA-SERVER-COMMON-NODE-TO-CONTROLLER-CHANNEL-MANAGER".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-FORWARDING-MANAGER-METRICS.
   05 WS-QUEUE-LENGTH PIC 9(9) COMP-5.
   05 WS-REMOTE-TIME-MS-HIST PIC 9(9) COMP-5.
   05 WS-QUEUE-TIME-MS-HIST PIC 9(9) COMP-5.

PROCEDURE DIVISION.

CLOSE-FORWARDING-MANAGER.
    PERFORM CLOSE-FORWARDING-MANAGER-METRICS.

CLOSE-FORWARDING-MANAGER-METRICS.
    CALL "CLOSE" USING WS-FORWARDING-MANAGER-METRICS.

FORWARD-REQUEST.
    MOVE FUNCTION DUPLICATE(ORIGINAL-REQUEST-BUFFER) TO WS-REQUEST-BUFFER-COPY.
    MOVE FUNCTION FLIP(WS-REQUEST-BUFFER-COPY) TO WS-REQUEST-BUFFER-COPY.
    PERFORM FORWARD-REQUEST-INTERNAL USING
        ORIGINAL-REQUEST-CONTEXT
        WS-REQUEST-BUFFER-COPY
        ORIGINAL-REQUEST-START-TIME-NANOS
        ORIGINAL-REQUEST-BODY
        ORIGINAL-REQUEST-TO-STRING-CALLBACK
        RESPONSE-CALLBACK.

FORWARD-REQUEST-INTERNAL.
    MOVE FUNCTION BUILD-ENVELOPE-REQUEST(
        REQUEST-CONTEXT,
        REQUEST-BUFFER-COPY) TO WS-ENVELOPE-REQUEST.
    MOVE FUNCTION TIME-UNIT-NANOSECONDS-TO-MILLISECONDS(REQUEST-CREATION-NS) TO WS-REQUEST-CREATION-TIME-MS.

    PERFORM FORWARD-REQUEST-RESPONSE-HANDLER.

FORWARD-REQUEST-RESPONSE-HANDLER.
    SUBTRACT 1 FROM WS-QUEUE-LENGTH.
    PERFORM RECORD-REMOTE-TIME-MS USING CLIENT-RESPONSE-REQUEST-LATENCY-MS.
    PERFORM RECORD-QUEUE-TIME-MS USING
        CLIENT-RESPONSE-RECEIVED-TIME-MS - CLIENT-RESPONSE-REQUEST-LATENCY-MS - WS-REQUEST-CREATION-TIME-MS.

    IF CLIENT-RESPONSE-VERSION-MISMATCH IS NOT NULL
        PERFORM LOG-DEBUG USING "Returning `UNKNOWN_SERVER_ERROR` in response to" ORIGINAL-REQUEST-TO-STRING "due to unexpected version error" CLIENT-RESPONSE-VERSION-MISMATCH
        MOVE FUNCTION GET-ERROR-RESPONSE(ORIGINAL-REQUEST-BODY, APACHE-KAFKA-COMMON-ERRORS-UNKNOWN-SERVER-ERROR-EXCEPTION) TO WS-RESPONSE
        PERFORM RESPONSE-CALLBACK USING WS-RESPONSE
    ELSE IF CLIENT-RESPONSE-AUTHENTICATION-EXCEPTION IS NOT NULL
        PERFORM LOG-DEBUG USING "Returning `UNKNOWN_SERVER_ERROR` in response to" ORIGINAL-REQUEST-TO-STRING "due to authentication error" CLIENT-RESPONSE-AUTHENTICATION-EXCEPTION  
        MOVE FUNCTION GET-ERROR-RESPONSE(ORIGINAL-REQUEST-BODY, APACHE-KAFKA-COMMON-ERRORS-UNKNOWN-SERVER-ERROR-EXCEPTION) TO WS-RESPONSE
        PERFORM RESPONSE-CALLBACK USING WS-RESPONSE
    ELSE
        MOVE FUNCTION CAST(CLIENT-RESPONSE-BODY, ENVELOPE-RESPONSE) TO WS-ENVELOPE-RESPONSE
        MOVE FUNCTION GET-ENVELOPE-ERROR(WS-ENVELOPE-RESPONSE) TO WS-ENVELOPE-ERROR

        IF WS-ENVELOPE-ERROR = APACHE-KAFKA-COMMON-ERRORS-UNSUPPORTED-VERSION
            PERFORM RESPONSE-CALLBACK USING NULL
        ELSE
            IF WS-ENVELOPE-ERROR NOT = APACHE-KAFKA-COMMON-ERRORS-NONE
                PERFORM LOG-DEBUG USING "Forwarded request" ORIGINAL-REQUEST-TO-STRING "failed with an error in the envelope response" WS-ENVELOPE-ERROR
                MOVE FUNCTION GET-ERROR-RESPONSE(ORIGINAL-REQUEST-BODY, APACHE-KAFKA-COMMON-ERRORS-UNKNOWN-SERVER-ERROR-EXCEPTION) TO WS-RESPONSE
            ELSE
                PERFORM PARSE-RESPONSE USING
                    FUNCTION GET-ENVELOPE-RESPONSE-DATA(WS-ENVELOPE-RESPONSE)
                    ORIGINAL-REQUEST-BODY
                    ORIGINAL-REQUEST-HEADER
                    INTO WS-RESPONSE
            END-IF
            PERFORM RESPONSE-CALLBACK USING WS-RESPONSE
        END-IF
    END-IF.

RECORD-REMOTE-TIME-MS.
    MOVE ARGUMENT-VALUE TO WS-REMOTE-TIME-MS-HIST.

RECORD-QUEUE-TIME-MS.
    MOVE ARGUMENT-VALUE TO WS-QUEUE-TIME-MS-HIST.

PARSE-RESPONSE.
    TRY
        MOVE FUNCTION PARSE-RESPONSE(ARGUMENT-1, ARGUMENT-2, ARGUMENT-3) TO ARGUMENT-4
    CATCH EXCEPTION
        PERFORM LOG-ERROR USING "Failed to parse response from envelope for request with header" ARGUMENT-3 EXCEPTION-OBJECT
        MOVE FUNCTION GET-ERROR-RESPONSE(ARGUMENT-2, APACHE-KAFKA-COMMON-ERRORS-UNKNOWN-SERVER-ERROR-EXCEPTION) TO ARGUMENT-4
    END-TRY.