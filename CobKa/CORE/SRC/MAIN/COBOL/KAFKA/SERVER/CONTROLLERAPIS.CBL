IDENTIFICATION DIVISION.
PROGRAM-ID. CONTROLLERAPIS.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

DATA DIVISION.
FILE SECTION.

WORKING-STORAGE SECTION.
01 REQUEST-CHANNEL PIC X(10).
01 AUTHORIZER PIC X(10).
01 QUOTAS PIC X(10).
01 TIME PIC X(10).
01 CONTROLLER PIC X(10).
01 RAFT-MANAGER PIC X(10).
01 CONFIG PIC X(10).
01 CLUSTER-ID PIC X(10).
01 REGISTRATIONS-PUBLISHER PIC X(10).
01 API-VERSION-MANAGER PIC X(10).
01 METADATA-CACHE PIC X(10).

01 AUTH-HELPER PIC X(10).
01 CONFIG-HELPER PIC X(10).
01 REQUEST-HELPER PIC X(10).
01 RUNTIME-LOGGER-MANAGER PIC X(10).
01 ACL-APIS PIC X(10).

PROCEDURE DIVISION.

MAIN-PROCEDURE.
    DISPLAY "IDENTIFICATION DIVISION."
    DISPLAY "PROGRAM-ID. CONTROLLERAPIS."

    DISPLAY "ENVIRONMENT DIVISION."
    DISPLAY "CONFIGURATION SECTION."
    DISPLAY "INPUT-OUTPUT SECTION."
    DISPLAY "FILE-CONTROL."

    DISPLAY "DATA DIVISION."
    DISPLAY "FILE SECTION."

    DISPLAY "WORKING-STORAGE SECTION."
    DISPLAY "01 REQUEST-CHANNEL PIC X(10)."
    DISPLAY "01 AUTHORIZER PIC X(10)."
    DISPLAY "01 QUOTAS PIC X(10)."
    DISPLAY "01 TIME PIC X(10)."
    DISPLAY "01 CONTROLLER PIC X(10)."
    DISPLAY "01 RAFT-MANAGER PIC X(10)."
    DISPLAY "01 CONFIG PIC X(10)."
    DISPLAY "01 CLUSTER-ID PIC X(10)."
    DISPLAY "01 REGISTRATIONS-PUBLISHER PIC X(10)."
    DISPLAY "01 API-VERSION-MANAGER PIC X(10)."
    DISPLAY "01 METADATA-CACHE PIC X(10)."

    DISPLAY "01 AUTH-HELPER PIC X(10)."
    DISPLAY "01 CONFIG-HELPER PIC X(10)."
    DISPLAY "01 REQUEST-HELPER PIC X(10)."
    DISPLAY "01 RUNTIME-LOGGER-MANAGER PIC X(10)."
    DISPLAY "01 ACL-APIS PIC X(10)."

    DISPLAY "PROCEDURE DIVISION."

    DISPLAY "MAIN-PROCEDURE."
    DISPLAY "    PERFORM HANDLE-REQUEST."
    DISPLAY "    STOP RUN."

    STOP RUN.

HANDLE-REQUEST.
    PERFORM HANDLE-FETCH.
    PERFORM HANDLE-FETCH-SNAPSHOT.
    PERFORM HANDLE-CREATE-TOPICS.
    PERFORM HANDLE-DELETE-TOPICS.
    PERFORM HANDLE-API-VERSIONS-REQUEST.
    PERFORM HANDLE-LEGACY-ALTER-CONFIGS.
    PERFORM HANDLE-VOTE.
    PERFORM HANDLE-BEGIN-QUORUM-EPOCH.
    PERFORM HANDLE-END-QUORUM-EPOCH.
    PERFORM HANDLE-DESCRIBE-QUORUM.
    PERFORM HANDLE-ALTER-PARTITION-REQUEST.
    PERFORM HANDLE-BROKER-REGISTRATION.
    PERFORM HANDLE-BROKER-HEARTBEAT-REQUEST.
    PERFORM HANDLE-UNREGISTER-BROKER.
    PERFORM HANDLE-ALTER-CLIENT-QUOTAS.
    PERFORM HANDLE-INCREMENTAL-ALTER-CONFIGS.
    PERFORM HANDLE-ALTER-PARTITION-REASSIGNMENTS.
    PERFORM HANDLE-LIST-PARTITION-REASSIGNMENTS.
    PERFORM HANDLE-ALTER-USER-SCRAM-CREDENTIALS.
    PERFORM HANDLE-CREATE-DELEGATION-TOKEN-REQUEST.
    PERFORM HANDLE-RENEW-DELEGATION-TOKEN-REQUEST.
    PERFORM HANDLE-EXPIRE-DELEGATION-TOKEN-REQUEST.
    PERFORM HANDLE-ENVELOPE-REQUEST.
    PERFORM HANDLE-SASL-HANDSHAKE-REQUEST.
    PERFORM HANDLE-SASL-AUTHENTICATE-REQUEST.
    PERFORM HANDLE-ALLOCATE-PRODUCER-IDS-REQUEST.
    PERFORM HANDLE-CREATE-PARTITIONS.
    PERFORM HANDLE-DESCRIBE-CONFIGS-REQUEST.
    PERFORM HANDLE-DESCRIBE-ACLS.
    PERFORM HANDLE-CREATE-ACLS.
    PERFORM HANDLE-DELETE-ACLS.
    PERFORM HANDLE-ELECT-LEADERS.
    PERFORM HANDLE-UPDATE-FEATURES.
    PERFORM HANDLE-DESCRIBE-CLUSTER.
    PERFORM HANDLE-CONTROLLER-REGISTRATION.
    PERFORM HANDLE-ASSIGN-REPLICAS-TO-DIRS.
    PERFORM HANDLE-ADD-RAFT-VOTER.
    PERFORM HANDLE-REMOVE-RAFT-VOTER.
    PERFORM HANDLE-UPDATE-RAFT-VOTER.

HANDLE-FETCH.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, CLUSTER-ACTION.
    CALL HANDLE-RAFT-REQUEST USING REQUEST, "FETCH-RESPONSE".

HANDLE-FETCH-SNAPSHOT.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, CLUSTER-ACTION.
    CALL HANDLE-RAFT-REQUEST USING REQUEST, "FETCH-SNAPSHOT-RESPONSE".

HANDLE-CREATE-TOPICS.
    CALL AUTH-HELPER "AUTHORIZE" USING REQUEST-CONTEXT, CREATE, CLUSTER, CLUSTER-NAME, FALSE.
    CALL CREATE-TOPICS USING REQUEST-CONTEXT, REQUEST-DATA, AUTH-HELPER "AUTHORIZE" USING REQUEST-CONTEXT, CREATE, TOPIC, NAMES, IDENTITY, AUTH-HELPER "AUTHORIZE" USING REQUEST-CONTEXT, DESCRIBE-CONFIGS, TOPIC, NAMES, FALSE, IDENTITY.

HANDLE-DELETE-TOPICS.
    CALL DELETE-TOPICS USING REQUEST-CONTEXT, REQUEST-DATA, REQUEST-CONTEXT-API-VERSION, AUTH-HELPER "AUTHORIZE" USING REQUEST-CONTEXT, DELETE, CLUSTER, CLUSTER-NAME, FALSE, AUTH-HELPER "FILTER-BY-AUTHORIZED" USING REQUEST-CONTEXT, DESCRIBE, TOPIC, NAMES, IDENTITY, AUTH-HELPER "FILTER-BY-AUTHORIZED" USING REQUEST-CONTEXT, DELETE, TOPIC, NAMES, IDENTITY.

HANDLE-API-VERSIONS-REQUEST.
    CALL API-VERSION-MANAGER "API-VERSION-RESPONSE" USING REQUEST-THROTTLE-MS, REQUEST-CONTEXT-API-VERSION-LESS-THAN-4.

HANDLE-LEGACY-ALTER-CONFIGS.
    CALL CONFIG-HELPER "HANDLE-DESCRIBE-CONFIGS-REQUEST" USING REQUEST, AUTH-HELPER.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST, REQUEST-THROTTLE-MS, RESULT.

HANDLE-VOTE.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, CLUSTER-ACTION.
    CALL HANDLE-RAFT-REQUEST USING REQUEST, "VOTE-RESPONSE".

HANDLE-BEGIN-QUORUM-EPOCH.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, CLUSTER-ACTION.
    CALL HANDLE-RAFT-REQUEST USING REQUEST, "BEGIN-QUORUM-EPOCH-RESPONSE".

HANDLE-END-QUORUM-EPOCH.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, CLUSTER-ACTION.
    CALL HANDLE-RAFT-REQUEST USING REQUEST, "END-QUORUM-EPOCH-RESPONSE".

HANDLE-DESCRIBE-QUORUM.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, DESCRIBE.
    CALL HANDLE-RAFT-REQUEST USING REQUEST, "DESCRIBE-QUORUM-RESPONSE".

HANDLE-ALTER-PARTITION-REQUEST.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, CLUSTER-ACTION.
    CALL CONTROLLER "ALTER-PARTITION" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-EXEMPT-THROTTLE" USING REQUEST, RESULT.

HANDLE-BROKER-REGISTRATION.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, CLUSTER-ACTION.
    CALL CONTROLLER "REGISTER-BROKER" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-BROKER-HEARTBEAT-REQUEST.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, CLUSTER-ACTION.
    CALL CONTROLLER "PROCESS-BROKER-HEARTBEAT" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-UNREGISTER-BROKER.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, ALTER.
    CALL CONTROLLER "UNREGISTER-BROKER" USING REQUEST-CONTEXT, REQUEST-DATA-BROKER-ID.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-ALTER-CLIENT-QUOTAS.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, ALTER-CONFIGS.
    CALL CONTROLLER "ALTER-CLIENT-QUOTAS" USING REQUEST-CONTEXT, REQUEST-ENTRIES, REQUEST-VALIDATE-ONLY.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-INCREMENTAL-ALTER-CONFIGS.
    CALL CONFIG-HELPER "HANDLE-INCREMENTAL-ALTER-CONFIGS" USING REQUEST, AUTH-HELPER.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-ALTER-PARTITION-REASSIGNMENTS.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, ALTER.
    CALL CONTROLLER "ALTER-PARTITION-REASSIGNMENTS" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-LIST-PARTITION-REASSIGNMENTS.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, DESCRIBE.
    CALL CONTROLLER "LIST-PARTITION-REASSIGNMENTS" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-ALTER-USER-SCRAM-CREDENTIALS.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, ALTER.
    CALL CONTROLLER "ALTER-USER-SCRAM-CREDENTIALS" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-CREATE-DELEGATION-TOKEN-REQUEST.
    CALL CONTROLLER "CREATE-DELEGATION-TOKEN" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-RENEW-DELEGATION-TOKEN-REQUEST.
    CALL CONTROLLER "RENEW-DELEGATION-TOKEN" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-EXPIRE-DELEGATION-TOKEN-REQUEST.
    CALL CONTROLLER "EXPIRE-DELEGATION-TOKEN" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-ENVELOPE-REQUEST.
    CALL AUTH-HELPER "AUTHORIZE" USING REQUEST-CONTEXT, CLUSTER-ACTION, CLUSTER, CLUSTER-NAME.
    CALL ENVELOPE-UTILS "HANDLE-ENVELOPE-REQUEST" USING REQUEST, REQUEST-CHANNEL-METRICS, HANDLE.

HANDLE-SASL-HANDSHAKE-REQUEST.
    MOVE SASL-HANDSHAKE-RESPONSE-DATA TO RESPONSE-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST, RESPONSE.

HANDLE-SASL-AUTHENTICATE-REQUEST.
    MOVE SASL-AUTHENTICATE-RESPONSE-DATA TO RESPONSE-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST, RESPONSE.

HANDLE-ALLOCATE-PRODUCER-IDS-REQUEST.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, CLUSTER-ACTION.
    CALL CONTROLLER "ALLOCATE-PRODUCER-IDS" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-CREATE-PARTITIONS.
    CALL CREATE-PARTITIONS USING REQUEST-CONTEXT, REQUEST-DATA, AUTH-HELPER "FILTER-BY-AUTHORIZED" USING REQUEST-CONTEXT, ALTER, TOPIC, NAMES, IDENTITY.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE-WITH-CONTROLLER-QUOTA" USING CONTROLLER-MUTATION-QUOTA, REQUEST, RESULT.

HANDLE-DESCRIBE-CONFIGS-REQUEST.
    CALL CONFIG-HELPER "HANDLE-DESCRIBE-CONFIGS-REQUEST" USING REQUEST, AUTH-HELPER.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-DESCRIBE-ACLS.
    CALL ACL-APIS "HANDLE-DESCRIBE-ACLS" USING REQUEST.

HANDLE-CREATE-ACLS.
    CALL ACL-APIS "HANDLE-CREATE-ACLS" USING REQUEST.

HANDLE-DELETE-ACLS.
    CALL ACL-APIS "HANDLE-DELETE-ACLS" USING REQUEST.

HANDLE-ELECT-LEADERS.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, ALTER.
    CALL CONTROLLER "ELECT-LEADERS" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-UPDATE-FEATURES.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, ALTER.
    CALL CONTROLLER "UPDATE-FEATURES" USING REQUEST-CONTEXT, REQUEST-DATA.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE" USING REQUEST-THROTTLE-MS, RESULT.

HANDLE-DESCRIBE-CLUSTER.
    CALL AUTH-HELPER "AUTHORIZE-CLUSTER-OPERATION" USING REQUEST, ALTER.
    CALL AUTH-HELPER "COMPUTE-DESCRIBE-CLUSTER-RESPONSE" USING REQUEST, END-POINT-TYPE-CONTROLLER, CLUSTER-ID, REGISTRATIONS-PUBLISHER "DESCRIBE-CLUSTER-CONTROLLERS" USING REQUEST-CONTEXT-LISTENER-NAME, RAFT-MANAGER "LEADER-AND-EPOCH" "LEADER-ID" USING.
    CALL REQUEST-HELPER "SEND-RESPONSE-MAYBE-THROTTLE"