IDENTIFICATION DIVISION.
PROGRAM-ID. ALTER-PARTITION-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC FUNCTIONS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-TOPIC-ID-PARTITION.
   05 WS-TOPIC-ID      PIC X(36).
   05 WS-PARTITION-ID  PIC 9(9) COMP.
01 WS-LEADER-AND-ISR.
   05 WS-LEADER-ID     PIC 9(9) COMP.
   05 WS-LEADER-EPOCH  PIC 9(9) COMP.
   05 WS-ISR           PIC 9(9) COMP OCCURS 0 TO 10 TIMES DEPENDING ON WS-ISR-COUNT.
   05 WS-ISR-COUNT     PIC 9(9) COMP.
   05 WS-LEADER-RECOVERY-STATE PIC 9(9) COMP.
   05 WS-PARTITION-EPOCH PIC 9(9) COMP.
01 WS-ALTER-PARTITION-ITEM.
   05 WS-TOPIC-ID-PARTITION    REDEFINES WS-TOPIC-ID-PARTITION.
   05 WS-LEADER-AND-ISR        REDEFINES WS-LEADER-AND-ISR.
   05 WS-FUTURE               PIC X(36).
01 WS-INFLIGHT-REQUEST        PIC X(1) VALUE "N".
    88 WS-INFLIGHT-REQUEST-ON  VALUE "Y".
    88 WS-INFLIGHT-REQUEST-OFF VALUE "N".
01 WS-BROKER-EPOCH            PIC 9(18) COMP-3.

PROCEDURE DIVISION.

START-PROCEDURE.
    CALL "CONTROLLER-CHANNEL-MANAGER-START".

SHUTDOWN-PROCEDURE.
    CALL "CONTROLLER-CHANNEL-MANAGER-SHUTDOWN".

SUBMIT-PROCEDURE.
    MOVE FUNCTION NATIONAL-RANDOM(36) TO WS-FUTURE.
    MOVE FUNCTION NATIONAL-RANDOM(36) TO WS-TOPIC-ID.
    MOVE FUNCTION RANDOM(9) TO WS-PARTITION-ID.
    MOVE FUNCTION RANDOM(9) TO WS-LEADER-ID.
    MOVE FUNCTION RANDOM(9) TO WS-LEADER-EPOCH.
    MOVE FUNCTION RANDOM(10) TO WS-ISR-COUNT.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > WS-ISR-COUNT
        MOVE FUNCTION RANDOM(9) TO WS-ISR(I)
    END-PERFORM.
    MOVE FUNCTION RANDOM(9) TO WS-LEADER-RECOVERY-STATE.
    MOVE FUNCTION RANDOM(9) TO WS-PARTITION-EPOCH.
    MOVE WS-TOPIC-ID-PARTITION TO WS-TOPIC-ID-PARTITION OF WS-ALTER-PARTITION-ITEM.
    MOVE WS-LEADER-AND-ISR TO WS-LEADER-AND-ISR OF WS-ALTER-PARTITION-ITEM.
    MOVE WS-FUTURE TO WS-FUTURE OF WS-ALTER-PARTITION-ITEM.

    IF WS-INFLIGHT-REQUEST-OFF
        SET WS-INFLIGHT-REQUEST-ON TO TRUE
        PERFORM SEND-REQUEST-PROCEDURE
    ELSE
        MOVE WS-ALTER-PARTITION-ITEM TO UNSENTISRUPDATES(WS-TOPIC-ID-PARTITION)
    END-IF.

SEND-REQUEST-PROCEDURE.
    MOVE FUNCTION RANDOM(18) TO WS-BROKER-EPOCH.
    PERFORM BUILD-REQUEST-PROCEDURE.
    CALL "CONTROLLER-CHANNEL-MANAGER-SEND-REQUEST"
        USING WS-REQUEST, CONTROLLER-REQUEST-COMPLETION-HANDLER.

CONTROLLER-REQUEST-COMPLETION-HANDLER.
    IF RESPONSE-AUTHENTICATION-EXCEPTION NOT EQUAL ZERO
        MOVE ERRORS-NETWORK-EXCEPTION TO WS-ERROR-CODE
    ELSE IF RESPONSE-VERSION-MISMATCH NOT EQUAL ZERO
        MOVE ERRORS-UNSUPPORTED-VERSION TO WS-ERROR-CODE
    ELSE
        PERFORM HANDLE-ALTER-PARTITION-RESPONSE-PROCEDURE
            USING RESPONSE-BODY, WS-BROKER-EPOCH, WS-ALTER-PARTITION-ITEMS
    END-IF.

    IF WS-ERROR-CODE EQUAL ERRORS-NONE
        PERFORM MAYBE-PROPAGATE-ISR-CHANGES-PROCEDURE
    ELSE
        CALL "SCHEDULER-SCHEDULE-ONCE"
            USING "SEND-ALTER-PARTITION", MAYBE-PROPAGATE-ISR-CHANGES-PROCEDURE, 50
    END-IF.

    SET WS-INFLIGHT-REQUEST-OFF TO TRUE.

HANDLE-ALTER-PARTITION-RESPONSE-PROCEDURE.
    PERFORM VARYING TOPIC-DATA IN RESPONSE-TOPICS
        PERFORM VARYING PARTITION-DATA IN TOPIC-DATA-PARTITIONS
            MOVE TOPIC-DATA-TOPIC-ID TO WS-TOPIC-ID
            MOVE PARTITION-DATA-PARTITION-INDEX TO WS-PARTITION-ID
            MOVE NEW-ISR-WITH-EPOCHS TO WS-ISR
            MOVE PARTITION-DATA-LEADER-EPOCH TO WS-LEADER-EPOCH
            MOVE PARTITION-DATA-PARTITION-EPOCH TO WS-PARTITION-EPOCH
            MOVE PARTITION-DATA-LEADER-RECOVERY-STATE TO WS-LEADER-RECOVERY-STATE
            IF PARTITION-DATA-ERROR-CODE EQUAL ERRORS-NONE
                MOVE WS-TOPIC-ID-PARTITION TO WS-TOPIC-ID-PARTITION OF WS-ALTER-PARTITION-ITEM
                MOVE WS-LEADER-AND-ISR TO WS-LEADER-AND-ISR OF WS-ALTER-PARTITION-ITEM
                MOVE WS-FUTURE TO WS-FUTURE OF WS-ALTER-PARTITION-ITEM
                PERFORM PROCESS-PARTITION-RESPONSE-PROCEDURE
            ELSE
                MOVE PARTITION-DATA-ERROR-CODE TO WS-ERROR-CODE
                PERFORM PROCESS-PARTITION-RESPONSE-PROCEDURE
            END-IF
        END-PERFORM
    END-PERFORM.

PROCESS-PARTITION-RESPONSE-PROCEDURE.
    REMOVE WS-ALTER-PARTITION-ITEM FROM UNSENTISRUPDATES(WS-TOPIC-ID-PARTITION).
    IF WS-ERROR-CODE EQUAL ERRORS-NONE
        MOVE WS-LEADER-AND-ISR TO WS-LEADER-AND-ISR OF WS-ALTER-PARTITION-ITEM
        CALL "FUTURE-COMPLETE" USING WS-FUTURE, WS-LEADER-AND-ISR
    ELSE
        CALL "FUTURE-COMPLETE-EXCEPTIONALLY" USING WS-FUTURE, WS-ERROR-CODE
    END-IF.

BUILD-REQUEST-PROCEDURE.
    MOVE BROKERED TO WS-REQUEST-BROKER-ID.
    MOVE WS-BROKER-EPOCH TO WS-REQUEST-BROKER-EPOCH.
    PERFORM VARYING ITEM IN WS-ALTER-PARTITION-ITEMS
        MOVE ITEM-TOPIC-ID TO WS-REQUEST-TOPIC-ID
        MOVE ITEM-PARTITION-ID TO WS-REQUEST-PARTITION-INDEX
        MOVE ITEM-LEADER-EPOCH TO WS-REQUEST-LEADER-EPOCH
        MOVE ITEM-ISR TO WS-REQUEST-ISR
        MOVE ITEM-PARTITION-EPOCH TO WS-REQUEST-PARTITION-EPOCH
        MOVE ITEM-LEADER-RECOVERY-STATE TO WS-REQUEST-LEADER-RECOVERY-STATE
        ADD WS-REQUEST-PARTITION TO WS-REQUEST-TOPIC
    END-PERFORM.
    MOVE WS-REQUEST-TOPIC TO WS-REQUEST-TOPICS.
    MOVE WS-REQUEST TO ALTER-PARTITION-REQUEST.

MAYBE-PROPAGATE-ISR-CHANGES-PROCEDURE.
    IF NOT UNSENTISRUPDATES IS EMPTY AND WS-INFLIGHT-REQUEST-OFF
        SET WS-INFLIGHT-REQUEST-ON TO TRUE
        PERFORM SEND-REQUEST-PROCEDURE
    END-IF.