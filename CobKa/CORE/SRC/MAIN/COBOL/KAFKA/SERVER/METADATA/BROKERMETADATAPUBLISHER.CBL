IDENTIFICATION DIVISION.
PROGRAM-ID. BROKER-METADATA-PUBLISHER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT TRANSACTION-TOPIC
        ASSIGN TO DYNAMIC TRANSACTION-STATE-TOPIC-NAME
        ORGANIZATION IS SEQUENTIAL.
    SELECT SHARE-GROUP-TOPIC
        ASSIGN TO DYNAMIC SHARE-GROUP-STATE-TOPIC-NAME
        ORGANIZATION IS SEQUENTIAL.
    SELECT GROUP-TOPIC
        ASSIGN TO DYNAMIC GROUP-METADATA-TOPIC-NAME
        ORGANIZATION IS SEQUENTIAL.

DATA DIVISION.
FILE SECTION.
FD  TRANSACTION-TOPIC.
01  TRANSACTION-TOPIC-RECORD.
    05  TRANSACTION-TOPIC-NAME         PIC X(128).
    05  TRANSACTION-TOPIC-PARTITION    PIC 9(9) BINARY.
    05  TRANSACTION-TOPIC-LEADER-EPOCH PIC 9(9) BINARY.

FD  SHARE-GROUP-TOPIC.
01  SHARE-GROUP-TOPIC-RECORD.
    05  SHARE-GROUP-TOPIC-NAME         PIC X(128).
    05  SHARE-GROUP-TOPIC-PARTITION    PIC 9(9) BINARY.
    05  SHARE-GROUP-TOPIC-LEADER-EPOCH PIC 9(9) BINARY.

FD  GROUP-TOPIC.
01  GROUP-TOPIC-RECORD.
    05  GROUP-TOPIC-NAME               PIC X(128).
    05  GROUP-TOPIC-PARTITION          PIC 9(9) BINARY.
    05  GROUP-TOPIC-LEADER-EPOCH       PIC 9(9) BINARY.

WORKING-STORAGE SECTION.
01  FIRST-PUBLISH                      PIC X(1) VALUE 'Y'.
01  FIRST-PUBLISH-FUTURE              PIC X(1) VALUE 'N'.
01  BROKER-ID                          PIC 9(9) BINARY.
01  HIGHEST-OFFSET-AND-EPOCH.
    05  HIGHEST-OFFSET                 PIC 9(18) BINARY.
    05  HIGHEST-EPOCH                  PIC 9(9) BINARY.
01  METADATA-VERSION                   PIC 9(9) BINARY.
01  DELETED-TOPIC-PARTITIONS.
    05  DELETED-TOPIC-COUNT            PIC 9(9) BINARY.
    05  DELETED-TOPIC-PARTITION-TABLE.
        10 DELETED-TOPIC-NAME          PIC X(128) OCCURS 9999 TIMES.
        10 DELETED-TOPIC-PARTITION     PIC 9(9) BINARY OCCURS 9999 TIMES.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM INITIALIZE-MANAGERS.
    PERFORM PROCESS-METADATA-UPDATE.
    PERFORM FINISH-INITIALIZING-REPLICA-MANAGER.
    PERFORM CLOSE-PUBLISHER.
    STOP RUN.

INITIALIZE-MANAGERS.
    PERFORM START-LOG-MANAGER.
    PERFORM START-REPLICA-MANAGER.
    PERFORM START-GROUP-COORDINATOR.
    PERFORM START-TRANSACTION-COORDINATOR.
    PERFORM START-SHARE-COORDINATOR.

START-LOG-MANAGER.
    CALL "LOGMANAGER-STARTUP" USING METADATA-CACHE-ALL-TOPICS, BROKER-ID, METADATA-IMAGE.
    CALL "LOGMANAGER-RECOVER-ABANDONED-FUTURE-LOGS" USING BROKER-ID, METADATA-IMAGE-TOPICS.

START-REPLICA-MANAGER.
    CALL "REPLICAMANAGER-STARTUP".

START-GROUP-COORDINATOR.
    CALL "GROUPCOORDINATOR-STARTUP" USING METADATA-CACHE-GET-NUM-PARTITIONS, DYNAMIC-GROUP-TOPIC-PARTITIONS.

START-TRANSACTION-COORDINATOR.
    CALL "TRANSACTIONCOORDINATOR-STARTUP" USING METADATA-CACHE-GET-NUM-PARTITIONS, DYNAMIC-TRANSACTION-TOPIC-PARTITIONS.

START-SHARE-COORDINATOR.
    CALL "SHARECOORDINATOR-STARTUP" USING METADATA-CACHE-GET-NUM-PARTITIONS, DYNAMIC-SHARE-TOPIC-PARTITIONS.

PROCESS-METADATA-UPDATE.
    PERFORM PUBLISH-METADATA-IMAGE.
    PERFORM APPLY-TOPIC-DELTA.
    PERFORM APPLY-CONFIG-DELTA.
    PERFORM APPLY-QUOTA-DELTA.
    PERFORM APPLY-SCRAM-DELTA.
    PERFORM APPLY-DELEGATION-TOKEN-DELTA.
    PERFORM APPLY-ACL-DELTA.
    PERFORM PROPAGATE-NEW-IMAGE.

PUBLISH-METADATA-IMAGE.
    IF FIRST-PUBLISH = 'Y'
        MOVE HIGHEST-OFFSET-AND-EPOCH TO METADATA-IMAGE
        MOVE METADATA-VERSION TO METADATA-VERSION-LOG-MSG
        MOVE 'N' TO FIRST-PUBLISH
        MOVE 'Y' TO FIRST-PUBLISH-FUTURE
    ELSE
        MOVE HIGHEST-OFFSET-AND-EPOCH TO METADATA-IMAGE
        MOVE METADATA-VERSION TO METADATA-VERSION-LOG-MSG.

APPLY-TOPIC-DELTA.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > DELETED-TOPIC-COUNT
        MOVE DELETED-TOPIC-NAME(I) TO TOPIC-NAME
        MOVE DELETED-TOPIC-PARTITION(I) TO TOPIC-PARTITION
        CALL "GROUPCOORDINATOR-ON-PARTITIONS-DELETED" USING TOPIC-NAME, TOPIC-PARTITION
    END-PERFORM.
    PERFORM VARYING EACH-TOPIC IN METADATA-IMAGE-TOPICS
        CALL "REPLICAMANAGER-APPLY-DELTA" USING EACH-TOPIC
        CALL "GROUPCOORDINATOR-ON-ELECTION" USING EACH-TOPIC-PARTITION, EACH-TOPIC-LEADER-EPOCH
        CALL "GROUPCOORDINATOR-ON-RESIGNATION" USING EACH-TOPIC-PARTITION, EACH-TOPIC-LEADER-EPOCH
        CALL "TRANSACTIONCOORDINATOR-ON-ELECTION" USING EACH-TOPIC-PARTITION, EACH-TOPIC-LEADER-EPOCH
        CALL "TRANSACTIONCOORDINATOR-ON-RESIGNATION" USING EACH-TOPIC-PARTITION, EACH-TOPIC-LEADER-EPOCH
        IF SHARE-COORDINATOR-ENABLED
            CALL "SHARECOORDINATOR-ON-ELECTION" USING EACH-TOPIC-PARTITION, EACH-TOPIC-LEADER-EPOCH
            CALL "SHARECOORDINATOR-ON-RESIGNATION" USING EACH-TOPIC-PARTITION, EACH-TOPIC-LEADER-EPOCH
        END-IF
    END-PERFORM.

APPLY-CONFIG-DELTA.
    CALL "DYNAMICCONFIG-PUBLISHER-ON-METADATA-UPDATE" USING METADATA-DELTA, METADATA-IMAGE.

APPLY-QUOTA-DELTA.
    CALL "DYNAMICCLIENTQUOTA-PUBLISHER-ON-METADATA-UPDATE" USING METADATA-DELTA, METADATA-IMAGE.
    CALL "DYNAMICTOPICCLUSTERQUOTA-PUBLISHER-ON-METADATA-UPDATE" USING METADATA-DELTA, METADATA-IMAGE.

APPLY-SCRAM-DELTA.
    CALL "SCRAM-PUBLISHER-ON-METADATA-UPDATE" USING METADATA-DELTA, METADATA-IMAGE.

APPLY-DELEGATION-TOKEN-DELTA.
    CALL "DELEGATIONTOKEN-PUBLISHER-ON-METADATA-UPDATE" USING METADATA-DELTA, METADATA-IMAGE.

APPLY-ACL-DELTA.
    CALL "ACL-PUBLISHER-ON-METADATA-UPDATE" USING METADATA-DELTA, METADATA-IMAGE, LOADER-MANIFEST.

PROPAGATE-NEW-IMAGE.
    CALL "GROUPCOORDINATOR-ON-NEW-METADATA-IMAGE" USING METADATA-IMAGE, METADATA-DELTA.
    IF SHARE-COORDINATOR-ENABLED
        CALL "SHARECOORDINATOR-ON-NEW-METADATA-IMAGE" USING METADATA-IMAGE, METADATA-DELTA
    END-IF.

FINISH-INITIALIZING-REPLICA-MANAGER.
    CALL "REPLICAMANAGER-START-HIGH-WATERMARK-CHECKPOINT-THREAD".

CLOSE-PUBLISHER.
    MOVE 'N' TO FIRST-PUBLISH-FUTURE.