IDENTIFICATION DIVISION.
PROGRAM-ID. DYNAMICCLIENTQUOTAPUBLISHER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SPECIAL-NAMES.
    ALPHABET NODECHAR IS STANDARD-1.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-CONF PIC X(1024).
01 WS-FAULTHANDLER PIC X(1024).
01 WS-NODETYPE PIC X(10).
01 WS-CLIENTQUOTAMETADATAMANAGER PIC X(1024).
01 WS-LOGIDENT PIC X(1024).
01 WS-DELTA PIC X(1024).
01 WS-NEWIMAGE PIC X(1024).
01 WS-MANIFEST PIC X(1024).
01 WS-DELTANAME PIC X(1024).
01 WS-CLIENTQUOTADELTA PIC X(1024).

PROCEDURE DIVISION.
MAIN-PROCEDURE.

    MOVE FUNCTION CONCATENATE("[", FUNCTION TRIM(WS-NODETYPE), " id=", WS-CONF, "] ") TO WS-LOGIDENT.

    MOVE FUNCTION CONCATENATE("DynamicClientQuotaPublisher ", WS-NODETYPE, " id=", WS-CONF) TO WS-NAME.

    PERFORM ON-METADATA-UPDATE USING WS-DELTA, WS-NEWIMAGE, WS-MANIFEST.

    STOP RUN.

ON-METADATA-UPDATE.
    MOVE FUNCTION CONCATENATE("MetadataDelta up to ", WS-NEWIMAGE) TO WS-DELTANAME.

    PERFORM VARYING WS-CLIENTQUOTADELTA FROM 1 BY 1 UNTIL WS-CLIENTQUOTADELTA > LENGTH(WS-DELTA)
        PERFORM UPDATE-CLIENT-QUOTA USING WS-CLIENTQUOTADELTA
    END-PERFORM.

UPDATE-CLIENT-QUOTA.
    PERFORM CATCH-EXCEPTION
        CALL "UPDATE" USING WS-CLIENTQUOTAMETADATAMANAGER, WS-CLIENTQUOTADELTA
    END-PERFORM.

CATCH-EXCEPTION.
    CALL "HANDLEFAULT" USING WS-FAULTHANDLER, 
        FUNCTION CONCATENATE("Uncaught exception while publishing dynamic client quota changes from ", WS-DELTANAME),
        WS-EXCEPTION-OBJECT.

END PROGRAM DYNAMICCLIENTQUOTAPUBLISHER.