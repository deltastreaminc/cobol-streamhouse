IDENTIFICATION DIVISION.
PROGRAM-ID. DYNAMICTOPICCLUSTERQUOTAPUBLISHER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY KAFKA-CONFIG.
    COPY QUOTA-MANAGERS.
    COPY FAULT-HANDLER.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 CLUSTER-ID PIC X(10).
01 NODE-TYPE PIC X(10).
01 DELTA-NAME PIC X(50).

PROCEDURE DIVISION USING CLUSTER-ID, KAFKA-CONFIG, FAULT-HANDLER, NODE-TYPE, QUOTA-MANAGERS.
    PERFORM ON-METADATA-UPDATE VARYING DELTA, NEW-IMAGE.

ON-METADATA-UPDATE.
    PERFORM CHECK-TOPICS-CLUSTER-DELTA
    EVALUATE TRUE
        WHEN QUOTA-MANAGERS-CLIENT-QUOTA-CALLBACK IS NOT NULL
            PERFORM UPDATE-CLUSTER-METADATA
            PERFORM UPDATE-QUOTA-METRIC-CONFIGS
        WHEN OTHER
            MOVE "Uncaught exception while publishing dynamic topic or cluster changes from" TO DELTA-NAME
            STRING "MetadataDelta up to " NEW-IMAGE-HIGHEST-OFFSET-AND-EPOCH-OFFSET INTO DELTA-NAME
            PERFORM HANDLE-FAULT USING DELTA-NAME, EXCEPTION-OBJECT
    END-EVALUATE.

CHECK-TOPICS-CLUSTER-DELTA.
    IF DELTA-TOPICS-DELTA IS NOT NULL OR DELTA-CLUSTER-DELTA IS NOT NULL
        SET CHECK-TOPICS-CLUSTER-DELTA TO TRUE
    ELSE 
        SET CHECK-TOPICS-CLUSTER-DELTA TO FALSE.

UPDATE-CLUSTER-METADATA.
    MOVE CLUSTER-ID TO CLUSTER-ID-IN
    MOVE NEW-IMAGE TO NEW-IMAGE-IN
    CALL "METADATA-CACHE-TO-CLUSTER" USING CLUSTER-ID-IN, NEW-IMAGE-IN GIVING CLUSTER-OUT
    CALL "CLIENT-QUOTA-CALLBACK-UPDATE-CLUSTER-METADATA" USING CLUSTER-OUT GIVING UPDATE-RESULT
    MOVE UPDATE-RESULT TO WS-UPDATE-RESULT.

UPDATE-QUOTA-METRIC-CONFIGS.
    CALL "QUOTA-MANAGERS-FETCH-UPDATE-QUOTA-METRIC-CONFIGS".
    CALL "QUOTA-MANAGERS-PRODUCE-UPDATE-QUOTA-METRIC-CONFIGS".
    CALL "QUOTA-MANAGERS-REQUEST-UPDATE-QUOTA-METRIC-CONFIGS".
    CALL "QUOTA-MANAGERS-CONTROLLER-MUTATION-UPDATE-QUOTA-METRIC-CONFIGS".

HANDLE-FAULT.
    MOVE EXCEPTION-OBJECT TO FAULT-OBJECT
    CALL "FAULT-HANDLER-HANDLE-FAULT" USING DELTA-NAME, FAULT-OBJECT.