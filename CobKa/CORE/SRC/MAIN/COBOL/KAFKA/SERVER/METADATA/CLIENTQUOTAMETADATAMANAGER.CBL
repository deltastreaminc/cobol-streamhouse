IDENTIFICATION DIVISION.
PROGRAM-ID. CLIENT-QUOTA-METADATA-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY KAFKA-NETWORK-CONNECTION-QUOTAS.
    COPY KAFKA-SERVER-CLIENT-QUOTA-MANAGER.
    COPY KAFKA-SERVER-QUOTA-FACTORY.
    COPY KAFKA-SERVER-METADATA-CLIENT-QUOTA-METADATA-MANAGER.
    COPY KAFKA-UTILS-LOGGING.
    COPY APACHE-KAFKA-COMMON-METRICS-QUOTA.
    COPY APACHE-KAFKA-COMMON-QUOTA-CLIENT-QUOTA-ENTITY.
    COPY APACHE-KAFKA-COMMON-UTILS-SANITIZER.
    COPY APACHE-KAFKA-IMAGE-CLIENT-QUOTA-DELTA.
    COPY APACHE-KAFKA-IMAGE-CLIENT-QUOTAS-DELTA.
    COPY APACHE-KAFKA-SERVER-CONFIG-QUOTA-CONFIG.

DATA DIVISION.
WORKING-STORAGE SECTION.
    01 QUOTA-ENTITY.
        05 FILLER PIC X(01) VALUE 'I'.
        05 IP-ENTITY PIC X(20).
        05 USER-ENTITY PIC X(20).
        05 CLIENT-ID-ENTITY PIC X(20).
    01 QUOTA-DELTA.
        05 FILLER PIC X(01) VALUE 'D'.
        05 QUOTA-CHANGES OCCURS 1 TO 10 TIMES DEPENDING ON CHANGES-COUNT.
            10 QUOTA-KEY PIC X(50).
            10 QUOTA-VALUE PIC 9(10)V9(2).

PROCEDURE DIVISION.

    UPDATE-QUOTAS.
        MOVE FUNCTION WS-NUMVAL(WS-QUOTA-VALUE) TO NEW-QUOTA-VALUE.
        EVALUATE WS-QUOTA-KEY
            WHEN QuotaConfig-CONSUMER-BYTE-RATE-OVERRIDE-CONFIG
                CALL "UPDATE-FETCH-QUOTA" USING WS-USER-ENTITY, WS-CLIENT-ENTITY, NEW-QUOTA-VALUE
            WHEN QuotaConfig-PRODUCER-BYTE-RATE-OVERRIDE-CONFIG
                CALL "UPDATE-PRODUCE-QUOTA" USING WS-USER-ENTITY, WS-CLIENT-ENTITY, NEW-QUOTA-VALUE
            WHEN QuotaConfig-REQUEST-PERCENTAGE-OVERRIDE-CONFIG
                CALL "UPDATE-REQUEST-QUOTA" USING WS-USER-ENTITY, WS-CLIENT-ENTITY, NEW-QUOTA-VALUE
            WHEN QuotaConfig-CONTROLLER-MUTATION-RATE-OVERRIDE-CONFIG
                CALL "UPDATE-CONTROLLER-MUTATION-QUOTA" USING WS-USER-ENTITY, WS-CLIENT-ENTITY, NEW-QUOTA-VALUE
            WHEN OTHER
                DISPLAY "Ignoring unexpected quota key " WS-QUOTA-KEY " for entity " WS-QUOTA-ENTITY.

    HANDLE-IP-QUOTA.
        IF WS-IP-ENTITY = "DefaultIpEntity"
            MOVE ZEROS TO WS-IP-ADDRESS
        ELSE
            MOVE WS-IP-ENTITY TO WS-IP-ADDRESS
            CALL "GET-INET-ADDRESS" USING WS-IP-ADDRESS, WS-IP-INET-ADDRESS
        END-IF.
        EVALUATE WS-QUOTA-KEY
            WHEN QuotaConfig-IP-CONNECTION-RATE-OVERRIDE-CONFIG
                CALL "UPDATE-IP-CONNECTION-RATE-QUOTA" USING WS-IP-INET-ADDRESS, NEW-QUOTA-VALUE
            WHEN OTHER
                DISPLAY "Ignoring unexpected quota key " WS-QUOTA-KEY " for entity " WS-QUOTA-ENTITY
        END-EVALUATE.

    UPDATE-ENTITY.
        IF WS-IP-ENTITY-FLAG = 'I'
            PERFORM HANDLE-IP-QUOTA
        ELSE
            PERFORM TRANSFER-TO-CLIENT-QUOTA-ENTITY
            PERFORM UPDATE-QUOTAS
        END-IF.

    TRANSFER-TO-CLIENT-QUOTA-ENTITY.
        EVALUATE WS-QUOTA-ENTITY
            WHEN "UserEntity"
                MOVE WS-USER-ENTITY TO WS-CLIENT-QUOTA-USER-ENTITY
                MOVE SPACES TO WS-CLIENT-QUOTA-CLIENT-ENTITY
            WHEN "DefaultUserEntity"
                MOVE "DefaultUserEntity" TO WS-CLIENT-QUOTA-USER-ENTITY
                MOVE SPACES TO WS-CLIENT-QUOTA-CLIENT-ENTITY
            WHEN "ClientIdEntity"
                MOVE SPACES TO WS-CLIENT-QUOTA-USER-ENTITY
                MOVE WS-CLIENT-ID-ENTITY TO WS-CLIENT-QUOTA-CLIENT-ENTITY
            WHEN "DefaultClientIdEntity"
                MOVE SPACES TO WS-CLIENT-QUOTA-USER-ENTITY
                MOVE "DefaultClientIdEntity" TO WS-CLIENT-QUOTA-CLIENT-ENTITY
            WHEN "ExplicitUserExplicitClientIdEntity"
                MOVE WS-USER-ENTITY TO WS-CLIENT-QUOTA-USER-ENTITY
                MOVE WS-CLIENT-ID-ENTITY TO WS-CLIENT-QUOTA-CLIENT-ENTITY
            WHEN "ExplicitUserDefaultClientIdEntity"
                MOVE WS-USER-ENTITY TO WS-CLIENT-QUOTA-USER-ENTITY
                MOVE "DefaultClientIdEntity" TO WS-CLIENT-QUOTA-CLIENT-ENTITY
            WHEN "DefaultUserExplicitClientIdEntity"
                MOVE "DefaultUserEntity" TO WS-CLIENT-QUOTA-USER-ENTITY
                MOVE WS-CLIENT-ID-ENTITY TO WS-CLIENT-QUOTA-CLIENT-ENTITY
            WHEN "DefaultUserDefaultClientIdEntity"
                MOVE "DefaultUserEntity" TO WS-CLIENT-QUOTA-USER-ENTITY
                MOVE "DefaultClientIdEntity" TO WS-CLIENT-QUOTA-CLIENT-ENTITY
            WHEN OTHER
                DISPLAY "Should not see IP quota entities here".

    UPDATE.
        MOVE FUNCTION WS-NUMVAL(WS-ENTITY-KEY) TO WS-CHANGES-COUNT.
        PERFORM VARYING WS-I FROM 1 BY 1 UNTIL WS-I > WS-CHANGES-COUNT
            MOVE WS-QUOTA-CHANGES(WS-I, 1) TO WS-QUOTA-KEY
            MOVE WS-QUOTA-CHANGES(WS-I, 2) TO WS-QUOTA-VALUE
            PERFORM UPDATE-ENTITY
        END-PERFORM.

    MAIN-PROCEDURE.
        PERFORM UPDATE.

STOP RUN.