IDENTIFICATION DIVISION.
PROGRAM-ID. DYNAMIC-CONFIG-PUBLISHER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
    SOURCE-COMPUTER. IBM-370.
    OBJECT-COMPUTER. IBM-370.

DATA DIVISION.
WORKING-STORAGE SECTION.
    01 WS-DELTA-NAME PIC X(30).
    01 WS-RESOURCE-TYPE PIC X(10).
    01 WS-RESOURCE-NAME PIC X(50).
    01 WS-CONFIG-PROPS PIC X(200).
    01 WS-FAULT-MESSAGE PIC X(200).

PROCEDURE DIVISION.
    MAIN-PARAGRAPH.
        PERFORM ON-METADATA-UPDATE.

    ON-METADATA-UPDATE.
        MOVE "MetadataDelta up to " TO WS-DELTA-NAME
        MOVE FUNCTION COMBINE-DATUMS(NEWIMAGE-HIGHEST-OFFSET-AND-EPOCH, OFFSET) TO WS-DELTA-NAME(26:).

        PERFORM APPLY-CONFIG-DELTAS.

    APPLY-CONFIG-DELTAS.
        PERFORM VARYING RESOURCE FROM DELTA-CONFIGS-CHANGES
            MOVE RESOURCE-TYPE TO WS-RESOURCE-TYPE
            MOVE RESOURCE-NAME TO WS-RESOURCE-NAME
            MOVE NEWIMAGE-CONFIG-PROPERTIES(RESOURCE) TO WS-CONFIG-PROPS

            EVALUATE WS-RESOURCE-TYPE
                WHEN "TOPIC"
                    PERFORM PROCESS-TOPIC-CONFIG-CHANGES
                WHEN "BROKER"
                    IF WS-RESOURCE-NAME IS EMPTY
                        PERFORM PROCESS-CLUSTER-CONFIG-CHANGES
                    ELSE IF WS-RESOURCE-NAME = NODE-ID
                        PERFORM PROCESS-NODE-CONFIG-CHANGES
                            PERFORM RELOAD-UPDATED-FILES
                WHEN "CLIENT-METRICS"
                    PERFORM PROCESS-METRICS-CONFIG-CHANGES  
                WHEN "GROUP"
                    PERFORM PROCESS-GROUP-CONFIG-CHANGES
                WHEN OTHER
                    CONTINUE
            END-EVALUATE
        END-PERFORM.

    PROCESS-TOPIC-CONFIG-CHANGES.
        DISPLAY "Updating topic " WS-RESOURCE-NAME " with new configuration: " WS-CONFIG-PROPS
        CALL "PROCESS-CONFIG-CHANGES" USING WS-RESOURCE-NAME, WS-CONFIG-PROPS.

    PROCESS-CLUSTER-CONFIG-CHANGES.
        DISPLAY "Updating cluster configuration: " WS-CONFIG-PROPS
        CALL "PROCESS-CONFIG-CHANGES" USING WS-RESOURCE-NAME, WS-CONFIG-PROPS.

    PROCESS-NODE-CONFIG-CHANGES.
        DISPLAY "Updating node " NODE-ID " with new configuration: " WS-CONFIG-PROPS
        CALL "PROCESS-CONFIG-CHANGES" USING WS-RESOURCE-NAME, WS-CONFIG-PROPS.

    RELOAD-UPDATED-FILES.
        CALL "RELOAD-UPDATED-FILES-WITHOUT-CONFIG-CHANGE" USING WS-CONFIG-PROPS.

    PROCESS-METRICS-CONFIG-CHANGES.
        DISPLAY "Updating client metrics " WS-RESOURCE-NAME " with new configuration: " WS-CONFIG-PROPS
        CALL "PROCESS-CONFIG-CHANGES" USING WS-RESOURCE-NAME, WS-CONFIG-PROPS.

    PROCESS-GROUP-CONFIG-CHANGES.
        DISPLAY "Updating group " WS-RESOURCE-NAME " with new configuration: " WS-CONFIG-PROPS
        CALL "PROCESS-CONFIG-CHANGES" USING WS-RESOURCE-NAME, WS-CONFIG-PROPS.

    HANDLE-FAULT.
        MOVE "Uncaught exception while publishing dynamic configuration changes from " TO WS-FAULT-MESSAGE
        MOVE WS-DELTA-NAME TO WS-FAULT-MESSAGE(67:)
        CALL "HANDLE-FAULT" USING WS-FAULT-MESSAGE.

    STOP RUN.