IDENTIFICATION DIVISION.
PROGRAM-ID. AclPublisher.
AUTHOR. Apache Software Foundation.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION-IDENTIFIER IS kafka.utils.Logging.
    FUNCTION-IDENTIFIER IS org.apache.kafka.image.publisher.MetadataPublisher.
    FUNCTION-IDENTIFIER IS org.apache.kafka.metadata.authorizer.ClusterMetadataAuthorizer.
    FUNCTION-IDENTIFIER IS org.apache.kafka.server.authorizer.Authorizer.
    FUNCTION-IDENTIFIER IS org.apache.kafka.server.fault.FaultHandler.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-NODE-ID PIC 9(9) COMP.
01 WS-FAULT-HANDLER PIC X(30) COMP-5.
01 WS-NODE-TYPE PIC X(30).
01 WS-AUTHORIZER PIC X(30) COMP-5.
01 WS-COMPLETED-INITIAL-LOAD PIC X.
    88 WS-INITIAL-LOAD-COMPLETED VALUE 'Y'.
01 WS-DELTA-NAME PIC X(50).

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    MOVE nodeId TO WS-NODE-ID.
    MOVE faultHandler TO WS-FAULT-HANDLER.
    MOVE nodeType TO WS-NODE-TYPE.
    MOVE authorizer TO WS-AUTHORIZER.
    MOVE 'N' TO WS-COMPLETED-INITIAL-LOAD.

    PERFORM NAME-PROCEDURE.

    PERFORM ON-METADATA-UPDATE-PROCEDURE UNTIL WS-INITIAL-LOAD-COMPLETED.

    PERFORM CLOSE-PROCEDURE.

    STOP RUN.

NAME-PROCEDURE.
    STRING "[AclPublisher " INTO WS-DELTA-NAME
           WS-NODE-TYPE " id=" INTO WS-DELTA-NAME
           WS-NODE-ID "]" INTO WS-DELTA-NAME.

ON-METADATA-UPDATE-PROCEDURE.
    MOVE MetadataDelta TO WS-DELTA-NAME.

    IF WS-AUTHORIZER IS NOT NUMERIC
       AND WS-AUTHORIZER IS ClusterMetadataAuthorizer
       AND LoaderManifestType IS SNAPSHOT
    THEN
        PERFORM LOAD-SNAPSHOT-PROCEDURE
    ELSE
        PERFORM APPLY-CHANGES-PROCEDURE.

    IF NOT WS-INITIAL-LOAD-COMPLETED
    THEN
        MOVE 'Y' TO WS-COMPLETED-INITIAL-LOAD
        CALL "completeInitialLoad" USING WS-AUTHORIZER.

LOAD-SNAPSHOT-PROCEDURE.
    DISPLAY "Loading authorizer snapshot at offset " MetadataImage-OFFSET.
    CALL "loadSnapshot" USING WS-AUTHORIZER, MetadataImage-ACLS.
    PERFORM FAULT-HANDLER-PROCEDURE
        ON EXCEPTION
            DISPLAY "Error loading authorizer snapshot in " WS-DELTA-NAME.

APPLY-CHANGES-PROCEDURE.
    PERFORM VARYING KEY FROM 1 BY 1 UNTIL KEY > MetadataDelta-CHANGES-SIZE
        IF MetadataDelta-CHANGES(KEY) IS PRESENT
        THEN
            CALL "addAcl" USING WS-AUTHORIZER, KEY, MetadataDelta-CHANGES(KEY)
        ELSE
            CALL "removeAcl" USING WS-AUTHORIZER, KEY
        END-IF
    END-PERFORM.
    PERFORM FAULT-HANDLER-PROCEDURE
        ON EXCEPTION
            DISPLAY "Error loading authorizer changes in " WS-DELTA-NAME.

FAULT-HANDLER-PROCEDURE.
    CALL "handleFault" USING WS-FAULT-HANDLER, WS-DELTA-NAME, EXCEPTION-OBJECT.

CLOSE-PROCEDURE.
    IF WS-AUTHORIZER IS NUMERIC
       AND WS-AUTHORIZER IS ClusterMetadataAuthorizer
    THEN
        CALL "completeInitialLoad" USING WS-AUTHORIZER, EXCEPTION-OBJECT.