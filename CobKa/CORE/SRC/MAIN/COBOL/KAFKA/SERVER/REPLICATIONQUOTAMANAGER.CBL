IDENTIFICATION DIVISION.
PROGRAM-ID. REPLICATION-QUOTA-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY "KAFKA-COMMON-COPYBOOK.cpy".
    COPY "REPLICATION-QUOTA-MANAGER-CONFIG.cpy".

DATA DIVISION.
WORKING-STORAGE SECTION.
   01 WS-THROTTLED-PARTITIONS PIC X(256) VALUE SPACES.
   01 WS-THROTTLED-PARTITIONS-TABLE.
       05 THROTTLED-PARTITIONS-ITEM OCCURS 1 TO 256 TIMES
          DEPENDING ON WS-THROTTLED-PARTITIONS-COUNT
          INDEXED BY WS-THROTTLED-PARTITIONS-IDX.
           10 TOPIC-NAME PIC X(256).
           10 PARTITIONS PIC 9(9) OCCURS 1 TO 9999 TIMES
              DEPENDING ON WS-PARTITIONS-COUNT INDEXED BY WS-PARTITIONS-IDX.
   01 WS-THROTTLED-PARTITIONS-COUNT PIC 9(9) VALUE 0.
   01 WS-PARTITIONS-COUNT PIC 9(9) VALUE 0.
   01 WS-THROTTLED-PARTITIONS-IDX PIC 9(9) VALUE 0.
   01 WS-PARTITIONS-IDX PIC 9(9) VALUE 0.
   01 WS-QUOTA PIC X(1024).
   01 WS-METRIC-CONFIG.
       05 WS-TIME-WINDOW PIC 9(9) VALUE 0.
       05 WS-NUM-SAMPLES PIC 9(9) VALUE 0.
       05 WS-QUOTA-BOUND PIC 9(18) VALUE 0.
   01 WS-QUOTA-EXCEEDED PIC X(1) VALUE 'N'.
   01 WS-SENSOR-NAME PIC X(256) VALUE SPACES.
   01 WS-REPLICATION-TYPE PIC X(256) VALUE SPACES.
   01 WS-METRIC-NAME PIC X(256) VALUE SPACES.
   01 WS-SENSOR PIC X(1024) VALUE SPACES.
   01 WS-CURRENT-TIME PIC 9(18) VALUE 0.

PROCEDURE DIVISION.

* Update the quota
UPDATE-QUOTA.
    MOVE WS-QUOTA TO WS-METRIC-CONFIG.
    MOVE WS-REPLICATION-TYPE TO WS-SENSOR-NAME.
    PERFORM GET-SENSOR.
    MOVE WS-METRIC-CONFIG TO METRIC-CONFIG OF WS-SENSOR.

* Check if the quota is currently exceeded  
IS-QUOTA-EXCEEDED.
    MOVE 'N' TO WS-QUOTA-EXCEEDED.
    PERFORM CHECK-QUOTA.
    IF WS-QUOTA-EXCEEDED = 'Y' THEN
        DISPLAY "Quota violated for sensor (" WS-SENSOR-NAME "), metric: (" WS-METRIC-NAME "), metric-value: (" WS-QUOTA-BOUND "), bound: (" QUOTA-BOUND OF WS-METRIC-CONFIG ")"
    END-IF.
    MOVE WS-QUOTA-EXCEEDED TO RETURN-CODE.

* Is the passed partition throttled by this ReplicationQuotaManager
IS-THROTTLED.
    MOVE SPACES TO WS-THROTTLED-PARTITIONS.
    MOVE 0 TO WS-THROTTLED-PARTITIONS-COUNT.
    PERFORM VARYING WS-THROTTLED-PARTITIONS-IDX FROM 1 BY 1 
        UNTIL WS-THROTTLED-PARTITIONS-IDX > WS-THROTTLED-PARTITIONS-COUNT
        IF TOPIC-NAME(WS-THROTTLED-PARTITIONS-IDX) = TOPIC-NAME
           IF PARTITIONS(WS-THROTTLED-PARTITIONS-IDX, 1) = -1 OR
              PARTITIONS(WS-THROTTLED-PARTITIONS-IDX, WS-PARTITIONS-IDX) = PARTITION
              MOVE 'Y' TO RETURN-CODE
              GOBACK
           END-IF
        END-IF
    END-PERFORM.
    MOVE 'N' TO RETURN-CODE.

* Add the passed value to the throttled rate
RECORD.
    PERFORM GET-SENSOR.
    MOVE WS-CURRENT-TIME TO TIMESTAMP OF WS-SENSOR.
    MOVE VALUE TO RATE OF WS-SENSOR.
    MOVE 'N' TO IGNORE-QUOTA OF WS-SENSOR.
    PERFORM UPDATE-SENSOR.

* Update the set of throttled partitions for this QuotaManager
MARK-THROTTLED.
    MOVE TOPIC-NAME TO WS-THROTTLED-PARTITIONS(WS-THROTTLED-PARTITIONS-COUNT + 1).
    MOVE PARTITIONS-LIST TO WS-THROTTLED-PARTITIONS(WS-THROTTLED-PARTITIONS-COUNT + 1, 2).
    ADD 1 TO WS-THROTTLED-PARTITIONS-COUNT.

MARK-ALL-THROTTLED.
    MOVE TOPIC-NAME TO WS-THROTTLED-PARTITIONS(WS-THROTTLED-PARTITIONS-COUNT + 1).
    MOVE -1 TO WS-THROTTLED-PARTITIONS(WS-THROTTLED-PARTITIONS-COUNT + 1, 2).
    ADD 1 TO WS-THROTTLED-PARTITIONS-COUNT.

REMOVE-THROTTLE.
    MOVE SPACES TO WS-THROTTLED-PARTITIONS(WS-THROTTLED-PARTITIONS-IDX).
    SUBTRACT 1 FROM WS-THROTTLED-PARTITIONS-COUNT.

GET-UPPER-BOUND.
    MOVE WS-QUOTA-BOUND TO RETURN-CODE.

GET-SENSOR.
    MOVE WS-SENSOR-NAME TO SENSOR-NAME OF WS-SENSOR.
    PERFORM UPDATE-SENSOR.

CHECK-QUOTA.
    MOVE 'N' TO WS-QUOTA-EXCEEDED.
    PERFORM UPDATE-SENSOR.
    IF QUOTA-VIOLATED OF WS-SENSOR = 'Y' THEN
        MOVE 'Y' TO WS-QUOTA-EXCEEDED
    END-IF.

UPDATE-SENSOR.
    CALL "UPDATE-METRIC" USING WS-SENSOR.

END PROGRAM REPLICATION-QUOTA-MANAGER.