IDENTIFICATION DIVISION.
PROGRAM-ID. DELAYED-PRODUCE.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY KAFKA-COMMON.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 PRODUCE-PARTITION-STATUS.
   05 REQUIRED-OFFSET PIC S9(18) COMP-3.
   05 RESPONSE-STATUS.
      10 ERROR-CODE PIC S9(9) COMP.
      10 BASE-OFFSET PIC S9(18) COMP-3.
   05 ACKS-PENDING PIC X.
       88 ACKS-PENDING-TRUE VALUE 'Y'.
       88 ACKS-PENDING-FALSE VALUE 'N'.

01 PRODUCE-METADATA.
   05 PRODUCE-REQUIRED-ACKS PIC S9(4) COMP.
   05 PRODUCE-STATUS OCCURS 1 TO 32767 TIMES DEPENDING ON PRODUCE-STATUS-COUNT.
      10 TOPIC-PARTITION.
         15 TOPIC PIC X(128).
         15 PARTITION PIC S9(9) COMP.
      10 PARTITION-STATUS REDEFINES TOPIC-PARTITION PIC X(136).

01 DELAYED-PRODUCE-METRICS.
   05 AGGREGATE-EXPIRATION-METER.
      10 MARK-COUNT PIC S9(9) COMP.
   05 PARTITION-EXPIRATION-METERS OCCURS 1 TO 32767 TIMES DEPENDING ON PARTITION-EXPIRATION-METER-COUNT.
      10 TOPIC PIC X(128).
      10 PARTITION PIC S9(9) COMP.
      10 METER-MARK-COUNT PIC S9(9) COMP.

PROCEDURE DIVISION.

DELAYED-PRODUCE-MAIN.
    PERFORM INITIAL-PARTITION-STATUS-UPDATE.
    PERFORM DELAYED-PRODUCE-COMPLETION-CHECK.
    PERFORM DELAYED-PRODUCE-EXPIRATION.
    PERFORM DELAYED-PRODUCE-COMPLETION.

INITIAL-PARTITION-STATUS-UPDATE.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > PRODUCE-STATUS-COUNT
        IF RESPONSE-STATUS(I)-ERROR-CODE = ZEROS
            SET ACKS-PENDING-TRUE TO TRUE
            MOVE ERRORS-REQUEST-TIMED-OUT TO RESPONSE-STATUS(I)-ERROR-CODE
        ELSE
            SET ACKS-PENDING-FALSE TO TRUE
        END-IF
        DISPLAY "Initial partition status for " TOPIC-PARTITION(I) " is " PRODUCE-PARTITION-STATUS(I)
    END-PERFORM.

DELAYED-PRODUCE-COMPLETION-CHECK.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > PRODUCE-STATUS-COUNT
        IF ACKS-PENDING-TRUE
            EVALUATE TRUE
                WHEN PARTITION-NOT-ASSIGNED
                    MOVE PARTITION-NOT-ASSIGNED TO RESPONSE-STATUS(I)-ERROR-CODE
                    SET ACKS-PENDING-FALSE TO TRUE
                WHEN REPLICA-NO-LONGER-LEADER
                    MOVE REPLICA-NO-LONGER-LEADER TO RESPONSE-STATUS(I)-ERROR-CODE
                    SET ACKS-PENDING-FALSE TO TRUE
                WHEN OTHER
                    PERFORM CHECK-ENOUGH-REPLICAS
            END-EVALUATE
        END-IF
    END-PERFORM.

    IF NOT ANY ACKS-PENDING-TRUE
        PERFORM DELAYED-PRODUCE-FORCE-COMPLETE
    ELSE
        MOVE FALSE TO RETURN-CODE.

CHECK-ENOUGH-REPLICAS.
    CALL "GET-PARTITION-OR-ERROR" USING TOPIC-PARTITION(I) 
        GIVING ENOUGH-REPLICAS, PARTITION-ERROR-CODE.
    IF PARTITION-ERROR-CODE = ZEROS AND ENOUGH-REPLICAS
        MOVE ZEROS TO RESPONSE-STATUS(I)-ERROR-CODE
    ELSE
        MOVE PARTITION-ERROR-CODE TO RESPONSE-STATUS(I)-ERROR-CODE
    END-IF.
    SET ACKS-PENDING-FALSE TO TRUE.

DELAYED-PRODUCE-EXPIRATION.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > PRODUCE-STATUS-COUNT
        IF ACKS-PENDING-TRUE
            DISPLAY "Expiring produce request for partition " TOPIC-PARTITION(I) " with status " PRODUCE-PARTITION-STATUS(I)
            PERFORM RECORD-PARTITION-EXPIRATION USING TOPIC-PARTITION(I)
        END-IF
    END-PERFORM.

DELAYED-PRODUCE-COMPLETION.
    MOVE PRODUCE-STATUS TO RESPONSE-STATUS.
    CALL "RESPONSE-CALLBACK" USING RESPONSE-STATUS.

RECORD-PARTITION-EXPIRATION.
    MOVE 1 TO METER-MARK-COUNT(PARTITION-EXPIRATION-METER-INDEX).
    ADD 1 TO MARK-COUNT(AGGREGATE-EXPIRATION-METER).

DELAYED-PRODUCE-FORCE-COMPLETE.
    MOVE TRUE TO RETURN-CODE.

END PROGRAM DELAYED-PRODUCE.