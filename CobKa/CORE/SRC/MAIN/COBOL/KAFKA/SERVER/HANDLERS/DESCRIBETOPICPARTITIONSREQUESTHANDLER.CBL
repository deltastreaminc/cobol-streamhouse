IDENTIFICATION DIVISION.
PROGRAM-ID. DESCRIBE-TOPIC-PARTITIONS-REQUEST-HANDLER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY "KAFKA-COMMON.cpy".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 METADATA-CACHE PIC X(30).
01 AUTH-HELPER PIC X(30).
01 KAFKA-CONFIG PIC X(30).

01 TOPIC-SET.
    05 TOPIC-LIST OCCURS 100 TIMES.
       10 TOPIC-NAME PIC X(100).

01 UNAUTHORIZED-TOPICS.
    05 UNAUTHORIZED-TOPIC-DATA OCCURS 100 TIMES.
       10 UNAUTHORIZED-TOPIC-NAME PIC X(100).
       10 UNAUTHORIZED-TOPIC-ID PIC X(36).
       10 UNAUTHORIZED-TOPIC-IS-INTERNAL PIC X.
       10 UNAUTHORIZED-TOPIC-PARTITIONS OCCURS 100 TIMES.
          15 UNAUTHORIZED-PARTITION-ERROR-CODE PIC 9(4).
          15 UNAUTHORIZED-PARTITION-DATA PIC X(100).

01 AUTHORIZED-TOPICS PIC X(100).
01 CURSOR-TOPIC-NAME PIC X(100).
01 CURSOR-PARTITION-INDEX PIC 9(9).
01 RESPONSE-PARTITION-LIMIT PIC 9(9).
01 FETCH-ALL-TOPICS PIC X.

PROCEDURE DIVISION.
HANDLE-DESCRIBE-TOPIC-PARTITIONS-REQUEST.
    MOVE METADATA-CACHE TO WS-METADATA-CACHE.
    MOVE AUTH-HELPER TO WS-AUTH-HELPER.
    MOVE KAFKA-CONFIG TO WS-KAFKA-CONFIG.

    INITIALIZE TOPIC-SET.
    INITIALIZE UNAUTHORIZED-TOPICS.
    MOVE SPACES TO AUTHORIZED-TOPICS.
    MOVE SPACES TO CURSOR-TOPIC-NAME.
    MOVE ZERO TO CURSOR-PARTITION-INDEX.
    MOVE ZERO TO RESPONSE-PARTITION-LIMIT.
    MOVE "N" TO FETCH-ALL-TOPICS.

    PERFORM PROCESS-DESCRIBE-TOPIC-PARTITIONS-REQUEST.

    MOVE WS-METADATA-CACHE TO METADATA-CACHE.
    MOVE WS-AUTH-HELPER TO AUTH-HELPER.
    MOVE WS-KAFKA-CONFIG TO KAFKA-CONFIG.

    RETURN WS-DESCRIBE-TOPIC-PARTITIONS-RESPONSE-DATA.

PROCESS-DESCRIBE-TOPIC-PARTITIONS-REQUEST.
    MOVE REQUEST-TOPICS TO TOPIC-LIST.
    INSPECT TOPIC-LIST TALLYING FOR ALL OCCURRENCE OF SPACES INTO TOPIC-COUNT.
    IF TOPIC-COUNT = LENGTH OF TOPIC-LIST
        MOVE "Y" TO FETCH-ALL-TOPICS
    ELSE
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > TOPIC-COUNT
            MOVE TOPIC-LIST(I) TO CURSOR-TOPIC-NAME
            IF CURSOR-TOPIC-NAME >= REQUEST-CURSOR-TOPIC-NAME
                MOVE TOPIC-LIST(I) TO AUTHORIZED-TOPICS(I)
            END-IF
        END-PERFORM
        IF REQUEST-CURSOR-TOPIC-NAME NOT = SPACES
            AND NOT AUTHORIZED-TOPICS CONTAINS REQUEST-CURSOR-TOPIC-NAME
                RAISE INVALID-REQUEST-EXCEPTION "DescribeTopicPartitionsRequest topic list should contain the cursor topic: " & REQUEST-CURSOR-TOPIC-NAME
        END-IF
    END-IF.

    IF REQUEST-CURSOR-PARTITION-INDEX < ZERO
        RAISE INVALID-REQUEST-EXCEPTION "DescribeTopicPartitionsRequest cursor partition must be valid: " & REQUEST-CURSOR
    END-IF.

    PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF AUTHORIZED-TOPICS
        MOVE AUTHORIZED-TOPICS(I) TO WS-TOPIC-NAME
        IF WS-AUTH-HELPER-AUTHORIZE(WS-TOPIC-NAME)
            CONTINUE
        ELSE
            MOVE WS-TOPIC-NAME TO UNAUTHORIZED-TOPIC-NAME(I)
            MOVE WS-ZERO-UUID TO UNAUTHORIZED-TOPIC-ID(I)
            MOVE "Y" TO UNAUTHORIZED-TOPIC-IS-INTERNAL(I)
            MOVE ZERO TO UNAUTHORIZED-PARTITION-ERROR-CODE(I, 1)
            MOVE SPACES TO UNAUTHORIZED-PARTITION-DATA(I, 1)
        END-IF
    END-PERFORM.

    MOVE WS-METADATA-CACHE-DESCRIBE-TOPIC-RESPONSE(
        AUTHORIZED-TOPICS,
        REQUEST-LISTENER-NAME,
        CURSOR-TOPIC-NAME,
        CURSOR-PARTITION-INDEX,
        RESPONSE-PARTITION-LIMIT,
        FETCH-ALL-TOPICS) TO WS-DESCRIBE-TOPIC-PARTITIONS-RESPONSE-DATA.

    PERFORM VARYING I FROM 1 BY 1 UNTIL I > LENGTH OF WS-DESCRIBE-TOPIC-PARTITIONS-RESPONSE-DATA-TOPICS
        MOVE WS-TOPIC-AUTHORIZED-OPERATIONS(WS-DESCRIBE-TOPIC-PARTITIONS-RESPONSE-DATA-TOPICS(I))
        TO WS-DESCRIBE-TOPIC-PARTITIONS-RESPONSE-DATA-TOPICS(I)-TOPIC-AUTHORIZED-OPERATIONS
    END-PERFORM.

    MOVE UNAUTHORIZED-TOPICS TO WS-DESCRIBE-TOPIC-PARTITIONS-RESPONSE-DATA-TOPICS.

DESCRIBE-TOPIC-PARTITIONS-RESPONSE-TOPIC.
    MOVE ERROR-CODE TO UNAUTHORIZED-PARTITION-ERROR-CODE(1).
    MOVE TOPIC-NAME TO UNAUTHORIZED-TOPIC-NAME(1).
    MOVE TOPIC-ID TO UNAUTHORIZED-TOPIC-ID(1).
    MOVE IS-INTERNAL TO UNAUTHORIZED-TOPIC-IS-INTERNAL(1).
    MOVE PARTITION-DATA TO UNAUTHORIZED-PARTITION-DATA(1, 1).
    RETURN NEW-DESCRIBE-TOPIC-PARTITIONS-RESPONSE-TOPIC.

ENTRY.

STOP RUN.