IDENTIFICATION DIVISION.
PROGRAM-ID. API-VERSION-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY API-KEYS.
    COPY LISTENER-TYPE.
    COPY SUPPORTED-VERSION-RANGE.
    COPY API-VERSIONS-RESPONSE.
    COPY REQUEST-CHANNEL-METRICS.
    COPY BROKER-FEATURES.
    COPY FINALIZED-FEATURES.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-ENABLED-APIS PIC X(20) OCCURS 10.
01 WS-API-VERSIONS PIC X(50) OCCURS 20.
01 WS-SUPPORTED-FEATURES PIC X(50).
01 WS-FINALIZED-FEATURES PIC X(50).
01 WS-FINALIZED-FEATURES-EPOCH PIC 9(9).
01 WS-ZK-MIGRATION-ENABLED PIC 9(1).
01 WS-ALTER-FEATURE-LEVEL-0 PIC 9(1).
01 WS-CLIENT-TELEMETRY-ENABLED PIC 9(1).

PROCEDURE DIVISION.

API-VERSION-MANAGER-MAIN.
    PERFORM ENABLE-APIS.
    PERFORM GET-API-VERSIONS-RESPONSE.
    PERFORM GET-REQUEST-METRICS.
    PERFORM GET-FEATURES.

ENABLE-APIS.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > 10
        SET WS-ENABLED-APIS(I) TO API-KEYS-VALUE(I)
    END-PERFORM.

GET-API-VERSIONS-RESPONSE.
    PERFORM BUILD-API-VERSIONS-RESPONSE.

BUILD-API-VERSIONS-RESPONSE.
    MOVE LISTENER-TYPE TO WS-LISTENER-TYPE.
    MOVE ENABLE-UNSTABLE-LAST-VERSION TO WS-ENABLE-UNSTABLE-LAST-VERSION.
    MOVE SUPPORTED-FEATURES TO WS-SUPPORTED-FEATURES.
    MOVE FINALIZED-FEATURES TO WS-FINALIZED-FEATURES.
    MOVE FINALIZED-FEATURES-EPOCH TO WS-FINALIZED-FEATURES-EPOCH.
    MOVE FALSE TO WS-ZK-MIGRATION-ENABLED.
    MOVE ALTER-FEATURE-LEVEL-0 TO WS-ALTER-FEATURE-LEVEL-0.
    MOVE CLIENT-TELEMETRY-ENABLED TO WS-CLIENT-TELEMETRY-ENABLED.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > 20
        MOVE WS-API-VERSIONS(I) TO API-VERSIONS(I)
    END-PERFORM.
    MOVE THROTTLE-TIME-MS TO WS-THROTTLE-TIME-MS.
    MOVE API-VERSIONS-RESPONSE-BUILDER TO WS-API-VERSIONS-RESPONSE.

GET-REQUEST-METRICS.
    PERFORM BUILD-REQUEST-CHANNEL-METRICS.

BUILD-REQUEST-CHANNEL-METRICS.
    MOVE WS-ENABLED-APIS TO REQUEST-CHANNEL-METRICS-APIS.
    MOVE REQUEST-CHANNEL-METRICS TO WS-REQUEST-CHANNEL-METRICS.

GET-FEATURES.
    MOVE FINALIZED-FEATURES TO WS-FINALIZED-FEATURES.
    MOVE FINALIZED-FEATURES-EPOCH TO WS-FINALIZED-FEATURES-EPOCH.

STOP RUN.