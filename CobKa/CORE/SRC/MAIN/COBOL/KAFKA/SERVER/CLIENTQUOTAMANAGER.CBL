IDENTIFICATION DIVISION.
PROGRAM-ID. CLIENT-QUOTA-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 LOCK.
   05 REENTRANT-READ-WRITE-LOCK.

01 SENSOR-ACCESSOR.
   05 SENSOR-ACCESS.

01 QUOTA-CALLBACK.
   05 DEFAULT-QUOTA-CALLBACK.

01 QUOTA-TYPES.
   05 NO-QUOTAS                PIC 9(1) VALUE 0.
   05 CLIENT-ID-QUOTA-ENABLED  PIC 9(1) VALUE 1.
   05 USER-QUOTA-ENABLED       PIC 9(1) VALUE 2.
   05 USER-CLIENT-ID-QUOTA-ENABLED PIC 9(1) VALUE 4.
   05 CUSTOM-QUOTAS            PIC 9(1) VALUE 8.

01 INACTIVE-SENSOR-EXPIRATION-TIME-SECONDS PIC 9(6) VALUE 3600.
01 DEFAULT-NAME PIC X(10) VALUE "<default>".

01 DEFAULT-CLIENT-ID-QUOTA-ENTITY.
   05 USER-ENTITY PIC X(10) VALUE SPACES.
   05 CLIENT-ID-ENTITY PIC X(10) VALUE DEFAULT-NAME.

01 DEFAULT-USER-QUOTA-ENTITY.
   05 USER-ENTITY PIC X(10) VALUE DEFAULT-NAME.
   05 CLIENT-ID-ENTITY PIC X(10) VALUE SPACES.

01 DEFAULT-USER-CLIENT-ID-QUOTA-ENTITY.
   05 USER-ENTITY PIC X(10) VALUE DEFAULT-NAME.
   05 CLIENT-ID-ENTITY PIC X(10) VALUE DEFAULT-NAME.

01 USER-ENTITY.
   05 SANITIZED-USER PIC X(50).
   05 USER-ENTITY-TYPE PIC 9(1) VALUE 1.
   05 USER-ENTITY-NAME PIC X(50).

01 CLIENT-ID-ENTITY.
   05 CLIENT-ID PIC X(50).
   05 CLIENT-ID-ENTITY-TYPE PIC 9(1) VALUE 2.
   05 CLIENT-ID-ENTITY-NAME PIC X(50).

01 DEFAULT-USER-ENTITY.
   05 DEFAULT-USER-ENTITY-TYPE PIC 9(1) VALUE 3.
   05 DEFAULT-USER-ENTITY-NAME PIC X(10) VALUE DEFAULT-NAME.

01 DEFAULT-CLIENT-ID-ENTITY.
   05 DEFAULT-CLIENT-ID-ENTITY-TYPE PIC 9(1) VALUE 4.
   05 DEFAULT-CLIENT-ID-ENTITY-NAME PIC X(10) VALUE DEFAULT-NAME.

01 KAFKA-QUOTA-ENTITY.
   05 USER-ENTITY PIC X(50).
   05 CLIENT-ID-ENTITY PIC X(50).
   05 SANITIZED-USER PIC X(50).
   05 CLIENT-ID PIC X(50).

01 DEFAULT-TAGS.
   05 USER PIC X(10) VALUE "user".
   05 CLIENT-ID PIC X(10) VALUE "client-id".

01 CLIENT-SENSORS.
   05 METRIC-TAGS PIC X(100).
   05 QUOTA-SENSOR PIC X(50).
   05 THROTTLE-TIME-SENSOR PIC X(50).

PROCEDURE DIVISION.
MAIN-SECTION.
    PERFORM INITIALIZE-QUOTA-MANAGER.
    PERFORM RECORD-AND-GET-THROTTLE-TIME-MS.
    PERFORM RECORD-NO-THROTTLE.
    PERFORM UNRECORD-QUOTA-SENSOR.
    PERFORM GET-MAX-VALUE-IN-QUOTA-WINDOW.
    PERFORM THROTTLE.
    PERFORM UPDATE-QUOTA.
    PERFORM UPDATE-QUOTA-METRIC-CONFIGS.
    PERFORM INITIATE-SHUTDOWN.
    PERFORM SHUTDOWN.

INITIALIZE-QUOTA-MANAGER.
    MOVE SPACES TO LOCK.
    MOVE SPACES TO SENSOR-ACCESSOR.
    MOVE SPACES TO QUOTA-CALLBACK.
    MOVE NO-QUOTAS TO QUOTA-TYPES.
    MOVE INACTIVE-SENSOR-EXPIRATION-TIME-SECONDS TO DELAYQUEUE-SENSOR.
    MOVE SPACES TO DELAYQUEUE.
    PERFORM START-THROTTLED-CHANNEL-REAPER.

RECORD-AND-GET-THROTTLE-TIME-MS.
    IF QUOTAS-ENABLED
        PERFORM RECORD-AND-GET-THROTTLE-TIME-MS-INTERNAL
    ELSE
        MOVE 0 TO RETURN-CODE.

RECORD-AND-GET-THROTTLE-TIME-MS-INTERNAL.
    PERFORM GET-OR-CREATE-QUOTA-SENSORS.
    PERFORM RECORD-QUOTA-SENSOR.
    MOVE 0 TO RETURN-CODE.

RECORD-NO-THROTTLE.
    PERFORM GET-OR-CREATE-QUOTA-SENSORS.
    PERFORM RECORD-QUOTA-SENSOR-NO-THROTTLE.

UNRECORD-QUOTA-SENSOR.
    PERFORM GET-OR-CREATE-QUOTA-SENSORS.
    PERFORM UNRECORD-QUOTA-SENSOR-INTERNAL.

GET-MAX-VALUE-IN-QUOTA-WINDOW.
    IF QUOTAS-ENABLED
        PERFORM GET-MAX-VALUE-IN-QUOTA-WINDOW-INTERNAL
    ELSE
        MOVE DOUBLE-MAX TO RETURN-CODE.

GET-MAX-VALUE-IN-QUOTA-WINDOW-INTERNAL.
    PERFORM GET-OR-CREATE-QUOTA-SENSORS.
    PERFORM GET-QUOTA-LIMIT.
    MOVE RETURN-CODE TO RETURN-CODE.

THROTTLE.
    IF THROTTLE-TIME-MS > 0
        PERFORM GET-OR-CREATE-QUOTA-SENSORS
        PERFORM RECORD-THROTTLE-TIME-SENSOR
        PERFORM ADD-TO-DELAYQUEUE
        PERFORM DEBUG-THROTTLED-CHANNEL.

UPDATE-QUOTA.
    PERFORM ACQUIRE-WRITE-LOCK.
    PERFORM UPDATE-QUOTA-ENTITIES.
    PERFORM UPDATE-QUOTA-METRIC-CONFIGS-INTERNAL.
    PERFORM RELEASE-WRITE-LOCK.

UPDATE-QUOTA-METRIC-CONFIGS.
    PERFORM UPDATE-QUOTA-METRIC-CONFIGS-INTERNAL.

UPDATE-QUOTA-METRIC-CONFIGS-INTERNAL.
    PERFORM GET-ALL-METRICS.
    PERFORM UPDATE-SINGLE-METRIC-OR-ALL-METRICS.

INITIATE-SHUTDOWN.
    PERFORM INITIATE-SHUTDOWN-REAPER.
    PERFORM ADD-NO-OP-TO-DELAYQUEUE.

SHUTDOWN.
    PERFORM INITIATE-SHUTDOWN.
    PERFORM AWAIT-SHUTDOWN-REAPER.

START-THROTTLED-CHANNEL-REAPER.
    PERFORM CREATE-THROTTLED-CHANNEL-REAPER.
    PERFORM START-THROTTLED-CHANNEL-REAPER-THREAD.

QUOTAS-ENABLED.
    IF QUOTA-TYPES NOT EQUAL NO-QUOTAS
        MOVE TRUE TO RETURN-CODE
    ELSE
        MOVE FALSE TO RETURN-CODE.

GET-OR-CREATE-QUOTA-SENSORS.
    PERFORM GET-METRIC-TAGS.
    PERFORM GET-OR-CREATE-QUOTA-SENSOR.
    PERFORM GET-OR-CREATE-THROTTLE-TIME-SENSOR.
    MOVE CLIENT-SENSORS TO RETURN-CODE.

RECORD-QUOTA-SENSOR.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL.

RECORD-QUOTA-SENSOR-NO-THROTTLE.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-NO-THROTTLE.

UNRECORD-QUOTA-SENSOR-INTERNAL.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-NEGATIVE.

GET-QUOTA-LIMIT.
    PERFORM GET-QUOTA-LIMIT-INTERNAL.
    MOVE RETURN-CODE TO RETURN-CODE.

ACQUIRE-WRITE-LOCK.
    ACQUIRE LOCK WRITE-LOCK.

RELEASE-WRITE-LOCK.
    RELEASE LOCK WRITE-LOCK.

GET-ALL-METRICS.
    MOVE METRICS TO RETURN-CODE.

UPDATE-SINGLE-METRIC-OR-ALL-METRICS.
    IF SINGLE-UPDATE
        PERFORM UPDATE-SINGLE-METRIC
    ELSE
        PERFORM UPDATE-ALL-METRICS.

INITIATE-SHUTDOWN-REAPER.
    PERFORM INITIATE-SHUTDOWN-THROTTLED-CHANNEL-REAPER.

AWAIT-SHUTDOWN-REAPER.
    PERFORM AWAIT-SHUTDOWN-THROTTLED-CHANNEL-REAPER.

GET-METRIC-TAGS.
    PERFORM GET-METRIC-TAGS-INTERNAL.
    MOVE METRIC-TAGS TO RETURN-CODE.

GET-OR-CREATE-QUOTA-SENSOR.
    PERFORM GET-OR-CREATE-SENSOR.
    MOVE QUOTA-SENSOR TO RETURN-CODE.

GET-OR-CREATE-THROTTLE-TIME-SENSOR.
    PERFORM GET-OR-CREATE-SENSOR.
    MOVE THROTTLE-TIME-SENSOR TO RETURN-CODE.

RECORD-QUOTA-SENSOR-INTERNAL.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-WITH-THROTTLE.

RECORD-QUOTA-SENSOR-INTERNAL-NO-THROTTLE.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-WITH-NO-THROTTLE.

RECORD-QUOTA-SENSOR-INTERNAL-NEGATIVE.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-WITH-NEGATIVE-VALUE.

GET-QUOTA-LIMIT-INTERNAL.
    PERFORM GET-QUOTA-LIMIT-FROM-CALLBACK.
    MOVE RETURN-CODE TO RETURN-CODE.

UPDATE-SINGLE-METRIC.
    PERFORM UPDATE-SINGLE-METRIC-INTERNAL.

UPDATE-ALL-METRICS.
    PERFORM UPDATE-ALL-METRICS-INTERNAL.

INITIATE-SHUTDOWN-THROTTLED-CHANNEL-REAPER.
    PERFORM INITIATE-SHUTDOWN-THROTTLED-CHANNEL-REAPER-INTERNAL.

AWAIT-SHUTDOWN-THROTTLED-CHANNEL-REAPER.
    PERFORM AWAIT-SHUTDOWN-THROTTLED-CHANNEL-REAPER-INTERNAL.

GET-METRIC-TAGS-INTERNAL.
    PERFORM GET-METRIC-TAGS-BASED-ON-QUOTA-TYPES.
    MOVE METRIC-TAGS TO RETURN-CODE.

GET-OR-CREATE-SENSOR.
    PERFORM GET-OR-CREATE-SENSOR-INTERNAL.
    MOVE RETURN-CODE TO RETURN-CODE.

RECORD-QUOTA-SENSOR-INTERNAL-WITH-THROTTLE.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-WITH-THROTTLE-LOGIC.

RECORD-QUOTA-SENSOR-INTERNAL-WITH-NO-THROTTLE.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-WITH-NO-THROTTLE-LOGIC.

RECORD-QUOTA-SENSOR-INTERNAL-WITH-NEGATIVE-VALUE.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-WITH-NEGATIVE-VALUE-LOGIC.

GET-QUOTA-LIMIT-FROM-CALLBACK.
    PERFORM GET-QUOTA-LIMIT-FROM-CALLBACK-INTERNAL.
    MOVE RETURN-CODE TO RETURN-CODE.

UPDATE-SINGLE-METRIC-INTERNAL.
    PERFORM UPDATE-SINGLE-METRIC-INTERNAL-LOGIC.

UPDATE-ALL-METRICS-INTERNAL.
    PERFORM UPDATE-ALL-METRICS-INTERNAL-LOGIC.

INITIATE-SHUTDOWN-THROTTLED-CHANNEL-REAPER-INTERNAL.
    PERFORM INITIATE-SHUTDOWN-THROTTLED-CHANNEL-REAPER-LOGIC.

AWAIT-SHUTDOWN-THROTTLED-CHANNEL-REAPER-INTERNAL.
    PERFORM AWAIT-SHUTDOWN-THROTTLED-CHANNEL-REAPER-LOGIC.

GET-METRIC-TAGS-BASED-ON-QUOTA-TYPES.
    PERFORM GET-METRIC-TAGS-BASED-ON-QUOTA-TYPES-LOGIC.
    MOVE METRIC-TAGS TO RETURN-CODE.

GET-OR-CREATE-SENSOR-INTERNAL.
    PERFORM GET-OR-CREATE-SENSOR-LOGIC.
    MOVE RETURN-CODE TO RETURN-CODE.

RECORD-QUOTA-SENSOR-INTERNAL-WITH-THROTTLE-LOGIC.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-WITH-THROTTLE-LOGIC-STEPS.

RECORD-QUOTA-SENSOR-INTERNAL-WITH-NO-THROTTLE-LOGIC.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-WITH-NO-THROTTLE-LOGIC-STEPS.

RECORD-QUOTA-SENSOR-INTERNAL-WITH-NEGATIVE-VALUE-LOGIC.
    PERFORM RECORD-QUOTA-SENSOR-INTERNAL-WITH-NEGATIVE-VALUE-LOGIC-STEPS.

GET-QUOTA-LIMIT-FROM-CALLBACK-INTERNAL.
    PERFORM GET-QUOTA-LIMIT-FROM-CALLBACK-LOGIC.
    MOVE RETURN-CODE TO RETURN-CODE.

UPDATE-SINGLE-METRIC-INTERNAL-LOGIC.
    PERFORM UPDATE-SINGLE-METRIC-INTERNAL-LOGIC-STEPS.

UPDATE-ALL-METRICS-INTERNAL-LOGIC.
    PERFORM UPDATE-ALL-METRICS-INTERNAL-LOGIC-STEPS.

INITIATE-SHUTDOWN-THROTTLED-CHANNEL-REAPER-LOGIC.
    PERFORM INITIATE-SHUTDOWN-THROTTLED-CHANNEL-REAPER-LOGIC-STEPS.

AWAIT-SHUTDOWN-THROTTLED-CHANNEL-REAPER-LOGIC.
    PERFORM AWAIT-SHUTDOWN-THROTTLED-CHANNEL-REAPER-LOGIC-STEPS.

GET-METRIC-TAGS-BASED-ON-QUOTA-TYPES-LOGIC.
    PERFORM GET-METRIC-TAGS-BASED-ON-QUOTA-TYPES-LOGIC-STEPS.
    MOVE METRIC-TAGS TO RETURN-CODE.

GET-OR-CREATE-SENSOR-LOGIC.
    PERFORM GET-OR-CREATE-SENSOR-LOGIC-STEPS.
    MOVE RETURN-CODE TO RETURN-CODE.

CREATE-THROTTLED-CHANNEL-REAPER.
    PERFORM CREATE-THROTTLED-CHANNEL-REAPER-LOGIC.

START-THROTTLED-CHANNEL-REAPER-THREAD.
    PERFORM START-THROTTLED-CHANNEL-REAPER-THREAD-LOGIC.

RECORD-THROTTLE-TIME-SENSOR.
    PERFORM RECORD-THROTTLE-TIME-SENSOR-LOGIC.

ADD-TO-DELAYQUEUE.
    PERFORM ADD-TO-DELAYQUEUE-LOGIC.

DEBUG-THROTTLED-CHANNEL.
    PERFORM DEBUG-THROTTLED-CHANNEL-LOGIC.