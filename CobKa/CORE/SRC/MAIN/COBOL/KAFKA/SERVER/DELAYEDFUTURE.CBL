IDENTIFICATION DIVISION.
PROGRAM-ID. DELAYED-FUTURE.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL-JAVA-TYPES.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 FUTURES-TABLE.
    05 FUTURES-COUNT PIC 9(3) VALUE 0.
    05 FUTURE-ITEM OCCURS 0 TO 999 TIMES DEPENDING ON FUTURES-COUNT
       PIC X(16).
01 RESPONSE-CALLBACK PIC X(16).
01 TIMEOUT-MS PIC 9(9) COMP.
01 DELAYED-FUTURE-KEY.
    05 KEY-LABEL PIC X(20) VALUE "DELAYED-FUTURE-KEY".

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM TRY-COMPLETE-ELSE-WATCH.
    PERFORM ON-COMPLETE.
    PERFORM ON-EXPIRATION.
    STOP RUN.

TRY-COMPLETE-ELSE-WATCH.
    MOVE FUNCTION ALL-JAVA-TYPES("kafka.server.DelayedFuture") TO DELAYED-FUTURE-KEY.
    CALL "tryCompleteElseWatch" USING TIMEOUT-MS, FUTURES-TABLE, RESPONSE-CALLBACK
         RETURNING DELAYED-FUTURE-KEY.

ON-COMPLETE.
    CALL "onComplete" USING DELAYED-FUTURE-KEY.

ON-EXPIRATION.
    CALL "onExpiration" USING DELAYED-FUTURE-KEY.

END PROGRAM DELAYED-FUTURE.

IDENTIFICATION DIVISION.
PROGRAM-ID. DELAYED-FUTURE-PURGATORY.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL-JAVA-TYPES.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 PURGATORY-NAME PIC X(20).
01 BROKER-ID PIC 9(3).
01 PURGATORY-KEY.
    05 KEY-LABEL PIC X(20) VALUE "DELAYED-FUTURE-KEY".
01 THREAD-POOL-EXECUTOR.
    05 CORE-POOL-SIZE PIC 9(3) VALUE 1.
    05 MAX-POOL-SIZE PIC 9(3) VALUE 1.
    05 KEEP-ALIVE-TIME PIC 9(9) COMP VALUE 0.
    05 TIME-UNIT PIC X(12) VALUE "MILLISECONDS".
    05 WORK-QUEUE PIC X(16) VALUE "LinkedBlockingQueue".
    05 THREAD-FACTORY PIC X(16) VALUE "KafkaThreadFactory".

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM INITIALIZE-PURGATORY.
    PERFORM SHUTDOWN.
    STOP RUN.

INITIALIZE-PURGATORY.
    MOVE "DelayedExecutor" TO THREAD-FACTORY.
    MOVE "delayed-future-purgatory" TO PURGATORY-NAME.
    MOVE 123 TO BROKER-ID.
    CALL "new" USING FUNCTION ALL-JAVA-TYPES("kafka.server.DelayedFuturePurgatory")
         PURGATORY-NAME, BROKER-ID
         RETURNING PURGATORY-KEY.
    CALL "tryCompleteElseWatch" USING 10000, FUTURES-TABLE, RESPONSE-CALLBACK
         RETURNING PURGATORY-KEY.

SHUTDOWN.
    CALL "shutdown" USING PURGATORY-KEY.
    CALL "isShutdown" USING PURGATORY-KEY
         RETURNING PROGRAM-STATUS.

END PROGRAM DELAYED-FUTURE-PURGATORY.