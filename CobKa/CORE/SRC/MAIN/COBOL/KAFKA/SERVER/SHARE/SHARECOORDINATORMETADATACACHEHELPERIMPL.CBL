IDENTIFICATION DIVISION.
PROGRAM-ID. SHARECOORDINATORMETADATACACHECACHEIMPL.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-TOPIC-SET PIC X(256) OCCURS 1 TO 256 TIMES DEPENDING ON WS-TOPIC-SET-SIZE.
01 WS-TOPIC-SET-SIZE PIC 9(3) COMP.
01 WS-TOPIC-METADATA-TABLE.
   05 WS-TOPIC-METADATA OCCURS 1 TO 256 TIMES DEPENDING ON WS-TOPIC-METADATA-SIZE.
      10 WS-TOPIC-NAME PIC X(128).
      10 WS-TOPIC-PARTITION-INDEX PIC 9(5) COMP.
      10 WS-TOPIC-LEADER-ID PIC 9(5) COMP.
      10 WS-TOPIC-ERROR-CODE PIC 9(5) COMP.
01 WS-TOPIC-METADATA-SIZE PIC 9(3) COMP.
01 WS-ALIVE-BROKER-NODES-TABLE.
   05 WS-ALIVE-BROKER-NODE OCCURS 1 TO 256 TIMES DEPENDING ON WS-ALIVE-BROKER-NODES-SIZE.
      10 WS-BROKER-ID PIC 9(5) COMP.
01 WS-ALIVE-BROKER-NODES-SIZE PIC 9(3) COMP.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM CONTAINS-TOPIC.
    PERFORM GET-SHARE-COORDINATOR.
    PERFORM GET-CLUSTER-NODES.
    STOP RUN.

CONTAINS-TOPIC.
    CALL "CONTAINS" USING WS-TOPIC-NAME
                         RETURNING WS-CONTAINS-FLAG.

GET-SHARE-COORDINATOR.
    MOVE 1 TO WS-TOPIC-SET-SIZE.
    MOVE WS-INTERNAL-TOPIC-NAME TO WS-TOPIC-SET(1).
    CALL "GET-TOPIC-METADATA" USING WS-TOPIC-SET
                                   WS-TOPIC-SET-SIZE
                                   WS-TOPIC-METADATA-TABLE
                                   WS-TOPIC-METADATA-SIZE
                                   WS-INTER-BROKER-LISTENER-NAME
                                   WS-BOOLEAN-FLAG
                                   WS-BOOLEAN-FLAG.
    PERFORM VARYING WS-IDX FROM 1 BY 1 UNTIL WS-IDX > WS-TOPIC-METADATA-SIZE
        IF WS-TOPIC-PARTITION-INDEX(WS-IDX) = WS-PARTITION-INDEX
            AND WS-TOPIC-LEADER-ID(WS-IDX) NOT EQUAL METADATA-RESPONSE-NO-LEADER-ID
            CALL "GET-ALIVE-BROKER-NODE" USING WS-TOPIC-LEADER-ID(WS-IDX)
                                              WS-INTER-BROKER-LISTENER-NAME
                                              RETURNING WS-SHARE-COORDINATOR
            IF WS-SHARE-COORDINATOR NOT EQUAL NODE-NO-NODE
                MOVE WS-SHARE-COORDINATOR TO RETURN-VALUE
                GOBACK
            END-IF
        END-IF
    END-PERFORM.
    MOVE NODE-NO-NODE TO RETURN-VALUE.

GET-CLUSTER-NODES.
    CALL "GET-ALIVE-BROKER-NODES" USING WS-INTER-BROKER-LISTENER-NAME
                                        WS-ALIVE-BROKER-NODES-TABLE
                                        WS-ALIVE-BROKER-NODES-SIZE.
    MOVE WS-ALIVE-BROKER-NODES-TABLE TO RETURN-VALUE.

COPY "SHARECOORDINATORHELPER".
COPY "METADATACACHE".
COPY "NODE".
COPY "ERRORS".
COPY "METADATARESPONSE".
COPY "SHAREENTRYTOOL".
COPY "LOGGER".

PROCEDURE DIVISION.