IDENTIFICATION DIVISION.
PROGRAM-ID. REPLICAFETCHERTHREAD.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY KAFKACONFIG.
    COPY REPLICAQUOTA.
    COPY REPLICAMANAGER.
    COPY TOPICPARTITION.
    COPY MEMORYRECORDS.
    COPY FETCHRESPONSE.
    COPY OFFSETANDEPOCH.
    COPY LOGAPPENDINFO.
    COPY LOGSTARTOFFSETINCREMENTREASON.
    COPY METADATAVERSION.
    COPY TIERSTATEMACHINE.
    COPY ABSTRACTFETCHERTHREAD.
    COPY FAILEDPARTITIONS.
    COPY LEADERBROKERSTATS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-PARTITIONSWITHNEWWATERMARK PIC X(30) VALUE "partitionsWithNewHighWatermark".
01 WS-PARTITIONSWITHNEWWATERMARK-TAB OCCURS 1 TO 100 TIMES DEPENDING ON WS-PARTITIONSWITHNEWWATERMARK-CNT.
   05 WS-PARTITIONS-TOPIC PIC X(50).
   05 WS-PARTITIONS-PARTITION PIC 9(9).
01 WS-PARTITIONSWITHNEWWATERMARK-CNT PIC 9(3) VALUE 0.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    INITIALIZE WS-PARTITIONSWITHNEWWATERMARK-TAB.

    PERFORM DOWORK-PARAGRAPH.
    PERFORM COMPLETEDELAYEDFETCHREQUESTS-PARAGRAPH.

DOWORK-PARAGRAPH.
    PERFORM SUPERCLASS-DOWORK.
    CALL "COMPLETEDELIVEREDFETCHREQUESTS" USING WS-PARTITIONSWITHNEWWATERMARK-TAB, WS-PARTITIONSWITHNEWWATERMARK-CNT.

COMPLETEDELIVEREDFETCHREQUESTS-PARAGRAPH.
    IF WS-PARTITIONSWITHNEWWATERMARK-CNT > 0
        CALL "COMPLETEDELIVEREDFETCHREQUESTS" USING WS-PARTITIONSWITHNEWWATERMARK-TAB, WS-PARTITIONSWITHNEWWATERMARK-CNT
        INITIALIZE WS-PARTITIONSWITHNEWWATERMARK-TAB
        MOVE 0 TO WS-PARTITIONSWITHNEWWATERMARK-CNT.

PROCESSPARTITIONDATA-PARAGRAPH.
    MOVE TOPICPARTITION TO WS-PARTITIONS-TOPIC.
    MOVE FETCHOFFSET TO WS-PARTITIONS-PARTITION.
    ADD 1 TO WS-PARTITIONSWITHNEWWATERMARK-CNT.
    PERFORM MAYBEWARNIFOVERSIZEDRECORDS-PARAGRAPH.
    PERFORM TRUNCATE-PARAGRAPH.
    MOVE LOGAPPENDINFO TO RETURN-VALUE.

MAYBEWARNIFOVERSIZEDRECORDS-PARAGRAPH.
    CALL "MAYBEWARNIFOVERSIZEDRECORDS" USING MEMORYRECORDS, TOPICPARTITION, METADATAVERSIONSUPPLIER.

TRUNCATE-PARAGRAPH.
    MOVE TOPICPARTITION TO WS-PARTITIONS-TOPIC.
    MOVE OFFSETTRUNCATIONSTATE-OFFSET TO WS-PARTITIONS-PARTITION.
    CALL "TRUNCATE" USING WS-PARTITIONS-TOPIC, WS-PARTITIONS-PARTITION, OFFSETTRUNCATIONSTATE.
    CALL "TRUNCATEFULLYANDDSTART" USING TOPICPARTITION, OFFSET.