IDENTIFICATION DIVISION.
PROGRAM-ID. DELAYED-ELECT-LEADER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY "KAFKA-COMMON.COPY".
    COPY "REPLICA-MANAGER.COPY".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-DELAYED-ELECT-LEADER.
   05 WS-DELAY-MS                PIC S9(9) COMP.
   05 WS-EXPECTED-LEADERS        USAGE IS OBJECT-REFERENCE.
   05 WS-RESULTS                 USAGE IS OBJECT-REFERENCE.
   05 WS-REPLICA-MANAGER         USAGE IS OBJECT-REFERENCE.
   05 WS-RESPONSE-CALLBACK       USAGE IS OBJECT-REFERENCE.
   05 WS-WAITING-PARTITIONS      USAGE IS OBJECT-REFERENCE.
   05 WS-FULL-RESULTS            USAGE IS OBJECT-REFERENCE.

PROCEDURE DIVISION.

DELAYED-ELECT-LEADER-LOGIC.
    PERFORM ON-EXPIRATION.
    PERFORM ON-COMPLETE.
    PERFORM TRY-COMPLETE.

ON-EXPIRATION.
    CONTINUE.

ON-COMPLETE.
    PERFORM UPDATE-WAITING.
    MOVE WS-WAITING-PARTITIONS TO WS-RESULTS.
    PERFORM WS-RESPONSE-CALLBACK.

TRY-COMPLETE.
    PERFORM UPDATE-WAITING.
    IF WS-WAITING-PARTITIONS IS EMPTY
        PERFORM FORCE-COMPLETE
        RETURN TRUE
    ELSE
        RETURN FALSE.

UPDATE-WAITING.
    MOVE WS-REPLICA-MANAGER-METADATA-CACHE TO WS-METADATA-CACHE.
    MOVE FUNCTION COLLECT(
        FOR TP IN WS-WAITING-PARTITIONS
        WHERE WS-METADATA-CACHE-GET-LEADER-AND-ISR(TP-TOPIC, TP-PARTITION)
              EXISTS AND
              WS-METADATA-CACHE-GET-LEADER-AND-ISR(TP-TOPIC, TP-PARTITION)-LEADER = TP-LEADER
        RETURN TP) TO WS-COMPLETED-PARTITIONS.
    PERFORM VARYING TP IN WS-COMPLETED-PARTITIONS
        MOVE TP TO WS-WAITING-PARTITIONS
        MOVE KAFKA-COMMON-API-ERROR-NONE TO WS-FULL-RESULTS(TP)
    END-PERFORM.

FORCE-COMPLETE.
    CONTINUE.

STOP RUN.