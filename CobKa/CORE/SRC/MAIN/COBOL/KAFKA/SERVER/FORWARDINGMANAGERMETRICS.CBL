IDENTIFICATION DIVISION.
PROGRAM-ID. FORWARDING-MANAGER-METRICS.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY METRICS-COPY.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 METRIC-GROUP-NAME PIC X(25) VALUE 'ForwardingManager'.
01 QUEUE-TIME-MS-NAME PIC X(15) VALUE 'QueueTimeMs'.
01 REMOTE-TIME-MS-NAME PIC X(15) VALUE 'RemoteTimeMs'.

01 QUEUE-LENGTH-NAME.
    05 METRIC-NAME PIC X(11) VALUE 'QueueLength'.
    05 DESCRIPTION PIC X(90) VALUE 'The current number of RPCs that are waiting in the broker''s forwarding manager queue, waiting to be sent to the controller.'.

01 QUEUE-LENGTH PIC 9(9) COMP-5.

01 LATENCY-HISTOGRAM-RECORD.
    05 SENSOR-NAME PIC X(15).
    05 LATENCY-P99-NAME PIC X(15).
    05 LATENCY-P999-NAME PIC X(15).
    05 MAX-LATENCY PIC 9(18) COMP-5.

PROCEDURE DIVISION.
FORWARDING-MANAGER-METRICS-INIT.
    CALL 'CREATE-METRICS' USING METRIC-GROUP-NAME, QUEUE-TIME-MS-NAME, REMOTE-TIME-MS-NAME, QUEUE-LENGTH-NAME, MAX-LATENCY
                           RETURNING LATENCY-HISTOGRAM-RECORD.

    MOVE 0 TO QUEUE-LENGTH.
    CALL 'ADD-GAUGE-METRIC' USING QUEUE-LENGTH-NAME, QUEUE-LENGTH.

FORWARDING-MANAGER-METRICS-CLOSE.
    CALL 'REMOVE-SENSOR' USING LATENCY-HISTOGRAM-RECORD(SENSOR-NAME).
    CALL 'REMOVE-METRIC' USING LATENCY-HISTOGRAM-RECORD(LATENCY-P99-NAME).
    CALL 'REMOVE-METRIC' USING LATENCY-HISTOGRAM-RECORD(LATENCY-P999-NAME).
    CALL 'REMOVE-GAUGE-METRIC' USING QUEUE-LENGTH-NAME.

RECORD-QUEUE-TIME.
    CALL 'RECORD-HISTOGRAM' USING LATENCY-HISTOGRAM-RECORD(SENSOR-NAME), LATENCY.

RECORD-REMOTE-TIME.
    CALL 'RECORD-HISTOGRAM' USING LATENCY-HISTOGRAM-RECORD(SENSOR-NAME), LATENCY.

INCREMENT-QUEUE-LENGTH.
    ADD 1 TO QUEUE-LENGTH.

DECREMENT-QUEUE-LENGTH.
    SUBTRACT 1 FROM QUEUE-LENGTH.