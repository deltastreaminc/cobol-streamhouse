IDENTIFICATION DIVISION.
PROGRAM-ID. AUTO-TOPIC-CREATION-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY "KAFKA-CONFIG".
    COPY "KAFKA-COORDINATOR-GROUP".
    COPY "KAFKA-COORDINATOR-TRANSACTION".
    COPY "KAFKA-COORDINATOR-SHARE".
    COPY "KAFKA-SERVER-COMMON".
    COPY "KAFKA-TOPIC".
    COPY "KAFKA-CLIENT-REQUEST".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-INFLIGHT-TOPICS.
    05 WS-INFLIGHT-TOPICS-MAP USAGE IS OBJECT REFERENCE.
01 WS-CREATABLE-TOPICS.
    05 WS-CREATABLE-TOPIC USAGE IS OBJECT REFERENCE.
    05 WS-CREATABLE-TOPIC-COLLECTION USAGE IS OBJECT REFERENCE.
01 WS-UNCREATABLE-TOPICS.
    05 WS-UNCREATABLE-TOPIC USAGE IS OBJECT REFERENCE.
01 WS-CREATE-TOPICS-REQUEST.
    05 WS-CREATE-TOPICS-REQUEST-DATA USAGE IS OBJECT REFERENCE.
    05 WS-CREATE-TOPICS-REQUEST-BUILDER USAGE IS OBJECT REFERENCE.
01 WS-REQUEST-COMPLETION-HANDLER USAGE IS OBJECT REFERENCE.
01 WS-REQUEST-CONTEXT USAGE IS OBJECT REFERENCE.
01 WS-REQUEST-HEADER USAGE IS OBJECT REFERENCE.
01 WS-TOPIC-CONFIG USAGE IS OBJECT REFERENCE.
01 WS-TOPIC-CONFIG-COLLECTION USAGE IS OBJECT REFERENCE.

PROCEDURE DIVISION.

CREATE-TOPICS.
    MOVE FUNCTION NEW(ConcurrentHashMap) TO WS-INFLIGHT-TOPICS-MAP.
    MOVE FUNCTION NEW(HashMap) TO WS-CREATABLE-TOPICS.
    MOVE FUNCTION NEW(ArrayList) TO WS-UNCREATABLE-TOPICS.

    PERFORM FILTER-CREATABLE-TOPICS
        USING WS-CREATABLE-TOPICS, WS-UNCREATABLE-TOPICS.

    IF WS-CREATABLE-TOPICS IS NOT EMPTY
        PERFORM SEND-CREATE-TOPIC-REQUEST
            USING WS-CREATABLE-TOPICS, WS-REQUEST-CONTEXT.

    RETURN WS-UNCREATABLE-TOPICS, WS-CREATABLE-TOPICS.

FILTER-CREATABLE-TOPICS.
    PERFORM VARYING TOPIC-NAME THROUGH WS-TOPIC-NAMES
        WHEN VALID-TOPIC-NAME(TOPIC-NAME)
            IF TOPIC-NAME NOT IN WS-INFLIGHT-TOPICS-MAP
                MOVE CREAT
ABLE-TOPIC(TOPIC-NAME) TO WS-CREATABLE-TOPIC
                ADD WS-CREATABLE-TOPIC TO WS-CREATABLE-TOPICS
            ELSE
                MOVE METADATA-RESPONSE-TOPIC(TOPIC-NAME, Errors.UNKNOWN_TOPIC_OR_PARTITION) 
                    TO WS-UNCREATABLE-TOPIC
                ADD WS-UNCREATABLE-TOPIC TO WS-UNCREATABLE-TOPICS
            END-IF
        WHEN OTHER
            MOVE METADATA-RESPONSE-TOPIC(TOPIC-NAME, Errors.INVALID_TOPIC_EXCEPTION)
                TO WS-UNCREATABLE-TOPIC
            ADD WS-UNCREATABLE-TOPIC TO WS-UNCREATABLE-TOPICS
        END-PERFORM.

SEND-CREATE-TOPIC-REQUEST.
    MOVE FUNCTION NEW(CreateTopicsRequestData) TO WS-CREATE-TOPICS-REQUEST-DATA.
    MOVE FUNCTION NEW(CreateTopicsRequest.Builder) TO WS-CREATE-TOPICS-REQUEST-BUILDER.
    PERFORM VARYING WS-CREATABLE-TOPIC THROUGH WS-CREATABLE-TOPICS
        ADD WS-CREATABLE-TOPIC TO WS-CREATE-TOPICS-REQUEST-DATA.TOPICS
    END-PERFORM.
    MOVE WS-CREATE-TOPICS-REQUEST-DATA TO WS-CREATE-TOPICS-REQUEST-BUILDER.TOPICS.

    MOVE FUNCTION NEW(RequestHeader) TO WS-REQUEST-HEADER.
    MOVE WS-REQUEST-CONTEXT TO WS-REQUEST-HEADER.
    MOVE WS-CREATE-TOPICS-REQUEST-BUILDER.BUILD(WS-REQUEST-HEADER.VERSION) TO WS-CREATE-TOPICS-REQUEST.

    MOVE FUNCTION NEW(ControllerRequestCompletionHandler) TO WS-REQUEST-COMPLETION-HANDLER.
    CALL "SEND-REQUEST" USING WS-CREATE-TOPICS-REQUEST, WS-REQUEST-COMPLETION-HANDLER.

    RETURN WS-CREATABLE-TOPICS.

CREAT
ABLE-TOPIC.
    EVALUATE TOPIC-NAME
        WHEN GROUP_METADATA_TOPIC_NAME
            MOVE FUNCTION NEW(CreatableTopic) TO WS-CREATABLE-TOPIC
            MOVE TOPIC-NAME TO WS-CREATABLE-TOPIC.NAME
            MOVE CONFIG-GROUP-METADATA-TOPIC TO WS-CREATABLE-TOPIC.CONFIGS
        WHEN TRANSACTION_STATE_TOPIC_NAME
            MOVE FUNCTION NEW(CreatableTopic) TO WS-CREATABLE-TOPIC
            MOVE TOPIC-NAME TO WS-CREATABLE-TOPIC.NAME
            MOVE CONFIG-TRANSACTION-TOPIC TO WS-CREATABLE-TOPIC.CONFIGS
        WHEN SHARE_GROUP_STATE_TOPIC_NAME
            MOVE FUNCTION NEW(CreatableTopic) TO WS-CREATABLE-TOPIC
            MOVE TOPIC-NAME TO WS-CREATABLE-TOPIC.NAME
            MOVE CONFIG-SHARE-GROUP-STATE-TOPIC TO WS-CREATABLE-TOPIC.CONFIGS
        WHEN OTHER
            MOVE FUNCTION NEW(CreatableTopic) TO WS-CREATABLE-TOPIC
            MOVE TOPIC-NAME TO WS-CREATABLE-TOPIC.NAME
            MOVE CONFIG-DEFAULT-TOPIC TO WS-CREATABLE-TOPIC
    END-EVALUATE.
    RETURN WS-CREATABLE-TOPIC.

VALID-TOPIC-NAME.
    TRY
        CALL "VALIDATE-TOPIC" USING TOPIC-NAME
        RETURN TRUE
    CATCH INVALID-TOPIC-EXCEPTION
        RETURN FALSE
    END-TRY.

METADATA-RESPONSE-TOPIC.
    MOVE FUNCTION NEW(MetadataResponseTopic) TO WS-UNCREATABLE-TOPIC.
    MOVE ERROR-CODE TO WS-UNCREATABLE-TOPIC.ERROR-CODE.
    MOVE TOPIC-NAME TO WS-UNCREATABLE-TOPIC.NAME.
    MOVE FUNCTION IS-INTERNAL(TOPIC-NAME) TO WS-UNCREATABLE-TOPIC.IS-INTERNAL.
    RETURN WS-UNCREATABLE-TOPIC.

CONFIG-GROUP-METADATA-TOPIC.
    MOVE FUNCTION NEW(CreatableTopicConfigCollection) TO WS-TOPIC-CONFIG-COLLECTION.
    PERFORM VARYING TOPIC-CONFIG THROUGH CONFIG-GROUP-METADATA
        MOVE FUNCTION NEW(CreatableTopicConfig) TO WS-TOPIC-CONFIG
        MOVE TOPIC-CONFIG.NAME TO WS-TOPIC-CONFIG.NAME
        MOVE TOPIC-CONFIG.VALUE TO WS-TOPIC-CONFIG.VALUE
        ADD WS-TOPIC-CONFIG TO WS-TOPIC-CONFIG-COLLECTION
    END-PERFORM.
    RETURN WS-TOPIC-CONFIG-COLLECTION.

CONFIG-TRANSACTION-TOPIC.
    MOVE FUNCTION NEW(CreatableTopicConfigCollection) TO WS-TOPIC-CONFIG-COLLECTION.
    PERFORM VARYING TOPIC-CONFIG THROUGH CONFIG-TRANSACTION
        MOVE FUNCTION NEW(CreatableTopicConfig) TO WS-TOPIC-CONFIG
        MOVE TOPIC-CONFIG.NAME TO WS-TOPIC-CONFIG.NAME
        MOVE TOPIC-CONFIG.VALUE TO WS-TOPIC-CONFIG.VALUE
        ADD WS-TOPIC-CONFIG TO WS-TOPIC-CONFIG-COLLECTION
    END-PERFORM.
    RETURN WS-TOPIC-CONFIG-COLLECTION.

CONFIG-SHARE-GROUP-STATE-TOPIC.
    MOVE FUNCTION NEW(CreatableTopicConfigCollection) TO WS-TOPIC-CONFIG-COLLECTION.
    PERFORM VARYING TOPIC-CONFIG THROUGH CONFIG-SHARE-GROUP-STATE
        MOVE FUNCTION NEW(CreatableTopicConfig) TO WS-TOPIC-CONFIG
        MOVE TOPIC-CONFIG.NAME TO WS-TOPIC-CONFIG.NAME
        MOVE TOPIC-CONFIG.VALUE TO WS-TOPIC-CONFIG.VALUE
        ADD WS-TOPIC-CONFIG TO WS-TOPIC-CONFIG-COLLECTION
    END-PERFORM.
    RETURN WS-TOPIC-CONFIG-COLLECTION.

CONFIG-DEFAULT-TOPIC.
    MOVE FUNCTION NEW(CreatableTopic) TO WS-CREATABLE-TOPIC.
    MOVE TOPIC-NAME TO WS-CREATABLE-TOPIC.NAME.
    MOVE CONFIG-NUM-PARTITIONS TO WS-CREATABLE-TOPIC.NUM-PARTITIONS.
    MOVE CONFIG-DEFAULT-REPLICATION-FACTOR TO WS-CREATABLE-TOPIC.REPLICATION-FACTOR.
    RETURN WS-CREATABLE-TOPIC.

CLEAR-INFLIGHT-REQUESTS.
    PERFORM VARYING TOPIC-NAME THROUGH WS-CREATABLE-TOPICS
        REMOVE TOPIC-NAME FROM WS-INFLIGHT-TOPICS-MAP
    END-PERFORM.

STOP RUN.