IDENTIFICATION DIVISION.
PROGRAM-ID. BROKER-LIFECYCLE-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
    SPECIAL-NAMES.
        CALENDAR-NAME IS TIME.

DATA DIVISION.
    WORKING-STORAGE SECTION.
        01 WS-CONFIG.
            05 WS-CONFIG-NODE-ID                 PIC 9(18).
            05 WS-CONFIG-RACK                    PIC X(100).
            05 WS-CONFIG-INITIAL-REGISTRATION-TIMEOUT-NS
                                                PIC 9(18) COMP.
            05 WS-CONFIG-BROKER-SESSION-TIMEOUT-MS
                                                PIC 9(18) COMP.
            05 WS-CONFIG-BROKER-HEARTBEAT-INTERVAL-MS
                                                PIC 9(18) COMP.
        01 WS-BROKER-INCARNATION-ID            PIC X(36).
        01 WS-INITIAL-CATCH-UP-FUTURE          PIC X(50).
        01 WS-INITIAL-UNFENCE-FUTURE           PIC X(50).
        01 WS-CONTROLLED-SHUTDOWN-FUTURE       PIC X(50).
        01 WS-BROKER-EPOCH                     PIC 9(18) COMP.
        01 WS-BROKER-STATE                     PIC X(25).
        01 WS-HIGHEST-METADATA-OFFSET-PROVIDER PROCEDURE-POINTER.
        01 WS-READY-TO-UNFENCE                 PIC X.
        01 WS-OFFLINE-DIRS                     OCCURS 100 TIMES.
            05 WS-OFFLINE-DIR-ID               PIC X(36).
            05 WS-OFFLINE-DIR-COMM-FAILED      PIC X.
        01 WS-GOT-CONTROLLED-SHUTDOWN-RESPONSE PIC X.
        01 WS-REGISTERED                       PIC X.
        01 WS-COMMUNICATION-IN-FLIGHT          PIC X.
        01 WS-NEXT-SCHEDULING-SHOULD-BE-IMMEDIATE
                                              PIC X.
        01 WS-INITIAL-REGISTRATION-SUCCEEDED  PIC X.
        01 WS-CLUSTER-ID                       PIC X(100).
        01 WS-ADVERTISED-LISTENERS.
            05 WS-LISTENER-COUNT              PIC 9(5) COMP.
            05 WS-LISTENER-ARRAY OCCURS 100 TIMES.
                10 WS-LISTENER-NAME           PIC X(100).
                10 WS-LISTENER-PORT           PIC 9(5) COMP.
                10 WS-LISTENER-SECURITY-PROTOCOL
                                              PIC X(50).
        01 WS-SUPPORTED-FEATURES.
            05 WS-FEATURE-COUNT              PIC 9(5) COMP.
            05 WS-FEATURE-ARRAY OCCURS 100 TIMES.
                10 WS-FEATURE-NAME           PIC X(100).
                10 WS-FEATURE-MIN-VERSION    PIC 9(5) COMP.
                10 WS-FEATURE-MAX-VERSION    PIC 9(5) COMP.
        01 WS-CHANNEL-MANAGER                  PIC X(50).
        01 WS-PREVIOUS-BROKER-EPOCH            PIC 9(18) COMP.
        01 WS-EVENT-QUEUE                      PIC X(50).
        01 WS-EXPONENTIAL-BACKOFF.
            05 WS-BACKOFF-INITIAL-DELAY-MS     PIC 9(5) COMP.
            05 WS-BACKOFF-MULTIPLIER           PIC 9(2) COMP.
            05 WS-BACKOFF-MAX-DELAY-MS         PIC 9(18) COMP.
            05 WS-BACKOFF-JITTER-FACTOR        PIC S9V9(2) COMP.
        01 WS-FAILED-ATTEMPTS                  PIC 9(18) COMP.
        01 WS-LOGPREFIX                        PIC X(100).

PROCEDURE DIVISION.

    PERFORM STARTUP-PROCEDURE.
    PERFORM SET-READY-TO-UNFENCE-PROCEDURE.
    PERFORM PROPAGATE-DIRECTORY-FAILURE-PROCEDURE.
    PERFORM RESEND-BROKER-REGISTRATION-PROCEDURE.
    PERFORM BEGIN-CONTROLLED-SHUTDOWN-PROCEDURE.
    PERFORM BEGIN-SHUTDOWN-PROCEDURE.
    PERFORM CLOSE-PROCEDURE.

    STARTUP-PROCEDURE.
        MOVE CONFIG-NODE-ID TO WS-CONFIG-NODE-ID.
        MOVE CONFIG-RACK TO WS-CONFIG-RACK.
        MOVE MILLISECONDS-TO-NANOSECONDS(CONFIG-INITIAL-REGISTRATION-TIMEOUT-MS) TO WS-CONFIG-INITIAL-REGISTRATION-TIMEOUT-NS.
        MOVE CONFIG-BROKER-SESSION-TIMEOUT-MS TO WS-CONFIG-BROKER-SESSION-TIMEOUT-MS.
        MOVE CONFIG-BROKER-HEARTBEAT-INTERVAL-MS TO WS-CONFIG-BROKER-HEARTBEAT-INTERVAL-MS.
        GENERATE-UNIQUE-UUID TO WS-BROKER-INCARNATION-ID.
        MOVE "STARTING" TO WS-BROKER-STATE.
        MOVE HIGH-METADATA-OFFSET-PROVIDER TO WS-HIGHEST-METADATA-OFFSET-PROVIDER.
        MOVE CHANNEL-MANAGER TO WS-CHANNEL-MANAGER.
        MOVE CLUSTER-ID TO WS-CLUSTER-ID.
        MOVE ADVERTISED-LISTENERS TO WS-ADVERTISED-LISTENERS.
        MOVE SUPPORTED-FEATURES TO WS-SUPPORTED-FEATURES.
        MOVE PREVIOUS-BROKER-EPOCH TO WS-PREVIOUS-BROKER-EPOCH.
        PERFORM SEND-BROKER-REGISTRATION-PROCEDURE.
        PERFORM SCHEDULE-REGISTRATION-TIMEOUT-PROCEDURE.

    SET-READY-TO-UNFENCE-PROCEDURE.
        MOVE 1 TO WS-READY-TO-UNFENCE.
        PERFORM SCHEDULE-NEXT-COMMUNICATION-IMMEDIATELY-PROCEDURE.

    PROPAGATE-DIRECTORY-FAILURE-PROCEDURE.
        MOVE DIRECTORY-ID TO WS-OFFLINE-DIR-ID(WS-OFFLINE-DIRS-INDEX).
        MOVE 0 TO WS-OFFLINE-DIR-COMM-FAILED(WS-OFFLINE-DIRS-INDEX).
        PERFORM SCHEDULE-NEXT-COMMUNICATION-IMMEDIATELY-PROCEDURE.
        PERFORM SCHEDULE-OFFLINE-DIR-FAILURE-PROCEDURE.

    RESEND-BROKER-REGISTRATION-PROCEDURE.
        MOVE 0 TO WS-REGISTERED.
        PERFORM SCHEDULE-NEXT-COMMUNICATION-IMMEDIATELY-PROCEDURE.

    BEGIN-CONTROLLED-SHUTDOWN-PROCEDURE.
        EVALUATE WS-BROKER-STATE
        WHEN "PENDING-CONTROLLED-SHUTDOWN"
            DISPLAY "Attempted to enter pending controlled shutdown state, but we are already in that state."
        WHEN "RUNNING"
            DISPLAY "Beginning controlled shutdown."
            MOVE "PENDING-CONTROLLED-SHUTDOWN" TO WS-BROKER-STATE
            PERFORM SCHEDULE-NEXT-COMMUNICATION-IMMEDIATELY-PROCEDURE
        WHEN OTHER
            DISPLAY "Skipping controlled shutdown because we are in state " WS-BROKER-STATE "."
            PERFORM BEGIN-SHUTDOWN-PROCEDURE
        END-EVALUATE.

    BEGIN-SHUTDOWN-PROCEDURE.
        PERFORM EVENTQUEUE-BEGIN-SHUTDOWN USING "beginShutdown".

    CLOSE-PROCEDURE.
        PERFORM BEGIN-SHUTDOWN-PROCEDURE.
        PERFORM EVENTQUEUE-CLOSE.

    SEND-BROKER-REGISTRATION-PROCEDURE.
        PERFORM COLLECT-SUPPORTED-FEATURES.
        PERFORM COLLECT-SORTED-LOG-DIRS.
        MOVE CONFIG-NODE-ID TO WS-BROKER-REGISTRATION-REQUEST-BROKER-ID.
        MOVE 0 TO WS-BROKER-REGISTRATION-REQUEST-IS-MIGRATING-ZK-BROKER.
        MOVE WS-CLUSTER-ID TO WS-BROKER-REGISTRATION-REQUEST-CLUSTER-ID.
        MOVE WS-SUPPORTED-FEATURES TO WS-BROKER-REGISTRATION-REQUEST-FEATURES.
        MOVE WS-BROKER-INCARNATION-ID TO WS-BROKER-REGISTRATION-REQUEST-INCARNATION-ID.
        MOVE WS-ADVERTISED-LISTENERS TO WS-BROKER-REGISTRATION-REQUEST-LISTENERS.
        MOVE WS-CONFIG-RACK TO WS-BROKER-REGISTRATION-REQUEST-RACK.
        MOVE WS-PREVIOUS-BROKER-EPOCH TO WS-BROKER-REGISTRATION-REQUEST-PREVIOUS-BROKER-EPOCH.
        MOVE WS-SORTED-LOG-DIRS TO WS-BROKER-REGISTRATION-REQUEST-LOG-DIRS.
        SEND-BROKER-REGISTRATION-REQUEST USING WS-CHANNEL-MANAGER, WS-BROKER-REGISTRATION-REQUEST.
        MOVE 1 TO WS-COMMUNICATION-IN-FLIGHT.

    SCHEDULE-REGISTRATION-TIMEOUT-PROCEDURE.
        SCHEDULE-DEFERRED-EVENT USING WS-EVENT-QUEUE, "initialRegistrationTimeout",
                COMPUTE DEADLINE-NS = TIME-NANOSECONDS() + WS-CONFIG-INITIAL-REGISTRATION-TIMEOUT-NS,
                NEW REGISTRATION-TIMEOUT-EVENT.

    SCHEDULE-NEXT-COMMUNICATION-IMMEDIATELY-PROCEDURE.
        PERFORM SCHEDULE-NEXT-COMMUNICATION-PROCEDURE USING 0.

    SCHEDULE-NEXT-COMMUNICATION-AFTER-FAILURE-PROCEDURE.
        PERFORM COMPUTE-BACKOFF-DELAY.
        ADD 1 TO WS-FAILED-ATTEMPTS.
        MOVE 0 TO WS-NEXT-SCHEDULING-SHOULD-BE-IMMEDIATE.
        PERFORM SCHEDULE-NEXT-COMMUNICATION-PROCEDURE USING WS-BACKOFF-DELAY-NS.

    SCHEDULE-NEXT-COMMUNICATION-AFTER-SUCCESS-PROCEDURE.
        PERFORM SCHEDULE-NEXT-COMMUNICATION-PROCEDURE USING
            MILLISECONDS-TO-NANOSECONDS(WS-CONFIG-BROKER-HEARTBEAT-INTERVAL-MS).

    SCHEDULE-NEXT-COMMUNICATION-PROCEDURE.
        MOVE INTERVALS-ARGUMENT TO WS-NEXT-COMMUNICATION-INTERVAL-NS.
        IF WS-NEXT-SCHEDULING-SHOULD-BE-IMMEDIATE
            MOVE 0 TO WS-NEXT-COMMUNICATION-INTERVAL-NS
        END-IF.
        MOVE 0 TO WS-NEXT-SCHEDULING-SHOULD-BE-IMMEDIATE.
        SCHEDULE-DEFERRED-EVENT USING WS-EVENT-QUEUE, "communication",
            COMPUTE DEADLINE-NS = TIME-NANOSECONDS() + WS-NEXT-COMMUNICATION-INTERVAL-NS,
            NEW COMMUNICATION-EVENT.

    SEND-BROKER-HEARTBEAT-PROCEDURE.
        MOVE WS-BROKER-EPOCH TO WS-BROKER-HEARTBEAT-REQUEST-BROKER-EPOCH.
        MOVE CONFIG-NODE-ID TO WS-BROKER-HEARTBEAT-REQUEST-BROKER-ID.
        MOVE WS-HIGHEST-METADATA-OFFSET-PROVIDER() TO WS-BROKER-HEARTBEAT-REQUEST-CURRENT-METADATA-OFFSET.
        MOVE WS-READY-TO-UNFENCE TO WS-BROKER-HEARTBEAT-REQUEST-WANT-FENCE.
        EVALUATE WS-BROKER-STATE
        WHEN "PENDING-CONTROLLED-SHUTDOWN"
            MOVE 1 TO WS-BROKER-HEARTBEAT-REQUEST-WANT-SHUTDOWN
        WHEN OTHER
            MOVE 0 TO WS-BROKER-HEARTBEAT-REQUEST-WANT-SHUTDOWN
        END-EVALUATE.
        MOVE WS-OFFLINE-DIRS-COUNT TO WS-BROKER-HEARTBEAT-REQUEST-OFFLINE-LOG-DIRS-COUNT.
        MOVE WS-OFFLINE-DIRS-ARRAY TO WS-BROKER-HEARTBEAT-REQUEST-OFFLINE-LOG-DIRS.
        SEND-BROKER-HEARTBEAT-REQUEST USING WS-CHANNEL-MANAGER, WS-BROKER-HEARTBEAT-REQUEST.
        MOVE 1 TO WS-COMMUNICATION-IN-FLIGHT.

    COMPUTE-BACKOFF-DELAY.
        COMPUTE WS-BACKOFF-DELAY-MS = COMPUTE-EXPONENTIAL-BACKOFF(WS-FAILED-ATTEMPTS,
                                      WS-BACKOFF-INITIAL-DELAY-MS,
                                      WS-BACKOFF-MULTIPLIER,
                                      WS-BACKOFF-MAX-DELAY-MS,
                                      WS-BACKOFF-JITTER-FACTOR).
        MOVE MILLISECONDS-TO-NANOSECONDS(WS-BACKOFF-DELAY-MS) TO WS-BACKOFF-DELAY-NS.

    COLLECT-SUPPORTED-FEATURES.
        MOVE 0 TO WS-FEATURE-COUNT.
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > MAP-SIZE(WS-SUPPORTED-FEATURES)
            MOVE MAP-KEY(WS-SUPPORTED-FEATURES, I) TO WS-FEATURE-NAME(WS-FEATURE-COUNT)
            MOVE MAP-VALUE(WS-SUPPORTED-FEATURES, I, "min") TO WS-FEATURE-MIN-VERSION(WS-FEATURE-COUNT)
            MOVE MAP-VALUE(WS-SUPPORTED-FEATURES, I, "max") TO WS-FEATURE-MAX-VERSION(WS-FEATURE-COUNT)
            ADD 1 TO WS-FEATURE-COUNT
        END-PERFORM.

    COLLECT-SORTED-LOG-DIRS.
        MOVE 0 TO WS-SORTED-LOG-DIRS-COUNT.
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > SET-SIZE(WS-LOG-DIRS)
            MOVE SET-ELEMENT(WS-LOG-DIRS, I) TO WS-SORTED-LOG-DIRS(WS-SORTED-LOG-DIRS-COUNT)
            ADD 1 TO WS-SORTED-LOG-DIRS-COUNT
        END-PERFORM.
        SORT WS-SORTED-LOG-DIRS ASCENDING.

    REGISTRATION-TIMEOUT-EVENT.
        IF NOT WS-INITIAL-REGISTRATION-SUCCEEDED
            DISPLAY "Shutting down because we were unable to register with the controller quorum."
            PERFORM EVENTQUEUE-BEGIN-SHUTDOWN USING "registrationTimeout"
        END-IF.

    COMMUNICATION-EVENT.
        IF WS-COMMUNICATION-IN-FLIGHT
            MOVE 1 TO WS-NEXT-SCHEDULING-SHOULD-BE-IMMEDIATE
        ELSE
            IF WS-REGISTERED
                PERFORM SEND-BROKER-HEARTBEAT-PROCEDURE
            ELSE
                PERFORM SEND-BROKER-REGISTRATION-PROCEDURE
            END-IF
        END-IF.

    SHUTDOWN-EVENT.
        DISPLAY "Transitioning from " WS-BROKER-STATE " to SHUTTING_DOWN."
        MOVE "SHUTTING_DOWN" TO WS-BROKER-STATE.
        MOVE NULL TO WS-CONTROLLED-SHUTDOWN-FUTURE.
        MOVE NULL TO WS-INITIAL-CATCH-UP-FUTURE. 
        MOVE NULL TO WS-INITIAL-UNFENCE-FUTURE.
        IF WS-CHANNEL-MANAGER NOT EQUAL NULL
            PERFORM CHANNEL-MANAGER-SHUTDOWN
            MOVE NULL TO WS-CHANNEL-MANAGER
        END-IF.

    EVENTQUEUE-BEGIN-SHUTDOWN.
        CALL "eventQueue.beginShutdown" USING SHUTDOWN-PROCEDURE-ARGUMENT.

    EVENTQUEUE-CLOSE.
        CALL "eventQueue.close".

    CHANNEL-MANAGER-SHUTDOWN.
        CALL "channelManager.shutdown".

    COMPUTE-EXPONENTIAL-BACKOFF.
        COMPUTE BACKOFF-DELAY-MS = BACKOFF-INITIAL-DELAY