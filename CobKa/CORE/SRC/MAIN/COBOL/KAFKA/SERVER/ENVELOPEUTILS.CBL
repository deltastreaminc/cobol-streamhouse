IDENTIFICATION DIVISION.
PROGRAM-ID. ENVELOPE-UTILS.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION InetAddress-GetByAddress OF JAVA-CLASS "java.net.InetAddress".
    FUNCTION RequestHeader-Parse OF JAVA-CLASS "org.apache.kafka.common.requests.RequestHeader".
    FUNCTION KafkaPrincipal-Deserialize OF JAVA-CLASS "org.apache.kafka.common.security.auth.KafkaPrincipal".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-ENVELOPE-REQUEST.
   05 WS-ENVELOPE-BODY.
      10 WS-ENVELOPE-REQUEST-PRINCIPAL PIC X(256).
      10 WS-ENVELOPE-CLIENT-ADDRESS PIC X(256).
      10 WS-ENVELOPE-REQUEST-DATA PIC X(4096).
   05 WS-ENVELOPE-REQUEST-HEADER.
      10 WS-ENVELOPE-API-KEY PIC 9(4) COMP-5.
      10 WS-ENVELOPE-CONNECTION-ID PIC X(256).
      10 WS-ENVELOPE-LISTENER-NAME PIC X(256).
      10 WS-ENVELOPE-SECURITY-PROTOCOL PIC X(256).

01 WS-FORWARDED-REQUEST.
   05 WS-FORWARDED-CONTEXT.
      10 WS-FORWARDED-HEADER PIC X(256).
      10 WS-FORWARDED-CLIENT-ADDRESS PIC X(256).
      10 WS-FORWARDED-PRINCIPAL PIC X(256).
      10 WS-FORWARDED-LISTENER-NAME PIC X(256).
      10 WS-FORWARDED-SECURITY-PROTOCOL PIC X(256).
      10 WS-FORWARDED-CLIENT-INFORMATION PIC X(256).
      10 WS-FORWARDED-FROM-PRIVILEGED-LISTENER PIC X(1).
   05 WS-FORWARDED-START-TIME-NANOS PIC 9(18) COMP-3.
   05 WS-FORWARDED-MEMORY-POOL PIC X(256).
   05 WS-FORWARDED-REQUEST-BUFFER PIC X(4096).
   05 WS-FORWARDED-REQUEST-DEQUEUE-TIME-NANOS PIC 9(18) COMP-3.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM HANDLE-ENVELOPE-REQUEST.
    STOP RUN.

HANDLE-ENVELOPE-REQUEST.
    MOVE REQUEST-ENVELOPE-BODY TO WS-ENVELOPE-BODY.
    PERFORM PARSE-FORWARDED-PRINCIPAL.
    PERFORM PARSE-FORWARDED-CLIENT-ADDRESS.
    PERFORM PARSE-FORWARDED-REQUEST-HEADER.
    PERFORM VALIDATE-FORWARDED-API.
    PERFORM PARSE-FORWARDED-REQUEST.
    PERFORM FORWARD-REQUEST.

PARSE-FORWARDED-PRINCIPAL.
    IF REQUEST-CONTEXT-PRINCIPAL-SERDE IS NOT NULL
        PERFORM JAVA-CALL USING KafkaPrincipal-Deserialize
                         WITH WS-ENVELOPE-REQUEST-PRINCIPAL
                         INTO WS-FORWARDED-PRINCIPAL
    ELSE
        RAISE PrincipalDeserializationException.

PARSE-FORWARDED-CLIENT-ADDRESS.
    PERFORM JAVA-CALL USING InetAddress-GetByAddress
                     WITH WS-ENVELOPE-CLIENT-ADDRESS
                     INTO WS-FORWARDED-CLIENT-ADDRESS.

PARSE-FORWARDED-REQUEST-HEADER.
    PERFORM JAVA-CALL USING RequestHeader-Parse
                     WITH WS-ENVELOPE-REQUEST-DATA
                     INTO WS-FORWARDED-HEADER.

VALIDATE-FORWARDED-API.
    IF WS-ENVELOPE-API-KEY IS NOT FORWARDABLE
        RAISE InvalidRequestException.

PARSE-FORWARDED-REQUEST.
    MOVE WS-ENVELOPE-REQUEST-DATA TO WS-FORWARDED-REQUEST-BUFFER.
    MOVE WS-ENVELOPE-CONNECTION-ID TO WS-FORWARDED-CONTEXT-CONNECTION-ID.
    MOVE WS-ENVELOPE-LISTENER-NAME TO WS-FORWARDED-CONTEXT-LISTENER-NAME.
    MOVE WS-ENVELOPE-SECURITY-PROTOCOL TO WS-FORWARDED-CONTEXT-SECURITY-PROTOCOL.
    MOVE REQUEST-START-TIME-NANOS TO WS-FORWARDED-START-TIME-NANOS.
    MOVE REQUEST-MEMORY-POOL TO WS-FORWARDED-MEMORY-POOL.
    MOVE REQUEST-DEQUEUE-TIME-NANOS TO WS-FORWARDED-REQUEST-DEQUEUE-TIME-NANOS.
    CREATE WS-FORWARDED-REQUEST.

FORWARD-REQUEST.
    PERFORM FORWARD-REQUEST-HANDLER USING WS-FORWARDED-REQUEST.