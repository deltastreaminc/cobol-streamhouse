IDENTIFICATION DIVISION.
ENVIRONMENT DIVISION.
DATA DIVISION.
PROCEDURE DIVISION.

001-MAIN-PROCEDURE.
    PERFORM 010-STARTUP.
    PERFORM 020-APPEND-RECORDS.
    PERFORM 030-DELETE-RECORDS.
    PERFORM 040-DESCRIBE-LOG-DIRS.
    PERFORM 050-FETCH-OFFSET.
    PERFORM 060-BECOME-LEADER-OR-FOLLOWER.
    PERFORM 070-SHUTDOWN.
    STOP RUN.

010-STARTUP.
    INITIALIZE WS-CONTROLLER-EPOCH TO 0.
    INITIALIZE WS-ALL-PARTITIONS TO EMPTY.
    INITIALIZE WS-REPLICA-FETCH-MANAGER TO CALL CREATE-REPLICA-FETCH-MANAGER.
    INITIALIZE WS-REPLICA-ALTER-LOG-DIRS-MANAGER TO CALL CREATE-REPLICA-ALTER-LOG-DIRS-MANAGER.
    INITIALIZE WS-HIGH-WATERMARK-CHECKPOINT-STARTED TO FALSE.
    INITIALIZE WS-LOG-DIR-FAILURE-HANDLER TO CALL CREATE-LOG-DIR-FAILURE-HANDLER.
    INITIALIZE WS-REPLICA-SELECTOR TO CALL CREATE-REPLICA-SELECTOR.
    INITIALIZE WS-METRICS-GROUP TO CALL CREATE-METRICS-GROUP.
    PERFORM 011-START-THREADS.

011-START-THREADS.
    START WS-LOG-DIR-FAILURE-HANDLER.
    CALL START ON WS-ADD-PARTITIONS-TO-TXN-MANAGER.
    SCHEDULE WS-HIGH-WATERMARK-CHECKPOINT-THREAD.
    SCHEDULE WS-IDLE-REPLICA-ALTER-LOG-DIRS-THREAD.
    SCHEDULE WS-ISR-EXPIRATION-THREAD.

020-APPEND-RECORDS.
    PERFORM 021-VALIDATE-REQUIRED-ACKS.
    PERFORM 022-APPEND-TO-LOCAL-LOG.
    PERFORM 023-ADD-COMPLETE-PURGATORY-ACTION.
    PERFORM 024-MAYBE-ADD-DELAYED-PRODUCE.

021-VALIDATE-REQUIRED-ACKS.
    IF WS-REQUIRED-ACKS IS NOT VALID
        PERFORM 021A-SEND-INVALID-REQUIRED-ACKS-RESPONSE.

021A-SEND-INVALID-REQUIRED-ACKS-RESPONSE.
    CALL SEND-RESPONSE WITH WS-ENTRIES-PER-PARTITION, WS-CALLBACK.

022-APPEND-TO-LOCAL-LOG.
    CALL APPEND-RECORDS-TO-LOCAL-LOG USING
        WS-INTERNAL-TOPICS-ALLOWED,
        WS-ORIGIN,
        WS-ENTRIES-PER-PARTITION,
        WS-REQUIRED-ACKS,
        WS-REQUEST-LOCAL,
        WS-VERIFICATION-GUARDS
    RETURNING WS-LOCAL-PRODUCE-RESULTS-WITH-TOPIC-ID.

023-ADD-COMPLETE-PURGATORY-ACTION.
    CALL ADD-COMPLETE-PURGATORY-ACTION USING
        WS-DEFAULT-ACTION-QUEUE,
        WS-LOCAL-PRODUCE-RESULTS-WITH-TOPIC-ID.

024-MAYBE-ADD-DELAYED-PRODUCE.
    IF DELAYED-PRODUCE-REQUEST-REQUIRED
        PERFORM 024A-CREATE-DELAYED-PRODUCE.
    ELSE
        PERFORM 024B-SEND-IMMEDIATE-RESPONSE.

024A-CREATE-DELAYED-PRODUCE.
    CALL CREATE-DELAYED-PRODUCE USING
        WS-REQUIRED-ACKS,
        WS-DELAYED-PRODUCE-LOCK,
        WS-TIMEOUT-MS,
        WS-ENTRIES-PER-PARTITION,
        WS-INITIAL-APPEND-RESULTS,
        WS-INITIAL-PRODUCE-STATUS,
        WS-CALLBACK.
    CALL TRY-COMPLETE-ELSE-WATCH ON WS-DELAYED-PRODUCE-PURGATORY.

024B-SEND-IMMEDIATE-RESPONSE.
    CALL SEND-RESPONSE USING WS-PRODUCE-RESPONSE-STATUS, WS-CALLBACK.

030-DELETE-RECORDS.
    PERFORM 031-DELETE-RECORDS-ON-LOCAL-LOG.
    PERFORM 032-MAYBE-ADD-DELAYED-DELETE-RECORDS.

031-DELETE-RECORDS-ON-LOCAL-LOG.
    CALL DELETE-RECORDS-ON-LOCAL-LOG USING WS-OFFSET-PER-PARTITION, WS-ALLOW-INTERNAL-TOPIC-DELETION
    RETURNING WS-LOCAL-DELETE-RECORDS-RESULTS.

032-MAYBE-ADD-DELAYED-DELETE-RECORDS.
    IF DELAYED-DELETE-RECORDS-REQUIRED
        PERFORM 032A-CREATE-DELAYED-DELETE-RECORDS.
    ELSE
        PERFORM 032B-SEND-IMMEDIATE-RESPONSE.

032A-CREATE-DELAYED-DELETE-RECORDS.
    CALL CREATE-DELAYED-DELETE-RECORDS USING
        WS-TIMEOUT-MS,
        WS-OFFSET-PER-PARTITION,
        WS-LOCAL-DELETE-RECORDS-RESULTS,
        WS-CALLBACK.
    CALL TRY-COMPLETE-ELSE-WATCH ON WS-DELAYED-DELETE-RECORDS-PURGATORY.

032B-SEND-IMMEDIATE-RESPONSE.
    CALL SEND-RESPONSE USING WS-DELETE-RECORDS-RESPONSE-STATUS, WS-CALLBACK.

040-DESCRIBE-LOG-DIRS.
    CALL DESCRIBE-LOG-DIRS USING WS-PARTITIONS
    RETURNING WS-DESCRIBE-LOG-DIRS-RESULTS.

050-FETCH-OFFSET.
    CALL FETCH-OFFSET USING
        WS-TOPICS,
        WS-DUPLICATE-PARTITIONS,
        WS-ISOLATION-LEVEL,
        WS-REPLICA-ID,
        WS-CLIENT-ID,
        WS-CORRELATION-ID,
        WS-VERSION,
        WS-BUILD-ERROR-RESPONSE,
        WS-CALLBACK,
        WS-TIMEOUT-MS.

060-BECOME-LEADER-OR-FOLLOWER.
    CALL BECOME-LEADER-OR-FOLLOWER USING
        WS-CORRELATION-ID,
        WS-LEADER-AND-ISR-REQUEST,
        WS-ON-LEADERSHIP-CHANGE.

070-SHUTDOWN.
    CALL SHUTDOWN.
    CALL REMOVE-METRICS.

CREATE-REPLICA-FETCH-MANAGER.
    CREATE NEW REPLICA-FETCH-MANAGER OBJECT.
    RETURN THE OBJECT.

CREATE-REPLICA-ALTER-LOG-DIRS-MANAGER.
    CREATE NEW REPLICA-ALTER-LOG-DIRS-MANAGER OBJECT.
    RETURN THE OBJECT.

CREATE-LOG-DIR-FAILURE-HANDLER.
    CREATE NEW LOG-DIR-FAILURE-HANDLER OBJECT.
    RETURN THE OBJECT.

CREATE-REPLICA-SELECTOR.
    CREATE NEW REPLICA-SELECTOR OBJECT.
    RETURN THE OBJECT.

CREATE-METRICS-GROUP.
    CREATE NEW KAFKA-METRICS-GROUP OBJECT.
    RETURN THE OBJECT.

DELAYED-PRODUCE-REQUEST-REQUIRED.
    IF WS-REQUIRED-ACKS = -1 AND
       WS-ENTRIES-PER-PARTITION IS NOT EMPTY AND
       WS-LOCAL-PRODUCE-RESULTS HAS FEWER ERRORS THAN WS-ENTRIES-PER-PARTITION
        RETURN TRUE
    ELSE
        RETURN FALSE.

DELAYED-DELETE-RECORDS-REQUIRED.
    IF WS-LOCAL-DELETE-RECORDS-RESULTS HAS ANY PARTITION WHERE
       EXCEPTION IS EMPTY AND LOW-WATERMARK < REQUESTED-OFFSET
        RETURN TRUE
    ELSE
        RETURN FALSE.