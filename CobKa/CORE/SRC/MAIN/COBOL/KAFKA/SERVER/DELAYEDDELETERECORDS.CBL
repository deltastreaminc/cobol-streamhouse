IDENTIFICATION DIVISION.
PROGRAM-ID. DELETE-RECORDS-HANDLER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY COMMON-STRUCTURES.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 PARTITION-STATUS.
   03 REQUIRED-OFFSET PIC S9(18) COMP-3.
   03 RESPONSE-STATUS.
      05 ERROR-CODE PIC S9(9) COMP.
      05 LOW-WATERMARK PIC S9(18) COMP-3.
   03 ACKS-PENDING PIC X.
       88 ACKS-PENDING-FLAG VALUE 'Y'.
       88 ACKS-COMPLETE-FLAG VALUE 'N'.

PROCEDURE DIVISION.

MAIN-LOGIC.
    PERFORM INITIALIZE-PARTITION-STATUS.
    PERFORM CHECK-PARTITION-STATUS.
    PERFORM FORCE-COMPLETION.
    PERFORM RETURN-RESPONSE.

INITIALIZE-PARTITION-STATUS.
    PERFORM VARYING EACH-PARTITION IN DELETE-RECORDS-STATUS
        IF RESPONSE-STATUS(EACH-PARTITION)ERROR-CODE = ZERO
            SET ACKS-PENDING-FLAG TO TRUE
            MOVE ERRORS-REQUEST-TIMED-OUT TO RESPONSE-STATUS(EACH-PARTITION)ERROR-CODE
        ELSE
            SET ACKS-COMPLETE-FLAG TO TRUE
        END-IF
        PERFORM LOG-INITIAL-STATUS
    END-PERFORM.

CHECK-PARTITION-STATUS.
    PERFORM VARYING EACH-PARTITION IN DELETE-RECORDS-STATUS
        IF ACKS-PENDING-FLAG
            PERFORM CHECK-PARTITION-SATISFACTION
        END-IF
    END-PERFORM.

CHECK-PARTITION-SATISFACTION.
    EVALUATE TRUE
        WHEN HOSTED-PARTITION-ONLINE
            PERFORM CHECK-LEADER-LOG-STATUS
        WHEN HOSTED-PARTITION-OFFLINE
            MOVE ERRORS-KAFKA-STORAGE-ERROR TO RESPONSE-STATUS(EACH-PARTITION)ERROR-CODE
            MOVE INVALID-LOW-WATERMARK TO RESPONSE-STATUS(EACH-PARTITION)LOW-WATERMARK
            SET ACKS-COMPLETE-FLAG TO TRUE
        WHEN HOSTED-PARTITION-NONE
            MOVE ERRORS-UNKNOWN-TOPIC-OR-PARTITION TO RESPONSE-STATUS(EACH-PARTITION)ERROR-CODE
            MOVE INVALID-LOW-WATERMARK TO RESPONSE-STATUS(EACH-PARTITION)LOW-WATERMARK
            SET ACKS-COMPLETE-FLAG TO TRUE
    END-EVALUATE.

CHECK-LEADER-LOG-STATUS.
    EVALUATE TRUE
        WHEN LEADER-LOG-AVAILABLE
            PERFORM UPDATE-LEADER-LOG-STATUS
        WHEN LEADER-LOG-UNAVAILABLE
            MOVE ERRORS-NOT-LEADER-OR-FOLLOWER TO RESPONSE-STATUS(EACH-PARTITION)ERROR-CODE
            MOVE INVALID-LOW-WATERMARK TO RESPONSE-STATUS(EACH-PARTITION)LOW-WATERMARK
            SET ACKS-COMPLETE-FLAG TO TRUE
    END-EVALUATE.

UPDATE-LEADER-LOG-STATUS.
    IF LEADER-LOW-WATERMARK >= REQUIRED-OFFSET(EACH-PARTITION)
        MOVE LEADER-LOW-WATERMARK TO RESPONSE-STATUS(EACH-PARTITION)LOW-WATERMARK
        SET ACKS-COMPLETE-FLAG TO TRUE
    ELSE
        SET ACKS-PENDING-FLAG TO TRUE
    END-IF.

FORCE-COMPLETION.
    IF NO ACKS-PENDING-FLAG
        CALL "FORCE-COMPLETE".

RETURN-RESPONSE.
    CALL "RETURN-RESPONSE-CALLBACK" USING DELETE-RECORDS-STATUS.

LOG-INITIAL-STATUS.
    PERFORM LOG-TRACE "Initial partition status for % is %"
        USING EACH-PARTITION, PARTITION-STATUS(EACH-PARTITION).

IDENTIFICATION DIVISION.
PROGRAM-ID. DELAYED-DELETE-RECORDS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 DELETE-RECORDS-STATUS PIC X(18) OCCURS 999.
    COPY PARTITION-STATUS FROM COPY-LIBRARY.

PROCEDURE DIVISION.

MAIN-LOGIC.
    PERFORM INITIALIZE-STATUS.
    PERFORM ATTEMPT-COMPLETION.
    PERFORM HANDLE-EXPIRATION.
    PERFORM RETURN-RESPONSE.

INITIALIZE-STATUS.
    PERFORM VARYING EACH-PARTITION IN DELETE-RECORDS-STATUS
        IF RESPONSE-STATUS(EACH-PARTITION)ERROR-CODE = ERRORS-NONE
            SET ACKS-PENDING-FLAG TO TRUE
        ELSE
            SET ACKS-COMPLETE-FLAG TO TRUE
        END-IF
        PERFORM LOG-INITIAL-STATUS
    END-PERFORM.

ATTEMPT-COMPLETION.
    PERFORM VARYING EACH-PARTITION IN DELETE-RECORDS-STATUS
        IF ACKS-PENDING-FLAG
            PERFORM CHECK-PARTITION-SATISFACTION
        END-IF
    END-PERFORM.
    IF NO ACKS-PENDING-FLAG
        CALL "FORCE-COMPLETE".

HANDLE-EXPIRATION.
    PERFORM VARYING EACH-PARTITION IN DELETE-RECORDS-STATUS
        IF ACKS-PENDING-FLAG
            CALL "RECORD-EXPIRATION" USING EACH-PARTITION
        END-IF
    END-PERFORM.

RETURN-RESPONSE.
    CALL "RETURN-RESPONSE-CALLBACK" USING DELETE-RECORDS-STATUS.

LOG-INITIAL-STATUS.
    PERFORM LOG-TRACE "Initial partition status for % is %"
        USING EACH-PARTITION, PARTITION-STATUS(EACH-PARTITION).

IDENTIFICATION DIVISION.
PROGRAM-ID. DELAYED-DELETE-RECORDS-METRICS.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY COMMON-STRUCTURES.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 METRICS-GROUP PIC X(30) VALUE "DELAYED-DELETE-RECORDS-METRICS".
01 EXPIRATION-METER PIC X(30) VALUE "ExpiresPerSec".
01 TIME-UNIT PIC X(10) VALUE "SECONDS".

PROCEDURE DIVISION.

RECORD-EXPIRATION.
    CALL "MARK-METER" USING METRICS-GROUP, EXPIRATION-METER, TIME-UNIT.