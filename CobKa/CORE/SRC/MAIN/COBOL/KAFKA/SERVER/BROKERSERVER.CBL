IDENTIFICATION DIVISION.
PROGRAM-ID. BROKER-SERVER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
    REPOSITORY.
        COPY "KAFKA-CONFIG".
        COPY "SHARED-SERVER".
        COPY "BROKER-STATE".
        COPY "PROCESS-STATUS".
        COPY "LOCK-CONDITION".
        COPY "KAFKA-APIS".
        COPY "REQUEST-HANDLER-POOL".
        COPY "LOG-DIR-FAILURE-CHANNEL".
        COPY "LOG-MANAGER".
        COPY "REMOTE-LOG-MANAGER".
        COPY "DELEGATION-TOKEN-MANAGER".
        COPY "DYNAMIC-CONFIG-HANDLERS".
        COPY "REPLICA-MANAGER".
        COPY "CREDENTIAL-PROVIDER".
        COPY "DELEGATION-TOKEN-CACHE".
        COPY "GROUP-COORDINATOR".
        COPY "GROUP-CONFIG-MANAGER".
        COPY "TRANSACTION-COORDINATOR".
        COPY "SHARE-COORDINATOR".
        COPY "NODE-TO-CONTROLLER-CHANNEL-MANAGER".
        COPY "FORWARDING-MANAGER".
        COPY "ALTER-PARTITION-MANAGER".
        COPY "AUTO-TOPIC-CREATION-MANAGER".
        COPY "KAFKA-SCHEDULER".
        COPY "KRAFT-METADATA-CACHE".
        COPY "QUOTA-FACTORY".
        COPY "CLIENT-QUOTA-METADATA-MANAGER".
        COPY "BROKER-TOPIC-STATS".
        COPY "BROKER-METADATA-PUBLISHER".
        COPY "BROKER-REGISTRATION-TRACKER".
        COPY "BROKER-FEATURES".
        COPY "KAFKA-YAMMER-METRICS".
        COPY "METADATA-PUBLISHERS".
        COPY "CLIENT-METRICS-MANAGER".
        COPY "SHARE-PARTITION-MANAGER".
        COPY "PERSISTER".

DATA DIVISION.
WORKING-STORAGE SECTION.
    01 CONFIG PIC X(32) VALUE SPACES.
    01 TIME PIC X(32) VALUE SPACES.
    01 METRICS PIC X(32) VALUE SPACES.
    01 RAFT-MANAGER PIC X(32) VALUE SPACES.
    01 BROKER-STATE PIC X(32) VALUE SPACES.
    01 LOG-CONTEXT PIC X(32) VALUE SPACES.
    01 LIFECYCLE-MANAGER PIC X(32) VALUE SPACES.
    01 ASSIGNMENTS-MANAGER PIC X(32) VALUE SPACES.
    01 IS-SHUTTING-DOWN PIC 1 VALUE 0.
    01 LOCK PIC X(32) VALUE SPACES.
    01 AWAIT-SHUTDOWN-COND PIC X(32) VALUE SPACES.
    01 STATUS PIC X(32) VALUE SPACES.
    01 DATA-PLANE-REQUEST-PROCESSOR PIC X(32) VALUE SPACES.
    01 AUTHORIZER PIC X(32) VALUE SPACES.
    01 SOCKET-SERVER PIC X(32) VALUE SPACES.
    01 DATA-PLANE-REQUEST-HANDLER-POOL PIC X(32) VALUE SPACES.
    01 LOG-DIR-FAILURE-CHANNEL PIC X(32) VALUE SPACES.
    01 LOG-MANAGER PIC X(32) VALUE SPACES.
    01 REMOTE-LOG-MANAGER-OPT PIC X(32) VALUE SPACES.
    01 TOKEN-MANAGER PIC X(32) VALUE SPACES.
    01 DYNAMIC-CONFIG-HANDLERS PIC X(32) VALUE SPACES.
    01 REPLICA-MANAGER PIC X(32) VALUE SPACES.
    01 CREDENTIAL-PROVIDER PIC X(32) VALUE SPACES.
    01 TOKEN-CACHE PIC X(32) VALUE SPACES.
    01 GROUP-COORDINATOR PIC X(32) VALUE SPACES.
    01 GROUP-CONFIG-MANAGER PIC X(32) VALUE SPACES.
    01 TRANSACTION-COORDINATOR PIC X(32) VALUE SPACES.
    01 SHARE-COORDINATOR PIC X(32) VALUE SPACES.
    01 CLIENT-TO-CONTROLLER-CHANNEL-MANAGER PIC X(32) VALUE SPACES.
    01 FORWARDING-MANAGER PIC X(32) VALUE SPACES.
    01 ALTER-PARTITION-MANAGER PIC X(32) VALUE SPACES.
    01 AUTO-TOPIC-CREATION-MANAGER PIC X(32) VALUE SPACES.
    01 KAFKA-SCHEDULER PIC X(32) VALUE SPACES.
    01 METADATA-CACHE PIC X(32) VALUE SPACES.
    01 QUOTA-MANAGERS PIC X(32) VALUE SPACES.
    01 CLIENT-QUOTA-METADATA-MANAGER PIC X(32) VALUE SPACES.
    01 BROKER-TOPIC-STATS PIC X(32) VALUE SPACES.
    01 CLUSTER-ID PIC X(32) VALUE SPACES.
    01 BROKER-METADATA-PUBLISHER PIC X(32) VALUE SPACES.
    01 BROKER-REGISTRATION-TRACKER PIC X(32) VALUE SPACES.
    01 BROKER-FEATURES PIC X(32) VALUE SPACES.
    01 KAFKA-YAMMER-METRICS PIC X(32) VALUE SPACES.
    01 METADATA-PUBLISHERS PIC X(32) VALUE SPACES.
    01 CLIENT-METRICS-MANAGER PIC X(32) VALUE SPACES.
    01 SHARE-PARTITION-MANAGER PIC X(32) VALUE SPACES.
    01 PERSISTER PIC X(32) VALUE SPACES.

PROCEDURE DIVISION.
    STARTUP.
        IF NOT CHANGE-STATUS(SHUTDOWN, STARTING) THEN
            RETURN.
        PERFORM SHARED-SERVER-STARTUP.
        PERFORM CLIENT-METRICS-CONFIG-INITIALIZE.
        PERFORM SCHEDULER-STARTUP.
        PERFORM BROKER-TOPIC-STATS-CREATE.
        PERFORM QUOTA-MANAGERS-CREATE.
        PERFORM LOG-DIR-FAILURE-CHANNEL-CREATE.
        PERFORM METADATA-CACHE-CREATE.
        PERFORM LOG-MANAGER-CREATE.
        PERFORM REMOTE-LOG-MANAGER-CREATE.
        PERFORM LIFECYCLE-MANAGER-CREATE.
        PERFORM TOKEN-CACHE-CREATE.
        PERFORM CREDENTIAL-PROVIDER-CREATE.
        PERFORM CLIENT-TO-CONTROLLER-CHANNEL-MANAGER-CREATE.
        PERFORM FORWARDING-MANAGER-CREATE.
        PERFORM ALTER-PARTITION-MANAGER-CREATE.
        PERFORM REPLICA-MANAGER-CREATE.
        PERFORM TOKEN-MANAGER-CREATE.
        PERFORM GROUP-CONFIG-MANAGER-CREATE.
        PERFORM SHARE-COORDINATOR-CREATE.
        PERFORM PERSISTER-CREATE.
        PERFORM GROUP-COORDINATOR-CREATE.
        PERFORM TRANSACTION-COORDINATOR-CREATE.
        PERFORM AUTO-TOPIC-CREATION-MANAGER-CREATE.
        PERFORM DYNAMIC-CONFIG-HANDLERS-CREATE.
        PERFORM SOCKET-SERVER-CREATE.
        PERFORM CLIENT-QUOTA-METADATA-MANAGER-CREATE.
        PERFORM AUTHORIZER-CREATE.
        PERFORM METADATA-PUBLISHERS-CREATE.
        PERFORM BROKER-METADATA-PUBLISHER-CREATE.
        PERFORM BROKER-REGISTRATION-TRACKER-CREATE.
        PERFORM BROKER-FEATURES-CREATE.
        PERFORM CLIENT-METRICS-MANAGER-CREATE.
        PERFORM SHARE-PARTITION-MANAGER-CREATE.
        PERFORM DATA-PLANE-REQUEST-PROCESSOR-CREATE.
        PERFORM DATA-PLANE-REQUEST-HANDLER-POOL-CREATE.
        PERFORM CHANGE-STATUS(STARTING, STARTED).

    SHUTDOWN.
        IF NOT CHANGE-STATUS(STARTED, SHUTTING-DOWN) THEN
            RETURN.
        PERFORM LIFECYCLE-MANAGER-BEGIN-SHUTDOWN.
        PERFORM SOCKET-SERVER-STOP-PROCESSING-REQUESTS.
        PERFORM METADATA-PUBLISHERS-REMOVE-AND-CLOSE.
        PERFORM DATA-PLANE-REQUEST-HANDLER-POOL-SHUTDOWN.
        PERFORM DATA-PLANE-REQUEST-PROCESSOR-CLOSE.
        PERFORM AUTHORIZER-CLOSE.
        PERFORM SCHEDULER-SHUTDOWN.
        PERFORM TRANSACTION-COORDINATOR-SHUTDOWN.
        PERFORM GROUP-CONFIG-MANAGER-CLOSE.
        PERFORM GROUP-COORDINATOR-SHUTDOWN.
        PERFORM SHARE-COORDINATOR-SHUTDOWN.
        PERFORM ASSIGNMENTS-MANAGER-CLOSE.
        PERFORM REPLICA-MANAGER-SHUTDOWN.
        PERFORM ALTER-PARTITION-MANAGER-SHUTDOWN.
        PERFORM FORWARDING-MANAGER-CLOSE.
        PERFORM CLIENT-TO-CONTROLLER-CHANNEL-MANAGER-SHUTDOWN.
        PERFORM LOG-MANAGER-SHUTDOWN.
        PERFORM REMOTE-LOG-MANAGER-CLOSE.
        PERFORM QUOTA-MANAGERS-SHUTDOWN.
        PERFORM SOCKET-SERVER-SHUTDOWN.
        PERFORM BROKER-TOPIC-STATS-CLOSE.
        PERFORM SHARE-PARTITION-MANAGER-CLOSE.
        PERFORM PERSISTER-STOP.
        PERFORM LIFECYCLE-MANAGER-CLOSE.
        PERFORM DYNAMIC-CONFIG-CLEAR.
        PERFORM CLIENT-METRICS-MANAGER-CLOSE.
        PERFORM SHARED-SERVER-STOP.
        PERFORM CHANGE-STATUS(SHUTTING-DOWN, SHUTDOWN).

    IS-SHUTDOWN.
        RETURN STATUS = SHUTDOWN OR STATUS = SHUTTING-DOWN.

    AWAIT-SHUTDOWN.
        LOCK.
        PERFORM UNTIL STATUS = SHUTDOWN
            AWAIT-SHUTDOWN-COND.WAIT-UNTIL-SIGNALED
        END-PERFORM.
        UNLOCK.

    BOUND-PORT.
        RETURN SOCKET-SERVER.BOUND-PORT(LISTENER-NAME).

    CHANGE-STATUS.
        LOCK.
        IF STATUS NOT = FROM-STATUS THEN
            RETURN FALSE.
        MOVE TO-STATUS TO STATUS.
        IF TO-STATUS = SHUTTING-DOWN THEN
            MOVE 1 TO IS-SHUTTING-DOWN.
        ELSE IF TO-STATUS = SHUTDOWN THEN
            MOVE 0 TO IS-SHUTTING-DOWN
            SIGNAL AWAIT-SHUTDOWN-COND.
        END-IF.
        UNLOCK.
        RETURN TRUE.

    REPLICA-MANAGER.
        RETURN REPLICA-MANAGER.

    SHARED-SERVER-STARTUP.
        PERFORM SHARED-SERVER.START-FOR-BROKER.

    CLIENT-METRICS-CONFIG-INITIALIZE.
        PERFORM CONFIG-DYNAMIC.INITIALIZE(CLIENT-METRICS-RECEIVER-PLUGIN).

    SCHEDULER-STARTUP.
        PERFORM KAFKA-SCHEDULER.STARTUP.

    BROKER-TOPIC-STATS-CREATE.
        MOVE FUNCTION BROKER-TOPIC-STATS-NEW(CONFIG.REMOTE-LOG-MANAGER-CONFIG.IS-REMOTE-STORAGE-SYSTEM-ENABLED) TO BROKER-TOPIC-STATS.

    QUOTA-MANAGERS-CREATE.
        MOVE FUNCTION QUOTA-FACTORY.INSTANTIATE(CONFIG, METRICS, TIME, "broker-" & CONFIG.NODE-ID & "-") TO QUOTA-MANAGERS.

    LOG-DIR-FAILURE-CHANNEL-CREATE.
        MOVE FUNCTION LOG-DIR-FAILURE-CHANNEL-NEW(LENGTH OF CONFIG.LOG-DIRS) TO LOG-DIR-FAILURE-CHANNEL.

    METADATA-CACHE-CREATE.
        MOVE FUNCTION METADATA-CACHE-KRAFT-METADATA-CACHE(CONFIG.NODE-ID, RAFT-MANAGER.CLIENT.KRAFT-VERSION) TO METADATA-CACHE.

    LOG-MANAGER-CREATE.
        MOVE FUNCTION LOG-MANAGER-NEW(CONFIG,
                                      SHARED-SERVER.META-PROPS-ENSEMBLE.ERROR-LOG-DIRS,
                                      METADATA-CACHE,
                                      KAFKA-SCHEDULER,
                                      TIME,
                                      BROKER-TOPIC-STATS,
                                      LOG-DIR-FAILURE-CHANNEL) TO LOG-MANAGER.

    REMOTE-LOG-MANAGER-CREATE.
        PERFORM CREATE-REMOTE-LOG-MANAGER.

    LIFECYCLE-MANAGER-CREATE.
        MOVE FUNCTION BROKER-LIFECYCLE-MANAGER-NEW(CONFIG,
                                                   TIME,
                                                   "broker-" & CONFIG.NODE-ID & "-",
                                                   LOG-MANAGER.DIRECTORY-IDS-SET,
                                                   SHUTDOWN) TO LIFECYCLE-MANAGER.

    TOKEN-CACHE-CREATE.
        MOVE FUNCTION DELEGATION-TOKEN-CACHE-NEW(SCRAM-MECHANISM.MECHANISM-NAMES) TO TOKEN-CACHE.

    CREDENTIAL-PROVIDER-CREATE.
        MOVE FUNCTION CREDENTIAL-PROVIDER-NEW(SCRAM-MECHANISM.MECHANISM-NAMES, TOKEN-CACHE) TO CREDENTIAL-PROVIDER.

    CLIENT-TO-CONTROLLER-CHANNEL-MANAGER-CREATE.
        MOVE FUNCTION NODE-TO-CONTROLLER-CHANNEL-MANAGER-IMPL-NEW(RAFT-MANAGER,
                                                                    CONFIG,
                                                                    TIME,
                                                                    METRICS,
                                                                    "forwarding",
                                                                    "broker-" & CONFIG.NODE-ID & "-",
                                                                    60000) TO CLIENT-TO-CONTROLLER-CHANNEL-MANAGER.

    FORWARDING-MANAGER-CREATE.
        MOVE FUNCTION FORWARDING-MANAGER-IMPL-NEW(CLIENT-TO-CONTROLLER-CHANNEL-MANAGER, METRICS) TO FORWARDING-MANAGER.

    ALTER-PARTITION-MANAGER-CREATE.
        MOVE FUNCTION ALTER-PARTITION-MANAGER-NEW(CONFIG,
                                                  KAFKA-SCHEDULER,
                                                  RAFT-MANAGER,
                                                  TIME,
                                                  METRICS,
                                                  "broker-" & CONFIG.NODE-ID & "-",
                                                  LIFECYCLE-MANAGER.BROKER-EPOCH) TO ALTER-PARTITION-MANAGER.

    REPLICA-MANAGER-CREATE.
        MOVE FUNCTION REPLICA-MANAGER-NEW(CONFIG, METRICS, TIME, KAFKA-SCHEDULER, LOG-MANAGER, REMOTE-LOG-MANAGER-OPT, QUOTA-MANAGERS, METADATA-CACHE, LOG-DIR-FAILURE-CHANNEL, ALTER-PARTITION-MANAGER, BROKER-TOPIC-STATS, IS-SHUTTING-DOWN, LIFECYCLE-MANAGER.BROKER-EPOCH, ADD-PARTITIONS-TO-TXN-MANAGER) TO REPLICA-MANAGER.

    TOKEN-MANAGER-CREATE.
        MOVE FUNCTION DELEGATION-TOKEN-MANAGER-NEW(CONFIG, TOKEN-CACHE, TIME) TO TOKEN-MANAGER.

    GROUP-CONFIG-MANAGER-CREATE.
        MOVE FUNCTION GROUP-CONFIG-MANAGER-NEW(CONFIG.GROUP-COORDINATOR-CONFIG.EXTRACT-GROUP-CONFIG-MAP(CONFIG.SHARE-GROUP-CONFIG)) TO GROUP-CONFIG-MANAGER.

    SHARE-COORDINATOR-CREATE.
        PERFORM CREATE-SHARE-COORDINATOR.

    PERSISTER-CREATE.
        PERFORM CREATE-SHARE-STATE-PERSISTER.

    GROUP-COORDINATOR-CREATE.
        PERFORM CREATE-GROUP-COORDINATOR.

    TRANSACTION-COORDINATOR-CREATE.
        MOVE FUNCTION TRANSACTION-COORDINATOR-NEW(CONFIG,
                                                  REPLICA-MANAGER,
                                                  KAFKA-SCHEDULER,
                                                  PRODUCER-ID-MANAGER-RPC,
                                                  METRICS,
                                                  METADATA-CACHE,
                                                  TIME-SYSTEM) TO TRANSACTION-COORDINATOR.

    AUTO-TOPIC-CREATION-MANAGER-CREATE.
        MOVE FUNCTION DEFAULT-AUTO-TOPIC-CREATION-MANAGER-NEW(CONFIG,
                                                              CLIENT-TO-CONTROLLER-CHANNEL-MANAGER,
                                                              GROUP-COORDINATOR,
                                                              TRANSACTION-COORDINATOR,
                                                              SHARE-COORDINATOR) TO AUTO-TOPIC-CREATION-MANAGER.

    DYNAMIC-CONFIG-HANDLERS-CREATE.
        MOVE FUNCTION DYNAMIC-CONFIG-HANDLERS-CREATE(
            CONFIG-TYPE-TOPIC -> FUNCTION TOP-CONFIG-HANDLER-NEW(REPLICA-MANAGER, CONFIG, QUOTA-MANAGERS),
            CONFIG-TYPE-BROKER -> FUNCTION BROKER-CONFIG-HANDLER-NEW