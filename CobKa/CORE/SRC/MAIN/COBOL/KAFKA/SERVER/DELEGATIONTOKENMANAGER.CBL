IDENTIFICATION DIVISION.
PROGRAM-ID. DELEGATION-TOKEN-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 DEFAULT-HMAC-ALGORITHM PIC X(11) VALUE "HmacSHA512".
01 ERROR-TIMESTAMP PIC S9(18) COMP-1 VALUE -1.

01 WS-TOKEN-INFORMATION.
   05 WS-TOKEN-ID PIC X(128).
   05 WS-OWNER PIC X(128).
   05 WS-RENEWERS PIC X(128) OCCURS 5 TIMES.

01 WS-SECRET-KEY.
   05 WS-SECRET-KEY-BYTES PIC X(128).
   05 WS-SECRET-KEY-SPEC.
      10 FILLER PIC X(11) VALUE "HmacSHA512".
      10 FILLER PIC X(117).

01 WS-HMAC PIC X(128).
01 WS-SCRAM-CREDENTIAL-MAP.
   05 FILLER OCCURS 5 TIMES.
      10 WS-SCRAM-MECHANISM PIC X(20).
      10 WS-SCRAM-CREDENTIAL.
         15 WS-ITERATIONS PIC 9(9) COMP.
         15 WS-SALT PIC X(128).
         15 WS-STORED-KEY PIC X(128).
         15 WS-SERVER-KEY PIC X(128).

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    MOVE "HmacSHA512" TO WS-SECRET-KEY-BYTES.
    PERFORM CREATE-SECRET-KEY.
    PERFORM PREPARE-SCRAM-CREDENTIALS.
    PERFORM UPDATE-TOKEN.
    PERFORM GET-DELEGATION-TOKEN.
    PERFORM REMOVE-TOKEN.
    PERFORM GET-TOKENS.
    STOP RUN.

CREATE-SECRET-KEY.
    IF CONFIG-TOKEN-AUTH-ENABLED
        MOVE CONFIG-DELEGATION-TOKEN-SECRET-KEY TO WS-SECRET-KEY-BYTES
    ELSE
        MOVE SPACES TO WS-SECRET-KEY-BYTES.
    COMPUTE WS-SECRET-KEY-SPEC(2:117) = LENGTH(WS-SECRET-KEY-BYTES).
    MOVE WS-SECRET-KEY-SPEC TO WS-SECRET-KEY.

PREPARE-SCRAM-CREDENTIALS.
    PERFORM VARYING WS-SCRAM-MECHANISM FROM 1 BY 1 UNTIL WS-SCRAM-MECHANISM > 5
        COMPUTE WS-ITERATIONS = SCRAM-MECHANISM-MIN-ITERATIONS(WS-SCRAM-MECHANISM)
        MOVE "SALT" TO WS-SALT(WS-SCRAM-MECHANISM)
        MOVE "STORED-KEY" TO WS-STORED-KEY(WS-SCRAM-MECHANISM)
        MOVE "SERVER-KEY" TO WS-SERVER-KEY(WS-SCRAM-MECHANISM)
        MOVE WS-SCRAM-MECHANISM TO WS-SCRAM-CREDENTIAL-MAP(WS-SCRAM-MECHANISM, 1)
        MOVE WS-SCRAM-CREDENTIAL TO WS-SCRAM-CREDENTIAL-MAP(WS-SCRAM-MECHANISM, 2)
    END-PERFORM.

UPDATE-TOKEN.
    MOVE TOKEN-HMAC-AS-BASE64 TO WS-HMAC.
    PERFORM PREPARE-SCRAM-CREDENTIALS.
    CALL "UPDATE-CACHE" USING TOKEN, WS-SCRAM-CREDENTIAL-MAP.

GET-DELEGATION-TOKEN.
    CALL "CREATE-HMAC" USING WS-TOKEN-ID, WS-SECRET-KEY GIVING WS-HMAC.
    MOVE WS-TOKEN-INFORMATION TO TOKEN.
    MOVE WS-HMAC TO TOKEN-HMAC.
    RETURN TOKEN.

REMOVE-TOKEN.
    CALL "REMOVE-CACHE" USING WS-TOKEN-ID.

GET-TOKENS.
    CALL "GET-TOKENS" USING FILTER-TOKEN GIVING RESULT.
    PERFORM VARYING RESULT-TOKEN FROM 1 BY 1 UNTIL RESULT-TOKEN > LENGTH(RESULT)
        CALL "GET-DELEGATION-TOKEN" USING RESULT(RESULT-TOKEN) GIVING RESULT-TOKEN-OBJ
        MOVE RESULT-TOKEN-OBJ TO RESULT(RESULT-TOKEN)
    END-PERFORM.
    RETURN RESULT.

FILTER-TOKEN.
    IF OWNERS-DEFINED AND NOT OWNERS-CONTAINS-OWNER
        RETURN FALSE
    ELSE IF TOKEN-OWNER-OR-RENEWER
        RETURN TRUE
    ELSE IF AUTHORIZE-TOKEN OR AUTHORIZE-REQUESTER
        RETURN TRUE
    ELSE
        RETURN FALSE.

COPY "SCRAM-MECHANISM".
COPY "TOKEN-INFORMATION".
COPY "DELEGATION-TOKEN".
COPY "DELEGATION-TOKEN-CACHE".

END PROGRAM DELEGATION-TOKEN-MANAGER.