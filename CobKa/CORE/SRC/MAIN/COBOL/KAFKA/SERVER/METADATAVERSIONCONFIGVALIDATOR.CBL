IDENTIFICATION DIVISION.
PROGRAM-ID. METADATAVERSIONCONFIGVALIDATOR.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    CLASS KAFKACONFIG AS "kafka.server.KafkaConfig".
    CLASS FAULTHANDLER AS "org.apache.kafka.server.fault.FaultHandler".
    CLASS METADATADELTA AS "org.apache.kafka.image.MetadataDelta".
    CLASS METADATAIMAGE AS "org.apache.kafka.image.MetadataImage".
    CLASS LOADERMANIFEST AS "org.apache.kafka.image.loader.LoaderManifest".
    CLASS METADATAPUBLISHER AS "org.apache.kafka.image.publisher.MetadataPublisher".
    CLASS METADATAVERSION AS "org.apache.kafka.server.common.MetadataVersion".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-NAME PIC X(30) VALUE "MetadataVersionPublisher(id=".
01 WS-CONFIG USAGE OBJECT REFERENCE KAFKACONFIG.
01 WS-FAULTHANDLER USAGE OBJECT REFERENCE FAULTHANDLER.

PROCEDURE DIVISION.

CONSTRUCTOR METHOD.
    MOVE FUNCTION CONCATENATE(WS-NAME, FUNCTION CONVERT(CONFIG-BROKERID, X(10)), ")") TO WS-NAME.
    SET WS-CONFIG TO CONFIG.
    SET WS-FAULTHANDLER TO FAULTHANDLER.

NAME METHOD.
    RETURN WS-NAME.

ONMETADATAUPDATE METHOD USING METADATADELTA, METADATAIMAGE, LOADERMANIFEST.
    IF FUNCTION REFERENCE(DELTA-FEATURESDELTA) NOT EQUAL ZERO
        IF FUNCTION REFERENCE(DELTA-METADATAVERSIONCHANGED) NOT EQUAL ZERO
            PERFORM ONMETADATAVERSIONCHANGED USING NEWIMAGE-FEATURES-METADATAVERSIONORTHROW
    .

ONMETADATAVERSIONCHANGED METHOD USING METADATAVERSION.
    PERFORM
        TRY
            CALL WS-CONFIG "VALIDATEWITHMETADATAVERSION" USING METADATAVERSION
        CATCH EXCEPTION
            CALL WS-FAULTHANDLER "HANDLEFAULT" USING
                "Broker configuration does not support the cluster MetadataVersion"
                EXCEPTION-OBJECT
    .