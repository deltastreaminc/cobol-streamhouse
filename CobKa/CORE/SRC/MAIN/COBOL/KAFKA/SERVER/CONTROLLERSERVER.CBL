IDENTIFICATION DIVISION.
PROGRAM-ID. CONTROLLER-SERVER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC FUNCTIONS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 SHARED-SERVER PIC X(30).
01 CONFIG-SCHEMA PIC X(30).
01 BOOTSTRAP-METADATA PIC X(30).
01 METRICS-GROUP PIC X(30).
01 CONFIG PIC X(30).
01 LOG-CONTEXT PIC X(30).
01 TIME PIC X(30).
01 METRICS PIC X(30).
01 RAFT-MANAGER PIC X(30).
01 LOCK PIC X(30).
01 AWAIT-SHUTDOWN-COND PIC X(30).
01 STATUS PIC X(30).
01 LINUX-IO-METRICS-COLLECTOR PIC X(30).
01 AUTHORIZER PIC X(30).
01 TOKEN-CACHE PIC X(30).
01 CREDENTIAL-PROVIDER PIC X(30).
01 SOCKET-SERVER PIC X(30).
01 SOCKET-SERVER-FIRST-BOUND-PORT-FUTURE PIC X(30).
01 CREATE-TOPIC-POLICY PIC X(30).
01 ALTER-CONFIG-POLICY PIC X(30).
01 QUORUM-CONTROLLER-METRICS PIC X(30).
01 CONTROLLER PIC X(30).
01 QUOTA-MANAGERS PIC X(30).
01 CLIENT-QUOTA-METADATA-MANAGER PIC X(30).
01 CONTROLLER-APIS PIC X(30).
01 CONTROLLER-APIS-HANDLER-POOL PIC X(30).
01 KAFKA-YAMMER-METRICS PIC X(30).
01 METADATA-PUBLISHERS PIC X(30).
01 METADATA-CACHE PIC X(30).
01 METADATA-CACHE-PUBLISHER PIC X(30).
01 FEATURES-PUBLISHER PIC X(30).
01 REGISTRATIONS-PUBLISHER PIC X(30).
01 INCARNATION-ID PIC X(30).
01 REGISTRATION-MANAGER PIC X(30).
01 REGISTRATION-CHANNEL-MANAGER PIC X(30).
01 CLUSTER-ID PIC X(30).

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM MAYBE-CHANGE-STATUS.
    PERFORM STARTUP.
    PERFORM SHUTDOWN.
    PERFORM AWAIT-SHUTDOWN.

MAYBE-CHANGE-STATUS.
    PERFORM LOCK-ACQUIRE.
    IF STATUS NOT = "STARTING" THEN
        RETURN
    END-IF.
    MOVE "STARTING" TO STATUS.
    PERFORM LOCK-RELEASE.
    RETURN.

STARTUP.
    PERFORM STARTUP-PROCEDURES.

STARTUP-PROCEDURES.
    MOVE "STARTING" TO STATUS.
    PERFORM STARTUP-DEADLINE.
    PERFORM STARTUP-LOGGING.
    PERFORM STARTUP-CONFIG.
    MOVE "STARTED" TO STATUS.
    PERFORM STARTUP-METRICS.
    PERFORM STARTUP-AUTHORIZER.
    PERFORM STARTUP-METADATA-CACHE.
    PERFORM STARTUP-METADATA-CACHE-PUBLISHER.
    PERFORM STARTUP-FEATURES-PUBLISHER.
    PERFORM STARTUP-REGISTRATIONS-PUBLISHER.
    PERFORM STARTUP-INCARNATION-ID.
    PERFORM STARTUP-API-VERSION-MANAGER.
    PERFORM STARTUP-SOCKET-SERVER.
    PERFORM STARTUP-ENDPOINT-READY-FUTURES.
    PERFORM STARTUP-QUORUM-VOTERS.
    PERFORM STARTUP-QUORUM-FEATURES.
    PERFORM STARTUP-DELEGATION-TOKEN-MANAGER.
    PERFORM STARTUP-CONTROLLER-BUILDER.
    PERFORM STARTUP-QUOTA-MANAGERS.
    PERFORM STARTUP-CLIENT-QUOTA-METADATA-MANAGER.
    PERFORM STARTUP-CONTROLLER-APIS.
    PERFORM STARTUP-CONTROLLER-APIS-HANDLER-POOL.
    PERFORM STARTUP-METADATA-PUBLISHERS.
    PERFORM STARTUP-REGISTRATION-MANAGER.
    PERFORM STARTUP-DYNAMIC-CONFIG-PUBLISHER.
    PERFORM STARTUP-DYNAMIC-CLIENT-QUOTA-PUBLISHER.
    PERFORM STARTUP-DYNAMIC-TOPIC-CLUSTER-QUOTA-PUBLISHER.
    PERFORM STARTUP-SCRAM-PUBLISHER.
    PERFORM STARTUP-DELEGATION-TOKEN-PUBLISHER.
    PERFORM STARTUP-CONTROLLER-METADATA-METRICS-PUBLISHER.
    PERFORM STARTUP-ACL-PUBLISHER.
    PERFORM STARTUP-AUTHORIZER-FUTURES.
    PERFORM STARTUP-SOCKET-SERVER-FUTURES.
    PERFORM STARTUP-REGISTRATION-CHANNEL-MANAGER.
    PERFORM STARTUP-REGISTRATION-MANAGER-START.

STARTUP-DEADLINE.
    PERFORM LOG-CONTEXT-INIT.
    PERFORM LOG-PREFIX-INIT.
    PERFORM INFO-LOG.

STARTUP-LOGGING.
    MOVE LOGIDENT TO LOG-CONTEXT.
    MOVE "Starting controller" TO INFO-MESSAGE.
    PERFORM LOG-INFO.

STARTUP-CONFIG.
    PERFORM CONFIG-INITIALIZE.

STARTUP-METRICS.
    PERFORM METRICS-GROUP-INIT.
    PERFORM CLUSTER-ID-GAUGE.
    PERFORM YAMMER-METRICS-GAUGE.
    PERFORM LINUX-IO-METRICS-COLLECTOR-INIT.

STARTUP-AUTHORIZER.
    PERFORM AUTHORIZER-CREATE.
    PERFORM AUTHORIZER-CONFIGURE.

STARTUP-METADATA-CACHE.
    PERFORM METADATA-CACHE-INIT.

STARTUP-METADATA-CACHE-PUBLISHER.
    PERFORM METADATA-CACHE-PUBLISHER-INIT.

STARTUP-FEATURES-PUBLISHER.
    PERFORM FEATURES-PUBLISHER-INIT.

STARTUP-REGISTRATIONS-PUBLISHER.
    PERFORM REGISTRATIONS-PUBLISHER-INIT.

STARTUP-INCARNATION-ID.
    MOVE FUNCTION UUID-RANDOM() TO INCARNATION-ID.

STARTUP-API-VERSION-MANAGER.
    PERFORM API-VERSION-MANAGER-INIT.

STARTUP-SOCKET-SERVER.
    PERFORM SOCKET-SERVER-INIT.
    PERFORM LISTENER-INFO-CREATE.
    PERFORM LISTENER-INFO-PROCESS.
    PERFORM SHARED-SERVER-START-FOR-CONTROLLER.

STARTUP-ENDPOINT-READY-FUTURES.
    PERFORM ENDPOINT-READY-FUTURES-BUILDER.
    PERFORM ENDPOINT-READY-FUTURES-BUILD.

STARTUP-QUORUM-VOTERS.
    PERFORM QUORUM-VOTERS-FUTURE-WAIT.
    PERFORM QUORUM-CONFIG-VOTER-CONNECTIONS-TO-NODES.

STARTUP-QUORUM-FEATURES.
    PERFORM QUORUM-FEATURES-INIT.

STARTUP-DELEGATION-TOKEN-MANAGER.
    PERFORM DELEGATION-TOKEN-KEY-INIT.

STARTUP-CONTROLLER-BUILDER.
    PERFORM LEADER-IMBALANCE-CHECK-INTERVAL-INIT.
    PERFORM MAX-IDLE-INTERVAL-INIT.
    PERFORM QUORUM-CONTROLLER-METRICS-INIT.
    PERFORM CONTROLLER-BUILDER-INIT.

STARTUP-QUOTA-MANAGERS.
    PERFORM QUOTA-MANAGERS-INIT.

STARTUP-CLIENT-QUOTA-METADATA-MANAGER.
    PERFORM CLIENT-QUOTA-METADATA-MANAGER-INIT.

STARTUP-CONTROLLER-APIS.
    PERFORM CONTROLLER-APIS-INIT.

STARTUP-CONTROLLER-APIS-HANDLER-POOL.
    PERFORM CONTROLLER-APIS-HANDLER-POOL-INIT.

STARTUP-METADATA-PUBLISHERS.
    PERFORM METADATA-PUBLISHERS-ADD.

STARTUP-REGISTRATION-MANAGER.
    PERFORM REGISTRATION-MANAGER-INIT.
    PERFORM REGISTRATION-MANAGER-START.

STARTUP-DYNAMIC-CONFIG-PUBLISHER.
    PERFORM DYNAMIC-CONFIG-PUBLISHER-INIT.

STARTUP-DYNAMIC-CLIENT-QUOTA-PUBLISHER.
    PERFORM DYNAMIC-CLIENT-QUOTA-PUBLISHER-INIT.

STARTUP-DYNAMIC-TOPIC-CLUSTER-QUOTA-PUBLISHER.
    PERFORM DYNAMIC-TOPIC-CLUSTER-QUOTA-PUBLISHER-INIT.

STARTUP-SCRAM-PUBLISHER.
    PERFORM SCRAM-PUBLISHER-INIT.

STARTUP-DELEGATION-TOKEN-PUBLISHER.
    PERFORM DELEGATION-TOKEN-PUBLISHER-INIT.

STARTUP-CONTROLLER-METADATA-METRICS-PUBLISHER.
    PERFORM CONTROLLER-METADATA-METRICS-PUBLISHER-INIT.

STARTUP-ACL-PUBLISHER.
    PERFORM ACL-PUBLISHER-INIT.

STARTUP-AUTHORIZER-FUTURES.
    PERFORM AUTHORIZER-FUTURES-WAIT.

STARTUP-SOCKET-SERVER-FUTURES.
    PERFORM SOCKET-SERVER-FUTURES-WAIT.

STARTUP-REGISTRATION-CHANNEL-MANAGER.
    PERFORM REGISTRATION-CHANNEL-MANAGER-INIT.
    PERFORM REGISTRATION-CHANNEL-MANAGER-START.

STARTUP-REGISTRATION-MANAGER-START.
    PERFORM REGISTRATION-MANAGER-START.

SHUTDOWN.
    PERFORM MAYBE-CHANGE-STATUS.
    PERFORM SHUTDOWN-PROCEDURES.

SHUTDOWN-PROCEDURES.
    MOVE "SHUTTING_DOWN" TO STATUS.
    PERFORM SHUTDOWN-RAFT-LEADER-CHECK.
    PERFORM SHUTDOWN-REGISTRATION-MANAGER.
    PERFORM SHUTDOWN-REGISTRATION-CHANNEL-MANAGER.
    PERFORM SHUTDOWN-METADATA-PUBLISHERS.
    PERFORM SHUTDOWN-METADATA-CACHE.
    PERFORM SHUTDOWN-METADATA-CACHE-PUBLISHER.
    PERFORM SHUTDOWN-FEATURES-PUBLISHER.
    PERFORM SHUTDOWN-REGISTRATIONS-PUBLISHER.
    PERFORM SHUTDOWN-SOCKET-SERVER.
    PERFORM SHUTDOWN-CONTROLLER-APIS-HANDLER-POOL.
    PERFORM SHUTDOWN-CONTROLLER-APIS.
    PERFORM SHUTDOWN-QUOTA-MANAGERS.
    PERFORM SHUTDOWN-CONTROLLER.
    PERFORM SHUTDOWN-QUORUM-CONTROLLER-METRICS.
    PERFORM SHUTDOWN-AUTHORIZER.
    PERFORM SHUTDOWN-CREATE-TOPIC-POLICY.
    PERFORM SHUTDOWN-ALTER-CONFIG-POLICY.
    PERFORM SHUTDOWN-SOCKET-SERVER-FIRST-BOUND-PORT-FUTURE.
    PERFORM SHUTDOWN-DYNAMIC-CONFIG.
    PERFORM SHARED-SERVER-STOP-FOR-CONTROLLER.
    MOVE "SHUTDOWN" TO STATUS.

SHUTDOWN-RAFT-LEADER-CHECK.
    PERFORM SHARED-SERVER-ENSURE-NOT-RAFT-LEADER.

SHUTDOWN-REGISTRATION-MANAGER.
    PERFORM CLOSE-OBJECT.
    MOVE NULL TO REGISTRATION-MANAGER.

SHUTDOWN-REGISTRATION-CHANNEL-MANAGER.
    PERFORM SHUTDOWN-OBJECT.
    MOVE NULL TO REGISTRATION-CHANNEL-MANAGER.

SHUTDOWN-METADATA-PUBLISHERS.
    PERFORM METADATA-PUBLISHERS-FOREACH.
    PERFORM METADATA-PUBLISHERS-CLEAR.

SHUTDOWN-METADATA-CACHE.
    MOVE NULL TO METADATA-CACHE.

SHUTDOWN-METADATA-CACHE-PUBLISHER.
    PERFORM CLOSE-OBJECT.
    MOVE NULL TO METADATA-CACHE-PUBLISHER.

SHUTDOWN-FEATURES-PUBLISHER.
    PERFORM CLOSE-OBJECT.
    MOVE NULL TO FEATURES-PUBLISHER.

SHUTDOWN-REGISTRATIONS-PUBLISHER.
    PERFORM CLOSE-OBJECT.
    MOVE NULL TO REGISTRATIONS-PUBLISHER.

SHUTDOWN-SOCKET-SERVER.
    PERFORM SOCKET-SERVER-STOP-PROCESSING-REQUESTS.
    PERFORM SOCKET-SERVER-SHUTDOWN.

SHUTDOWN-CONTROLLER-APIS-HANDLER-POOL.
    PERFORM SHUTDOWN-OBJECT.

SHUTDOWN-CONTROLLER-APIS.
    PERFORM CLOSE-OBJECT.

SHUTDOWN-QUOTA-MANAGERS.
    PERFORM SHUTDOWN-OBJECT.

SHUTDOWN-CONTROLLER.
    PERFORM BEGIN-SHUTDOWN.
    PERFORM CLOSE-OBJECT.

SHUTDOWN-QUORUM-CONTROLLER-METRICS.
    PERFORM CLOSE-OBJECT.

SHUTDOWN-AUTHORIZER.
    PERFORM AUTHORIZER-CLOSE.

SHUTDOWN-CREATE-TOPIC-POLICY.
    PERFORM POLICY-CLOSE.

SHUTDOWN-ALTER-CONFIG-POLICY.
    PERFORM POLICY-CLOSE.

SHUTDOWN-SOCKET-SERVER-FIRST-BOUND-PORT-FUTURE.
    PERFORM FUTURE-COMPLETE-EXCEPTIONALLY.

SHUTDOWN-DYNAMIC-CONFIG.
    PERFORM DYNAMIC-CONFIG-CLEAR.

AWAIT-SHUTDOWN.
    PERFORM LOCK-ACQUIRE.
    PERFORM LOOP-UNTIL-SHUTDOWN.
    PERFORM LOCK-RELEASE.

LOOP-UNTIL-SHUTDOWN.
    IF STATUS = "SHUTDOWN" THEN
        RETURN
    END-IF.
    PERFORM AWAIT-SHUTDOWN-COND-AWAIT.

LOCK-ACQUIRE.
    PERFORM LOCK.

LOCK-RELEASE.
    PERFORM UNLOCK.

END PROGRAM CONTROLLER-SERVER.