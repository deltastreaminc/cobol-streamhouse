IDENTIFICATION DIVISION.
PROGRAM-ID. CONFIG-ADMIN-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY. 
    CLASS KAFKA-CONFIG IS EXTERNAL.
    CLASS CONFIG-RESOURCE IS EXTERNAL.
    CLASS RUNTIME-LOGGER-MANAGER IS EXTERNAL.
    CLASS INCREMENTAL-ALTER-CONFIGS-REQUEST-DATA IS EXTERNAL.
    CLASS ALTER-CONFIGS-REQUEST-DATA IS EXTERNAL.
    CLASS INCREMENTAL-ALTER-CONFIGS-RESPONSE-DATA IS EXTERNAL.
    CLASS ALTER-CONFIGS-RESPONSE-DATA IS EXTERNAL.
    CLASS ALTER-CONFIG-OP IS EXTERNAL.
    CLASS CONFIG-ENTRY IS EXTERNAL.
    CLASS API-ERROR IS EXTERNAL.
    CLASS PROPERTIES IS EXTERNAL.
    CLASS IDENTITY-HASH-MAP IS EXTERNAL.
    CLASS HASH-SET IS EXTERNAL.
    CLASS HASH-MAP IS EXTERNAL.
    CLASS CONFIG-DEF IS EXTERNAL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-NODE-ID PIC 9(9) BINARY.
01 WS-KAFKA-CONFIG PIC X(128).
01 WS-CONFIG-REPOSITORY PIC X(128).
01 WS-RUNTIME-LOGGER-MANAGER PIC X(128).
01 WS-LOGGER PIC X(128).
01 WS-LOGGER-IDENT PIC X(128).
01 WS-PREPROCESSED-REQUESTS-INCREMENTAL USAGE IS POINTER.
01 WS-PREPROCESSED-REQUESTS-LEGACY USAGE IS POINTER.
01 WS-PERSISTENT-RESPONSES-INCREMENTAL USAGE IS POINTER.
01 WS-PERSISTENT-RESPONSES-LEGACY USAGE IS POINTER.
01 WS-CONFIG-PROPS USAGE IS OBJECT REFERENCE PROPERTIES.
01 WS-CONFIG-KEYS USAGE IS OBJECT REFERENCE.
01 WS-RESOURCE-TYPE PIC 9(9) BINARY.
01 WS-RESOURCE-NAME PIC X(128).
01 WS-CONFIG-RESOURCE USAGE IS OBJECT REFERENCE CONFIG-RESOURCE.
01 WS-ALTER-CONFIG-OPS OCCURS 99 TIMES USAGE IS OBJECT REFERENCE ALTER-CONFIG-OP.
01 WS-RESOURCE-ID-MAP USAGE IS OBJECT REFERENCE HASH-MAP.
01 WS-ERROR-RESPONSES USAGE IS OBJECT REFERENCE IDENTITY-HASH-MAP.
01 WS-NULL-UPDATES USAGE IS OBJECT REFERENCE ARRAY-LIST.
01 WS-DUPLICATE-CONFIGS USAGE IS OBJECT REFERENCE HASH-SET.

PROCEDURE DIVISION.

PREPROCESSING-INCREMENTAL.
    MOVE FUNCTION NEW(INCREMENTAL-ALTER-CONFIGS-REQUEST-DATA) TO WS-PREPROCESSED-REQUESTS-INCREMENTAL.
    MOVE FUNCTION NEW(IDENTITY-HASH-MAP) TO WS-ERROR-RESPONSES.
    PERFORM VARYING WS-PREPROCESSED-REQUESTS-INCREMENTAL FROM 1 BY 1 UNTIL WS-PREPROCESSED-REQUESTS-INCREMENTAL IS EMPTY
        MOVE FUNCTION NEXT(WS-PREPROCESSED-REQUESTS-INCREMENTAL) TO WS-RESOURCE-ID-MAP
        PERFORM VARYING WS-RESOURCE-ID-MAP FROM 1 BY 1 UNTIL WS-RESOURCE-ID-MAP IS EMPTY
            MOVE FUNCTION NEXT(WS-RESOURCE-ID-MAP) TO WS-RESOURCE-TYPE
            MOVE FUNCTION NEXT(WS-RESOURCE-ID-MAP) TO WS-RESOURCE-NAME
            MOVE FUNCTION NEW(CONFIG-RESOURCE, WS-RESOURCE-TYPE, WS-RESOURCE-NAME) TO WS-CONFIG-RESOURCE
            PERFORM PREPROCESS-RESOURCE
        END-PERFORM
    END-PERFORM.
    MOVE WS-ERROR-RESPONSES TO RETURN-CODE.

PREPROCESSING-LEGACY.
    MOVE FUNCTION NEW(ALTER-CONFIGS-REQUEST-DATA) TO WS-PREPROCESSED-REQUESTS-LEGACY.
    MOVE FUNCTION NEW(IDENTITY-HASH-MAP) TO WS-ERROR-RESPONSES.
    PERFORM VARYING WS-PREPROCESSED-REQUESTS-LEGACY FROM 1 BY 1 UNTIL WS-PREPROCESSED-REQUESTS-LEGACY IS EMPTY
        MOVE FUNCTION NEXT(WS-PREPROCESSED-REQUESTS-LEGACY) TO WS-RESOURCE-ID-MAP
        PERFORM VARYING WS-RESOURCE-ID-MAP FROM 1 BY 1 UNTIL WS-RESOURCE-ID-MAP IS EMPTY
            MOVE FUNCTION NEXT(WS-RESOURCE-ID-MAP) TO WS-RESOURCE-TYPE
            MOVE FUNCTION NEXT(WS-RESOURCE-ID-MAP) TO WS-RESOURCE-NAME
            MOVE FUNCTION NEW(CONFIG-RESOURCE, WS-RESOURCE-TYPE, WS-RESOURCE-NAME) TO WS-CONFIG-RESOURCE
            PERFORM PREPROCESS-RESOURCE
        END-PERFORM
    END-PERFORM.
    MOVE WS-ERROR-RESPONSES TO RETURN-CODE.

PREPROCESS-RESOURCE.
    EVALUATE WS-RESOURCE-TYPE
        WHEN BROKER-LOGGER
            PERFORM APPLY-LOGGER-CHANGES
        WHEN BROKER
            PERFORM VALIDATE-BROKER-CONFIG-CHANGE
        WHEN TOPIC ALSO WHEN CLIENT-METRICS ALSO WHEN GROUP
            CONTINUE
        WHEN OTHER
            MOVE FUNCTION NEW(INVALID-REQUEST-EXCEPTION, "Unknown resource type " & WS-RESOURCE-TYPE) TO WS-ERROR-RESPONSES(WS-CONFIG-RESOURCE)
    END-EVALUATE.

APPLY-LOGGER-CHANGES.
    CALL "APPLY-CHANGES-FOR-RESOURCE" USING WS-RUNTIME-LOGGER-MANAGER, WS-PREPROCESSED-REQUESTS-INCREMENTAL(VALIDATE-ONLY), WS-RESOURCE-ID-MAP.
    MOVE FUNCTION NEW(API-ERROR, NONE) TO WS-ERROR-RESPONSES(WS-CONFIG-RESOURCE).

VALIDATE-BROKER-CONFIG-CHANGE.
    MOVE FUNCTION NEW(PROPERTIES) TO WS-CONFIG-PROPS.
    PERFORM VARYING WS-ALTER-CONFIG-OPS FROM 1 BY 1 UNTIL WS-ALTER-CONFIG-OPS IS EMPTY
        MOVE FUNCTION NEW(CONFIG-ENTRY, WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME), WS-ALTER-CONFIG-OPS(CONFIGURATION-VALUE)) TO WS-ALTER-CONFIG-OPS(CONFIGURATION-ENTRY)
        MOVE FUNCTION NEW(ALTER-CONFIG-OP, WS-ALTER-CONFIG-OPS(CONFIGURATION-ENTRY), WS-ALTER-CONFIG-OPS(OPERATION-TYPE)) TO WS-ALTER-CONFIG-OPS(CONFIGURATION-OP)
        PERFORM PREPARE-INCREMENTAL-CONFIGS USING WS-ALTER-CONFIG-OPS(CONFIGURATION-OP), WS-CONFIG-PROPS, WS-CONFIG-KEYS
    END-PERFORM.
    PERFORM VALIDATE-BROKER-CONFIG-CHANGE USING WS-CONFIG-PROPS, WS-CONFIG-RESOURCE.

VALIDATE-BROKER-CONFIG-CHANGE.
    CALL "VALIDATE" USING WS-KAFKA-CONFIG, WS-CONFIG-PROPS, WS-RESOURCE-NAME.

PREPARE-INCREMENTAL-CONFIGS.
    PERFORM VARYING WS-ALTER-CONFIG-OPS FROM 1 BY 1 UNTIL WS-ALTER-CONFIG-OPS IS EMPTY
        EVALUATE WS-ALTER-CONFIG-OPS(OPERATION-TYPE)
            WHEN SET
                MOVE WS-ALTER-CONFIG-OPS(CONFIGURATION-VALUE) TO WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME))
            WHEN DELETE
                CANCEL WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME))
            WHEN APPEND
                PERFORM APPEND-LIST-CONFIG
            WHEN SUBTRACT
                PERFORM SUBTRACT-LIST-CONFIG
        END-EVALUATE
    END-PERFORM.

APPEND-LIST-CONFIG.
    MOVE WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME)) TO WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME)).
    PERFORM VARYING WS-ALTER-CONFIG-OPS(CONFIGURATION-ENTRY) FROM 1 BY 1 UNTIL WS-ALTER-CONFIG-OPS(CONFIGURATION-ENTRY) IS EMPTY
        IF NOT WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME)) CONTAINS WS-ALTER-CONFIG-OPS(CONFIGURATION-ENTRY)
            STRING WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME)) DELIMITED BY "," 
                  WS-ALTER-CONFIG-OPS(CONFIGURATION-ENTRY) DELIMITED BY ","
                  INTO WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME))
        END-IF
    END-PERFORM.

SUBTRACT-LIST-CONFIG.
    MOVE WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME)) TO WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME)).
    PERFORM VARYING WS-ALTER-CONFIG-OPS(CONFIGURATION-ENTRY) FROM 1 BY 1 UNTIL WS-ALTER-CONFIG-OPS(CONFIGURATION-ENTRY) IS EMPTY
        PERFORM VARYING WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME)) FROM 1 BY 1 UNTIL WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME)) IS EMPTY
            IF WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME)) = WS-ALTER-CONFIG-OPS(CONFIGURATION-ENTRY)
                CANCEL WS-CONFIG-PROPS(WS-ALTER-CONFIG-OPS(CONFIGURATION-NAME))
            END-IF
        END-PERFORM
    END-PERFORM.

CONTAIN-DUPLICATES.
    MOVE FUNCTION NEW(HASH-SET) TO WS-DUPLICATE-CONFIGS.
    PERFORM VARYING WS-PREPROCESSED-REQUESTS-INCREMENTAL FROM 1 BY 1 UNTIL WS-PREPROCESSED-REQUESTS-INCREMENTAL IS EMPTY
        IF NOT FUNCTION ADD(WS-DUPLICATE-CONFIGS, WS-PREPROCESSED-REQUESTS-INCREMENTAL(CONFIGURATION-NAME))
            RETURN TRUE
        END-IF
    END-PERFORM.
    RETURN FALSE.

VALIDATE-RESOURCE-NAME-IS-CURRENT-NODE-ID.
    MOVE FUNCTION NEW(INVALID-REQUEST-EXCEPTION, "Node id must be an integer, but it is: " & WS-RESOURCE-NAME) TO WS-ERROR-RESPONSES(WS-CONFIG-RESOURCE).
    IF FUNCTION INTEGER(WS-RESOURCE-NAME) <> WS-NODE-ID
        MOVE FUNCTION NEW(INVALID-REQUEST-EXCEPTION, "Unexpected broker id, expected " & WS-NODE-ID & ", but received " & WS-RESOURCE-NAME) TO WS-ERROR-RESPONSES(WS-CONFIG-RESOURCE)
    END-IF.

COPY-WITHOUT-PREPROCESSED-INCREMENTAL.
    MOVE FUNCTION NEW(INCREMENTAL-ALTER-CONFIGS-REQUEST-DATA) TO RETURN-CODE.
    PERFORM VARYING WS-PREPROCESSED-REQUESTS-INCREMENTAL FROM 1 BY 1 UNTIL WS-PREPROCESSED-REQUESTS-INCREMENTAL IS EMPTY
        IF NOT WS-ERROR-RESPONSES CONTAINS WS-PREPROCESSED-REQUESTS-INCREMENTAL
            MOVE FUNCTION NEW(WS-PREPROCESSED-REQUESTS-INCREMENTAL) TO RETURN-CODE(RESOURCES)
        END-IF
    END-PERFORM.

COPY-WITHOUT-PREPROCESSED-LEGACY.
    MOVE FUNCTION NEW(ALTER-CONFIGS-REQUEST-DATA) TO RETURN-CODE.
    PERFORM VARYING WS-PREPROCESSED-REQUESTS-LEGACY FROM 1 BY 1 UNTIL WS-PREPROCESSED-REQUESTS-LEGACY IS EMPTY
        IF NOT WS-ERROR-RESPONSES CONTAINS WS-PREPROCESSED-REQUESTS-LEGACY
            MOVE FUNCTION NEW(WS-PREPROCESSED-REQUESTS-LEGACY) TO RETURN-CODE(RESOURCES)
        END-IF
    END-PERFORM.

REASSEMBLE-INCREMENTAL-RESPONSE.
    MOVE FUNCTION NEW(INCREMENTAL-ALTER-CONFIGS-RESPONSE-DATA) TO RETURN-CODE.
    PERFORM VARYING WS-PREPROCESSED-REQUESTS-INCREMENTAL FROM 1 BY 1 UNTIL WS-PREPROCESSED-REQUESTS-INCREMENTAL IS EMPTY
        MOVE FUNCTION GET(WS-ERROR-RESPONSES, WS-PREPROCESSED-REQUESTS-INCREMENTAL) TO WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-INCREMENTAL)
        IF WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-INCREMENTAL) IS NULL
            MOVE FUNCTION FIND(WS-PERSISTENT-RESPONSES-INCREMENTAL, WS-PREPROCESSED-REQUESTS-INCREMENTAL(RESOURCE-NAME), WS-PREPROCESSED-REQUESTS-INCREMENTAL(RESOURCE-TYPE)) TO WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-INCREMENTAL)
            IF WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-INCREMENTAL) IS NULL
                MOVE FUNCTION NEW(API-ERROR, UNKNOWN-SERVER-ERROR) TO WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-INCREMENTAL)
            END-IF
        END-IF
        MOVE FUNCTION NEW(INCREMENTAL-ALTER-CONFIGS-RESOURCE-RESPONSE, 
                          WS-PREPROCESSED-REQUESTS-INCREMENTAL(RESOURCE-NAME),
                          WS-PREPROCESSED-REQUESTS-INCREMENTAL(RESOURCE-TYPE),
                          WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-INCREMENTAL)(ERROR-CODE),
                          WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-INCREMENTAL)(ERROR-MESSAGE)) 
        TO RETURN-CODE(RESPONSES)
    END-PERFORM.

REASSEMBLE-LEGACY-RESPONSE.
    MOVE FUNCTION NEW(ALTER-CONFIGS-RESPONSE-DATA) TO RETURN-CODE.
    PERFORM VARYING WS-PREPROCESSED-REQUESTS-LEGACY FROM 1 BY 1 UNTIL WS-PREPROCESSED-REQUESTS-LEGACY IS EMPTY
        MOVE FUNCTION GET(WS-ERROR-RESPONSES, WS-PREPROCESSED-REQUESTS-LEGACY) TO WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-LEGACY)
        IF WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-LEGACY) IS NULL
            MOVE FUNCTION FIND(WS-PERSISTENT-RESPONSES-LEGACY, WS-PREPROCESSED-REQUESTS-LEGACY(RESOURCE-NAME), WS-PREPROCESSED-REQUESTS-LEGACY(RESOURCE-TYPE)) TO WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-LEGACY)
            IF WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-LEGACY) IS NULL
                MOVE FUNCTION NEW(API-ERROR, UNKNOWN-SERVER-ERROR) TO WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-LEGACY)
            END-IF
        END-IF
        MOVE FUNCTION NEW(ALTER-CONFIGS-RESOURCE-RESPONSE, 
                          WS-PREPROCESSED-REQUESTS-LEGACY(RESOURCE-NAME),
                          WS-PREPROCESSED-REQUESTS-LEGACY(RESOURCE-TYPE),
                          WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-LEGACY)(ERROR-CODE),
                          WS-ERROR-RESPONSES(WS-PREPROCESSED-REQUESTS-LEGACY)(ERROR-MESSAGE))
        TO RETURN-CODE(RESPONSES)
    END-PERFORM.

TO-LOGGABLE-PROPS.
    MOVE FUNCTION NEW(