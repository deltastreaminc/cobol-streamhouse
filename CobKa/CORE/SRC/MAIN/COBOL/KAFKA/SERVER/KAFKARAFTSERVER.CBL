IDENTIFICATION DIVISION.
PROGRAM-ID. KAFKARAFTSERVER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SPECIAL-NAMES.
    LINKAGE SECTION.
DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-META-PROPS-ENSEMBLE PIC X(256).
01 WS-BOOTSTRAP-METADATA PIC X(256).
01 WS-METRICS PIC X(256).
01 WS-SHARED-SERVER PIC X(256).
01 WS-BROKER PIC X(256).
01 WS-CONTROLLER PIC X(256).
01 WS-LOGGER PIC X(256).
01 WS-LOG-IDENT PIC X(256).
01 WS-CONFIG PIC X(256).
01 WS-TIME PIC X(256).

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM INITIALIZE-LOG-DIRS.
    PERFORM INITIALIZE-METRICS.
    PERFORM INITIALIZE-SHARED-SERVER.
    PERFORM INITIALIZE-BROKER.
    PERFORM INITIALIZE-CONTROLLER.
    PERFORM STARTUP.
    PERFORM SHUTDOWN.
    PERFORM AWAIT-SHUTDOWN.
    STOP RUN.

INITIALIZE-LOG-DIRS.
    MOVE FUNCTION INITIALIZE-LOG-DIRS(WS-CONFIG, WS-LOGGER, WS-LOG-IDENT) TO WS-META-PROPS-ENSEMBLE, WS-BOOTSTRAP-METADATA.

INITIALIZE-METRICS.
    MOVE FUNCTION INITIALIZE-METRICS(WS-CONFIG, WS-TIME, WS-META-PROPS-ENSEMBLE(CLUSTER-ID)) TO WS-METRICS.

INITIALIZE-SHARED-SERVER.
    MOVE FUNCTION INITIALIZE-SHARED-SERVER(WS-CONFIG, WS-META-PROPS-ENSEMBLE, WS-TIME, WS-METRICS, FUNCTION PARSE-VOTER-CONNECTIONS(WS-CONFIG(QUORUM-CONFIG-VOTERS)), FUNCTION PARSE-BOOTSTRAP-SERVERS(WS-CONFIG(QUORUM-CONFIG-BOOTSTRAP-SERVERS)), NEW STANDARD-FAULT-HANDLER-FACTORY(), SERVER-SOCKET-FACTORY-INSTANCE) TO WS-SHARED-SERVER.

INITIALIZE-BROKER.
    IF WS-CONFIG(PROCESS-ROLES) CONTAINS PROCESS-ROLE-BROKER THEN
        MOVE NEW BROKER-SERVER(WS-SHARED-SERVER) TO WS-BROKER
    ELSE
        MOVE SPACE TO WS-BROKER.

INITIALIZE-CONTROLLER.
    IF WS-CONFIG(PROCESS-ROLES) CONTAINS PROCESS-ROLE-CONTROLLER THEN
        MOVE NEW CONTROLLER-SERVER(WS-SHARED-SERVER, KAFKA-RAFT-SERVER-CONFIG-SCHEMA, WS-BOOTSTRAP-METADATA) TO WS-CONTROLLER
    ELSE
        MOVE SPACE TO WS-CONTROLLER.

STARTUP.
    PERFORM LOAD-MX4J.
    IF WS-CONTROLLER NOT EQUAL SPACE THEN
        PERFORM STARTUP-CONTROLLER
    END-IF.
    IF WS-BROKER NOT EQUAL SPACE THEN
        PERFORM STARTUP-BROKER
    END-IF.
    PERFORM REGISTER-APP-INFO.
    PERFORM LOG-STARTED-MESSAGE.

SHUTDOWN.
    IF WS-BROKER NOT EQUAL SPACE THEN
        PERFORM SHUTDOWN-BROKER
    END-IF.
    IF WS-CONTROLLER NOT EQUAL SPACE THEN
        PERFORM SHUTDOWN-CONTROLLER
    END-IF.
    PERFORM UNREGISTER-APP-INFO.

AWAIT-SHUTDOWN.
    IF WS-BROKER NOT EQUAL SPACE THEN
        PERFORM AWAIT-BROKER-SHUTDOWN
    END-IF.
    IF WS-CONTROLLER NOT EQUAL SPACE THEN
        PERFORM AWAIT-CONTROLLER-SHUTDOWN
    END-IF.

LOAD-MX4J.
    CALL "MX4JLOADER-MAYBELOAD".

STARTUP-CONTROLLER.
    CALL "CONTROLLER-SERVER-STARTUP" USING WS-CONTROLLER.

STARTUP-BROKER.
    CALL "BROKER-SERVER-STARTUP" USING WS-BROKER.

REGISTER-APP-INFO.
    CALL "APPINFOPARSER-REGISTERAPPINFO" USING SERVER-METRICS-PREFIX, WS-CONFIG(BROKER-ID), WS-METRICS, WS-TIME(MILLISECONDS).

LOG-STARTED-MESSAGE.
    PERFORM LOG-INFO USING KAFKA-BROKER-STARTED-MESSAGE.

SHUTDOWN-BROKER.
    CALL "BROKER-SERVER-SHUTDOWN" USING WS-BROKER.

SHUTDOWN-CONTROLLER.
    CALL "CONTROLLER-SERVER-SHUTDOWN" USING WS-CONTROLLER.

UNREGISTER-APP-INFO.
    CALL "APPINFOPARSER-UNREGISTERAPPINFO" USING SERVER-METRICS-PREFIX, WS-CONFIG(BROKER-ID), WS-METRICS.

AWAIT-BROKER-SHUTDOWN.
    CALL "BROKER-SERVER-AWAITSHUTDOWN" USING WS-BROKER.

AWAIT-CONTROLLER-SHUTDOWN.
    CALL "CONTROLLER-SERVER-AWAITSHUTDOWN" USING WS-CONTROLLER.

LOG-INFO.
    CALL "LOGGER-INFO" USING WS-LOGGER, FUNCTION CONCAT(WS-LOG-IDENT, ARGUMENT-VALUE).

COPY "KAFKA-RAFT-SERVER-CONSTANTS".
COPY "KAFKA-CONFIG".
COPY "KAFKA-RAFT-SERVER-CONFIG-SCHEMA".
COPY "BROKER-SERVER".
COPY "CONTROLLER-SERVER".
COPY "SHARED-SERVER".
COPY "STANDARD-FAULT-HANDLER-FACTORY".
COPY "SERVER-SOCKET-FACTORY".
COPY "APPINFOPARSER".
COPY "LOGGER".
COPY "TIME".
COPY "METRICS".

END PROGRAM KAFKARAFTSERVER.