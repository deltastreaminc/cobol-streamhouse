IDENTIFICATION DIVISION.
PROGRAM-ID. DUMP-LOG-SEGMENTS.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC FUNCTIONS.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-MISMATCH-FOR-INDEX-FILES-MAP.
    05 WS-MISMATCH-FOR-INDEX-FILES-MAP-ITEM OCCURS 1 TO 9999 TIMES DEPENDING ON WS-MISMATCH-FOR-INDEX-FILES-MAP-COUNT.
       10 WS-MISMATCH-FOR-INDEX-FILES-MAP-FILE-NAME PIC X(256).
       10 WS-MISMATCH-FOR-INDEX-FILES-MAP-LIST.
          15 WS-MISMATCH-FOR-INDEX-FILES-MAP-OFFSET PIC 9(18) COMP-3.
          15 WS-MISMATCH-FOR-INDEX-FILES-MAP-LOG-OFFSET PIC 9(18) COMP-3.
    05 WS-MISMATCH-FOR-INDEX-FILES-MAP-COUNT PIC 9(5) COMP.

01 WS-TIME-INDEX-DUMP-ERRORS.
    05 WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP.
       10 WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-ITEM OCCURS 1 TO 9999 TIMES DEPENDING ON WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-COUNT.
          15 WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-FILE-NAME PIC X(256).
          15 WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-LIST.
             20 WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-TIMESTAMP PIC 9(18) COMP-3.
             20 WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-LOG-TIMESTAMP PIC 9(18) COMP-3.
    05 WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-COUNT PIC 9(5) COMP.

    05 WS-TIME-INDEX-OUT-OF-ORDER-TIMESTAMP.
       10 WS-TIME-INDEX-OUT-OF-ORDER-TIMESTAMP-ITEM OCCURS 1 TO 9999 TIMES DEPENDING ON WS-TIME-INDEX-OUT-OF-ORDER-TIMESTAMP-COUNT.
          15 WS-TIME-INDEX-OUT-OF-ORDER-TIMESTAMP-FILE-NAME PIC X(256).
          15 WS-TIME-INDEX-OUT-OF-ORDER-TIMESTAMP-LIST.
             20 WS-TIME-INDEX-OUT-OF-ORDER-TIMESTAMP PIC 9(18) COMP-3.
             20 WS-TIME-INDEX-OUT-OF-ORDER-PREV-TIMESTAMP PIC 9(18) COMP-3.
    05 WS-TIME-INDEX-OUT-OF-ORDER-TIMESTAMP-COUNT PIC 9(5) COMP.

    05 WS-TIME-INDEX-SHALLOW-OFFSET-NOT-FOUND.
       10 WS-TIME-INDEX-SHALLOW-OFFSET-NOT-FOUND-ITEM OCCURS 1 TO 9999 TIMES DEPENDING ON WS-TIME-INDEX-SHALLOW-OFFSET-NOT-FOUND-COUNT.
          15 WS-TIME-INDEX-SHALLOW-OFFSET-NOT-FOUND-FILE-NAME PIC X(256).
          15 WS-TIME-INDEX-SHALLOW-OFFSET-NOT-FOUND-LIST.
             20 WS-TIME-INDEX-SHALLOW-OFFSET-NOT-FOUND-INDEX-OFFSET PIC 9(18) COMP-3.
             20 WS-TIME-INDEX-SHALLOW-OFFSET-NOT-FOUND-LOG-OFFSET PIC 9(18) COMP-3.
    05 WS-TIME-INDEX-SHALLOW-OFFSET-NOT-FOUND-COUNT PIC 9(5) COMP.

01 WS-NON-CONSECUTIVE-PAIRS-FOR-LOG-FILES-MAP.
    05 WS-NON-CONSECUTIVE-PAIRS-FOR-LOG-FILES-MAP-ITEM OCCURS 1 TO 9999 TIMES DEPENDING ON WS-NON-CONSECUTIVE-PAIRS-FOR-LOG-FILES-MAP-COUNT.
       10 WS-NON-CONSECUTIVE-PAIRS-FOR-LOG-FILES-MAP-FILE-NAME PIC X(256).
       10 WS-NON-CONSECUTIVE-PAIRS-FOR-LOG-FILES-MAP-LIST.
          15 WS-NON-CONSECUTIVE-PAIRS-FOR-LOG-FILES-MAP-FIRST PIC 9(18) COMP-3.
          15 WS-NON-CONSECUTIVE-PAIRS-FOR-LOG-FILES-MAP-SECOND PIC 9(18) COMP-3.
    05 WS-NON-CONSECUTIVE-PAIRS-FOR-LOG-FILES-MAP-COUNT PIC 9(5) COMP.

01 WS-FILE-OBJECT.
    05 WS-FILE-NAME PIC X(256).
    05 WS-SUFFIX PIC X(10).
    05 WS-START-OFFSET PIC 9(18) COMP-3.

01 WS-RECORD-INDENT PIC X(1) VALUE '|'.

01 WS-DECODER-MESSAGE-PARSER.
    05 WS-KEY-DECODER PIC X(256).
    05 WS-VALUE-DECODER PIC X(256).

01 WS-OPTIONS.
    05 WS-PRINT-DATA-LOG PIC X.
    05 WS-VERIFY-ONLY PIC X.
    05 WS-INDEX-SANITY-ONLY PIC X.
    05 WS-FILES PIC X(256) OCCURS 1 TO 9999 TIMES DEPENDING ON WS-FILES-COUNT.
    05 WS-FILES-COUNT PIC 9(5) COMP.
    05 WS-MAX-MESSAGE-SIZE PIC 9(9) COMP.
    05 WS-MAX-BYTES PIC 9(9) COMP.
    05 WS-DEEP-ITERATION PIC X.
    05 WS-SKIP-RECORD-METADATA PIC X.

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM INIT-OPTIONS.
    PERFORM PROCESS-FILES.
    PERFORM PRINT-ERRORS.
    STOP RUN.

INIT-OPTIONS.
    PERFORM PARSE-COMMAND-LINE-ARGUMENTS.
    PERFORM VALIDATE-REQUIRED-ARGUMENTS.

PARSE-COMMAND-LINE-ARGUMENTS.
    * Parse command line arguments and populate WS-OPTIONS

VALIDATE-REQUIRED-ARGUMENTS.
    IF WS-FILES-COUNT = 0
        DISPLAY "REQUIRED: The comma separated list of data and index log files to be dumped."
        STOP RUN.

PROCESS-FILES.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > WS-FILES-COUNT
        MOVE WS-FILES(I) TO WS-FILE-NAME
        PERFORM PROCESS-FILE
    END-PERFORM.

PROCESS-FILE.
    DISPLAY "Dumping " WS-FILE-NAME.
    PERFORM EXTRACT-FILE-SUFFIX.
    EVALUATE WS-SUFFIX
        WHEN ".log" PERFORM DUMP-LOG
        WHEN ".index" PERFORM DUMP-INDEX
        WHEN ".time-index" PERFORM DUMP-TIME-INDEX
        WHEN ".producer-snapshot" PERFORM DUMP-PRODUCER-ID-SNAPSHOT
        WHEN ".txn-index" PERFORM DUMP-TXN-INDEX
        WHEN OTHER
            DISPLAY "Ignoring unknown file " WS-FILE-NAME.
    END-EVALUATE.

EXTRACT-FILE-SUFFIX.
    INSPECT WS-FILE-NAME TALLYING WS-SUFFIX FOR LAST OCCURRENCE OF "."
    MOVE WS-FILE-NAME(WS-SUFFIX + 1:) TO WS-SUFFIX.

DUMP-LOG.
    PERFORM EXTRACT-START-OFFSET.
    DISPLAY "Log starting offset: " WS-START-OFFSET.
    PERFORM OPEN-FILE-RECORDS.
    PERFORM PROCESS-BATCHES.
    PERFORM CLOSE-FILE-RECORDS.

EXTRACT-START-OFFSET.
    UNSTRING WS-FILE-NAME DELIMITED BY "." INTO WS-START-OFFSET.

OPEN-FILE-RECORDS.
    * Open file records

PROCESS-BATCHES.
    PERFORM VARYING BATCH-IDX FROM 1 BY 1 UNTIL BATCH-IDX > NUM-BATCHES
        PERFORM PRINT-BATCH-LEVEL
        IF WS-DEEP-ITERATION = 'Y'
            PERFORM PROCESS-RECORDS IN BATCH
        END-IF
    END-PERFORM.

PRINT-BATCH-LEVEL.
    * Print batch level information

PROCESS-RECORDS IN BATCH.
    PERFORM VARYING RECORD-IDX FROM 1 BY 1 UNTIL RECORD-IDX > NUM-RECORDS-IN-BATCH
        PERFORM PRINT-RECORD-DETAILS
    END-PERFORM.

PRINT-RECORD-DETAILS.
    DISPLAY WS-RECORD-INDENT " offset: " RECORD-OFFSET
        " timestamp-type: " RECORD-TIMESTAMP-TYPE
        " timestamp: " RECORD-TIMESTAMP
        " keySize: " RECORD-KEY-SIZE
        " valueSize: " RECORD-VALUE-SIZE.
    IF BATCH-MAGIC >= RECORD-BATCH-MAGIC-VALUE-V2
        DISPLAY " sequence: " RECORD-SEQUENCE
        " headerKeys: [" RECORD-HEADER-KEYS "]".
    IF BATCH-IS-VALID = 'N'
        DISPLAY " isValid: " BATCH-IS-VALID " crc: " BATCH-CHECKSUM.
    PERFORM PRINT-CONTROL-RECORD-DETAILS.

PRINT-CONTROL-RECORD-DETAILS.
    IF BATCH-IS-CONTROL-BATCH
        EVALUATE CONTROL-RECORD-TYPE
            WHEN ABORT PERFORM PRINT-ABORT-COMMIT-DETAILS
            WHEN COMMIT PERFORM PRINT-ABORT-COMMIT-DETAILS
            WHEN SNAPSHOT-HEADER PERFORM PRINT-SNAPSHOT-HEADER-DETAILS
            WHEN SNAPSHOT-FOOTER PERFORM PRINT-SNAPSHOT-FOOTER-DETAILS
            WHEN KRAFT-VERSION PERFORM PRINT-KRAFT-VERSION-DETAILS
            WHEN KRAFT-VOTERS PERFORM PRINT-KRAFT-VOTERS-DETAILS
            WHEN OTHER
                DISPLAY " controlType: " CONTROL-RECORD-TYPE "(" CONTROL-RECORD-TYPE-ID ")".
        END-EVALUATE.
    END-IF.

PRINT-ABORT-COMMIT-DETAILS.
    DISPLAY " endTxnMarker: " END-TXN-MARKER-CONTROL-TYPE
        " coordinatorEpoch: " END-TXN-MARKER-COORDINATOR-EPOCH.

PRINT-SNAPSHOT-HEADER-DETAILS.
    DISPLAY " SnapshotHeader " SNAPSHOT-HEADER-JSON.

PRINT-SNAPSHOT-FOOTER-DETAILS.
    DISPLAY " SnapshotFooter " SNAPSHOT-FOOTER-JSON.

PRINT-KRAFT-VERSION-DETAILS.
    DISPLAY " KRaftVersion " KRAFT-VERSION-JSON.

PRINT-KRAFT-VOTERS-DETAILS.
    DISPLAY " KRaftVoters " KRAFT-VOTERS-JSON.

CLOSE-FILE-RECORDS.
    * Close file records

DUMP-INDEX.
    PERFORM EXTRACT-START-OFFSET.
    PERFORM OPEN-INDEX-FILE.
    PERFORM PROCESS-INDEX-ENTRIES.
    PERFORM CLOSE-INDEX-FILE.

EXTRACT-START-OFFSET.
    UNSTRING WS-FILE-NAME DELIMITED BY "." INTO WS-START-OFFSET.

OPEN-INDEX-FILE.
    * Open index file

PROCESS-INDEX-ENTRIES.
    PERFORM VARYING IDX FROM 1 BY 1 UNTIL IDX > NUM-INDEX-ENTRIES
        PERFORM PRINT-INDEX-ENTRY
        PERFORM CHECK-INDEX-ENTRY-MISMATCH
    END-PERFORM.

PRINT-INDEX-ENTRY.
    DISPLAY "offset: " INDEX-ENTRY-OFFSET " position: " INDEX-ENTRY-POSITION.

CHECK-INDEX-ENTRY-MISMATCH.
    PERFORM OPEN-LOG-FILE.
    PERFORM READ-LOG-RECORD.
    IF INDEX-ENTRY-OFFSET <> FIRST-RECORD-OFFSET
        PERFORM RECORD-INDEX-MISMATCH.
    PERFORM CLOSE-LOG-FILE.

OPEN-LOG-FILE.
    * Open log file

READ-LOG-RECORD.
    * Read first record from log file

RECORD-INDEX-MISMATCH.
    PERFORM GET-OR-CREATE-MISMATCH-LIST.
    MOVE INDEX-ENTRY-OFFSET TO WS-MISMATCH-FOR-INDEX-FILES-MAP-OFFSET(WS-MISMATCH-FOR-INDEX-FILES-MAP-COUNT).
    MOVE FIRST-RECORD-OFFSET TO WS-MISMATCH-FOR-INDEX-FILES-MAP-LOG-OFFSET(WS-MISMATCH-FOR-INDEX-FILES-MAP-COUNT).
    ADD 1 TO WS-MISMATCH-FOR-INDEX-FILES-MAP-COUNT.

GET-OR-CREATE-MISMATCH-LIST.
    SEARCH WS-MISMATCH-FOR-INDEX-FILES-MAP-ITEM
        WHEN WS-FILE-NAME = WS-MISMATCH-FOR-INDEX-FILES-MAP-FILE-NAME(IDX)
            CONTINUE
        WHEN OTHER
            MOVE WS-FILE-NAME TO WS-MISMATCH-FOR-INDEX-FILES-MAP-FILE-NAME(WS-MISMATCH-FOR-INDEX-FILES-MAP-COUNT)
            MOVE 1 TO WS-MISMATCH-FOR-INDEX-FILES-MAP-COUNT
    END-SEARCH.

CLOSE-INDEX-FILE.
    * Close index file

CLOSE-LOG-FILE.
    * Close log file

DUMP-TIME-INDEX.
    PERFORM EXTRACT-START-OFFSET.
    PERFORM OPEN-TIME-INDEX-FILE.
    PERFORM PROCESS-TIME-INDEX-ENTRIES.
    PERFORM CLOSE-TIME-INDEX-FILE.

EXTRACT-START-OFFSET.
    UNSTRING WS-FILE-NAME DELIMITED BY "." INTO WS-START-OFFSET.

OPEN-TIME-INDEX-FILE.
    * Open time index file

PROCESS-TIME-INDEX-ENTRIES.
    PERFORM VARYING IDX FROM 1 BY 1 UNTIL IDX > NUM-TIME-INDEX-ENTRIES
        PERFORM PRINT-TIME-INDEX-ENTRY
        PERFORM CHECK-TIME-INDEX-ENTRY
    END-PERFORM.

PRINT-TIME-INDEX-ENTRY.
    DISPLAY "timestamp: " TIME-INDEX-ENTRY-TIMESTAMP " offset: " TIME-INDEX-ENTRY-OFFSET.

CHECK-TIME-INDEX-ENTRY.
    PERFORM OPEN-LOG-FILE.
    PERFORM FIND-LOG-RECORD-BY-OFFSET.
    IF TIME-INDEX-ENTRY-OFFSET <> LOG-RECORD-OFFSET
        PERFORM RECORD-TIME-INDEX-MISMATCH.
    PERFORM CLOSE-LOG-FILE.

FIND-LOG-RECORD-BY-OFFSET.
    * Find log record by offset

RECORD-TIME-INDEX-MISMATCH.
    PERFORM GET-OR-CREATE-TIME-INDEX-MISMATCH-LIST.
    MOVE TIME-INDEX-ENTRY-TIMESTAMP TO WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-TIMESTAMP(WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-COUNT).
    MOVE LOG-RECORD-TIMESTAMP TO WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-LOG-TIMESTAMP(WS-TIME-INDEX-MISMATCH-FOR-FILES-MAP-COUNT).
    ADD 1 TO WS-TIME-INDEX