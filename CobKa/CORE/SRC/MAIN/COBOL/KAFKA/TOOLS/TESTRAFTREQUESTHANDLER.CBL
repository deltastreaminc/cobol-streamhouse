IDENTIFICATION DIVISION.
PROGRAM-ID. TEST-RAFT-REQUEST-HANDLER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
    REPOSITORY.
        FUNCTION ALL INTRINSIC FUNCTIONS.

DATA DIVISION.
WORKING-STORAGE SECTION.
    01 WS-RAFT-MANAGER PIC X(10).
    01 WS-REQUEST-CHANNEL PIC X(10).
    01 WS-TIME PIC X(10).
    01 WS-API-VERSION-MANAGER PIC X(15).

PROCEDURE DIVISION USING WS-RAFT-MANAGER, WS-REQUEST-CHANNEL, WS-TIME, WS-API-VERSION-MANAGER.
    PERFORM HANDLE-REQUEST.
    STOP RUN.

HANDLE-REQUEST.
    PERFORM VARYING REQUEST-KEY FROM 1 BY 1 UNTIL REQUEST-KEY > 6
        EVALUATE REQUEST-KEY
            WHEN 1 PERFORM HANDLE-API-VERSIONS
            WHEN 2 PERFORM HANDLE-VOTE
            WHEN 3 PERFORM HANDLE-BEGIN-QUORUM-EPOCH
            WHEN 4 PERFORM HANDLE-END-QUORUM-EPOCH
            WHEN 5 PERFORM HANDLE-FETCH
            WHEN 6 PERFORM HANDLE-FETCH-SNAPSHOT
            WHEN OTHER RAISE ILLEGAL-ARGUMENT-EXCEPTION
        END-EVALUATE
    END-PERFORM.

HANDLE-API-VERSIONS.
    MOVE FUNCTION API-VERSION-RESPONSE(0, REQUEST-HEADER-API-VERSION) TO RESPONSE.
    PERFORM SEND-RESPONSE.

HANDLE-VOTE.
    PERFORM HANDLE-REQUEST-BODY USING VOTE-RESPONSE-DATA.

HANDLE-BEGIN-QUORUM-EPOCH.
    PERFORM HANDLE-REQUEST-BODY USING BEGIN-QUORUM-EPOCH-RESPONSE-DATA.

HANDLE-END-QUORUM-EPOCH.
    PERFORM HANDLE-REQUEST-BODY USING END-QUORUM-EPOCH-RESPONSE-DATA.

HANDLE-FETCH.
    PERFORM HANDLE-REQUEST-BODY USING FETCH-RESPONSE-DATA.

HANDLE-FETCH-SNAPSHOT.
    PERFORM HANDLE-REQUEST-BODY USING FETCH-SNAPSHOT-RESPONSE-DATA.

HANDLE-REQUEST-BODY.
    MOVE REQUEST-BODY TO WS-REQUEST-BODY.
    PERFORM RAFT-MANAGER-HANDLE-REQUEST.
    PERFORM SEND-RESPONSE.

RAFT-MANAGER-HANDLE-REQUEST.
    CALL "RAFT-MANAGER-HANDLE-REQUEST" USING REQUEST-CONTEXT, REQUEST-HEADER, WS-REQUEST-BODY, CURRENT-TIME GIVING RESPONSE.
    IF EXCEPTION-OCCURRED
        MOVE FUNCTION ERROR-RESPONSE(WS-REQUEST-BODY) TO RESPONSE
    END-IF.

SEND-RESPONSE.
    CALL "SEND-RESPONSE" USING REQUEST, RESPONSE, NULL.

ILLEGAL-ARGUMENT-EXCEPTION.
    RAISE EXCEPTION "UNSUPPORTED-API-KEY".

END PROGRAM TEST-RAFT-REQUEST-HANDLER.