IDENTIFICATION DIVISION.
PROGRAM-ID. TEST-RAFT-SERVER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-PARTITION.
   05 WS-TOPIC-NAME      PIC X(28) VALUE "__raft_performance_test".
   05 WS-PARTITION-NUM   PIC 9(1) VALUE 0.
01 WS-TOPIC-ID.
   05 WS-TOPIC-ID-PART1  PIC 9(18) VALUE 0.
   05 WS-TOPIC-ID-PART2  PIC 9(18) VALUE 2.
01 WS-RECORD-SIZE       PIC 9(9) VALUE 256.
01 WS-THROUGHPUT        PIC 9(9) VALUE 5000.
01 WS-SHUTDOWN-LATCH    PIC 9(9) VALUE 1.
01 WS-THREAD-NAME-PREFIX PIC X(16) VALUE "test-raft".

01 WS-SOCKET-SERVER     PIC X(01) VALUE "X".
01 WS-CREDENTIAL-PROVIDER PIC X(01) VALUE "X".
01 WS-TOKEN-CACHE       PIC X(01) VALUE "X".
01 WS-REQUEST-HANDLER-POOL PIC X(01) VALUE "X".
01 WS-WORKLOAD-GENERATOR PIC X(01) VALUE "X".
01 WS-RAFT-MANAGER      PIC X(01) VALUE "X".

PROCEDURE DIVISION.
MAIN-PROCEDURE.
    PERFORM STARTUP-PROCEDURE.
    PERFORM SHUTDOWN-PROCEDURE.
    PERFORM AWAIT-SHUTDOWN.
    STOP RUN.

STARTUP-PROCEDURE.
    MOVE NEW DELEGATION-TOKEN-CACHE TO WS-TOKEN-CACHE.
    MOVE NEW CREDENTIAL-PROVIDER TO WS-CREDENTIAL-PROVIDER.

    MOVE NEW SIMPLE-API-VERSION-MANAGER TO WS-API-VERSION-MANAGER.
    MOVE NEW SOCKET-SERVER TO WS-SOCKET-SERVER.

    MOVE NEW KAFKA-RAFT-MANAGER TO WS-RAFT-MANAGER.
    MOVE NEW RAFT-WORKLOAD-GENERATOR TO WS-WORKLOAD-GENERATOR.
    MOVE NEW TEST-RAFT-REQUEST-HANDLER TO WS-REQUEST-HANDLER-POOL.

    CALL "WS-WORKLOAD-GENERATOR" USING "START".
    CALL "WS-RAFT-MANAGER" USING "STARTUP".
    CALL "WS-SOCKET-SERVER" USING "ENABLE-REQUEST-PROCESSING".

SHUTDOWN-PROCEDURE.
    IF WS-RAFT-MANAGER NOT EQUAL SPACE
        CALL "WS-RAFT-MANAGER" USING "SHUTDOWN".
    IF WS-WORKLOAD-GENERATOR NOT EQUAL SPACE 
        CALL "WS-WORKLOAD-GENERATOR" USING "SHUTDOWN".
    IF WS-REQUEST-HANDLER-POOL NOT EQUAL SPACE
        CALL "WS-REQUEST-HANDLER-POOL" USING "SHUTDOWN".
    IF WS-SOCKET-SERVER NOT EQUAL SPACE
        CALL "WS-SOCKET-SERVER" USING "SHUTDOWN".
    CALL "UTILS" USING "CLOSE-QUIETLY" USING WS-METRICS.
    SUBTRACT 1 FROM WS-SHUTDOWN-LATCH.

AWAIT-SHUTDOWN.
    WAIT FOR WS-SHUTDOWN-LATCH EQUALS 0.

COPY "BYTE-ARRAY-SERDE".
COPY "PENDING-APPEND".
COPY "LATENCY-HISTOGRAM".
COPY "THROUGHPUT-METER".
COPY "THROUGHPUT-THROTTLER".
COPY "WRITE-STATS".
COPY "TEST-RAFT-REQUEST-HANDLER".