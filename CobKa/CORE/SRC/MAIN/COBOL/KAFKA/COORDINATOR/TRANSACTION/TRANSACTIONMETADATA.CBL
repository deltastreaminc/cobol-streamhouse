IDENTIFICATION DIVISION.
PROGRAM-ID. TRANSACTION-METADATA.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL-STATES IS TransactionState.
    FUNCTION FROM-NAME IS TransactionState.fromName.
    FUNCTION FROM-ID IS TransactionState.fromId.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 TRANSACTION-STATE.
   05 FILLER REDEFINES TRANSACTION-STATE.
      10 ID PIC X.
      10 NAME PIC X(20).
      10 VALID-PREVIOUS-STATES PIC X(200).
      10 EXPIRATION-ALLOWED PIC X.
01 TXN-TRANSIT-METADATA.
   05 PRODUCER-ID PIC 9(18).
   05 PREV-PRODUCER-ID PIC 9(18).
   05 NEXT-PRODUCER-ID PIC 9(18).
   05 PRODUCER-EPOCH PIC 9(4).
   05 LAST-PRODUCER-EPOCH PIC 9(4).
   05 TXN-TIMEOUT-MS PIC 9(9).
   05 TXN-STATE PIC X(20).
   05 TOPIC-PARTITIONS PIC X(200).
   05 TXN-START-TIMESTAMP PIC 9(18).
   05 TXN-LAST-UPDATE-TIMESTAMP PIC 9(18).
   05 CLIENT-TXN-VERSION PIC 9(9).
01 TRANSACTION-METADATA.
   05 TRANSACTIONAL-ID PIC X(50).
   05 PRODUCER-ID PIC 9(18).
   05 PREV-PRODUCER-ID PIC 9(18).
   05 NEXT-PRODUCER-ID PIC 9(18).
   05 PRODUCER-EPOCH PIC 9(4).
   05 LAST-PRODUCER-EPOCH PIC 9(4).
   05 TXN-TIMEOUT-MS PIC 9(9).
   05 TXN-STATE PIC X(20).
   05 PENDING-STATE PIC X(20).
   05 HAS-FAILED-EPOCH-FENCE PIC X.
   05 TOPIC-PARTITIONS PIC X(200).
   05 TXN-START-TIMESTAMP PIC 9(18).
   05 TXN-LAST-UPDATE-TIMESTAMP PIC 9(18).
   05 CLIENT-TXN-VERSION PIC 9(9).

PROCEDURE DIVISION.

    INITIALIZE-METADATA.
        MOVE 0 TO ID OF TRANSACTION-STATE.
        MOVE "Empty" TO NAME OF TRANSACTION-STATE.
        MOVE "Empty CompleteCommit CompleteAbort" TO VALID-PREVIOUS-STATES OF TRANSACTION-STATE.
        MOVE "Y" TO EXPIRATION-ALLOWED OF TRANSACTION-STATE.

        MOVE 1 TO ID OF TRANSACTION-STATE.
        MOVE "Ongoing" TO NAME OF TRANSACTION-STATE.
        MOVE "Ongoing Empty CompleteCommit CompleteAbort" TO VALID-PREVIOUS-STATES OF TRANSACTION-STATE.

        MOVE 2 TO ID OF TRANSACTION-STATE.
        MOVE "PrepareCommit" TO NAME OF TRANSACTION-STATE.
        MOVE "Ongoing" TO VALID-PREVIOUS-STATES OF TRANSACTION-STATE.

        MOVE 3 TO ID OF TRANSACTION-STATE.
        MOVE "PrepareAbort" TO NAME OF TRANSACTION-STATE.
        MOVE "Ongoing PrepareEpochFence Empty CompleteCommit CompleteAbort" TO VALID-PREVIOUS-STATES OF TRANSACTION-STATE.

        MOVE 4 TO ID OF TRANSACTION-STATE.
        MOVE "CompleteCommit" TO NAME OF TRANSACTION-STATE.
        MOVE "PrepareCommit" TO VALID-PREVIOUS-STATES OF TRANSACTION-STATE.
        MOVE "Y" TO EXPIRATION-ALLOWED OF TRANSACTION-STATE.

        MOVE 5 TO ID OF TRANSACTION-STATE.
        MOVE "CompleteAbort" TO NAME OF TRANSACTION-STATE.
        MOVE "PrepareAbort" TO VALID-PREVIOUS-STATES OF TRANSACTION-STATE.
        MOVE "Y" TO EXPIRATION-ALLOWED OF TRANSACTION-STATE.

        MOVE 6 TO ID OF TRANSACTION-STATE.
        MOVE "Dead" TO NAME OF TRANSACTION-STATE.
        MOVE "Empty CompleteAbort CompleteCommit" TO VALID-PREVIOUS-STATES OF TRANSACTION-STATE.

        MOVE 7 TO ID OF TRANSACTION-STATE.
        MOVE "PrepareEpochFence" TO NAME OF TRANSACTION-STATE.
        MOVE "Ongoing" TO VALID-PREVIOUS-STATES OF TRANSACTION-STATE.

    IS-EPOCH-EXHAUSTED.
        IF PRODUCER-EPOCH >= 32767 THEN
            RETURN TRUE
        ELSE
            RETURN FALSE.

    PREPARE-NO-TRANSIT.
        MOVE PRODUCER-ID TO PRODUCER-ID OF TXN-TRANSIT-METADATA.
        MOVE PREV-PRODUCER-ID TO PREV-PRODUCER-ID OF TXN-TRANSIT-METADATA.
        MOVE NEXT-PRODUCER-ID TO NEXT-PRODUCER-ID OF TXN-TRANSIT-METADATA.
        MOVE PRODUCER-EPOCH TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA.
        MOVE LAST-PRODUCER-EPOCH TO LAST-PRODUCER-EPOCH OF TXN-TRANSIT-METADATA.
        MOVE TXN-TIMEOUT-MS TO TXN-TIMEOUT-MS OF TXN-TRANSIT-METADATA.
        MOVE TXN-STATE TO TXN-STATE OF TXN-TRANSIT-METADATA.
        MOVE TOPIC-PARTITIONS TO TOPIC-PARTITIONS OF TXN-TRANSIT-METADATA.
        MOVE TXN-START-TIMESTAMP TO TXN-START-TIMESTAMP OF TXN-TRANSIT-METADATA.
        MOVE TXN-LAST-UPDATE-TIMESTAMP TO TXN-LAST-UPDATE-TIMESTAMP OF TXN-TRANSIT-METADATA.
        MOVE CLIENT-TXN-VERSION TO CLIENT-TXN-VERSION OF TXN-TRANSIT-METADATA.
        RETURN TXN-TRANSIT-METADATA.

    PREPARE-FENCE-PRODUCER-EPOCH.
        IF PRODUCER-EPOCH = 32767 THEN
            THROW EXCEPTION "Cannot fence producer with epoch equal to Short.MaxValue".

        IF HAS-FAILED-EPOCH-FENCE = "Y" THEN
            MOVE PRODUCER-EPOCH TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA
        ELSE
            MOVE (PRODUCER-EPOCH + 1) TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA.

        MOVE "PrepareEpochFence" TO TXN-STATE OF TXN-TRANSIT-METADATA.
        MOVE BINARY-ZEROS TO LAST-PRODUCER-EPOCH OF TXN-TRANSIT-METADATA.
        RETURN TXN-TRANSIT-METADATA.

    PREPARE-INCREMENT-PRODUCER-EPOCH.
        IF IS-EPOCH-EXHAUSTED
            THROW EXCEPTION "Cannot allocate any more producer epochs for producerId ".

        MOVE (PRODUCER-EPOCH + 1) TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA.

        IF EXPECTED-PRODUCER-EPOCH IS NOT SUPPLIED THEN
            MOVE PRODUCER-EPOCH OF TXN-TRANSIT-METADATA TO LAST-PRODUCER-EPOCH OF TXN-TRANSIT-METADATA
        ELSE IF EXPECTED-PRODUCER-EPOCH = PRODUCER-EPOCH OR PRODUCER-EPOCH = BINARY-ZEROS THEN
            MOVE PRODUCER-EPOCH OF TXN-TRANSIT-METADATA TO LAST-PRODUCER-EPOCH OF TXN-TRANSIT-METADATA
        ELSE IF EXPECTED-PRODUCER-EPOCH = LAST-PRODUCER-EPOCH THEN
            MOVE PRODUCER-EPOCH TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA
        ELSE
            RETURN PRODUCER-FENCED-ERROR.

        MOVE "Empty" TO TXN-STATE OF TXN-TRANSIT-METADATA.
        MOVE NEW-TXN-TIMEOUT-MS TO TXN-TIMEOUT-MS OF TXN-TRANSIT-METADATA.
        MOVE BINARY-ZEROS TO TOPIC-PARTITIONS OF TXN-TRANSIT-METADATA.
        MOVE BINARY-ZEROS TO TXN-START-TIMESTAMP OF TXN-TRANSIT-METADATA.
        MOVE UPDATE-TIMESTAMP TO TXN-LAST-UPDATE-TIMESTAMP OF TXN-TRANSIT-METADATA.
        RETURN TXN-TRANSIT-METADATA.

    PREPARE-PRODUCER-ID-ROTATION.
        IF PENDING-STATE IS NOT BINARY-ZEROS THEN
            THROW EXCEPTION "Cannot rotate producer ids while a transaction is still pending".

        MOVE NEW-PRODUCER-ID TO PRODUCER-ID OF TXN-TRANSIT-METADATA.
        MOVE 0 TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA.
        IF RECORD-LAST-EPOCH THEN
            MOVE PRODUCER-EPOCH TO LAST-PRODUCER-EPOCH OF TXN-TRANSIT-METADATA
        ELSE
            MOVE BINARY-ZEROS TO LAST-PRODUCER-EPOCH OF TXN-TRANSIT-METADATA.
        MOVE NEW-TXN-TIMEOUT-MS TO TXN-TIMEOUT-MS OF TXN-TRANSIT-METADATA.
        MOVE BINARY-ZEROS TO TOPIC-PARTITIONS OF TXN-TRANSIT-METADATA.
        MOVE BINARY-ZEROS TO TXN-START-TIMESTAMP OF TXN-TRANSIT-METADATA.
        MOVE UPDATE-TIMESTAMP TO TXN-LAST-UPDATE-TIMESTAMP OF TXN-TRANSIT-METADATA.
        RETURN TXN-TRANSIT-METADATA.

    PREPARE-ADD-PARTITIONS.
        EVALUATE TXN-STATE
            WHEN "Empty" OR "CompleteAbort" OR "CompleteCommit"
                MOVE UPDATE-TIMESTAMP TO TXN-START-TIMESTAMP OF TXN-TRANSIT-METADATA
            WHEN OTHER
                MOVE TXN-START-TIMESTAMP TO TXN-START-TIMESTAMP OF TXN-TRANSIT-METADATA.

        MOVE "Ongoing" TO TXN-STATE OF TXN-TRANSIT-METADATA.
        MOVE (TOPIC-PARTITIONS + ADDED-TOPIC-PARTITIONS) TO TOPIC-PARTITIONS OF TXN-TRANSIT-METADATA.
        MOVE UPDATE-TIMESTAMP TO TXN-LAST-UPDATE-TIMESTAMP OF TXN-TRANSIT-METADATA.
        MOVE CLIENT-TXN-VERSION TO CLIENT-TXN-VERSION OF TXN-TRANSIT-METADATA.
        RETURN TXN-TRANSIT-METADATA.

    PREPARE-ABORT-OR-COMMIT.
        IF CLIENT-TXN-VERSION.SUPPORTS-EPOCH-BUMP THEN
            MOVE (PRODUCER-EPOCH + 1) TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA
            MOVE PRODUCER-EPOCH TO LAST-PRODUCER-EPOCH OF TXN-TRANSIT-METADATA
        ELSE
            MOVE PRODUCER-EPOCH TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA
            MOVE LAST-PRODUCER-EPOCH TO LAST-PRODUCER-EPOCH OF TXN-TRANSIT-METADATA.

        IF NO-PARTITION-ADDED THEN
            MOVE UPDATE-TIMESTAMP TO TXN-START-TIMESTAMP OF TXN-TRANSIT-METADATA
        ELSE
            MOVE TXN-START-TIMESTAMP TO TXN-START-TIMESTAMP OF TXN-TRANSIT-METADATA.

        MOVE NEW-STATE TO TXN-STATE OF TXN-TRANSIT-METADATA.
        MOVE NEXT-PRODUCER-ID TO NEXT-PRODUCER-ID OF TXN-TRANSIT-METADATA.
        MOVE UPDATE-TIMESTAMP TO TXN-LAST-UPDATE-TIMESTAMP OF TXN-TRANSIT-METADATA.
        MOVE CLIENT-TXN-VERSION TO CLIENT-TXN-VERSION OF TXN-TRANSIT-METADATA.
        RETURN TXN-TRANSIT-METADATA.

    PREPARE-COMPLETE.
        IF TXN-STATE = "PrepareCommit" THEN
            MOVE "CompleteCommit" TO TXN-STATE OF TXN-TRANSIT-METADATA
        ELSE
            MOVE "CompleteAbort" TO TXN-STATE OF TXN-TRANSIT-METADATA.

        MOVE "N" TO HAS-FAILED-EPOCH-FENCE.

        IF CLIENT-TXN-VERSION.SUPPORTS-EPOCH-BUMP AND NEXT-PRODUCER-ID <> BINARY-ZEROS THEN
            MOVE NEXT-PRODUCER-ID TO PRODUCER-ID OF TXN-TRANSIT-METADATA
            MOVE 0 TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA
        ELSE
            MOVE PRODUCER-ID TO PRODUCER-ID OF TXN-TRANSIT-METADATA
            MOVE PRODUCER-EPOCH TO PRODUCER-EPOCH OF TXN-TRANSIT-METADATA.

        MOVE BINARY-ZEROS TO NEXT-PRODUCER-ID OF TXN-TRANSIT-METADATA.
        MOVE BINARY-ZEROS TO TOPIC-PARTITIONS OF TXN-TRANSIT-METADATA.
        MOVE UPDATE-TIMESTAMP TO TXN-LAST-UPDATE-TIMESTAMP OF TXN-TRANSIT-METADATA.
        RETURN TXN-TRANSIT-METADATA.

    PREPARE-DEAD.
        MOVE "Dead" TO TXN-STATE OF TXN-TRANSIT-METADATA.
        MOVE BINARY-ZEROS TO TOPIC-PARTITIONS OF TXN-TRANSIT-METADATA.
        RETURN TXN-TRANSIT-METADATA.

    COMPLETE-TRANSITION-TO.
        EVALUATE PENDING-STATE
            WHEN BINARY-ZEROS
                THROW EXCEPTION "TransactionalId has no pending state".
            WHEN TXN-STATE OF TXN-TRANSIT-METADATA
                CONTINUE
            WHEN OTHER
                THROW EXCEPTION "Transition to " TXN-STATE OF TXN-TRANSIT-METADATA " is not valid".

        EVALUATE TXN-STATE OF TXN-TRANSIT-METADATA
            WHEN "Empty"
                IF (PRODUCER-EPOCH <> PRODUCER-EPOCH OF TXN-TRANSIT-METADATA AND NOT VALID-PRODUCER-EPOCH-BUMP(TXN-TRANSIT-METADATA)) OR
                   TOPIC-PARTITIONS OF TXN-TRANSIT-METADATA IS NOT BINARY-ZEROS OR
                   TXN-START-TIMESTAMP OF TXN-TRANSIT-METADATA <> -1 THEN
                    THROW EXCEPTION "Transition to " TXN-TRANSIT-METADATA " is not valid"
            WHEN "Ongoing"
                IF NOT VALID-PRODUCER-EPOCH(TXN-TRANSIT-METADATA) OR
                   NOT TOPIC-PARTITIONS INCLUDES TOPIC-PARTITIONS OF TXN-TRANSIT-METADATA OR
                   TXN-TIMEOUT-MS <> TXN-TIMEOUT-MS OF TXN-TRANSIT-METADATA THEN
                    THROW EXCEPTION "Transition to " TXN-TRANSIT-METADATA " is not valid"
            WHEN "PrepareAbort" OR "PrepareCommit"
                IF NOT VALID-PRODUCER-EPOCH(TXN-TRANSIT-METADATA) OR
                   TOPIC-PARTITIONS <> TOPIC-PARTITIONS OF TXN-TRANSIT-METADATA OR
                   TXN-TIMEOUT-MS <> TXN-TIMEOUT-MS OF TXN-TRANSIT-METADATA OR
                   (TXN-START-TIMESTAMP <> TXN-START-TIMESTAMP OF TXN-TRANSIT-METADATA AND
                    NOT (PENDING-STATE = "PrepareAbort" AND CLIENT-TXN-VERSION.SUPPORTS-EPOCH-BUMP AND
                        (TXN-STATE = "Empty" OR TXN-STATE = "Compl