IDENTIFICATION DIVISION.
PROGRAM-ID. TRANSACTION-MARKER-CHANNEL-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
SPECIAL-NAMES.
    LINKAGE TYPE IS OBJECT.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 CONFIG PIC X(10).
01 METRICS PIC X(10).
01 METADATA-CACHE PIC X(10).
01 TXN-STATE-MANAGER PIC X(10).
01 TIME PIC X(10).
01 LOGCONTEXT PIC X(10).

01 INTER-BROKER-LISTENER-NAME PIC X(20).

01 MARKERS-QUEUE-PER-BROKER PIC X(20).
01 MARKERS-QUEUE-FOR-UNKNOWN-BROKER PIC X(20).
01 TXN-LOG-APPEND-RETRY-QUEUE PIC X(20).
01 TRANSACTIONS-WITH-PENDING-MARKERS PIC X(20).

01 METRICS-GROUP PIC X(10).
01 LOG-IDENT PIC X(30).

01 PENDING-COMPLETE-TXN.
   05 TRANSACTIONAL-ID PIC X(30).
   05 COORDINATOR-EPOCH PIC 9(9).
   05 TXN-METADATA PIC X(20).
   05 NEW-METADATA PIC X(20).

01 PENDING-COMPLETE-TXN-AND-MARKER-ENTRY.
   05 PENDING-COMPLETE-TXN PIC X(20).
   05 TXN-MARKER-ENTRY PIC X(20).

PROCEDURE DIVISION.

    IDENTIFICATION DIVISION.
    PROGRAM-ID. TRANSACTION-MARKER-CHANNEL-MANAGER.

    ENVIRONMENT DIVISION.
    CONFIGURATION SECTION.
    SPECIAL-NAMES.
        LINKAGE TYPE IS OBJECT.

    DATA DIVISION.
    WORKING-STORAGE SECTION.
    01 CONFIG PIC X(10).
    01 METRICS PIC X(10).
    01 METADATA-CACHE PIC X(10).
    01 TXN-STATE-MANAGER PIC X(10).
    01 TIME PIC X(10).
    01 LOGCONTEXT PIC X(10).

    01 INTER-BROKER-LISTENER-NAME PIC X(20).

    01 MARKERS-QUEUE-PER-BROKER PIC X(20).
    01 MARKERS-QUEUE-FOR-UNKNOWN-BROKER PIC X(20).
    01 TXN-LOG-APPEND-RETRY-QUEUE PIC X(20).
    01 TRANSACTIONS-WITH-PENDING-MARKERS PIC X(20).

    01 METRICS-GROUP PIC X(10).
    01 LOG-IDENT PIC X(30).

    01 PENDING-COMPLETE-TXN.
       05 TRANSACTIONAL-ID PIC X(30).
       05 COORDINATOR-EPOCH PIC 9(9).
       05 TXN-METADATA PIC X(20).
       05 NEW-METADATA PIC X(20).

    01 PENDING-COMPLETE-TXN-AND-MARKER-ENTRY.
       05 PENDING-COMPLETE-TXN PIC X(20).
       05 TXN-MARKER-ENTRY PIC X(20).

    PROCEDURE DIVISION.
        CALL "SHUTDOWN" USING SELF.
        CALL "REMOVE-METRICS" USING SELF.
        CALL "QUEUE-FOR-BROKER" USING SELF, BROKEID.
        CALL "QUEUE-FOR-UNKNOWN-BROKER" USING SELF.
        CALL "ADD-MARKERS-FOR-BROKER" USING SELF, BROKER, TXNTOPICPARTITION, PENDING-COMPLETE-TXN-AND-MARKER.
        CALL "RETRY-LOG-APPENDS" USING SELF.
        CALL "GENERATE-REQUESTS" USING SELF.
        CALL "WRITE-TXN-COMPLETION" USING SELF, PENDING-COMPLETE-TXN.
        CALL "ADD-TXN-MARKERS-TO-SEND" USING SELF, COORDINATOR-EPOCH, TXN-RESULT, TXN-METADATA, NEW-METADATA.
        CALL "MAYBE-WRITE-TXN-COMPLETION" USING SELF, TRANSACTIONAL-ID.
        CALL "TRY-APPEND-TO-LOG" USING SELF, TXN-LOG-APPEND.
        CALL "ADD-TXN-MARKERS-TO-BROKER-QUEUE" USING SELF, PRODUCER-ID, PRODUCER-EPOCH, TXN-RESULT, PENDING-COMPLETE-TXN, TOPIC-PARTITIONS.
        CALL "REMOVE-MARKERS-FOR-TXN-TOPIC-PARTITION" USING SELF, TXNTOPIC-PARTITION-ID.
        CALL "REMOVE-MARKERS-FOR-TXN" USING SELF, PENDING-COMPLETE-TXN.

    STOP RUN.