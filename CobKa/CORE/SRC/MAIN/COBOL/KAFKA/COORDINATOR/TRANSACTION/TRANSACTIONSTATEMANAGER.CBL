IDENTIFICATION DIVISION.
PROGRAM-ID. TRANSACTION-STATE-MANAGER.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION 'SQRT' IS INTRINSIC.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 SHUTTING-DOWN PIC X(1) VALUE 'N'.
01 STATE-LOCK.
    05 READ-LOCK REDEFINES STATE-LOCK.
    05 WRITE-LOCK REDEFINES STATE-LOCK.
01 LOADING-PARTITIONS.
    05 LOADING-PARTITION OCCURS 1 TO 9999 TIMES DEPENDING ON WS-LOADING-PARTITION-COUNT.
        10 TXN-PARTITION-ID PIC 9(9).
        10 COORDINATOR-EPOCH PIC 9(9).
01 WS-LOADING-PARTITION-COUNT PIC 9(9) USAGE COMP.
01 TRANSACTION-METADATA-CACHE.
    05 CACHE-ENTRY OCCURS 1 TO 9999 TIMES DEPENDING ON WS-CACHE-ENTRY-COUNT.
        10 COORDINATOR-EPOCH PIC 9(9).
        10 METADATA-PER-TRANSACTIONAL-ID.
            15 TRANSACTIONAL-ID PIC X(128).
            15 TRANSACTION-METADATA.
                20 TRANSACTIONAL-ID PIC X(128).
                20 PRODUCER-ID PIC 9(18).
                20 PRODUCER-EPOCH PIC 9(4).
                20 TXN-START-TIMESTAMP PIC 9(18).
                20 TXN-TIMEOUT-MS PIC 9(9).
                20 TXN-LAST-UPDATE-TIMESTAMP PIC 9(18).
                20 STATE PIC X(32).
                20 PENDING-STATE PIC X(32).
                20 PENDING-TRANSITION-IN-PROGRESS PIC X(1).
01 WS-CACHE-ENTRY-COUNT PIC 9(9) USAGE COMP.
01 RETRIEVE-TRANSACTION-TOPIC-PARTITION-COUNT PIC 9(9) USAGE COMP.
01 TRANSACTION-TOPIC-PARTITION-COUNT PIC 9(9) USAGE COMP.
01 PARTITION-LOAD-SENSOR.
    05 PARTITION-LOAD-TIME-MAX PIC 9(9)V9(6).
    05 PARTITION-LOAD-TIME-AVG PIC 9(9)V9(6).
01 TRANSACTIONAL-ID-AND-PRODUCER-ID-EPOCH.
    05 TRANSACTIONAL-ID PIC X(128).
    05 PRODUCER-ID PIC 9(18).
    05 PRODUCER-EPOCH PIC 9(4).
01 TRANSACTION-PARTITION-AND-LEADER-EPOCH.
    05 TXN-PARTITION-ID PIC 9(9).
    05 COORDINATOR-EPOCH PIC 9(9).
01 TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.
    05 TRANSACTIONAL-ID PIC X(128).
    05 COORDINATOR-EPOCH PIC 9(9).
    05 TRANSIT-METADATA.
        10 TRANSACTIONAL-ID PIC X(128).
        10 PRODUCER-ID PIC 9(18).
        10 PRODUCER-EPOCH PIC 9(4).
        10 TXN-TIMEOUT-MS PIC 9(9).
        10 TXN-LAST-UPDATE-TIMESTAMP PIC 9(18).
        10 STATE PIC X(32).
01 TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-TRANSIT-METADATA.
    05 TRANSACTIONAL-ID PIC X(128).
    05 COORDINATOR-EPOCH PIC 9(9).
    05 RESULT PIC X(32).
    05 TXN-METADATA.
        10 TRANSACTIONAL-ID PIC X(128).
        10 PRODUCER-ID PIC 9(18).
        10 PRODUCER-EPOCH PIC 9(4).
        10 TXN-START-TIMESTAMP PIC 9(18).
        10 TXN-TIMEOUT-MS PIC 9(9).
        10 TXN-LAST-UPDATE-TIMESTAMP PIC 9(18).
        10 STATE PIC X(32).
        10 PENDING-STATE PIC X(32).
        10 PENDING-TRANSITION-IN-PROGRESS PIC X(1).
    05 TRANSIT-METADATA.
        10 TRANSACTIONAL-ID PIC X(128).
        10 PRODUCER-ID PIC 9(18).
        10 PRODUCER-EPOCH PIC 9(4).
        10 TXN-TIMEOUT-MS PIC 9(9).
        10 TXN-LAST-UPDATE-TIMESTAMP PIC 9(18).
        10 STATE PIC X(32).
01 TRANSACTION-CONFIG.
    05 TRANSACTIONAL-ID-EXPIRATION-MS PIC 9(9) VALUE 300000.
    05 TRANSACTION-MAX-TIMEOUT-MS PIC 9(9) VALUE 900000.
    05 TRANSACTION-LOG-NUM-PARTITIONS PIC 9(9) VALUE 50.
    05 TRANSACTION-LOG-REPLICATION-FACTOR PIC 9(4) VALUE 3.
    05 TRANSACTION-LOG-SEGMENT-BYTES PIC 9(9) VALUE 1073741824.
    05 TRANSACTION-LOG-LOAD-BUFFER-SIZE PIC 9(9) VALUE 4096.
    05 TRANSACTION-LOG-MIN-ISR PIC 9(9) VALUE 2.
    05 ABORT-TIMED-OUT-TRANSACTIONS-INTERVAL-MS PIC 9(9) VALUE 300000.
    05 REMOVE-EXPIRED-TRANSACTIONAL-ID-INTERVAL-MS PIC 9(9) VALUE 3600000.
    05 REQUEST-TIMEOUT-MS PIC 9(9) VALUE 30000.

PROCEDURE DIVISION.

MAIN-PROCEDURE.
    PERFORM INITIALIZE-TRANSACTION-STATE-MANAGER.
    PERFORM ENABLE-TRANSACTIONAL-ID-EXPIRATION.

    STOP RUN.

INITIALIZE-TRANSACTION-STATE-MANAGER.
    MOVE 'N' TO SHUTTING-DOWN.
    INITIALIZE LOADING-PARTITIONS.
    INITIALIZE TRANSACTION-METADATA-CACHE.
    MOVE FUNCTION SQRT(TRANSACTION-CONFIG.TRANSACTION-LOG-NUM-PARTITIONS) TO RETRIEVE-TRANSACTION-TOPIC-PARTITION-COUNT.
    MOVE RETRIEVE-TRANSACTION-TOPIC-PARTITION-COUNT TO TRANSACTION-TOPIC-PARTITION-COUNT.
    PERFORM INITIALIZE-PARTITION-LOAD-SENSOR.

ENABLE-TRANSACTIONAL-ID-EXPIRATION.
    PERFORM REMOVE-EXPIRED-TRANSACTIONAL-IDS.

REMOVE-EXPIRED-TRANSACTIONAL-IDS.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > WS-CACHE-ENTRY-COUNT
        PERFORM REMOVE-EXPIRED-TRANSACTIONAL-IDS-FOR-PARTITION
            USING CACHE-ENTRY(I).COORDINATOR-EPOCH
                  CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID
    END-PERFORM.

REMOVE-EXPIRED-TRANSACTIONAL-IDS-FOR-PARTITION.
    MOVE CURRENT-DATE TO WS-CURRENT-TIMESTAMP.
    PERFORM VARYING J FROM 1 BY 1 UNTIL J > 9999
        IF CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).PENDING-TRANSITION-IN-PROGRESS = 'N'
            AND CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).TXN-LAST-UPDATE-TIMESTAMP + TRANSACTION-CONFIG.TRANSACTIONAL-ID-EXPIRATION-MS < WS-CURRENT-TIMESTAMP
            MOVE CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).TRANSACTIONAL-ID TO TRANSACTIONAL-ID-AND-PRODUCER-ID-EPOCH.TRANSACTIONAL-ID
            MOVE CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).PRODUCER-ID TO TRANSACTIONAL-ID-AND-PRODUCER-ID-EPOCH.PRODUCER-ID
            MOVE CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).PRODUCER-EPOCH TO TRANSACTIONAL-ID-AND-PRODUCER-ID-EPOCH.PRODUCER-EPOCH
            PERFORM APPEND-TRANSACTIONAL-ID-EXPIRATION
        END-IF
    END-PERFORM.

APPEND-TRANSACTIONAL-ID-EXPIRATION.
    MOVE TRANSACTIONAL-ID-AND-PRODUCER-ID-EPOCH TO TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.
    MOVE 'DEAD' TO TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA.STATE.
    PERFORM APPEND-TRANSACTION-TO-LOG
        USING TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA
        CALLBACK PROCESS-APPEND-RESPONSE.

PROCESS-APPEND-RESPONSE.
    IF APPEND-RESPONSE-ERROR = ZERO
        PERFORM REMOVE-EXPIRED-TRANSACTIONAL-ID-FROM-CACHE
            USING TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA
    ELSE
        DISPLAY 'Failed to append transactional ID expiration: ' TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA
    END-IF.

REMOVE-EXPIRED-TRANSACTIONAL-ID-FROM-CACHE.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > WS-CACHE-ENTRY-COUNT
        PERFORM VARYING J FROM 1 BY 1 UNTIL J > 9999
            IF CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).TRANSACTIONAL-ID = TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSACTIONAL-ID
                AND CACHE-ENTRY(I).COORDINATOR-EPOCH = TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.COORDINATOR-EPOCH
                AND CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).PENDING-STATE = 'DEAD'
                AND CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).PRODUCER-EPOCH = TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA.PRODUCER-EPOCH
                AND APPEND-RESPONSE-ERROR = ZERO
                REMOVE CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J)
            ELSE
                DISPLAY 'Failed to remove expired transactional ID: ' CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).TRANSACTIONAL-ID
                MOVE CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).PENDING-STATE TO SPACES
            END-IF
        END-PERFORM
    END-PERFORM.

APPEND-TRANSACTION-TO-LOG.
    MOVE TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSACTIONAL-ID TO WS-TRANSACTIONAL-ID.
    MOVE TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.COORDINATOR-EPOCH TO WS-COORDINATOR-EPOCH.
    MOVE TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA TO WS-TRANSIT-METADATA.
    PERFORM GENERATE-TRANSACTION-LOG-RECORD.
    PERFORM APPEND-RECORDS-TO-TRANSACTION-LOG
        USING WS-TRANSACTION-LOG-RECORD
        CALLBACK PROCESS-APPEND-RESPONSE.

GENERATE-TRANSACTION-LOG-RECORD.
    MOVE WS-TRANSACTIONAL-ID TO TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA.TRANSACTIONAL-ID.
    MOVE WS-TRANSIT-METADATA.PRODUCER-ID TO TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA.PRODUCER-ID.
    MOVE WS-TRANSIT-METADATA.PRODUCER-EPOCH TO TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA.PRODUCER-EPOCH.
    MOVE WS-TRANSIT-METADATA.TXN-TIMEOUT-MS TO TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA.TXN-TIMEOUT-MS.
    MOVE WS-TRANSIT-METADATA.TXN-LAST-UPDATE-TIMESTAMP TO TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA.TXN-LAST-UPDATE-TIMESTAMP.
    MOVE WS-TRANSIT-METADATA.STATE TO TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA.STATE.
    MOVE TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSIT-METADATA TO WS-TRANSACTION-LOG-RECORD.

APPEND-RECORDS-TO-TRANSACTION-LOG.
    PERFORM GET-TRANSACTION-STATE
        USING WS-TRANSACTIONAL-ID
        INTO WS-COORDINATOR-EPOCH-AND-TRANSACTION-METADATA.
    IF WS-COORDINATOR-EPOCH-AND-TRANSACTION-METADATA.COORDINATOR-EPOCH = WS-COORDINATOR-EPOCH
        PERFORM APPEND-RECORDS
            USING WS-TRANSACTION-LOG-RECORD
            CALLBACK PROCESS-APPEND-RESPONSE
    ELSE
        MOVE ZERO TO APPEND-RESPONSE-ERROR
        PERFORM PROCESS-APPEND-RESPONSE
    END-IF.

GET-TRANSACTION-STATE.
    MOVE WS-TRANSACTIONAL-ID TO TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSACTIONAL-ID.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > WS-CACHE-ENTRY-COUNT
        IF CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(1).TRANSACTIONAL-ID = WS-TRANSACTIONAL-ID
            MOVE CACHE-ENTRY(I).COORDINATOR-EPOCH TO WS-COORDINATOR-EPOCH-AND-TRANSACTION-METADATA.COORDINATOR-EPOCH
            MOVE CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(1) TO WS-COORDINATOR-EPOCH-AND-TRANSACTION-METADATA.TRANSACTION-METADATA
            EXIT PARAGRAPH
        END-IF
    END-PERFORM.
    MOVE ZERO TO WS-COORDINATOR-EPOCH-AND-TRANSACTION-METADATA.COORDINATOR-EPOCH.
    MOVE SPACES TO WS-COORDINATOR-EPOCH-AND-TRANSACTION-METADATA.TRANSACTION-METADATA.

APPEND-RECORDS.
    CALL "REPLICA-MANAGER" USING APPEND-RECORDS
        GIVING APPEND-RESPONSE-ERROR.

PROCESS-APPEND-RESPONSE.
    PERFORM VARYING I FROM 1 BY 1 UNTIL I > WS-CACHE-ENTRY-COUNT
        PERFORM VARYING J FROM 1 BY 1 UNTIL J > 9999
            IF CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).TRANSACTIONAL-ID = TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.TRANSACTIONAL-ID
                AND CACHE-ENTRY(I).COORDINATOR-EPOCH = TRANSACTIONAL-ID-COORDINATOR-EPOCH-AND-METADATA.COORDINATOR-EPOCH
                AND CACHE-ENTRY(I).METADATA-PER-TRANSACTIONAL-ID(J).PENDING-STATE = 'DEAD'
                AND CACHE-ENTRY(I).