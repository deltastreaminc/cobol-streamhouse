IDENTIFICATION DIVISION.
PROGRAM-ID. KAFKA-COORDINATOR-GROUP.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 GROUP-STATE.
   05 PREPARING-REBALANCE.
      10 VALID-PREVIOUS-STATES.
         15 FILLER PIC X(7) VALUE 'STABLE'.
         15 FILLER PIC X(15) VALUE 'COMPLETINGREBALANCE'.
         15 FILLER PIC X(5) VALUE 'EMPTY'.
      10 TO-LOWER-CASE-STRING PIC X(16) VALUE 'preparingrebalance'.
   05 COMPLETING-REBALANCE.
      10 VALID-PREVIOUS-STATES.
         15 FILLER PIC X(16) VALUE 'PREPARINGREBALANCE'.
      10 TO-LOWER-CASE-STRING PIC X(16) VALUE 'completingrebalance'.
   05 STABLE.
      10 VALID-PREVIOUS-STATES.
         15 FILLER PIC X(16) VALUE 'COMPLETINGREBALANCE'.
      10 TO-LOWER-CASE-STRING PIC X(6) VALUE 'stable'.
   05 DEAD.
      10 VALID-PREVIOUS-STATES.
         15 FILLER PIC X(6) VALUE 'STABLE'.
         15 FILLER PIC X(16) VALUE 'PREPARINGREBALANCE'.
         15 FILLER PIC X(15) VALUE 'COMPLETINGREBALANCE'.
         15 FILLER PIC X(5) VALUE 'EMPTY'.
         15 FILLER PIC X(4) VALUE 'DEAD'.
      10 TO-LOWER-CASE-STRING PIC X(4) VALUE 'dead'.
   05 EMPTY.
      10 VALID-PREVIOUS-STATES.
         15 FILLER PIC X(16) VALUE 'PREPARINGREBALANCE'.
      10 TO-LOWER-CASE-STRING PIC X(5) VALUE 'empty'.

01 GROUP-METADATA.
   05 GROUP-ID PIC X(256).
   05 INITIAL-STATE PIC X POINTER.
   05 TIME PIC 9(18) BINARY-LONG.
   05 LOCK PIC X(1024).
   05 STATE PIC X.
   05 CURRENT-STATE-TIMESTAMP PIC 9(18) BINARY-LONG.
   05 PROTOCOL-TYPE PIC X(256).
   05 PROTOCOL-NAME PIC X(256).
   05 GENERATION-ID PIC 9(10) BINARY-LONG.
   05 LEADER-ID PIC X(256).
   05 MEMBERS.
      10 OCCURS 1 TO 9999 TIMES DEPENDING ON MEMBERS-COUNT.
         15 MEMBER-ID PIC X(256).
         15 GROUP-INSTANCE-ID PIC X(256).
         15 PROTOCOL-TYPE PIC X(256).
         15 SUPPORTED-PROTOCOLS.
            20 OCCURS 1 TO 9999 TIMES DEPENDING ON SUPPORTED-PROTOCOLS-COUNT.
               25 PROTOCOL PIC X(256).
               25 VOTES PIC 9(10) BINARY-LONG.
         15 REBALANCE-TIMEOUT-MS PIC 9(10) BINARY-LONG.
         15 SESSION-TIMEOUT-MS PIC 9(10) BINARY-LONG.
         15 AWAITING-JOIN-CALLBACK PIC X(1024).
   05 STATIC-MEMBERS.
      10 OCCURS 1 TO 9999 TIMES DEPENDING ON STATIC-MEMBERS-COUNT.
         15 GROUP-INSTANCE-ID PIC X(256).
         15 MEMBER-ID PIC X(256).
   05 PENDING-MEMBERS PIC X(256) OCCURS 1 TO 9999 TIMES DEPENDING ON PENDING-MEMBERS-COUNT.
   05 NUM-MEMBERS-AWAITING-JOIN PIC 9(10) BINARY-LONG.
   05 SUPPORTED-PROTOCOLS.
      10 OCCURS 1 TO 9999 TIMES DEPENDING ON SUPPORTED-PROTOCOLS-COUNT.
         15 PROTOCOL PIC X(256).
         15 VOTES PIC 9(10) BINARY-LONG.
   05 OFFSETS.
      10 OCCURS 1 TO 9999 TIMES DEPENDING ON OFFSETS-COUNT.
         15 TOPIC-PARTITION PIC X(256).
         15 COMMIT-RECORD-METADATA-AND-OFFSET.
            20 APPENDED-BATCH-OFFSET PIC 9(18) BINARY-LONG.
            20 OFFSET-AND-METADATA.
               25 OFFSET PIC 9(18) BINARY-LONG.
               25 METADATA PIC X(1024).
               25 EXPIRE-TIMESTAMP-MS PIC 9(18) BINARY-LONG.
               25 COMMIT-TIMESTAMP-MS PIC 9(18) BINARY-LONG.
   05 PENDING-OFFSET-COMMITS.
      10 OCCURS 1 TO 9999 TIMES DEPENDING ON PENDING-OFFSET-COMMITS-COUNT.
         15 TOPIC-PARTITION PIC X(256).
         15 OFFSET-AND-METADATA.
            20 OFFSET PIC 9(18) BINARY-LONG.
            20 METADATA PIC X(1024).
            20 EXPIRE-TIMESTAMP-MS PIC 9(18) BINARY-LONG.
            20 COMMIT-TIMESTAMP-MS PIC 9(18) BINARY-LONG.
   05 PENDING-TRANSACTIONAL-OFFSET-COMMITS.
      10 OCCURS 1 TO 9999 TIMES DEPENDING ON PENDING-TRANSACTIONAL-OFFSET-COMMITS-COUNT.
         15 PRODUCER-ID PIC 9(18) BINARY-LONG.
         15 OFFSETS.
            20 OCCURS 1 TO 9999 TIMES DEPENDING ON OFFSETS-COUNT.
               25 TOPIC-PARTITION PIC X(256).
               25 COMMIT-RECORD-METADATA-AND-OFFSET.
                  30 APPENDED-BATCH-OFFSET PIC 9(18) BINARY-LONG.
                  30 OFFSET-AND-METADATA.
                     35 OFFSET PIC 9(18) BINARY-LONG.
                     35 METADATA PIC X(1024).
                     35 EXPIRE-TIMESTAMP-MS PIC 9(18) BINARY-LONG.
                     35 COMMIT-TIMESTAMP-MS PIC 9(18) BINARY-LONG.
   05 RECEIVED-TRANSACTIONAL-OFFSET-COMMITS PIC X.
   05 RECEIVED-CONSUMER-OFFSET-COMMITS PIC X.
   05 PENDING-SYNC-MEMBERS PIC X(256) OCCURS 1 TO 9999 TIMES DEPENDING ON PENDING-SYNC-MEMBERS-COUNT.
   05 SUBSCRIBED-TOPICS.
      10 OCCURS 1 TO 9999 TIMES DEPENDING ON SUBSCRIBED-TOPICS-COUNT.
         15 TOPIC PIC X(256).
   05 NEW-MEMBER-ADDED PIC X.

PROCEDURE DIVISION.
    CALL "CoreUtils.inLock" USING LOCK, PROCEDURE-POINTER.
        IF CURRENT-STATE = PREPARING-REBALANCE
            CONTINUE
        ELSE IF CURRENT-STATE = COMPLETING-REBALANCE
            CONTINUE
        ELSE IF CURRENT-STATE = STABLE
            CONTINUE
        ELSE IF CURRENT-STATE = DEAD
            CONTINUE
        ELSE IF CURRENT-STATE = EMPTY
            CONTINUE
        ELSE
            THROW EXCEPTION "INVALID_STATE".
    END-CALL.

    CALL "GroupMetadata.loadGroup" USING GROUP-ID, INITIAL-STATE, GENERATION-ID, PROTOCOL-TYPE, PROTOCOL-NAME, LEADER-ID, CURRENT-STATE-TIMESTAMP, MEMBERS, TIME.
        MOVE RETURN-CODE TO GROUP-METADATA.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.add" USING MEMBER-METADATA, CALLBACK.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.remove" USING MEMBER-ID.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.replaceStaticMember" USING GROUP-INSTANCE-ID, OLD-MEMBER-ID, NEW-MEMBER-ID.
        MOVE RETURN-CODE TO MEMBER-METADATA.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        IF CURRENT-STATE = PREPARING-REBALANCE OR
           CURRENT-STATE = COMPLETING-REBALANCE OR
           CURRENT-STATE = STABLE OR
           CURRENT-STATE = EMPTY
            CONTINUE
        ELSE
            THROW EXCEPTION "INVALID_STATE".
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.maybeElectNewJoinedLeader".
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.addPendingMember" USING MEMBER-ID.
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.addPendingSyncMember" USING MEMBER-ID.
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.removePendingSyncMember" USING MEMBER-ID.
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.hasReceivedSyncFromAllMembers".
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.allPendingSyncMembers".
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.clearPendingSyncMembers".
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.hasStaticMember" USING GROUP-INSTANCE-ID.
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.currentStaticMemberId" USING GROUP-INSTANCE-ID.
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.currentState".
        MOVE RETURN-CODE TO CURRENT-STATE.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.notYetRejoinedMembers".
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.hasAllMembersJoined".
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.allMembers".
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.allStaticMembers".
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.allDynamicMembers".
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.numPending".
        MOVE RETURN-CODE TO NUM-PENDING.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.numAwaiting".
        MOVE RETURN-CODE TO NUM-AWAITING.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.allMemberMetadata".
        MOVE RETURN-CODE TO MEMBER-METADATA-LIST.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.rebalanceTimeoutMs".
        MOVE RETURN-CODE TO REBALANCE-TIMEOUT-MS.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.generateMemberId" USING CLIENT-ID, GROUP-INSTANCE-ID.
        MOVE RETURN-CODE TO MEMBER-ID.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.canRebalance".
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.transitionTo" USING GROUP-STATE.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.selectProtocol".
        MOVE RETURN-CODE TO PROTOCOL.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.getSubscribedTopics".
        MOVE RETURN-CODE TO SUBSCRIBED-TOPICS.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.isSubscribedToTopic" USING TOPIC.
        MOVE RETURN-CODE TO RESULT.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.computeSubscribedTopics".
        MOVE RETURN-CODE TO SUBSCRIBED-TOPICS.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.updateMember" USING MEMBER-METADATA, PROTOCOLS, REBALANCE-TIMEOUT-MS, SESSION-TIMEOUT-MS, CALLBACK.
    END-CALL.

    CALL "GroupMetadata.inLock" USING LOCK, PROCEDURE-POINTER.
        CALL "GroupMetadata.maybeInvokeJoinCallback" USING MEMBER-METADATA, JOIN-GROUP-RESULT.
    END-CALL.

    CALL "