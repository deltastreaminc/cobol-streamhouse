IDENTIFICATION DIVISION.
PROGRAM-ID. GROUP-COORDINATOR.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY "KAFKA-SERVER-PURGATORY.CPY".
    COPY "GROUP-METADATA.CPY".

DATA DIVISION.
WORKING-STORAGE SECTION.
01 WS-REBALANCE-TIMEOUT        PIC 9(18) COMP-3.
01 WS-CONFIGURED-REBALANCE-DELAY PIC 9(9) COMP.
01 WS-DELAY-MS                 PIC 9(9) COMP.
01 WS-REMAINING-MS             PIC 9(9) COMP.

PROCEDURE DIVISION.

DELAYED-JOIN SECTION.
    MOVE FUNCTION MAX(REBALANCE-TIMEOUT, 0) TO WS-REBALANCE-TIMEOUT.
    MOVE FUNCTION MIN(CONFIGURED-REBALANCE-DELAY, REMAINING-MS) TO WS-DELAY-MS.
    MOVE FUNCTION MAX(REMAINING-MS - WS-DELAY-MS, 0) TO WS-REMAINING-MS.

    PERFORM TRY-COMPLETE-JOIN.
    PERFORM ON-EXPIRATION.
    PERFORM ON-COMPLETE.

TRY-COMPLETE-JOIN SECTION.
    PERFORM TRYCOMPLAETE-DELAYED-ACTION.

TRYCOMPLAETE-DELAYED-ACTION SECTION.
    CALL "REPLICA-MANAGER" USING COORDINATOR-GROUP-MANAGER
        PERFORM TRYCOMPLAETE-ACTIONS.

ON-EXPIRATION SECTION.
    PERFORM TRYCOMPLAETE-DELAYED-ACTION.

ON-COMPLETE SECTION.
    CALL "ON-COMPLETE-JOIN" USING COORDINATOR GROUP.

INITIAL-DELAYED-JOIN SECTION.
    PERFORM TRY-COMPLETE.
    PERFORM ON-COMPLETE.

INITIAL-ON-COMPLETE SECTION.
    IF NEW-MEMBER-ADDED AND REMAINING-MS > 0
        MOVE FALSE TO NEW-MEMBER-ADDED
        PERFORM SCHEDULE-DELAYED-JOIN
    ELSE
        PERFORM ON-COMPLETE.

SCHEDULE-DELAYED-JOIN SECTION.
    CALL "DELAYED-OPERATION-PURGATORY" USING COORDINATOR PURGATORY GROUP
        PERFORM TRYCOMPLAETE-ELSEWATCH USING NEW-INITIAL-DELAYED-JOIN.

NEW-INITIAL-DELAYED-JOIN SECTION.
    MOVE CONFIGURED-REBALANCE-DELAY TO WS-CONFIGURED-REBALANCE-DELAY.
    MOVE WS-DELAY-MS TO WS-DELAY-MS.
    MOVE WS-REMAINING-MS TO WS-REMAINING-MS.
    PERFORM INITIAL-DELAYED-JOIN.