IDENTIFICATION DIVISION.
PROGRAM-ID. MEMBER-METADATA.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    COPY COBOL-UTILITY-FUNCTIONS.
    COPY COBOL-COMMON-VARIABLES.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 MEMBER-ID PIC X(32).
01 GROUP-INSTANCE-ID PIC X(32) OPTIONAL.
01 CLIENT-ID PIC X(32).
01 CLIENT-HOST PIC X(64).
01 REBALANCE-TIMEOUT-MS PIC 9(9) BINARY.
01 SESSION-TIMEOUT-MS PIC 9(9) BINARY.
01 PROTOCOL-TYPE PIC X(32).
01 SUPPORTED-PROTOCOLS.
    03 PROTOCOL-COUNT PIC 9(3) BINARY.
    03 PROTOCOL-LIST OCCURS 10 TIMES.
        05 PROTOCOL-NAME PIC X(32).
        05 PROTOCOL-METADATA PIC X(1024) OCCURS 1 TO 64 TIMES DEPENDING ON PROTOCOL-LENGTH.
01 PROTOCOL-LENGTH PIC 9(4) BINARY.
01 ASSIGNMENT PIC X(1024) OCCURS 1 TO 64 TIMES DEPENDING ON ASSIGNMENT-LENGTH.
01 ASSIGNMENT-LENGTH PIC 9(4) BINARY.
01 AWAITING-JOIN-CALLBACK PIC X(8).
01 AWAITING-SYNC-CALLBACK PIC X(8).
01 IS-NEW PIC X(1).
01 HEARTBEAT-SATISFIED PIC X(1).
01 MEMBER-SUMMARY.
    03 MEMBER-ID PIC X(32).
    03 GROUP-INSTANCE-ID PIC X(32) OPTIONAL.
    03 CLIENT-ID PIC X(32).
    03 CLIENT-HOST PIC X(64).
    03 METADATA PIC X(1024) OCCURS 1 TO 64 TIMES DEPENDING ON METADATA-LENGTH.
    03 METADATA-LENGTH PIC 9(4) BINARY.
    03 ASSIGNMENT PIC X(1024) OCCURS 1 TO 64 TIMES DEPENDING ON ASSIGNMENT-LENGTH.
    03 ASSIGNMENT-LENGTH PIC 9(4) BINARY.

PROCEDURE DIVISION.
    MEMBER-METADATA-INIT.
        MOVE SPACES TO MEMBER-ID.
        MOVE SPACES TO GROUP-INSTANCE-ID.
        MOVE SPACES TO CLIENT-ID.
        MOVE SPACES TO CLIENT-HOST.
        MOVE ZEROS TO REBALANCE-TIMEOUT-MS.
        MOVE ZEROS TO SESSION-TIMEOUT-MS.
        MOVE SPACES TO PROTOCOL-TYPE.
        MOVE ZEROS TO PROTOCOL-COUNT.
        MOVE SPACES TO ASSIGNMENT.
        MOVE ZEROS TO ASSIGNMENT-LENGTH.
        MOVE SPACES TO AWAITING-JOIN-CALLBACK.
        MOVE SPACES TO AWAITING-SYNC-CALLBACK.
        MOVE 'N' TO IS-NEW.
        MOVE 'Y' TO HEARTBEAT-SATISFIED.

    MEMBER-SUMMARY-CREATE.
        MOVE MEMBER-ID TO MEMBER-SUMMARY-MEMBER-ID.
        MOVE GROUP-INSTANCE-ID TO MEMBER-SUMMARY-GROUP-INSTANCE-ID.
        MOVE CLIENT-ID TO MEMBER-SUMMARY-CLIENT-ID.
        MOVE CLIENT-HOST TO MEMBER-SUMMARY-CLIENT-HOST.
        MOVE ASSIGNMENT TO MEMBER-SUMMARY-ASSIGNMENT.
        MOVE ASSIGNMENT-LENGTH TO MEMBER-SUMMARY-ASSIGNMENT-LENGTH.
        MOVE METADATA(PROTOCOL-TYPE) TO MEMBER-SUMMARY-METADATA.
        MOVE PROTOCOL-LENGTH TO MEMBER-SUMMARY-METADATA-LENGTH.

    MEMBER-SUMMARY-NO-METADATA.
        MOVE MEMBER-ID TO MEMBER-SUMMARY-MEMBER-ID.
        MOVE GROUP-INSTANCE-ID TO MEMBER-SUMMARY-GROUP-INSTANCE-ID.
        MOVE CLIENT-ID TO MEMBER-SUMMARY-CLIENT-ID.
        MOVE CLIENT-HOST TO MEMBER-SUMMARY-CLIENT-HOST.
        MOVE SPACES TO MEMBER-SUMMARY-ASSIGNMENT.
        MOVE ZEROS TO MEMBER-SUMMARY-ASSIGNMENT-LENGTH.
        MOVE SPACES TO MEMBER-SUMMARY-METADATA.
        MOVE ZEROS TO MEMBER-SUMMARY-METADATA-LENGTH.

    VOTE-PROTOCOL.
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > PROTOCOL-COUNT
            IF PROTOCOL-NAME(I) IN SUPPORTED-PROTOCOLS IS MEMBER OF CANDIDATES
                RETURN PROTOCOL-NAME(I)
            END-IF
        END-PERFORM.
        RAISE ILLEGAL-ARGUMENT-EXCEPTION.

    METADATA-GET.
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > PROTOCOL-COUNT
            IF PROTOCOL-NAME(I) = PROTOCOL
                RETURN PROTOCOL-METADATA(I)
            END-IF
        END-PERFORM.
        RAISE ILLEGAL-ARGUMENT-EXCEPTION.

    MATCHES-PROTOCOLS.
        IF PROTOCOL-COUNT <> LENGTH OF PROTOCOLS
            RETURN FALSE
        END-IF.
        PERFORM VARYING I FROM 1 BY 1 UNTIL I > PROTOCOL-COUNT
            IF PROTOCOL-NAME(I) <> PROTOCOL-NAME(I) OF PROTOCOLS
                OR PROTOCOL-METADATA(I) <> PROTOCOL-METADATA(I) OF PROTOCOLS
                RETURN FALSE
            END-IF
        END-PERFORM.
        RETURN TRUE.

    HEARTBEAT-SATISFIED-CHECK.
        IF IS-NEW
            RETURN HEARTBEAT-SATISFIED
        ELSE IF AWAITING-JOIN-CALLBACK NOT = SPACES
            OR AWAITING-SYNC-CALLBACK NOT = SPACES
            RETURN TRUE
        ELSE
            RETURN HEARTBEAT-SATISFIED
        END-IF.

    MEMBER-METADATA-DISPLAY.
        DISPLAY "MemberMetadata("
            "memberId=" MEMBER-ID ", "
            "groupInstanceId=" GROUP-INSTANCE-ID ", "
            "clientId=" CLIENT-ID ", "
            "clientHost=" CLIENT-HOST ", "
            "sessionTimeoutMs=" SESSION-TIMEOUT-MS ", "
            "rebalanceTimeoutMs=" REBALANCE-TIMEOUT-MS ", "
            "supportedProtocols=" SUPPORTED-PROTOCOLS ")"
        .

GOBACK.