IDENTIFICATION DIVISION.
PROGRAM-ID. COORDINATORLOADERIMPL.

ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
REPOSITORY.
    FUNCTION ALL INTRINSIC.

DATA DIVISION.
WORKING-STORAGE SECTION.
01 IS-RUNNING PIC X(1) VALUE 'T'.
01 SCHEDULER.
    02 SCHEDULER-THREAD PIC X(50).
    02 SCHEDULE-RESULT PIC X(1) VALUE 'F'.
01 FUTURE.
    02 LOAD-SUMMARY.
        03 START-TIME-MS PIC 9(18).
        03 END-TIME-MS PIC 9(18).
        03 SCHEDULER-QUEUE-TIME-MS PIC 9(18).
        03 NUM-RECORDS PIC 9(18).
        03 NUM-BYTES PIC 9(18).
01 BUFFER.
    02 BUFFER-SIZE PIC 9(9) VALUE 0.
    02 BUFFER-DATA PIC X(32767).
01 CURRENT-OFFSET PIC 9(18) VALUE 0.
01 READ-AT-LEAST-ONE-RECORD PIC X(1) VALUE 'T'.
01 PREVIOUS-HIGH-WATERMARK PIC 9(18) VALUE -1.
01 NUM-RECORDS PIC 9(18) VALUE 0.
01 NUM-BYTES PIC 9(18) VALUE 0.

PROCEDURE DIVISION.

LOAD-COORDINATOR.
    MOVE FUNCTION CURRENT-DATE TO START-TIME-MS.
    PERFORM SCHEDULE-LOAD.
    MOVE 'F' TO SCHEDULE-RESULT.
    IF SCHEDULE-RESULT = 'T'
        MOVE 'T' TO IS-RUNNING
        PERFORM DO-LOAD
    ELSE
        MOVE 'Coordinator loader is closed.' TO LOAD-SUMMARY-ERROR
        SET FUTURE-COMPLETED-EXCEPTIONALLY TO TRUE.

SCHEDULE-LOAD.
    MOVE 'Load coordinator from TopicPartition' TO SCHEDULER-THREAD.
    CALL 'SCHEDULEONCE' USING SCHEDULER-THREAD, PROCEDURE POINTER TO DO-LOAD
        GIVING SCHEDULE-RESULT.

DO-LOAD.
    MOVE FUNCTION CURRENT-DATE TO SCHEDULER-QUEUE-TIME-MS.
    SUBTRACT START-TIME-MS FROM SCHEDULER-QUEUE-TIME-MS GIVING SCHEDULER-QUEUE-TIME-MS.

    PERFORM GET-LOG.
    IF LOG-EXIST
        PERFORM LOAD-RECORDS
        PERFORM UPDATE-METADATA
        MOVE FUNCTION CURRENT-DATE TO END-TIME-MS
        IF IS-RUNNING = 'T'
            MOVE LOAD-SUMMARY TO FUTURE-RESULT
            SET FUTURE-COMPLETED TO TRUE
        ELSE
            MOVE 'Coordinator loader is closed.' TO LOAD-SUMMARY-ERROR
            SET FUTURE-COMPLETED-EXCEPTIONALLY TO TRUE
    ELSE
        MOVE 'Could not load records from TopicPartition because the log does not exist.' TO LOAD-SUMMARY-ERROR
        SET FUTURE-COMPLETED-EXCEPTIONALLY TO TRUE.

GET-LOG.
    CALL 'GETLOG' USING TopicPartition GIVING LOG-HANDLE.
    IF LOG-HANDLE = ZERO
        MOVE 'F' TO LOG-EXIST
    ELSE
        MOVE 'T' TO LOG-EXIST.

LOAD-RECORDS.
    PERFORM UNTIL CURRENT-OFFSET >= LOG-END-OFFSET OR READ-AT-LEAST-ONE-RECORD = 'F' OR IS-RUNNING = 'F'
        CALL 'READ' USING LOG-HANDLE, CURRENT-OFFSET, BUFFER-SIZE, BUFFER-DATA
            GIVING FETCH-DATA-INFO
        IF FETCH-DATA-INFO-RECORDS-SIZE > 0
            MOVE 'T' TO READ-AT-LEAST-ONE-RECORD
            PERFORM PROCESS-RECORDS
        ELSE
            MOVE 'F' TO READ-AT-LEAST-ONE-RECORD.

PROCESS-RECORDS.
    PERFORM VARYING RECORD-INDEX FROM 1 BY 1 UNTIL RECORD-INDEX > RECORD-COUNT
        IF RECORD-IS-CONTROL-BATCH
            PERFORM PROCESS-CONTROL-RECORD
        ELSE
            PERFORM PROCESS-DATA-RECORD
        END-IF
        ADD 1 TO NUM-RECORDS
        ADD RECORD-SIZE TO NUM-BYTES
    END-PERFORM.

PROCESS-CONTROL-RECORD.
    IF RECORD-CONTROL-TYPE = 'COMMIT'
        CALL 'REPLAYENDTRANSACTIONMARKER' USING PRODUCER-ID, PRODUCER-EPOCH, TRANSACTION-RESULT-COMMIT
    ELSE IF RECORD-CONTROL-TYPE = 'ABORT'
        CALL 'REPLAYENDTRANSACTIONMARKER' USING PRODUCER-ID, PRODUCER-EPOCH, TRANSACTION-RESULT-ABORT
    END-IF.

PROCESS-DATA-RECORD.
    PERFORM DESERIALIZE-RECORD.
    IF DESERIALIZE-SUCCESSFUL
        CALL 'REPLAY' USING RECORD-OFFSET, PRODUCER-ID, PRODUCER-EPOCH, COORDINATOR-RECORD
    ELSE
        MOVE 'Deserializing record from TopicPartition failed.' TO LOAD-SUMMARY-ERROR
        SET FUTURE-COMPLETED-EXCEPTIONALLY TO TRUE
    END-IF.

DESERIALIZE-RECORD.
    CALL 'DESERIALIZE' USING RECORD-KEY, RECORD-VALUE GIVING COORDINATOR-RECORD.
    IF EXCEPTION-OCCUR
        MOVE 'F' TO DESERIALIZE-SUCCESSFUL
    ELSE
        MOVE 'T' TO DESERIALIZE-SUCCESSFUL
    END-IF.

UPDATE-METADATA.
    IF CURRENT-OFFSET >= LOG-HIGH-WATERMARK
        CALL 'UPDATELASTWRITTENOFFSET' USING CURRENT-OFFSET
        IF LOG-HIGH-WATERMARK > PREVIOUS-HIGH-WATERMARK
            CALL 'UPDATELASTCOMMITTEDOFFSET' USING LOG-HIGH-WATERMARK
            MOVE LOG-HIGH-WATERMARK TO PREVIOUS-HIGH-WATERMARK
        END-IF
    END-IF.

CLOSE-LOADER.
    IF IS-RUNNING = 'T'
        MOVE 'F' TO IS-RUNNING
        CALL 'SHUTDOWN' USING SCHEDULER
    ELSE
        MOVE 'Coordinator loader is already shutting down.' TO LOAD-SUMMARY-ERROR
    END-IF.